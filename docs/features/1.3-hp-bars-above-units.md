# Feature Spec: HP Bars Above Units

| Property | Value |
|----------|-------|
| **Feature ID** | 1.3 |
| **Status** | Implemented |
| **Priority** | Critical |
| **Estimated Time** | 1 hour |
| **Phase** | Phase 1: Combat Visuals & Basic Interaction |
| **Dependencies** | Task 1.2 (Unit Placeholder Sprites) |

---

## 1. Purpose

### Why This Feature Exists

HP bars are essential visual feedback for tactical combat. Without visible health information, players cannot make informed decisions about which enemies to focus, when to heal allies, or when units are in danger. This directly supports the **Tactical Combat** design pillar by enabling strategic decision-making based on unit health states.

### What It Enables

- Players can assess battlefield health at a glance
- Prioritize targets (focus low HP enemies for quick kills)
- Identify allies in need of healing before it's too late
- Visual urgency when units reach critical health (color change)
- Foundation for damage feedback systems (Task 1.7)

### Success Criteria

| Criterion | Measurement |
|-----------|-------------|
| HP bar visibility | Bar clearly visible above every unit |
| Accurate representation | Bar fill matches current/max HP percentage |
| Dynamic updates | Bar responds immediately to HP changes |
| Critical warning | Color changes to red at 25% HP or below |
| Non-intrusive | Bar doesn't obscure unit sprite or interfere with selection |

---

## 2. Design Pillar Alignment

| Pillar | How This Feature Supports It |
|--------|------------------------------|
| **Tactical Combat** | Health visibility enables strategic targeting - players can focus fire on wounded enemies or protect injured allies |
| **Build & Command** | At-a-glance health status for 8-12 friendly units + 15-20 enemies allows commanders to assess the battlefield quickly without clicking each unit |

---

## 3. How It Works

### Overview

Each unit (party members, soldiers, and enemies) displays a horizontal health bar floating above their sprite. The bar uses a ProgressBar node positioned at a fixed Y offset above the unit's center. The bar has a red background (representing missing health) with a green foreground (representing current health) that shrinks from right to left as damage is taken.

When a unit's health drops below 25% of maximum, the foreground color changes from green to red, providing an urgent visual warning that the unit is in critical condition. This color change is immediate and persistent until the unit heals above the threshold.

The HP bar is a child of the Unit scene, meaning it moves with the unit and is automatically cleaned up when the unit is removed from the scene.

### User Flow

```
1. Battle begins, units spawn on grid
2. Each unit displays HP bar at full (100% green fill)
3. Unit takes damage from attack
4. HP bar fill decreases proportionally
5. If HP drops below 25%, bar color changes to red
6. If healed, bar fill increases (color reverts if above 25%)
7. When unit dies (HP = 0), unit and bar are removed
```

### Rules & Constraints

- HP bar always visible while unit is alive
- Bar position is fixed relative to unit sprite (doesn't bob or animate)
- Bar fill is calculated as `current_hp / max_hp`
- Color threshold is exactly 25% (not 24.9%, not 25.1%)
- Bar updates synchronously with HP changes (no animation delay for prototype)
- All unit types use the same bar dimensions and positioning

### Edge Cases

- **HP at exactly 25%**: Bar should be red (threshold is "less than or equal to 25%")
- **HP healed from critical**: Bar immediately returns to green when HP > 25%
- **Overkill damage**: HP cannot go below 0; bar shows 0% fill before unit removal
- **Healing above max**: HP cannot exceed max; bar shows 100% fill
- **Unit with 1 max HP**: Bar still displays correctly at tiny fill percentages

---

## 4. User Interaction

### This Task

**No direct user interaction with HP bars** - bars are read-only visual feedback. Players observe bars to inform their tactical decisions.

### Visual Feedback

| Event | Visual Response |
|-------|-----------------|
| Unit spawns | HP bar appears at 100% fill (green) |
| Damage taken | Bar fill decreases instantly |
| HP below 25% | Bar color changes from green to red |
| Healing received | Bar fill increases |
| HP above 25% (from critical) | Bar color returns to green |
| Unit dies | Bar removed with unit |

### Debug Controls (For Testing)

For development testing, add temporary debug controls:
- Press `D` while hovering over unit: Deal 10 damage to that unit
- Press `H` while hovering over unit: Heal 10 HP to that unit

These debug controls will be removed or disabled before playtest.

---

## 5. Visual Design

### Layout

```
        ┌────────────────────────────────┐
        │         HP Bar (48x6)          │  ← 40px above unit center
        └────────────────────────────────┘

        ┌────────────────────────────────┐
        │                                │
        │         Unit Sprite            │
        │          (56x56)               │
        │                                │
        └────────────────────────────────┘
```

### HP Bar Anatomy

```
Full HP (100%):
┌──────────────────────────────────────────────┐
│██████████████████████████████████████████████│  Green fill
└──────────────────────────────────────────────┘

Half HP (50%):
┌──────────────────────────────────────────────┐
│███████████████████████░░░░░░░░░░░░░░░░░░░░░░░│  Green fill | Red background
└──────────────────────────────────────────────┘

Critical HP (20%):
┌──────────────────────────────────────────────┐
│████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│  Red fill | Red background
└──────────────────────────────────────────────┘
```

### Color Palette

| Element | Color | Hex | Usage |
|---------|-------|-----|-------|
| Healthy fill | Green | #27ae60 | HP bar foreground when HP > 25% |
| Critical fill | Red | #c0392b | HP bar foreground when HP <= 25% |
| Background | Dark Red | #7f1d1d | HP bar background (visible as "missing" health) |
| Border | Black | #000000 | 1px border around bar (optional, for visibility) |

### Specifications

| Property | Value | Rationale |
|----------|-------|-----------|
| Bar width | 48 pixels | Slightly smaller than unit sprite (56px) |
| Bar height | 6 pixels | Thin but visible; doesn't dominate unit |
| Y offset | -40 pixels | Above 56px sprite with clearance |
| Low HP threshold | 25% | Standard "critical" indicator |

### Visual States

| HP Range | Fill Color | Background | Visual Meaning |
|----------|------------|------------|----------------|
| 26-100% | #27ae60 (Green) | #7f1d1d | Healthy |
| 0-25% | #c0392b (Red) | #7f1d1d | Critical - needs attention |
| 0% | Empty bar | #7f1d1d | Dead (bar about to be removed) |

---

## 6. Technical Implementation

### Scene Structure

```
Unit.tscn (Modified)
├── Unit (CharacterBody2D or Node2D) [root]
│   ├── Sprite2D [existing]
│   ├── CollisionShape2D [existing, for click detection in Task 1.4]
│   └── HPBar (ProgressBar) [NEW]
│       └── Positioned at (0, -40) relative to unit center
```

### Node Configuration

**HPBar (ProgressBar) Settings:**
```
Node name: HPBar
Type: ProgressBar
Position: Vector2(0, -40)  # Centered above unit, 40px up
Size: Vector2(48, 6)
Anchors: Centered (anchor_left: 0.5, anchor_right: 0.5)

# Offset to center the bar (since ProgressBar anchors at top-left)
position.x = -24  # Half of width (48/2)
position.y = -40  # Above unit

# ProgressBar properties
min_value: 0
max_value: 100  # Use percentage for simplicity
value: 100  # Starts full
show_percentage: false
```

### Script Responsibilities

**unit.gd (Modified)**

```gdscript
extends Node2D  # or CharacterBody2D
class_name Unit

## Unit HP and visual feedback

signal hp_changed(current_hp: int, max_hp: int)
signal unit_died

# HP Configuration
@export var max_hp: int = 35  # Default, override per unit type
var current_hp: int

# HP Bar colors
const COLOR_HEALTHY: Color = Color("#27ae60")
const COLOR_CRITICAL: Color = Color("#c0392b")
const COLOR_BACKGROUND: Color = Color("#7f1d1d")
const LOW_HP_THRESHOLD: float = 0.25  # 25%

# HP Bar dimensions
const HP_BAR_WIDTH: int = 48
const HP_BAR_HEIGHT: int = 6
const HP_BAR_OFFSET_Y: int = -40

@onready var hp_bar: ProgressBar = $HPBar

func _ready() -> void:
    current_hp = max_hp
    _setup_hp_bar()
    _update_hp_bar()

func _setup_hp_bar() -> void:
    # Configure HP bar styling
    hp_bar.custom_minimum_size = Vector2(HP_BAR_WIDTH, HP_BAR_HEIGHT)
    hp_bar.size = Vector2(HP_BAR_WIDTH, HP_BAR_HEIGHT)
    hp_bar.position = Vector2(-HP_BAR_WIDTH / 2, HP_BAR_OFFSET_Y)
    hp_bar.min_value = 0
    hp_bar.max_value = 100
    hp_bar.show_percentage = false

    # Apply custom theme/stylebox for colors
    _apply_hp_bar_style()

func _apply_hp_bar_style() -> void:
    # Create styleboxes for the progress bar
    var bg_style = StyleBoxFlat.new()
    bg_style.bg_color = COLOR_BACKGROUND
    bg_style.corner_radius_top_left = 1
    bg_style.corner_radius_top_right = 1
    bg_style.corner_radius_bottom_left = 1
    bg_style.corner_radius_bottom_right = 1
    hp_bar.add_theme_stylebox_override("background", bg_style)

    _update_fill_color()

func _update_fill_color() -> void:
    var fill_style = StyleBoxFlat.new()
    var hp_percent = float(current_hp) / float(max_hp)

    if hp_percent <= LOW_HP_THRESHOLD:
        fill_style.bg_color = COLOR_CRITICAL
    else:
        fill_style.bg_color = COLOR_HEALTHY

    fill_style.corner_radius_top_left = 1
    fill_style.corner_radius_top_right = 1
    fill_style.corner_radius_bottom_left = 1
    fill_style.corner_radius_bottom_right = 1
    hp_bar.add_theme_stylebox_override("fill", fill_style)

func _update_hp_bar() -> void:
    var hp_percent = (float(current_hp) / float(max_hp)) * 100
    hp_bar.value = hp_percent
    _update_fill_color()

## Public API

func take_damage(amount: int) -> void:
    current_hp = max(0, current_hp - amount)
    _update_hp_bar()
    hp_changed.emit(current_hp, max_hp)

    if current_hp <= 0:
        _die()

func heal(amount: int) -> void:
    current_hp = min(max_hp, current_hp + amount)
    _update_hp_bar()
    hp_changed.emit(current_hp, max_hp)

func get_hp_percent() -> float:
    return float(current_hp) / float(max_hp)

func is_critical() -> bool:
    return get_hp_percent() <= LOW_HP_THRESHOLD

func _die() -> void:
    unit_died.emit()
    queue_free()  # For prototype; may change to disable/animate
```

### Integration Points

| System | Integration |
|--------|-------------|
| Attack resolution (Task 1.7) | Calls `unit.take_damage(amount)` |
| Healing abilities (Task 2.6) | Calls `unit.heal(amount)` |
| Victory/Defeat detection (Task 1.9) | Listens for `unit_died` signal |
| Combat log (Task 4.3) | Displays HP change amounts |
| Turn order panel (Task 1.6) | May show HP percentage next to portrait |

### Signals

```gdscript
signal hp_changed(current_hp: int, max_hp: int)  # Emitted on any HP change
signal unit_died  # Emitted when HP reaches 0
```

---

## 7. File Structure

```
scenes/
└── combat/
    └── Unit.tscn              # Modified to include HP bar

scripts/
└── combat/
    └── unit.gd                # Modified with HP tracking and bar logic

# No new files required - this modifies existing files from Task 1.2
```

---

## 8. Acceptance Criteria

Feature is complete when:

- [ ] HP bar visible above each unit sprite
- [ ] Bar positioned 40 pixels above unit center
- [ ] Bar dimensions are 48x6 pixels
- [ ] Bar shows correct fill percentage (current_hp / max_hp)
- [ ] Full HP displays as 100% green fill
- [ ] Partial HP displays as proportional fill with red background
- [ ] HP at or below 25% changes fill color to red
- [ ] HP above 25% displays green fill
- [ ] `take_damage()` function reduces HP and updates bar
- [ ] `heal()` function increases HP and updates bar
- [ ] HP cannot go below 0 or above max
- [ ] Debug key (D) deals damage for testing
- [ ] Debug key (H) heals unit for testing
- [ ] Bar color transitions correctly when crossing 25% threshold

---

## 9. Testing Checklist

### Functional Tests

- [ ] HP bar appears when unit is placed on grid
- [ ] Bar starts at 100% fill for full HP units
- [ ] Dealing 10 damage to 35 HP unit shows ~71% fill
- [ ] Dealing enough damage to reach 25% shows red bar
- [ ] Healing from 25% to 30% returns bar to green
- [ ] Dealing lethal damage removes unit from scene

### Visual Tests

- [ ] Bar is centered above unit sprite
- [ ] Bar doesn't overlap with unit sprite
- [ ] Green (#27ae60) color matches specification
- [ ] Red (#c0392b) color matches specification
- [ ] Background red (#7f1d1d) visible as "missing" health
- [ ] Bar visible on all unit types (party, soldiers, enemies)

### Edge Case Tests

- [ ] Unit with 1 HP shows tiny sliver of fill
- [ ] Unit at exactly 25% HP shows red fill
- [ ] Unit at 26% HP shows green fill
- [ ] Healing above max HP caps at 100% fill
- [ ] Overkill damage shows 0% fill (briefly before unit removed)
- [ ] Multiple units all display bars correctly

### Integration Tests

- [ ] HP bar doesn't interfere with unit selection (Task 1.4)
- [ ] HP bar moves with unit during movement (Task 1.5)
- [ ] HP bar updates when attack resolves (Task 1.7)

### Performance Tests

- [ ] 20+ units with HP bars maintains 60 FPS
- [ ] No visible lag when updating multiple HP bars simultaneously

---

## 10. Implementation Notes

### Approach Rationale

**Why ProgressBar over TextureProgressBar?**
- Simpler setup for prototype
- StyleBoxFlat provides easy solid color styling
- No need for custom textures
- Can upgrade to TextureProgressBar for polish later

**Why fixed position instead of billboard?**
- 2D game doesn't need billboard behavior
- Fixed offset is simpler and predictable
- Consistent appearance regardless of camera

**Why 25% threshold?**
- Industry standard for "critical" health
- Creates urgency without being too early (50%) or too late (10%)
- Matches common player expectations from other tactical games

### Gotchas to Watch

1. **ProgressBar anchor points**: Default anchor is top-left, so must offset by -width/2 for centering
2. **StyleBox caching**: Must create new StyleBoxFlat instances or they'll be shared
3. **HP bar z-index**: May need to adjust if bar renders behind other elements
4. **Color comparison**: Use exact hex values; Color("#27ae60") not Color(0.15, 0.68, 0.38)

### Future Considerations

- **Damage numbers**: Task 1.7 adds floating damage numbers near HP bar
- **Status icons**: Could add buff/debuff icons adjacent to HP bar
- **HP text**: Could show "25/35" text below bar for detailed view
- **Animation**: Could add smooth fill animation for polish phase

---

## 11. Definition of Done

- [ ] HP bar node added to Unit.tscn
- [ ] unit.gd updated with HP tracking and bar management
- [ ] `take_damage()` and `heal()` functions work correctly
- [ ] Bar colors match specification
- [ ] Low HP threshold triggers color change
- [ ] Debug controls (D/H keys) work for testing
- [ ] All acceptance criteria pass
- [ ] Code follows GDScript style guidelines
- [ ] Ready for Task 1.4 (Click-to-Select Unit)

---

## 12. References

### From GDD

- **Combat HUD**: "HP bars" listed in prototype scope (Section 5: What's IN)
- **Party HP values**: Player 35, Thorne 40, Lyra 25, Matthias 30 (Section 4: Party Members)
- **Enemy HP values**: Bandit Melee 15, Archer 10, Leader 30 (Section 4: Enemy Types)

### From Roadmap

- **Task 1.3**: HP Bars Above Units (Phase 1, Day 1, 1 hour)
- **Dependencies**: Task 1.2 (units must exist)
- **Leads to**: Task 1.4 (Click-to-Select Unit)

### Godot Documentation

- [ProgressBar](https://docs.godotengine.org/en/stable/classes/class_progressbar.html)
- [StyleBoxFlat](https://docs.godotengine.org/en/stable/classes/class_styleboxflat.html)
- [Theme Overrides](https://docs.godotengine.org/en/stable/tutorials/ui/gui_using_theme_editor.html)
