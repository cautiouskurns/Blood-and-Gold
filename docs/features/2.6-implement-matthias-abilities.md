# Task 2.6: Implement Matthias Abilities

**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 4-6 hours
**Dependencies:** Task 2.3 (Implement Player Abilities - ability system foundation)
**Assigned To:** AI Assistant

---

## Purpose

**Why does this feature exist?**
Matthias is the party's healer and support character, essential for sustaining the party through extended combat encounters. His abilities provide the only healing available during battle and can buff the entire party's effectiveness.

**What does it enable?**
Players can heal wounded allies during combat, apply party-wide buffs to turn the tide of difficult battles, and use ranged holy damage to safely damage enemies without exposing Matthias to melee range. This creates tactical depth around positioning and resource management.

**Success criteria:**
- Matthias's 4 abilities appear in the AbilityBar when he is selected
- Heal can target and restore HP to any ally within range 5
- Bless applies +2 to all rolls for all party members for 3 turns
- Smite deals holy damage to enemies at range 3
- Basic Attack allows melee combat when needed

---

## How It Works

### Overview

Matthias is a support-focused character with four distinct abilities that emphasize healing, buffing, and ranged combat. Unlike Thorne who focuses on tanking and melee damage, Matthias should typically stay behind the front line, using his range advantage to support the party.

**Heal** is Matthias's signature ability, allowing him to restore 2d8+4 HP to any friendly unit within 5 tiles. This is the only healing available during combat, making Matthias critical to party survival. The heal requires targeting an ally (not self for balance reasons) and ends his turn.

**Bless** is a party-wide buff that grants +2 to all d20 rolls (attack, defense checks if implemented) for 3 turns to all friendly units. Unlike Rally which only affects soldiers, Bless affects the entire party including heroes. This makes it valuable at the start of difficult encounters or when the party needs to break through enemy defenses.

**Smite** is a ranged holy damage attack dealing 1d8 damage to a single enemy within 3 tiles. It does not require an attack roll (auto-hit) representing divine accuracy, but deals less damage than melee attacks to compensate. This allows Matthias to contribute to damage output while staying safe.

**Basic Attack** is a simple melee attack using his staff (1d6 damage). This is Matthias's fallback option when out of position or when healing/buffing isn't needed. It uses the standard attack resolution (d20 + attack bonus vs defense).

### User Flow

```
=== Heal Flow ===
1. Player selects Matthias during his turn
2. Player clicks "Heal" ability in AbilityBar
3. Valid ally targets within range 5 are highlighted (green)
4. Player clicks on a wounded ally
5. System rolls 2d8+4, heals the ally for that amount
6. Floating heal number appears (green) over healed ally
7. Matthias's turn ends

=== Bless Flow ===
1. Player selects Matthias during his turn
2. Player clicks "Bless" ability in AbilityBar
3. No targeting needed - immediately applies to all party members
4. +2 buff indicator appears briefly over all party members
5. All party members gain BLESSED status for 3 turns
6. Matthias's turn ends

=== Smite Flow ===
1. Player selects Matthias during his turn
2. Player clicks "Smite" ability in AbilityBar
3. Valid enemy targets within range 3 are highlighted (red)
4. Player clicks on an enemy
5. System rolls 1d8 holy damage (auto-hit)
6. Floating damage number appears over enemy
7. Matthias's turn ends

=== Basic Attack Flow ===
1. Player selects Matthias during his turn
2. Player clicks "Basic Attack" ability in AbilityBar
3. Adjacent enemies are highlighted (same as other melee attacks)
4. Player clicks adjacent enemy
5. Standard attack resolution: d20 + ATK vs DEF
6. If hit: 1d6 + STR damage dealt
7. Matthias's turn ends
```

### Rules & Constraints

**Heal:**
- Range: 5 tiles (calculated as Manhattan/grid distance)
- Cannot target self (for balance - encourages party protection)
- Cannot target enemies
- Cannot target dead units
- Healing: 2d8+4 (minimum 6, maximum 20)
- Cannot overheal (capped at max HP)
- Uses per battle: Unlimited (but ends turn)

**Bless:**
- No targeting required - automatically affects all friendly units
- Buff value: +2 to all d20 rolls
- Duration: 3 turns (tracked per-unit)
- Does not stack with itself (refreshes duration instead)
- Affects: Player, Thorne, Lyra, Matthias, and any friendly soldiers

**Smite:**
- Range: 3 tiles
- Damage: 1d8 (no modifier added - pure holy damage)
- Auto-hit (no attack roll required)
- Can only target enemies
- Cannot target dead units
- Uses per battle: Unlimited

**Basic Attack:**
- Range: 1 tile (adjacent only)
- Attack roll: d20 + DEX modifier (Matthias uses DEX for staff attacks)
- Damage: 1d6 + DEX modifier
- Standard critical hit rules apply (nat 20 = double damage)

### Edge Cases

- **What happens if Matthias tries to heal at full HP?**
  - Allow the action but heal for 0 (waste of turn, player's choice)
  - Show "Full HP" floating text instead of heal number

- **What happens if Bless is used when already blessed?**
  - Refresh the duration to 3 turns
  - Do not stack the +2 bonus (still just +2)

- **What happens if target moves out of range after targeting started?**
  - This can't happen in our turn-based system (units don't move during targeting)

- **What happens if target dies before ability executes?**
  - Cancel the ability, show "Target died" message
  - Do not end turn (allow re-targeting)

- **What happens if Matthias is the only ally alive?**
  - Heal shows no valid targets (cannot self-heal)
  - Bless still works (buffs just Matthias)

---

## User Interaction

### Controls

- **Left-click on ability button:** Begin targeting for that ability
- **Left-click on valid target:** Execute ability on target
- **Right-click or ESC during targeting:** Cancel ability targeting
- **Click on empty tile during targeting:** Cancel ability targeting

### Visual Feedback

**Targeting State:**
- Heal: Friendly units in range have green highlight
- Smite: Enemy units in range have red highlight
- Bless: No targeting highlight (immediate effect)
- Basic Attack: Adjacent enemies have red highlight (same as existing melee)

**Execution Feedback:**
- Heal: Green floating number showing HP restored (+14)
- Bless: Brief golden glow effect on all party members
- Smite: Yellow/white floating damage number (holy damage)
- Basic Attack: Standard red damage number or "Miss" text

**Ability Button States:**
- Available: Normal appearance, clickable
- Selected (targeting): Highlighted/pressed appearance
- Unavailable (no valid targets): Grayed out, not clickable

### Audio Feedback (if applicable)

- Heal: Soft chime or healing sound effect
- Bless: Choir or blessing sound effect
- Smite: Holy impact sound
- Basic Attack: Staff impact sound

---

## Visual Design

### Layout

Ability bar remains the same as Task 2.3 - four buttons in a row at bottom center of screen.

### Components

For Matthias, the AbilityBar shows:
- **Slot 1:** Heal - green cross/heart icon
- **Slot 2:** Bless - golden sun/halo icon
- **Slot 3:** Smite - lightning bolt icon
- **Slot 4:** Basic Attack - staff icon

### Visual Style

- Heal: Green/white colors suggesting restoration
- Bless: Gold/yellow colors suggesting divine favor
- Smite: Yellow/white suggesting holy light
- Basic Attack: Brown/neutral suggesting simple staff

### States

- **Default:** Standard button appearance with icon
- **Hover:** Slight brightness increase, tooltip showing ability details
- **Active/Selected:** Highlighted border, pressed appearance
- **Disabled:** Grayed out (no valid targets or not Matthias's turn)
- **On Cooldown:** N/A (no cooldowns in this system)

---

## Technical Implementation

### Scene Structure

No new scenes needed - uses existing AbilityBar.tscn and ability resource system.

### New Ability Resources

Create 4 new `.tres` files in `resources/abilities/matthias/`:

```
resources/abilities/matthias/
â”œâ”€â”€ matthias_heal.tres
â”œâ”€â”€ matthias_bless.tres
â”œâ”€â”€ matthias_smite.tres
â””â”€â”€ matthias_basic_attack.tres
```

### Script Modifications

**1. scripts/resources/ability.gd - Add new ability types:**

```gdscript
enum AbilityType {
    MELEE_ATTACK,
    RANGED_ATTACK,      # Implement for Smite
    SELF_BUFF,
    ALLY_BUFF,
    ALLY_HEAL,          # NEW: Heal ability type
    SOLDIER_BUFF,
    PARTY_BUFF,         # NEW: Bless (affects all party, not just soldiers)
    AOE_ATTACK,
    ARC_ATTACK,
    ENEMY_TAUNT,
    PASSIVE,
}

enum TargetType {
    NONE,
    ENEMY_ADJACENT,
    ENEMY_RANGE,        # Implement for Smite
    ALLY,               # Implement for Heal
    ALLY_RANGE,         # NEW: Ally within range (for Heal)
    SELF,
}

# New properties for healing
@export var heal_dice_count: int = 0    # 2 for 2d8
@export var heal_dice_size: int = 0     # 8 for 2d8
@export var heal_bonus: int = 0         # +4 for 2d8+4
@export var auto_hit: bool = false      # true for Smite (no attack roll)
```

**2. scripts/combat/ability_executor.gd - Add execution handlers:**

```gdscript
static func execute(user: Unit, ability: Ability, target: Unit = null) -> Dictionary:
    # ... existing match statement ...
    match ability.ability_type:
        # ... existing cases ...
        Ability.AbilityType.ALLY_HEAL:
            result = _execute_heal(user, ability, target)
        Ability.AbilityType.PARTY_BUFF:
            result = _execute_party_buff(user, ability)
        Ability.AbilityType.RANGED_ATTACK:
            result = _execute_ranged_attack(user, ability, target)
    return result

static func _execute_heal(user: Unit, ability: Ability, target: Unit) -> Dictionary:
    ## Execute healing ability on ally
    # Roll healing: heal_dice_count * d(heal_dice_size) + heal_bonus
    # Apply healing to target (capped at max HP)
    # Spawn green floating number
    pass

static func _execute_party_buff(user: Unit, ability: Ability) -> Dictionary:
    ## Execute party-wide buff (Bless)
    # Get all friendly units (not just soldiers)
    # Apply BLESSED status to each
    pass

static func _execute_ranged_attack(user: Unit, ability: Ability, target: Unit) -> Dictionary:
    ## Execute ranged attack (Smite)
    # Check range
    # If auto_hit: skip attack roll, go straight to damage
    # Roll damage and apply
    pass
```

**3. scripts/autoload/combat_manager.gd - Add helper methods:**

```gdscript
func get_allies_in_range(unit: Unit, ability_range: int) -> Array[Unit]:
    ## Get all friendly units within range of the given unit
    pass

func get_all_party_members() -> Array[Unit]:
    ## Get all friendly units (heroes + soldiers)
    pass
```

**4. scripts/combat/unit.gd - Add Matthias ability assignment:**

```gdscript
func _configure_abilities_for_type() -> void:
    match unit_type:
        # ... existing cases ...
        UnitType.MATTHIAS:
            _abilities = [
                preload("res://resources/abilities/matthias/matthias_heal.tres"),
                preload("res://resources/abilities/matthias/matthias_bless.tres"),
                preload("res://resources/abilities/matthias/matthias_smite.tres"),
                preload("res://resources/abilities/matthias/matthias_basic_attack.tres"),
            ]
```

### Integration Points

- **Connects to:** CombatManager (targeting), AbilityBar (UI), Unit (ability assignment)
- **Emits signals:**
  - `ability_executed(user, ability, target, result)` - existing signal
  - `healing_applied(target, amount)` - new signal for heal feedback
  - `buff_applied(targets, buff_name, duration)` - new signal for buff feedback
- **Listens for:**
  - `ability_button_pressed(ability_id)` - from AbilityBar
  - `target_selected(target)` - from Unit Area2D click
- **Modifies:**
  - Target unit's `current_hp` (heal)
  - All party members' status effects (bless)
  - Target unit's `current_hp` (smite damage)

### Configuration

**Ability Resource Files:**

`matthias_heal.tres`:
```gdscript
id = "matthias_heal"
display_name = "Heal"
description = "Restore 2d8+4 HP to an ally within 5 tiles"
ability_type = AbilityType.ALLY_HEAL
target_type = TargetType.ALLY_RANGE
ability_range = 5
heal_dice_count = 2
heal_dice_size = 8
heal_bonus = 4
ends_turn = true
uses_per_battle = -1
```

`matthias_bless.tres`:
```gdscript
id = "matthias_bless"
display_name = "Bless"
description = "Grant all party members +2 to all rolls for 3 turns"
ability_type = AbilityType.PARTY_BUFF
target_type = TargetType.NONE
requires_target = false
applies_status = "BLESSED"
status_duration = 3
status_value = 2
ends_turn = true
uses_per_battle = -1
```

`matthias_smite.tres`:
```gdscript
id = "matthias_smite"
display_name = "Smite"
description = "Deal 1d8 holy damage to enemy within 3 tiles (auto-hit)"
ability_type = AbilityType.RANGED_ATTACK
target_type = TargetType.ENEMY_RANGE
ability_range = 3
auto_hit = true
damage_multiplier = 1.0
bonus_damage = 0
# Note: Uses fixed 1d8 damage, not weapon damage
ends_turn = true
uses_per_battle = -1
```

`matthias_basic_attack.tres`:
```gdscript
id = "matthias_basic_attack"
display_name = "Basic Attack"
description = "Attack with staff (1d6 damage)"
ability_type = AbilityType.MELEE_ATTACK
target_type = TargetType.ENEMY_ADJACENT
ability_range = 1
damage_multiplier = 1.0
ends_turn = true
uses_per_battle = -1
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Matthias has 4 abilities visible in AbilityBar when selected
- [ ] Heal ability can target allies within 5 tiles and restores 2d8+4 HP
- [ ] Heal shows green floating number indicating HP restored
- [ ] Bless ability immediately buffs all party members with +2 for 3 turns
- [ ] Bless applies BLESSED status tracked by StatusEffectManager
- [ ] Smite ability can target enemies within 3 tiles and deals 1d8 damage (auto-hit)
- [ ] Basic Attack functions identically to other melee attacks (d20 + ATK vs DEF)
- [ ] All abilities properly end Matthias's turn when used
- [ ] Invalid targets are not highlightable/clickable during targeting
- [ ] AbilityBar shows correct ability names and icons for Matthias

---

## Testing Checklist

### Functional Tests

- [ ] **Heal targeting:** Click Heal, verify only allies in range 5 are highlighted
- [ ] **Heal execution:** Click valid ally, verify HP increases by 2d8+4
- [ ] **Heal cap:** Heal ally at near-full HP, verify doesn't exceed max HP
- [ ] **Bless execution:** Click Bless, verify all party members gain BLESSED status
- [ ] **Bless buff tracking:** Verify +2 bonus applies to attack rolls for 3 turns
- [ ] **Bless duration:** Verify BLESSED expires after 3 turns
- [ ] **Smite targeting:** Click Smite, verify only enemies in range 3 are highlighted
- [ ] **Smite auto-hit:** Verify Smite always hits (no attack roll displayed)
- [ ] **Smite damage:** Verify 1d8 damage dealt (range 1-8)
- [ ] **Basic Attack:** Verify standard melee attack flow with d20 roll

### Edge Case Tests

- [ ] **No valid heal targets:** If all allies at full HP or out of range, Heal button disabled
- [ ] **Self-heal prevention:** Verify Matthias cannot target himself with Heal
- [ ] **Bless refresh:** Use Bless twice, verify duration refreshes (not stacks)
- [ ] **Only ally alive:** Verify Bless still works on solo Matthias
- [ ] **Target dies during targeting:** Verify graceful handling if target killed by other effect

### Integration Tests

- [ ] **Works with TurnOrderPanel:** Turn advances after each ability use
- [ ] **Works with StatusEffectManager:** BLESSED status properly tracked and expires
- [ ] **Works with DamageNumber system:** All floating numbers display correctly
- [ ] **Works with combat log:** All ability usage properly logged to console

### Polish Tests

- [ ] **Floating numbers:** Heal shows green number, Smite shows damage number
- [ ] **Ability button states:** Correct enabled/disabled states based on valid targets
- [ ] **Ability names visible:** Labels show "Heal", "Bless", "Smite", "Basic Attack"
- [ ] **Performance:** No frame drops when executing abilities

---

## Implementation Notes

*(For AI assistant or future developer)*

- **Heal targeting differs from attack targeting:** Need to highlight allies (green) instead of enemies (red). May need new highlight color in CombatGrid.
- **Bless is simpler than Rally:** Rally only targets soldiers with SOLDIER unit class. Bless targets all friendly units regardless of class.
- **Smite's auto-hit is intentional:** This represents divine accuracy. The tradeoff is lower damage (1d8) compared to melee attacks.
- **BLESSED status needs implementation:** Similar to ATTACK_BUFF but affects all d20 rolls, not just attack rolls. May need to modify how StatusEffectManager.get_attack_modifier() works, or add new method for general roll modifiers.
- **Range calculation:** Use Manhattan distance (|x1-x2| + |y1-y2|) consistent with movement range. CombatGrid should have helper method for this.
- **Consider future extensibility:** Lyra (Task 2.5) will need similar ranged attack support. Design Smite execution to be reusable.

---
