# Merchant's Escort - Tutorial Contract

**Status:** ðŸ”´ Planned
**Priority:** ðŸ”¥ Critical
**Estimated Time:** 3 hours
**Dependencies:** Task 3.2 (Contract Board UI), Phase 2 (Full Combat System)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The Merchant's Escort contract serves as the player's introduction to Blood & Gold's tactical combat systems. It teaches core mechanics (movement, attacking, soldier orders) in a low-stakes environment while establishing the mercenary company narrative and introducing the first companion character, Thorne.

**What does it enable?**
Players will learn how to navigate grid-based combat, issue basic orders to soldiers, protect objectives, and complete contracts for gold rewards. This tutorial establishes the core gameplay loop that drives the entire prototype.

**Success criteria:**
- First-time players understand movement and attacking within 2-3 turns
- Players successfully use at least one soldier order during combat
- Completion rate >90% (combat is forgiving enough to learn)
- Average completion time: 10-15 minutes
- Players feel invested in protecting the merchant wagon

---

## How It Works

### Overview

The Merchant's Escort is the first contract available on the Contract Board. When selected, players see a briefing screen describing the mission: escort a merchant wagon through bandit territory. The briefing establishes stakes (the merchant paid good gold, bandits threaten the route) and objectives (reach destination with wagon intact).

Combat takes place on the Forest Clearing map (12x12 grid). The player's party (4 members) and soldiers (2 Infantry) start on the western edge, with the merchant wagon in the center. Six bandits (4 Melee, 2 Archers) are positioned in ambush along the eastern side. Tutorial prompts appear at key moments to explain mechanics without overwhelming the player.

Upon victory (all bandits defeated with wagon surviving), players receive 300 gold and transition to the first camp scene where they meet Thorne properly. If the wagon is destroyed, players can retry. If all party members fall, standard defeat screen appears with retry option.

### User Flow

```
1. Player selects "Merchant's Escort" from Contract Board
2. Briefing screen displays mission details and objectives
3. Player clicks "Accept Contract"
4. Combat scene loads with Forest Clearing map
5. Tutorial popup: "Welcome to combat! Click a unit to select them."
6. Player selects a party member
7. Tutorial popup: "Blue tiles show where you can move. Click to move."
8. Player moves unit
9. Tutorial popup: "Click an enemy to attack when adjacent."
10. Player attacks enemy
11. Tutorial popup: "Your soldiers follow orders. Try the Order Panel on the right."
12. Player issues order to soldiers
13. Combat continues (player uses learned mechanics)
14. Victory: "Contract Complete! +300 Gold"
15. Transition to Thorne Camp Scene
16. Return to Hub
```

### Rules & Constraints

- **Wagon Protection:** The merchant wagon is an objective unit that cannot move or attack. If its HP reaches 0, the mission fails.
- **Wagon HP:** 50 HP (roughly 3-4 bandit attacks to destroy)
- **Soldier Limit:** Player has exactly 2 Infantry soldiers for this mission (fixed, not affected by recruitment)
- **Enemy Aggro:** Bandits prioritize the wagon over party members until attacked
- **Tutorial Prompts:** Each prompt appears only once per playthrough; subsequent retries skip seen prompts
- **No Retreat:** Player cannot retreat from this contract once combat begins
- **Order Tutorial:** Only "Advance" and "Hold Line" orders are explained; other orders are available but not tutorialized

### Edge Cases

- **What happens if wagon destroyed?** Mission Fail screen with "The merchant wagon was destroyed. The bandits claimed the cargo." Option to Retry or Return to Hub (forfeit contract).
- **What happens if party wipes but wagon survives?** Standard defeat, even if wagon intact. "Your company has fallen." Option to Retry.
- **What happens if player ignores tutorial prompts?** Prompts disappear after 10 seconds or after player performs the tutorialized action. Game remains playable.
- **What happens if player kills all enemies before reaching wagon?** Victory triggers normally; tutorial is combat-focused, not position-focused.
- **What happens if player already completed this contract?** Tutorial prompts do not reappear; contract is removed from board (one-time only).

---

## User Interaction

### Controls

- **Left Click on Friendly Unit:** Select unit, show movement range
- **Left Click on Tile:** Move selected unit (if valid)
- **Left Click on Enemy:** Attack enemy (if in range)
- **Right Click:** Deselect / Cancel action
- **Order Panel Buttons:** Click to select order, click soldier to assign
- **Spacebar:** Skip/dismiss tutorial popup
- **Escape:** Open pause menu (Retry, Settings, Quit)

### Visual Feedback

- **Selected Unit:** Yellow outline glow (#f1c40f)
- **Valid Move Tiles:** Green overlay with 40% opacity (#27ae60)
- **Attack Range:** Red overlay for enemies in range (#e74c3c, 30% opacity)
- **Wagon Status:** Large HP bar above wagon, pulsing red when below 50%
- **Tutorial Popup:** Semi-transparent panel with highlighted area showing relevant UI element
- **Order Assignment:** Brief flash on soldier when order assigned
- **Victory Banner:** Gold-bordered banner sliding down from top of screen

### Audio Feedback

- **Tutorial Popup Appear:** Soft chime sound
- **Wagon Taking Damage:** Warning horn/bell sound
- **Order Assigned:** Command acknowledgment sound (soldier grunt)
- **Victory:** Triumphant horn fanfare
- **Defeat:** Somber defeat tone

---

## Visual Design

### Layout

```
+--------------------------------------------------+
|               TURN ORDER PANEL                   |
+--------------------------------------------------+
|                                                  |
|   [FOREST CLEARING MAP - 12x12 GRID]            |
|                                                  |
|   [P][T][L][M]        [WAGON]        [B][B]     |
|   [S1][S2]                           [B][B]     |
|                  [trees] [stream]    [A][A]     |
|                                                  |
+--------------------------------------------------+
|   [ABILITY BAR]              [ORDER PANEL]       |
+--------------------------------------------------+
```

### Components

- **Briefing Panel:** Full-screen overlay before combat starts
  - Mission title at top
  - Flavor text describing situation
  - Objectives list (Primary: Wagon survives, Secondary: No soldier deaths)
  - Rewards display (300 Gold)
  - "Accept Contract" button

- **Tutorial Popup:** Modal overlay during combat
  - Arrow pointing to relevant UI element
  - Short instructional text (1-2 sentences)
  - "Got it" button or auto-dismiss

- **Wagon Unit:** Special objective marker
  - Larger sprite than standard units
  - Distinct wagon icon (brown cart)
  - Large HP bar always visible
  - "PROTECT" label above wagon

- **Victory Panel:** Post-combat summary
  - "Contract Complete!" header
  - Gold earned: +300
  - Casualties (if any)
  - "Continue" button (leads to camp scene)

### Visual Style

- **Colors:**
  - Tutorial highlight: Soft blue glow (#3498db, 50% opacity)
  - Wagon: Warm brown (#8b4513)
  - Wagon danger state: Pulsing red border
  - Victory gold: #f1c40f

- **Fonts:**
  - Tutorial text: Clear sans-serif, 18px
  - Headers: Bold, 24px

- **Animations:**
  - Tutorial popup: Fade in over 0.3s
  - Arrow pointing: Gentle pulse/bounce
  - Wagon damage: Screen shake (small)
  - Victory: Confetti particles (subtle)

### States

- **Briefing (Pre-Combat):**
  - Full briefing panel visible
  - Combat grid dimmed in background
  - Single "Accept" CTA button

- **Combat (Normal):**
  - Standard combat UI
  - Tutorial popups appear at trigger moments
  - Wagon HP prominently displayed

- **Combat (Wagon Danger):**
  - Wagon HP bar turns red and pulses
  - Warning indicator appears
  - Priority target highlighted

- **Victory:**
  - Combat pauses
  - Victory banner slides in
  - Gold reward animated

- **Defeat (Wagon Lost):**
  - Wagon destruction animation
  - Failure popup
  - Retry/Exit options

---

## Technical Implementation

### Scene Structure

```
MerchantsEscort.tscn
â”œâ”€â”€ ContractBriefing (CanvasLayer)
â”‚   â”œâ”€â”€ Panel (PanelContainer)
â”‚   â”‚   â”œâ”€â”€ Title (Label)
â”‚   â”‚   â”œâ”€â”€ Description (RichTextLabel)
â”‚   â”‚   â”œâ”€â”€ Objectives (VBoxContainer)
â”‚   â”‚   â”œâ”€â”€ Rewards (HBoxContainer)
â”‚   â”‚   â””â”€â”€ AcceptButton (Button)
â”œâ”€â”€ CombatScene (Node2D)
â”‚   â”œâ”€â”€ ForestClearingMap (TileMapLayer)
â”‚   â”œâ”€â”€ UnitManager (Node2D)
â”‚   â”‚   â”œâ”€â”€ PartyUnits (Node2D)
â”‚   â”‚   â”œâ”€â”€ SoldierUnits (Node2D)
â”‚   â”‚   â”œâ”€â”€ EnemyUnits (Node2D)
â”‚   â”‚   â””â”€â”€ MerchantWagon (Node2D)
â”‚   â””â”€â”€ CombatUI (CanvasLayer)
â”œâ”€â”€ TutorialManager (Node)
â”‚   â””â”€â”€ TutorialPopup (CanvasLayer)
â”œâ”€â”€ ContractResults (CanvasLayer)
â”‚   â”œâ”€â”€ VictoryPanel (PanelContainer)
â”‚   â””â”€â”€ DefeatPanel (PanelContainer)
â””â”€â”€ AudioManager (Node)
```

### Script Responsibilities

- **merchants_escort.gd:** Main contract controller
  - Manages contract state (briefing â†’ combat â†’ results)
  - Spawns units at correct positions
  - Monitors victory/defeat conditions
  - Triggers tutorial events
  - Awards gold on completion
  - Transitions to camp scene

- **merchant_wagon.gd:** Wagon objective unit
  - Extends base Unit but cannot move/attack
  - Emits `wagon_damaged(current_hp, max_hp)` signal
  - Emits `wagon_destroyed()` signal
  - Handles wagon-specific visual effects

- **tutorial_manager.gd:** Tutorial popup controller
  - Tracks which tutorials have been shown (persisted to save)
  - Listens for trigger events (unit_selected, unit_moved, etc.)
  - Shows contextual popups with highlights
  - Handles popup dismissal

- **contract_briefing.gd:** Pre-combat briefing UI
  - Populates briefing data from contract resource
  - Handles Accept button
  - Transitions to combat

### Integration Points

- **Connects to:**
  - `CombatManager` (autoload) - Combat state and turn management
  - `GameManager` (autoload) - Gold tracking, game state
  - `ContractBoard` - Contract selection and availability
  - `CampScene` - Transition after completion

- **Emits signals:**
  - `contract_started(contract_id: String)`
  - `contract_completed(contract_id: String, gold_earned: int)`
  - `contract_failed(contract_id: String, reason: String)`
  - `wagon_health_changed(current: int, max: int)`
  - `tutorial_step_completed(step_id: String)`

- **Listens for:**
  - `CombatManager.battle_ended(victory: bool)`
  - `CombatManager.unit_died(unit: Unit)`
  - `CombatManager.unit_selected(unit: Unit)` - Tutorial trigger
  - `CombatManager.unit_moved(unit, from, to)` - Tutorial trigger
  - `CombatManager.unit_attacked(attacker, target, damage)` - Tutorial trigger

- **Modifies:**
  - `GameManager.gold` - Add 300 on completion
  - `GameManager.contracts_completed` - Add "merchants_escort"
  - `GameManager.tutorial_flags` - Mark tutorials as seen

### Configuration

- **Contract Data:** `resources/contracts/merchants_escort.tres`
  ```gdscript
  # Contract resource properties
  contract_id = "merchants_escort"
  display_name = "Merchant's Escort"
  description = "A merchant seeks protection through bandit territory..."
  map_scene = "res://scenes/combat/maps/ForestClearing.tscn"
  reward_gold = 300
  difficulty = "Tutorial"
  is_tutorial = true
  ```

- **Tutorial Steps:** `resources/tutorials/merchants_escort_tutorial.json`
  ```json
  {
    "steps": [
      {
        "id": "select_unit",
        "trigger": "combat_start",
        "text": "Welcome to combat! Click a unit to select them.",
        "highlight": "party_units"
      },
      {
        "id": "movement",
        "trigger": "unit_selected",
        "text": "Blue tiles show where you can move. Click to move.",
        "highlight": "valid_tiles"
      },
      {
        "id": "attack",
        "trigger": "unit_moved",
        "text": "Click an enemy to attack when adjacent.",
        "highlight": "enemy_units"
      },
      {
        "id": "orders",
        "trigger": "first_attack",
        "text": "Your soldiers follow orders. Try the Order Panel on the right.",
        "highlight": "order_panel"
      }
    ]
  }
  ```

- **Hardcoded Constants (in script):**
  ```gdscript
  const WAGON_HP := 50
  const WAGON_POSITION := Vector2i(6, 5)  # Center of 12x12 grid
  const PARTY_SPAWN := [Vector2i(1, 4), Vector2i(1, 5), Vector2i(1, 6), Vector2i(1, 7)]
  const SOLDIER_SPAWN := [Vector2i(2, 5), Vector2i(2, 6)]
  const BANDIT_MELEE_SPAWN := [Vector2i(10, 3), Vector2i(10, 4), Vector2i(10, 7), Vector2i(10, 8)]
  const BANDIT_ARCHER_SPAWN := [Vector2i(11, 5), Vector2i(11, 6)]
  const REWARD_GOLD := 300
  ```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Contract appears on Contract Board with correct name, description, and reward
- [ ] Clicking "Accept" displays briefing screen with objectives
- [ ] Combat loads with Forest Clearing map, party, soldiers, wagon, and 6 bandits
- [ ] Merchant wagon appears at center of map with visible HP bar
- [ ] Tutorial popup for unit selection appears at combat start
- [ ] Tutorial popup for movement appears after first unit selection
- [ ] Tutorial popup for attacking appears after first movement
- [ ] Tutorial popup for soldier orders appears after first attack
- [ ] Tutorial popups can be dismissed manually or auto-dismiss after action
- [ ] Victory triggers when all 6 bandits are defeated AND wagon survives
- [ ] Defeat triggers if wagon HP reaches 0
- [ ] Victory awards exactly 300 gold to player
- [ ] After victory, game transitions to Thorne camp scene (Task 3.11)
- [ ] Contract is marked complete and removed from board after success

---

## Testing Checklist

### Functional Tests

- [ ] **Contract Selection:** Selecting contract from board opens briefing
- [ ] **Briefing Accept:** Accept button starts combat with correct setup
- [ ] **Unit Spawning:** All 4 party members spawn at correct positions
- [ ] **Soldier Spawning:** Both Infantry soldiers spawn correctly
- [ ] **Enemy Spawning:** 4 Melee + 2 Archer bandits spawn at correct positions
- [ ] **Wagon Spawning:** Wagon appears at center with 50 HP
- [ ] **Tutorial Triggers:** Each tutorial popup appears at correct trigger
- [ ] **Tutorial Dismiss:** Tutorials dismiss on click or action completion
- [ ] **Wagon Damage:** Wagon takes damage when attacked, HP bar updates
- [ ] **Wagon Death:** Mission fails immediately when wagon HP reaches 0
- [ ] **Victory Condition:** All bandits dead + wagon alive = victory
- [ ] **Gold Reward:** Player gold increases by exactly 300 on victory
- [ ] **Scene Transition:** Victory transitions to Thorne camp scene

### Edge Case Tests

- [ ] **Wagon survives, party dies:** Game over (defeat), not victory
- [ ] **Retry after wagon death:** Combat resets with all units at full HP
- [ ] **Skip all tutorials:** Combat functions normally without tutorial guidance
- [ ] **Kill archers first:** Melee bandits continue attacking wagon
- [ ] **Protect wagon perfectly:** Secondary objective (0 wagon damage) tracked
- [ ] **Soldier deaths:** Mission can still succeed with soldier casualties

### Integration Tests

- [ ] **Works with CombatManager:** Turn order, movement, attacks all function
- [ ] **Works with GameManager:** Gold persists to hub after completion
- [ ] **Works with ContractBoard:** Contract removed after completion
- [ ] **Works with CampScene:** Thorne scene loads with correct dialogue
- [ ] **Doesn't break other contracts:** Other contracts remain selectable

### Polish Tests

- [ ] Tutorial popups animate smoothly (fade in/out)
- [ ] Wagon damage triggers warning sound
- [ ] Victory fanfare plays on completion
- [ ] Screen doesn't jitter during tutorials
- [ ] Performance acceptable (60 FPS) with all units on screen
- [ ] All text is readable and fits within UI bounds

---

## Implementation Notes

*(For AI assistant or future developer)*

- **Tutorial System Reuse:** The tutorial system built here should be generic enough to add tutorials to future content. Use a data-driven approach with JSON configuration rather than hardcoding triggers.

- **Wagon as Special Unit:** The wagon extends the base Unit class but overrides `can_move()` and `can_attack()` to return false. Consider using a flag `is_objective` rather than a separate script if behavior is simple.

- **Bandit Aggro Priority:** The GDD specifies bandits prioritize the wagon. Implement this in enemy AI as: `if wagon exists and not threatened, target wagon; else target nearest party/soldier`. This makes the tutorial feel urgent without being unfair.

- **Tutorial Replay:** Some players may want to see tutorials again. Consider a "Reset Tutorials" option in settings, or allow tutorials to replay if player hasn't completed the contract yet.

- **Difficulty Tuning:** The tutorial should be easy. If playtesters report difficulty, consider: reducing bandit count to 4, increasing wagon HP to 60, or giving soldiers more HP. Do NOT increase player damage as that would make later contracts too easy.

- **Camp Scene Trigger:** The transition to Thorne's camp scene should happen automatically after the victory panel closes. Store a flag `awaiting_camp_scene = "thorne_camp_1"` in GameManager and check on hub load.

- **Alternative Approach Considered:** Originally considered making wagon movement (escort it to destination) part of the objective. Rejected because it adds complexity to the tutorial and doesn't teach combat mechanics effectively. "Kill all enemies" is clearer for a first mission.

---
