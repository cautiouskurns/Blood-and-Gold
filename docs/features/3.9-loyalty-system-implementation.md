# Loyalty System Implementation

**Feature ID:** 3.9
**Status:** üî¥ Planned
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 2-3 hours
**Dependencies:** Task 3.1 (Hub Scene Structure), Task 3.5 (Border Dispute - Loyalty stub exists)
**Assigned To:** AI Assistant

---

## Purpose

### Why does this feature exist?
The Loyalty System creates emotional investment in companion characters by tracking their approval of player decisions and rewarding sustained positive relationships with combat bonuses. This directly supports the "Meaningful Choice" and "Character Progression" design pillars by making companion opinions matter mechanically, not just narratively.

### What does it enable?
- Companions react to player choices with visible loyalty changes
- High loyalty unlocks powerful combat stat bonuses (+10% to +20%)
- Low loyalty penalizes combat performance (-10%) and risks companion departure
- Players have a tangible reason to consider companion values when making decisions
- Creates a secondary progression system beyond equipment and gold

### Success Criteria
- Loyalty is tracked per companion (0-100 scale)
- Loyalty changes from choice contracts reflect immediately
- Loyalty thresholds visibly affect companion status text and color
- Stat modifiers apply in combat based on loyalty tier
- Loyalty is visible in the character sheet UI
- Players understand which choices affect which companions

---

## How It Works

### Overview
The Loyalty System tracks a 0-100 loyalty value for each of the three companions (Thorne, Lyra, Matthias). Loyalty starts at 50 (Neutral) and changes based on player decisions during contracts and camp scenes. Each companion has defined values that affect their approval:

- **Thorne Blackwood:** Respects honor in combat (+), disapproves of assassination and dishonorable tactics (-)
- **Lyra Swiftblade:** Values protecting the team (+), disapproves of betrayal (-)
- **Brother Matthias:** Prioritizes protecting innocents (+), strongly opposes cruelty (-)

When loyalty crosses certain thresholds, the companion's status changes and combat modifiers apply. At extremely low loyalty (below 10), companions may leave the party permanently.

The system provides immediate feedback via the existing LoyaltyPopup UI and tracks changes in the LoyaltyManager autoload. Combat modifiers are applied dynamically when units spawn or at the start of combat.

### User Flow
```
1. Player makes a choice during contract (e.g., Border Dispute Option A)
2. System calculates loyalty changes for each affected companion
3. LoyaltyPopup displays each change in sequence
4. GameState or LoyaltyManager stores new values
5. Player can view current loyalty in character sheet
6. In next combat, stat modifiers apply based on loyalty tier
7. If loyalty drops too low, warning message appears
8. At loyalty < 10, companion leaves permanently
```

### Rules & Constraints

**Loyalty Scale:**
- Range: 0-100 (integer)
- Starting value: 50 (Neutral)
- Minimum: 0 (cannot go negative)
- Maximum: 100 (cannot exceed)

**Loyalty Thresholds:**

| Score | Status | Combat Modifier | Special Effect |
|-------|--------|-----------------|----------------|
| 0-9 | Hostile | -20% all stats | May leave permanently |
| 10-29 | Disloyal | -10% all stats | Warning about leaving |
| 30-49 | Neutral | No modifier | Normal behavior |
| 50-69 | Loyal | No modifier | Normal behavior |
| 70-89 | Devoted | +10% all stats | Unlocks special dialogue |
| 90-100 | Bonded | +20% all stats | Unlocks ultimate ability |

**Stat Modifiers Apply To:**
- HP (max health)
- Attack damage
- Defense value
- Movement (rounded down, minimum 1)

**Loyalty Change Sources:**
- Choice contract decisions: +/-5 to +/-20
- Camp scene dialogue choices: +/-2 to +/-5
- Companion personal quests: +20 on completion (future)
- Protecting/abandoning companions in combat: +/-5 (future)

### Edge Cases
- **Loyalty at 0:** Companion leaves permanently after current scene
- **Loyalty at 100:** Cannot increase further, still shows "+X" feedback
- **Multiple companions affected:** Changes shown sequentially in popup
- **Combat modifier rounding:** Round stat modifications to nearest integer
- **Negative HP from modifier:** Floor at 1 HP minimum
- **Save/Load:** Loyalty persists across sessions

---

## User Interaction

### Controls
- **Character Sheet:** Click companion portrait or name to view details including loyalty
- **Loyalty Popup:** Auto-dismisses after 2.5 seconds, or click to advance
- **Camp Scenes:** Dialogue choices show companion reaction indicators

### Visual Feedback
- **Loyalty Change:** LoyaltyPopup slides in showing companion name, delta, and quote
- **Threshold Crossed:** Special notification when entering new status tier
- **Character Sheet:** Loyalty bar fills based on current value with tier color
- **Combat:** Affected stats displayed with modifier notation (e.g., "HP: 35 (+4)")

### Audio Feedback
- **Loyalty Increase:** Pleasant chime, rising tone
- **Loyalty Decrease:** Discordant tone, falling note
- **Threshold Up:** Triumphant fanfare (brief)
- **Threshold Down:** Ominous low tone
- **Companion Leaving:** Dramatic departure sound

---

## Visual Design

### Character Sheet Loyalty Display
```
+--------------------------------------------------+
|  THORNE BLACKWOOD                    [Portrait]  |
+--------------------------------------------------+
|                                                  |
|  LOYALTY: [======----] 65/100                   |
|  Status: LOYAL                                   |
|  Combat Modifier: None                           |
|                                                  |
|  Values:                                         |
|  + Honor in combat                               |
|  - Assassination, dishonorable tactics           |
|                                                  |
|  Current Opinion:                                |
|  "You lead well, Captain."                       |
|                                                  |
+--------------------------------------------------+
```

### Loyalty Bar Colors
| Status | Bar Color | Text Color |
|--------|-----------|------------|
| Hostile | Dark Red (#8B0000) | Red |
| Disloyal | Red (#e74c3c) | Orange |
| Neutral | Yellow (#f1c40f) | Yellow |
| Loyal | Light Green (#2ecc71) | Green |
| Devoted | Green (#27ae60) | Cyan |
| Bonded | Blue (#3498db) | Gold |

### Loyalty Popup (existing from Task 3.5)
```
+------------------------+
| [Portrait] MATTHIAS    |
|                        |
| Status: Neutral (50)   |
| +10 LOYALTY            |
|                        |
| "Now that's the        |
|  captain I follow!"    |
+------------------------+
```

---

## Technical Implementation

### Scene Structure

No new scenes required. Existing components:
- `scenes/ui/LoyaltyPopup.tscn` (from Task 3.5)

New UI to add to character sheet:
```
CharacterSheet (existing)
‚îî‚îÄ‚îÄ LoyaltySection (VBoxContainer)
    ‚îú‚îÄ‚îÄ LoyaltyHeader (Label) - "LOYALTY"
    ‚îú‚îÄ‚îÄ LoyaltyBar (ProgressBar)
    ‚îú‚îÄ‚îÄ LoyaltyStatus (Label) - "Status: LOYAL"
    ‚îú‚îÄ‚îÄ ModifierLabel (Label) - "Combat Modifier: None"
    ‚îî‚îÄ‚îÄ ValuesContainer (VBoxContainer)
        ‚îú‚îÄ‚îÄ LikesLabel (Label) - "+ Honor in combat"
        ‚îî‚îÄ‚îÄ DislikesLabel (Label) - "- Assassination"
```

### Script Responsibilities

#### loyalty_manager.gd (Update existing)

Refactor existing stub to use 0-100 scale and implement stat modifiers.

```gdscript
## LoyaltyManager - Tracks companion loyalty and provides stat modifiers
## Part of: Blood & Gold Prototype
## Task 3.9: Loyalty System Implementation
extends Node

# ===== SIGNALS =====
signal loyalty_changed(companion_id: String, new_value: int, delta: int)
signal threshold_crossed(companion_id: String, new_status: String)
signal companion_leaving(companion_id: String)
signal companion_left(companion_id: String)

# ===== CONSTANTS =====
const DEFAULT_LOYALTY: int = 50
const MIN_LOYALTY: int = 0
const MAX_LOYALTY: int = 100
const LEAVE_THRESHOLD: int = 10
const LEAVE_IMMEDIATE_THRESHOLD: int = 0

# Threshold boundaries (lower bound inclusive)
const THRESHOLDS := {
    "hostile": 0,
    "disloyal": 10,
    "neutral": 30,
    "loyal": 50,
    "devoted": 70,
    "bonded": 90
}

# Stat multipliers per status
const STAT_MODIFIERS := {
    "hostile": -0.20,
    "disloyal": -0.10,
    "neutral": 0.0,
    "loyal": 0.0,
    "devoted": 0.10,
    "bonded": 0.20
}

# Companion value descriptions
const COMPANION_VALUES := {
    "thorne": {
        "likes": ["Honor in combat", "Protecting allies"],
        "dislikes": ["Assassination", "Dishonorable tactics"]
    },
    "lyra": {
        "likes": ["Protecting the team", "Clever tactics"],
        "dislikes": ["Betrayal", "Abandoning allies"]
    },
    "matthias": {
        "likes": ["Protecting innocents", "Mercy"],
        "dislikes": ["Cruelty", "Harming civilians"]
    }
}

# ===== COMPANION DATA =====
var _loyalty: Dictionary = {
    "thorne": DEFAULT_LOYALTY,
    "lyra": DEFAULT_LOYALTY,
    "matthias": DEFAULT_LOYALTY,
}

var _companions_left: Array[String] = []

# ===== PUBLIC API =====
func get_loyalty(companion_id: String) -> int:
    ## Get current loyalty value (0-100)
    return _loyalty.get(companion_id.to_lower(), DEFAULT_LOYALTY)

func modify_loyalty(companion_id: String, delta: int) -> void:
    ## Modify loyalty by a delta amount
    var id := companion_id.to_lower()
    if id in _companions_left:
        return  # Companion has left

    var old_value := _loyalty.get(id, DEFAULT_LOYALTY)
    var new_value := clampi(old_value + delta, MIN_LOYALTY, MAX_LOYALTY)
    _loyalty[id] = new_value

    loyalty_changed.emit(id, new_value, delta)
    _check_threshold_change(id, old_value, new_value)
    _check_departure(id, new_value)

func get_status(companion_id: String) -> String:
    ## Get status text based on loyalty
    var loyalty := get_loyalty(companion_id)
    if loyalty >= THRESHOLDS.bonded:
        return "Bonded"
    elif loyalty >= THRESHOLDS.devoted:
        return "Devoted"
    elif loyalty >= THRESHOLDS.loyal:
        return "Loyal"
    elif loyalty >= THRESHOLDS.neutral:
        return "Neutral"
    elif loyalty >= THRESHOLDS.disloyal:
        return "Disloyal"
    else:
        return "Hostile"

func get_stat_modifier(companion_id: String) -> float:
    ## Get the stat multiplier for combat
    var status := get_status(companion_id).to_lower()
    return STAT_MODIFIERS.get(status, 0.0)

func apply_stat_modifier(companion_id: String, base_stat: int) -> int:
    ## Apply loyalty modifier to a stat value
    var modifier := get_stat_modifier(companion_id)
    var modified := int(base_stat * (1.0 + modifier))
    return maxi(modified, 1)  # Minimum 1

func get_loyalty_color(companion_id: String) -> Color:
    ## Get color for loyalty display
    var status := get_status(companion_id).to_lower()
    match status:
        "hostile": return Color("#8B0000")
        "disloyal": return Color("#e74c3c")
        "neutral": return Color("#f1c40f")
        "loyal": return Color("#2ecc71")
        "devoted": return Color("#27ae60")
        "bonded": return Color("#3498db")
    return Color.WHITE

func get_companion_values(companion_id: String) -> Dictionary:
    ## Get likes/dislikes for a companion
    return COMPANION_VALUES.get(companion_id.to_lower(), {"likes": [], "dislikes": []})

func has_companion_left(companion_id: String) -> bool:
    ## Check if companion has left the party
    return companion_id.to_lower() in _companions_left

# ===== INTERNAL METHODS =====
func _check_threshold_change(companion_id: String, old_value: int, new_value: int) -> void:
    var old_status := _get_status_from_value(old_value)
    var new_status := _get_status_from_value(new_value)
    if old_status != new_status:
        threshold_crossed.emit(companion_id, new_status)

func _get_status_from_value(value: int) -> String:
    if value >= THRESHOLDS.bonded:
        return "bonded"
    elif value >= THRESHOLDS.devoted:
        return "devoted"
    elif value >= THRESHOLDS.loyal:
        return "loyal"
    elif value >= THRESHOLDS.neutral:
        return "neutral"
    elif value >= THRESHOLDS.disloyal:
        return "disloyal"
    else:
        return "hostile"

func _check_departure(companion_id: String, loyalty: int) -> void:
    if loyalty < LEAVE_THRESHOLD and loyalty > LEAVE_IMMEDIATE_THRESHOLD:
        companion_leaving.emit(companion_id)
    elif loyalty <= LEAVE_IMMEDIATE_THRESHOLD:
        _companions_left.append(companion_id)
        companion_left.emit(companion_id)

# ===== SAVE/LOAD =====
func get_save_data() -> Dictionary:
    return {
        "loyalty": _loyalty.duplicate(),
        "companions_left": _companions_left.duplicate()
    }

func load_save_data(data: Dictionary) -> void:
    _loyalty.clear()
    for key in data.get("loyalty", {}).keys():
        _loyalty[key] = data.loyalty[key]
    _companions_left.clear()
    for id in data.get("companions_left", []):
        _companions_left.append(id)

func reset_to_default() -> void:
    _loyalty = {
        "thorne": DEFAULT_LOYALTY,
        "lyra": DEFAULT_LOYALTY,
        "matthias": DEFAULT_LOYALTY,
    }
    _companions_left.clear()
```

### Integration Points

| System | Integration |
|--------|-------------|
| **Combat** | Apply stat modifiers to companion units at spawn |
| **Choice Contracts** | Call `modify_loyalty()` when choices are made |
| **Camp Scenes** | Call `modify_loyalty()` based on dialogue choices |
| **Character Sheet** | Display loyalty bar, status, and values |
| **LoyaltyPopup** | Display changes via existing UI component |
| **Party Management** | Check `has_companion_left()` before including in party |
| **Save/Load** | Persist loyalty values and departed companions |

### Combat Stat Modifier Integration

In combat unit spawning or stat initialization:

```gdscript
# When spawning a companion unit
func _apply_loyalty_modifiers(unit: Unit, companion_id: String) -> void:
    var modifier := LoyaltyManager.get_stat_modifier(companion_id)
    if modifier == 0.0:
        return

    # Apply to base stats
    unit.max_hp = LoyaltyManager.apply_stat_modifier(companion_id, unit.base_max_hp)
    unit.current_hp = unit.max_hp
    unit.attack_bonus += int(unit.base_attack * modifier)
    unit.defense += int(unit.base_defense * modifier)

    # Show modifier indicator
    if modifier > 0:
        unit.show_buff_indicator("Devoted: +%d%%" % int(modifier * 100))
    else:
        unit.show_debuff_indicator("Disloyal: %d%%" % int(modifier * 100))
```

### Character Sheet Integration

```gdscript
# In character_sheet.gd
func _update_loyalty_display(companion_id: String) -> void:
    var loyalty := LoyaltyManager.get_loyalty(companion_id)
    var status := LoyaltyManager.get_status(companion_id)
    var modifier := LoyaltyManager.get_stat_modifier(companion_id)
    var color := LoyaltyManager.get_loyalty_color(companion_id)
    var values := LoyaltyManager.get_companion_values(companion_id)

    loyalty_bar.max_value = 100
    loyalty_bar.value = loyalty
    loyalty_bar.modulate = color

    status_label.text = "Status: %s" % status

    if modifier > 0:
        modifier_label.text = "Combat Modifier: +%d%% all stats" % int(modifier * 100)
        modifier_label.modulate = Color.GREEN
    elif modifier < 0:
        modifier_label.text = "Combat Modifier: %d%% all stats" % int(modifier * 100)
        modifier_label.modulate = Color.RED
    else:
        modifier_label.text = "Combat Modifier: None"
        modifier_label.modulate = Color.WHITE

    # Show values
    for like in values.likes:
        _add_value_label("+ " + like, Color.GREEN)
    for dislike in values.dislikes:
        _add_value_label("- " + dislike, Color.RED)
```

### Signals
- `loyalty_changed(companion_id: String, new_value: int, delta: int)` - On any loyalty change
- `threshold_crossed(companion_id: String, new_status: String)` - When entering new tier
- `companion_leaving(companion_id: String)` - Warning when loyalty < 10
- `companion_left(companion_id: String)` - Companion permanently departed

---

## Acceptance Criteria

- [ ] Loyalty tracked per companion using 0-100 scale
- [ ] Starting loyalty is 50 (Neutral) for all companions
- [ ] Loyalty changes from choice contracts apply correctly
- [ ] LoyaltyPopup displays changes with companion quote
- [ ] Six loyalty tiers implemented: Hostile, Disloyal, Neutral, Loyal, Devoted, Bonded
- [ ] Stat modifiers apply in combat: -20%, -10%, 0%, 0%, +10%, +20%
- [ ] Character sheet shows loyalty bar, status, and combat modifier
- [ ] Character sheet shows companion likes/dislikes
- [ ] Threshold crossing triggers notification
- [ ] Loyalty < 10 triggers warning about companion leaving
- [ ] Loyalty = 0 causes companion to leave permanently
- [ ] Departed companions excluded from party
- [ ] Loyalty persists through save/load

---

## Testing Checklist

### Functional Tests
- [ ] `LoyaltyManager.get_loyalty()` returns correct value
- [ ] `LoyaltyManager.modify_loyalty()` changes value correctly
- [ ] `LoyaltyManager.get_status()` returns correct tier name
- [ ] `LoyaltyManager.get_stat_modifier()` returns correct multiplier
- [ ] `LoyaltyManager.apply_stat_modifier()` calculates correctly
- [ ] Loyalty cannot go below 0 or above 100
- [ ] `loyalty_changed` signal fires with correct parameters

### Threshold Tests
- [ ] Loyalty 0-9 = Hostile, -20% stats
- [ ] Loyalty 10-29 = Disloyal, -10% stats
- [ ] Loyalty 30-49 = Neutral, 0% stats
- [ ] Loyalty 50-69 = Loyal, 0% stats
- [ ] Loyalty 70-89 = Devoted, +10% stats
- [ ] Loyalty 90-100 = Bonded, +20% stats
- [ ] `threshold_crossed` signal fires when entering new tier

### Edge Case Tests
- [ ] Loyalty at 0 triggers companion departure
- [ ] Loyalty at 100 caps correctly, shows change feedback
- [ ] Stat modifier minimum is 1 (no 0 or negative HP)
- [ ] Departed companions cannot have loyalty modified
- [ ] Multiple simultaneous loyalty changes handled correctly

### Integration Tests
- [ ] Choice contracts modify loyalty correctly
- [ ] LoyaltyPopup displays changes (existing functionality)
- [ ] Combat units receive stat modifiers
- [ ] Character sheet displays loyalty section
- [ ] Save/load preserves loyalty values
- [ ] Save/load preserves departed companions list

### Polish Tests
- [ ] Loyalty bar color matches status tier
- [ ] Status text updates immediately on change
- [ ] Modifier display shows +/- signs correctly
- [ ] Companion values display correctly

---

## Implementation Notes

### Approach
- Refactor existing `loyalty_manager.gd` stub from Task 3.5
- Change from -100 to +100 scale to 0-100 scale per GDD
- Add stat modifier calculation functions
- Add companion departure tracking
- Update character sheet UI to include loyalty section

### Gotchas
- Existing Border Dispute uses `modify_loyalty()` - ensure API compatibility
- Existing LoyaltyPopup expects specific signal parameters
- Combat system needs to call stat modifier at spawn time
- Departed companions should be removed from all party lists
- Round stat modifiers to integers, minimum value 1

### Migration from Stub
The existing `loyalty_manager.gd` uses a -100 to +100 scale with different thresholds. This needs refactoring:
- Change MIN_LOYALTY from -100 to 0
- Change MAX_LOYALTY from 100 to 100 (same)
- Update DEFAULT_LOYALTY from 50 to 50 (same)
- Replace threshold constants with new tier boundaries
- Add STAT_MODIFIERS constant
- Add companion values constant
- Add departure tracking

### Future Enhancements (Out of Scope)
- Camp scene dialogue affecting loyalty
- Loyalty-based combat abilities unlock
- Companion personal quests
- Inter-companion relationships
- Loyalty decay over time
- Special events at max loyalty

---

## Files

**Modified Files:**
- `scripts/autoload/loyalty_manager.gd` - Complete refactor to full implementation
- Character sheet scene/script (location TBD) - Add loyalty display section

**Existing Files Used:**
- `scenes/ui/LoyaltyPopup.tscn` - Displays loyalty changes (from Task 3.5)
- `scripts/ui/loyalty_popup.gd` - Popup controller (from Task 3.5)

**No New Files Required** - This task primarily refactors and extends existing systems.
