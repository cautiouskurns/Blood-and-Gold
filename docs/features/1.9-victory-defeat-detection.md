# Feature Spec: Victory/Defeat Detection

| Property | Value |
|----------|-------|
| **Feature ID** | 1.9 |
| **Status** | üî¥ Planned |
| **Priority** | üî• Critical |
| **Estimated Time** | 1 hour |
| **Phase** | Phase 1: Combat Visuals & Basic Interaction |
| **Dependencies** | Task 1.7 (Basic Melee Attack - units can die), Task 1.8 (Turn System Framework) |

---

## 1. Purpose

### Why This Feature Exists

Combat needs a clear ending. Without victory/defeat detection, battles would continue indefinitely even after one side is eliminated. This feature provides closure to each combat encounter by detecting when all enemies are defeated (victory) or when all party members are incapacitated (defeat). It directly supports the **Tactical Combat** design pillar by giving meaning to the combat choices players make - success or failure has observable consequences.

### What It Enables

- Automatic detection when combat should end (no more valid targets)
- Clear visual feedback on battle outcome via popup UI
- Victory rewards (gold) to feed into the economy loop
- Defeat handling with retry option for continued testing
- Foundation for the contract system (Phase 3) where battles have objectives
- Smooth transition out of combat state back to normal game flow
- Statistics tracking for end-game summary (Phase 4)

### Success Criteria

| Criterion | Measurement |
|-----------|-------------|
| Victory detected | Battle ends immediately when last enemy dies |
| Defeat detected | Battle ends immediately when last party member dies |
| Visual feedback | Appropriate popup displayed for outcome |
| Gold reward | Victory grants placeholder gold amount |
| Restart option | Can restart battle after defeat (testing feature) |
| Turn system integration | Turn system stops processing when battle ends |

---

## 2. Design Pillar Alignment

| Pillar | How This Feature Supports It |
|--------|------------------------------|
| **Tactical Combat** | Victory/defeat gives weight to tactical decisions. Poor positioning leads to defeat; clever tactics lead to victory. Without stakes, combat has no meaning. |
| **Build & Command** | Victory rewards fuel company growth (gold for soldiers, upgrades). Defeat teaches players to command better. The mercenary fantasy requires clear battle outcomes. |
| **Meaningful Choice** | Every choice in combat contributes to victory or defeat. Seeing "Battle Won!" after a tough fight validates player decisions. Defeat prompts reflection on what went wrong. |

---

## 3. How It Works

### Overview

The Victory/Defeat Detection system monitors unit deaths and checks win/lose conditions after each death event. When a unit dies, the system counts remaining units on each side. If all enemies are dead, victory is triggered. If all party members are dead, defeat is triggered.

Upon triggering an outcome:
1. The Turn System stops (no more turns processed)
2. Combat state transitions to an "ended" state
3. A popup displays the outcome with appropriate message and options
4. For victory: Gold reward is granted (visible in popup)
5. For defeat: Retry button allows restarting the battle

The check happens in TurnManager after a unit is removed from the turn order. This ensures proper sequencing - the death animation plays, the unit is removed, then the battle end check runs.

### User Flow

```
VICTORY FLOW:
1. Player attacks enemy
2. Enemy HP reaches 0
3. Death animation plays, unit removed from turn order
4. TurnManager.remove_unit() triggers battle end check
5. Count remaining enemies: 0
6. Victory condition met!
7. Turn system stops (is_battle_active = false)
8. CombatManager emits battle_ended(victory=true)
9. BattleResultPopup appears:
   - "VICTORY!"
   - "Battle Won!"
   - "Gold Earned: 100g"
   - [Continue] button
10. Player clicks Continue
11. Popup closes, game continues (or hub loads in Phase 3)

DEFEAT FLOW:
1. Enemy attacks party member
2. Party member HP reaches 0
3. Death animation plays, unit removed from turn order
4. TurnManager.remove_unit() triggers battle end check
5. Count remaining party members: 0
6. Defeat condition met!
7. Turn system stops
8. CombatManager emits battle_ended(victory=false)
9. BattleResultPopup appears:
   - "DEFEAT"
   - "Party Defeated"
   - [Retry] button
10. Player clicks Retry
11. Battle restarts from beginning (same units, positions reset)
```

### Rules & Constraints

| Rule | Description |
|------|-------------|
| All enemies must die | Victory requires zero living enemy units |
| All party must die | Defeat requires zero living party members |
| Soldiers don't count | Losing all soldiers is NOT defeat (party must survive) |
| Check after death | Win/lose check runs after each unit death |
| Immediate transition | No additional turns after condition met |
| Gold on victory only | No gold reward on defeat |
| Retry resets state | Retry restores all units to starting HP/positions |

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Mutual kill (both die same turn) | Check party first - if party dead, defeat; otherwise check enemies |
| Last enemy dies on player turn | Victory triggers before turn advances |
| Last party member dies on enemy turn | Defeat triggers before next enemy acts |
| Only soldiers remain (party dead) | Defeat - soldiers alone cannot win |
| All soldiers dead, party alive | Battle continues - not defeat |
| Single unit vs single unit | Normal rules apply |
| Unit dies from damage-over-time (future) | Same check triggers when HP reaches 0 |

---

## 4. User Interaction

### Controls

| Input | Action | Context |
|-------|--------|---------|
| Click [Continue] | Close victory popup, end battle | Victory popup visible |
| Click [Retry] | Restart battle from beginning | Defeat popup visible |
| ESC (optional) | Same as Continue/Retry | Popup visible |

### Visual Feedback

| Event | Visual |
|-------|--------|
| Last enemy dies | Normal death animation, then popup fades in |
| Last party member dies | Normal death animation, then popup fades in |
| Victory popup | Green/gold themed, celebratory |
| Defeat popup | Red/dark themed, somber |
| Gold reward | Number prominently displayed in victory popup |
| Button hover | Standard UI hover effect |

### Audio Feedback (Future)

| Event | Sound |
|-------|-------|
| Victory triggered | Triumphant fanfare/sting |
| Defeat triggered | Somber/failure sound |
| Button click | UI click sound |

*Note: Audio is out of scope for prototype but noted for future.*

---

## 5. Visual Design

### BattleResultPopup Layout

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                         ‚îÇ
‚îÇ           [OUTCOME TITLE]               ‚îÇ  <- "VICTORY!" or "DEFEAT"
‚îÇ                                         ‚îÇ
‚îÇ           [Outcome Message]             ‚îÇ  <- "Battle Won!" or "Party Defeated"
‚îÇ                                         ‚îÇ
‚îÇ           [Gold Display]                ‚îÇ  <- Victory only: "Gold Earned: 100g"
‚îÇ                                         ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ            ‚îÇ  BUTTON  ‚îÇ                 ‚îÇ  <- [Continue] or [Retry]
‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Visual Components

| Component | Purpose | Style |
|-----------|---------|-------|
| Overlay | Dim background to focus on popup | Black, 50% opacity |
| Popup Panel | Container for result content | Rounded corners, solid background |
| Title Label | Display outcome (VICTORY/DEFEAT) | Large, bold font |
| Message Label | Descriptive text | Medium font |
| Gold Label | Show reward amount (victory only) | Gold color (#f1c40f) |
| Action Button | Continue or Retry | Standard button style |

### Color Scheme

| Element | Victory | Defeat |
|---------|---------|--------|
| Title text | Gold (#f1c40f) | Dark red (#c0392b) |
| Panel background | Dark blue (#1a1a2e) | Dark red tint (#2e1a1a) |
| Panel border | Gold (#f1c40f) | Red (#c0392b) |
| Button | Green (#27ae60) | Red (#e74c3c) |
| Message text | White (#ffffff) | Light gray (#cccccc) |

### States

| State | Appearance |
|-------|------------|
| Popup appearing | Fade in over 0.3 seconds |
| Popup visible | Fully opaque, button interactive |
| Button hover | Slight brightness increase |
| Button pressed | Slight scale down |
| Popup closing | Fade out over 0.2 seconds |

---

## 6. Technical Implementation

### Scene Structure

**scenes/UI/BattleResultPopup.tscn:**
```
BattleResultPopup (CanvasLayer)
‚îú‚îÄ‚îÄ Overlay (ColorRect)
‚îÇ   ‚îî‚îÄ‚îÄ [Mouse filter: Stop - blocks clicks behind]
‚îú‚îÄ‚îÄ CenterContainer
‚îÇ   ‚îî‚îÄ‚îÄ Panel (PanelContainer)
‚îÇ       ‚îî‚îÄ‚îÄ VBoxContainer
‚îÇ           ‚îú‚îÄ‚îÄ TitleLabel (Label) - "VICTORY!" or "DEFEAT"
‚îÇ           ‚îú‚îÄ‚îÄ MessageLabel (Label) - "Battle Won!" etc.
‚îÇ           ‚îú‚îÄ‚îÄ GoldContainer (HBoxContainer) - Victory only
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ GoldIcon (TextureRect)
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ GoldLabel (Label) - "100g"
‚îÇ           ‚îî‚îÄ‚îÄ ActionButton (Button) - "Continue" or "Retry"
```

### Script Responsibilities

**scripts/UI/battle_result_popup.gd (NEW):**
- Display victory or defeat result
- Show gold reward for victory
- Handle button click (emit signal)
- Animate popup appearance/disappearance
- Provide `show_victory(gold_earned)` and `show_defeat()` methods

**scripts/combat/turn_manager.gd (MODIFY):**
- Add `check_battle_end()` method called after unit removal
- Count living units per faction
- Emit `battle_ended(victory: bool)` signal when condition met
- Stop turn processing when battle ends

**scripts/autoload/combat_manager.gd (MODIFY):**
- Listen for `battle_ended` signal
- Set state to BATTLE_ENDED
- Coordinate with UI to show popup
- Handle retry by calling battle reset

**scripts/main/main.gd (MODIFY):**
- Instance and manage BattleResultPopup
- Connect to popup signals for continue/retry
- Implement `restart_battle()` for retry functionality

### Detailed Script: battle_result_popup.gd

```gdscript
## BattleResultPopup - Displays victory/defeat outcome
## Part of: Blood & Gold Prototype
## Spec: docs/features/1.9-victory-defeat-detection.md
class_name BattleResultPopup
extends CanvasLayer

# ===== SIGNALS =====
signal continue_pressed()
signal retry_pressed()

# ===== CONSTANTS =====
const FADE_IN_DURATION: float = 0.3
const FADE_OUT_DURATION: float = 0.2

# Victory colors
const COLOR_VICTORY_TITLE: Color = Color("#f1c40f")
const COLOR_VICTORY_PANEL: Color = Color("#1a1a2e")
const COLOR_VICTORY_BORDER: Color = Color("#f1c40f")
const COLOR_VICTORY_BUTTON: Color = Color("#27ae60")

# Defeat colors
const COLOR_DEFEAT_TITLE: Color = Color("#c0392b")
const COLOR_DEFEAT_PANEL: Color = Color("#2e1a1a")
const COLOR_DEFEAT_BORDER: Color = Color("#c0392b")
const COLOR_DEFEAT_BUTTON: Color = Color("#e74c3c")

# ===== NODE REFERENCES =====
@onready var overlay: ColorRect = $Overlay
@onready var panel: PanelContainer = $CenterContainer/Panel
@onready var title_label: Label = $CenterContainer/Panel/VBoxContainer/TitleLabel
@onready var message_label: Label = $CenterContainer/Panel/VBoxContainer/MessageLabel
@onready var gold_container: HBoxContainer = $CenterContainer/Panel/VBoxContainer/GoldContainer
@onready var gold_label: Label = $CenterContainer/Panel/VBoxContainer/GoldContainer/GoldLabel
@onready var action_button: Button = $CenterContainer/Panel/VBoxContainer/ActionButton

# ===== LIFECYCLE =====
func _ready() -> void:
	visible = false
	action_button.pressed.connect(_on_action_button_pressed)

# ===== PUBLIC API =====
func show_victory(gold_earned: int) -> void:
	## Display victory result with gold reward
	_setup_victory_visuals()
	title_label.text = "VICTORY!"
	message_label.text = "Battle Won!"
	gold_container.visible = true
	gold_label.text = "%dg" % gold_earned
	action_button.text = "Continue"
	_show_popup()
	print("[BattleResultPopup] Showing victory - %dg earned" % gold_earned)

func show_defeat() -> void:
	## Display defeat result with retry option
	_setup_defeat_visuals()
	title_label.text = "DEFEAT"
	message_label.text = "Party Defeated"
	gold_container.visible = false
	action_button.text = "Retry"
	_show_popup()
	print("[BattleResultPopup] Showing defeat")

func hide_popup() -> void:
	## Hide the popup with animation
	var tween = create_tween()
	tween.tween_property(self, "modulate:a", 0.0, FADE_OUT_DURATION)
	tween.tween_callback(func(): visible = false)

# ===== INTERNAL METHODS =====
func _show_popup() -> void:
	## Animate popup appearing
	modulate.a = 0.0
	visible = true
	var tween = create_tween()
	tween.tween_property(self, "modulate:a", 1.0, FADE_IN_DURATION)

func _setup_victory_visuals() -> void:
	## Configure colors for victory
	title_label.add_theme_color_override("font_color", COLOR_VICTORY_TITLE)
	_set_panel_style(COLOR_VICTORY_PANEL, COLOR_VICTORY_BORDER)
	_set_button_style(COLOR_VICTORY_BUTTON)

func _setup_defeat_visuals() -> void:
	## Configure colors for defeat
	title_label.add_theme_color_override("font_color", COLOR_DEFEAT_TITLE)
	_set_panel_style(COLOR_DEFEAT_PANEL, COLOR_DEFEAT_BORDER)
	_set_button_style(COLOR_DEFEAT_BUTTON)

func _set_panel_style(bg_color: Color, border_color: Color) -> void:
	var style = StyleBoxFlat.new()
	style.bg_color = bg_color
	style.border_color = border_color
	style.border_width_left = 2
	style.border_width_right = 2
	style.border_width_top = 2
	style.border_width_bottom = 2
	style.corner_radius_top_left = 8
	style.corner_radius_top_right = 8
	style.corner_radius_bottom_left = 8
	style.corner_radius_bottom_right = 8
	style.content_margin_left = 40
	style.content_margin_right = 40
	style.content_margin_top = 30
	style.content_margin_bottom = 30
	panel.add_theme_stylebox_override("panel", style)

func _set_button_style(color: Color) -> void:
	var style = StyleBoxFlat.new()
	style.bg_color = color
	style.corner_radius_top_left = 4
	style.corner_radius_top_right = 4
	style.corner_radius_bottom_left = 4
	style.corner_radius_bottom_right = 4
	style.content_margin_left = 20
	style.content_margin_right = 20
	style.content_margin_top = 10
	style.content_margin_bottom = 10
	action_button.add_theme_stylebox_override("normal", style)

	var hover_style = style.duplicate()
	hover_style.bg_color = color.lightened(0.1)
	action_button.add_theme_stylebox_override("hover", hover_style)

	var pressed_style = style.duplicate()
	pressed_style.bg_color = color.darkened(0.1)
	action_button.add_theme_stylebox_override("pressed", pressed_style)

# ===== SIGNAL HANDLERS =====
func _on_action_button_pressed() -> void:
	## Handle action button click
	if action_button.text == "Continue":
		continue_pressed.emit()
	else:
		retry_pressed.emit()
	hide_popup()

func _unhandled_input(event: InputEvent) -> void:
	## Allow ESC to dismiss popup
	if visible and event.is_action_pressed("ui_cancel"):
		_on_action_button_pressed()
		get_viewport().set_input_as_handled()
```

### TurnManager Battle End Check Addition

```gdscript
## Add to scripts/combat/turn_manager.gd

# ===== SIGNALS =====
signal battle_won(gold_earned: int)
signal battle_lost()

# ===== CONSTANTS =====
const VICTORY_GOLD_REWARD: int = 100

# ===== MODIFIED: remove_unit =====
func remove_unit(unit: Unit) -> void:
	## Remove a unit from turn order (death)
	var index = _turn_order.find(unit)
	if index == -1:
		return

	_turn_order.remove_at(index)
	print("[TurnManager] Removed from turn order: %s" % unit.unit_name)

	# Check for battle end before adjusting turn index
	if _check_battle_end():
		return  # Battle ended, don't continue turn processing

	# Adjust current index if needed
	if index < _current_turn_index:
		_current_turn_index -= 1
	elif index == _current_turn_index:
		_current_turn_index = mini(_current_turn_index, _turn_order.size() - 1)
		if _is_battle_active and not _turn_order.is_empty():
			_start_current_turn()

# ===== NEW: check_battle_end =====
func _check_battle_end() -> bool:
	## Check if victory or defeat conditions are met
	## Returns true if battle ended
	if not _is_battle_active:
		return false

	var party_alive = _count_living_party()
	var enemies_alive = _count_living_enemies()

	print("[TurnManager] Battle check - Party: %d, Enemies: %d" % [party_alive, enemies_alive])

	# Check defeat first (if party is wiped, defeat even if enemies also died)
	if party_alive == 0:
		_trigger_defeat()
		return true

	# Check victory
	if enemies_alive == 0:
		_trigger_victory()
		return true

	return false

func _count_living_party() -> int:
	## Count living party members (not soldiers)
	var count = 0
	for unit in _turn_order:
		if is_instance_valid(unit) and unit.is_friendly() and not unit.is_soldier:
			count += 1
	return count

func _count_living_enemies() -> int:
	## Count living enemy units
	var count = 0
	for unit in _turn_order:
		if is_instance_valid(unit) and unit.is_enemy:
			count += 1
	return count

func _trigger_victory() -> void:
	## Handle victory condition
	print("[TurnManager] === VICTORY! ===")
	_is_battle_active = false
	battle_won.emit(VICTORY_GOLD_REWARD)

func _trigger_defeat() -> void:
	## Handle defeat condition
	print("[TurnManager] === DEFEAT ===")
	_is_battle_active = false
	battle_lost.emit()
```

### CombatManager Integration

```gdscript
## Add to scripts/autoload/combat_manager.gd

# ===== SIGNALS =====
signal battle_won(gold_earned: int)
signal battle_lost()

# ===== TURN STATE ENUM (add BATTLE_ENDED) =====
enum TurnState {
	INACTIVE,
	WAITING_FOR_INPUT,
	MOVING,
	ACTING,
	TURN_END,
	BATTLE_ENDED  # NEW: Battle has concluded
}

# ===== MODIFIED: start_battle =====
func start_battle(units: Array[Unit]) -> void:
	# ... existing code ...

	# Connect battle end signals
	_turn_manager.battle_won.connect(_on_battle_won)
	_turn_manager.battle_lost.connect(_on_battle_lost)

	# ... rest of existing code ...

func _on_battle_won(gold_earned: int) -> void:
	set_turn_state(TurnState.BATTLE_ENDED)
	_current_turn_unit = null
	deselect_unit()
	battle_won.emit(gold_earned)
	print("[CombatManager] Battle won! Gold: %d" % gold_earned)

func _on_battle_lost() -> void:
	set_turn_state(TurnState.BATTLE_ENDED)
	_current_turn_unit = null
	deselect_unit()
	battle_lost.emit()
	print("[CombatManager] Battle lost!")
```

### Integration Points

| System | Integration |
|--------|-------------|
| TurnManager | Checks win/lose after unit death, emits battle_won/battle_lost |
| CombatManager | Receives signals, sets BATTLE_ENDED state, relays to UI |
| BattleResultPopup | Displays outcome, emits continue/retry signals |
| Main.gd | Manages popup, handles restart on retry |
| Unit death (Task 1.7) | Triggers remove_unit which triggers battle end check |
| Gold system (future) | Victory gold feeds into economy |

### Signals

| Signal | Emitter | Parameters | Purpose |
|--------|---------|------------|---------|
| `battle_won` | TurnManager | `(gold_earned: int)` | Victory detected |
| `battle_lost` | TurnManager | `()` | Defeat detected |
| `battle_won` | CombatManager | `(gold_earned: int)` | Relay to UI layer |
| `battle_lost` | CombatManager | `()` | Relay to UI layer |
| `continue_pressed` | BattleResultPopup | `()` | Player clicked Continue |
| `retry_pressed` | BattleResultPopup | `()` | Player clicked Retry |

---

## 7. File Structure

```
scenes/
‚îî‚îÄ‚îÄ UI/
    ‚îî‚îÄ‚îÄ BattleResultPopup.tscn   # NEW: Victory/defeat popup

scripts/
‚îú‚îÄ‚îÄ UI/
‚îÇ   ‚îî‚îÄ‚îÄ battle_result_popup.gd   # NEW: Popup logic
‚îú‚îÄ‚îÄ combat/
‚îÇ   ‚îî‚îÄ‚îÄ turn_manager.gd          # MODIFY: Add battle end check
‚îî‚îÄ‚îÄ autoload/
    ‚îî‚îÄ‚îÄ combat_manager.gd        # MODIFY: Add BATTLE_ENDED state

scripts/main/
‚îî‚îÄ‚îÄ main.gd                      # MODIFY: Manage popup, handle retry
```

---

## 8. Acceptance Criteria

| # | Criterion | Test Method |
|---|-----------|-------------|
| 1 | Victory triggers when last enemy dies | Kill all enemies, verify popup appears |
| 2 | Defeat triggers when last party member dies | Let all party die, verify popup appears |
| 3 | Victory popup shows "VICTORY!" and gold amount | Visual inspection |
| 4 | Defeat popup shows "DEFEAT" and Retry button | Visual inspection |
| 5 | Continue button closes popup | Click Continue after victory |
| 6 | Retry button restarts battle | Click Retry after defeat, verify units reset |
| 7 | Turn system stops on battle end | No more turn processing after condition met |
| 8 | Soldiers dying doesn't trigger defeat | Kill all soldiers, verify battle continues |
| 9 | Console logs battle end clearly | Check [TurnManager] output |
| 10 | Popup animation smooth | Visual inspection of fade in/out |

---

## 9. Testing Checklist

### Functional Tests
- [ ] Victory popup appears when last enemy dies
- [ ] Defeat popup appears when last party member dies
- [ ] Gold amount displayed correctly (100g)
- [ ] Continue button works and closes popup
- [ ] Retry button works and restarts battle
- [ ] Turn system stops immediately on battle end
- [ ] Battle end check runs after each death
- [ ] Popup fades in smoothly
- [ ] Popup fades out on button click

### Integration Tests
- [ ] Attack killing enemy triggers victory check
- [ ] Attack killing party member triggers defeat check
- [ ] TurnManager signals reach CombatManager
- [ ] CombatManager signals reach Main/UI
- [ ] Retry properly resets all unit positions and HP
- [ ] Turn order re-initialized after retry

### Edge Cases
- [ ] Mutual kill (both sides die) - defeat takes priority
- [ ] Solo party member vs solo enemy - proper detection
- [ ] All soldiers dead but party alive - battle continues
- [ ] Party dead but soldiers alive - defeat triggers
- [ ] Multiple enemies die same turn - single victory trigger
- [ ] Rapid clicking doesn't cause duplicate popups

### UI Tests
- [ ] Victory colors correct (gold theme)
- [ ] Defeat colors correct (red theme)
- [ ] Button hover states work
- [ ] Popup centered on screen
- [ ] Text readable and properly sized
- [ ] ESC key dismisses popup (optional)

---

## 10. Implementation Notes

### Approach Rationale

**Why check in TurnManager.remove_unit()?**
- Single point of truth for unit removal
- Guaranteed to run after any death (combat, effects, etc.)
- Proper sequencing - death animation completes first
- Clean integration with existing turn flow

**Why separate signals for win/lose?**
- Different handling paths (gold vs retry)
- Clearer intent in code
- Easier to extend with different outcomes (retreat, objective complete, etc.)

**Why use CanvasLayer for popup?**
- Renders above all game elements
- Proper input handling (blocks clicks behind)
- Easy to manage z-order
- Standard pattern for overlay UI

**Why placeholder 100g reward?**
- Simple validation that gold system works
- Will be replaced by contract-specific rewards in Phase 3
- Easy to find and update (single constant)

### Gotchas to Watch

1. **Signal order**: Ensure battle_won/lost emits AFTER state changes complete
2. **Unit validity**: Dead units may be freed - always check `is_instance_valid()`
3. **Double triggers**: Prevent multiple victory/defeat signals if multiple units die
4. **Retry state reset**: Must reset turn order, positions, HP - not just restart scene
5. **Popup input blocking**: Overlay must block all game input while visible
6. **Soldier flag**: Units need `is_soldier` property to distinguish from party members

### Alternative Approaches Considered

| Approach | Pros | Cons | Decision |
|----------|------|------|----------|
| Check every frame | Always accurate | Performance waste | Rejected |
| Check on turn end | Grouped checks | Miss mid-turn kills | Rejected |
| **Check on death** | Immediate, efficient | Need signal hookup | **Chosen** |
| Scene reload for retry | Simple reset | Loses any persistent state | Rejected |
| **In-place reset** | Keeps context | More code | **Chosen** |

### Dependencies on Previous Tasks

- **Task 1.7 (Attack Action)**: Must emit death signals, reduce HP to 0
- **Task 1.8 (Turn System)**: TurnManager must exist, state machine must work
- **Task 1.2 (Units)**: Units need `is_alive()`, `is_enemy`, `is_friendly()` properties

### Future Enhancements (Out of Scope)

- Multiple victory conditions (kill leader, capture point, survive X turns)
- Retreat option (escape battle, lose some gold)
- Detailed battle statistics on popup
- Different rewards based on performance
- Companion reactions to outcome
- Sound effects and music stings
- Screen shake on defeat

---

## 11. Definition of Done

- [ ] `scenes/UI/BattleResultPopup.tscn` created
- [ ] `scripts/UI/battle_result_popup.gd` implemented
- [ ] `scripts/combat/turn_manager.gd` modified with battle end check
- [ ] `scripts/autoload/combat_manager.gd` modified with BATTLE_ENDED state
- [ ] `scripts/main/main.gd` modified to handle popup and retry
- [ ] Victory triggers when all enemies dead
- [ ] Defeat triggers when all party members dead
- [ ] Soldiers dying doesn't cause defeat
- [ ] Victory popup displays gold reward (100g)
- [ ] Defeat popup displays Retry button
- [ ] Continue closes popup
- [ ] Retry restarts battle with fresh state
- [ ] Popup animation smooth (fade in/out)
- [ ] Turn system stops on battle end
- [ ] All acceptance criteria pass
- [ ] Console logging shows battle end state
- [ ] Code follows GDScript style guidelines

---

## 12. References

### From GDD

- **Battle End**: "Battle ends when: All enemies dead/fled OR all your units incapacitated" (Section 3: Combat System)
- **Victory/Defeat**: "Victory/defeat conditions" listed in Phase 1 deliverables (Section 6)
- **Gold System**: Economy supports contract rewards, soldier hiring (Section 3: Company Management)
- **Turn Structure**: Turn system must integrate with battle end (Section 3)

### From Roadmap

- **Task 1.9**: Victory/Defeat Detection (Phase 1, Day 2, 1 hour)
- **Dependencies**: Task 1.7 (units can die)
- **Hardcoded Values**: Victory gold = 100g, popup until click
- **Files**: BattleResultPopup.tscn, modify turn_manager.gd
- **Phase 1 Checkpoint**: "Battle ends on victory/defeat"

### Godot Documentation

- [CanvasLayer](https://docs.godotengine.org/en/stable/classes/class_canvaslayer.html)
- [Signals](https://docs.godotengine.org/en/stable/getting_started/step_by_step/signals.html)
- [Tween animations](https://docs.godotengine.org/en/stable/classes/class_tween.html)
- [StyleBoxFlat](https://docs.godotengine.org/en/stable/classes/class_styleboxflat.html)
