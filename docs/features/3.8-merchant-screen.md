# Merchant Screen

**Feature ID:** 3.8
**Status:** üî¥ Planned
**Priority:** ‚û°Ô∏è Medium
**Estimated Time:** 2-3 hours
**Dependencies:** Task 3.1 (Hub Scene Structure)
**Assigned To:** AI Assistant

---

## Purpose

### Why does this feature exist?
The Merchant screen allows players to spend gold earned from contracts on equipment upgrades for their party members. This creates meaningful economic choices and supports the "Character Progression" design pillar where "equipment matters - finding that enchanted sword changes everything."

### What does it enable?
- Players can purchase weapons and armor using gold
- Equipment directly improves combat stats (damage, defense, movement)
- Creates meaningful choice between saving for fort upgrades vs immediate combat power
- Comparison view helps players make informed purchasing decisions

### Success Criteria
- Players can view available weapons and armor with clear stats
- Players can see comparison between current equipment and new items
- Purchases deduct gold and update character stats
- Equipment changes persist and affect combat performance

---

## How It Works

### Overview
The Merchant screen is accessed from the main hub navigation. It displays two categories of items for sale: Weapons and Armor. Each item shows its name, price, and key stats. When the player selects an item, a comparison panel shows current vs new stats for the selected party member, highlighting improvements in green and downgrades in red.

Players can only equip items to party members (Player, Thorne, Lyra, Matthias), not soldiers. Each party member can have one weapon and one armor equipped. Purchasing an item automatically equips it to the currently selected party member, replacing their existing equipment (the old equipment is lost - no inventory system for prototype).

### User Flow
1. Player navigates to Hub and clicks "MERCHANT" button
2. Merchant screen opens showing item categories (Weapons/Armor)
3. Player selects a party member from the roster at top
4. Player browses items in selected category
5. Clicking an item shows comparison panel with stat changes
6. Player clicks "PURCHASE" to buy and equip
7. Gold is deducted, stats are updated, item shows as "EQUIPPED"
8. Player can switch party members or browse more items
9. Back button returns to hub

### Rules & Constraints
- Only party members can equip items (not soldiers)
- Each party member has one weapon slot and one armor slot
- Purchasing replaces existing equipment (no inventory for prototype)
- Gold must be sufficient to purchase
- Items can be purchased multiple times for different characters
- Equipment effects apply immediately and persist to combat

### Items for Sale

#### Weapons
| Item | Cost | Damage Die | Properties | Best For |
|------|------|------------|------------|----------|
| Iron Sword | 100g | 1d8 | Standard melee | Player, Thorne |
| Steel Sword | 300g | 1d8+1 | +1 damage bonus | Player, Thorne |

#### Armor
| Item | Cost | Defense | Movement | Properties |
|------|------|---------|----------|------------|
| Leather Armor | 50g | +2 | 6 tiles | Light |
| Chain Shirt | 150g | +4 | 5 tiles | Medium |
| Scale Mail | 300g | +5 | 5 tiles | Heavy |

### Edge Cases
- **Insufficient Gold:** Purchase button disabled, cost shown in red
- **Already Equipped:** Item shows "EQUIPPED" badge for that character, can still buy for others
- **Ranged Character:** Lyra uses bow by default; swords would change her to melee (warn player)
- **Character Swap:** Comparison updates when selecting different party member
- **All Characters Have Item:** Show "(X equipped)" count on item card

---

## User Interaction

### Controls
- **Mouse Click:** Select category, select item, select party member, purchase
- **ESC / Back Button:** Return to hub main view

### Visual Feedback
- **Item Hover:** Card highlights, shows brief tooltip
- **Item Selected:** Border highlight, comparison panel appears
- **Stat Improvement:** Green text with up arrow (‚Üë)
- **Stat Reduction:** Red text with down arrow (‚Üì)
- **No Change:** White/gray text
- **Purchase Success:** Gold counter animates down, item flashes, "EQUIPPED" appears
- **Purchase Denied:** Shake animation, brief red flash

### Audio Feedback (Placeholder)
- **Hover:** Subtle UI hover sound
- **Purchase:** Coin sound effect, equip clang
- **Denied:** Error buzz

---

## Visual Design

### Layout
```
+------------------------------------------------------------------+
|  < BACK        MERCHANT                           GOLD: 500      |
+------------------------------------------------------------------+
|                                                                  |
|  [ Party Member Selection ]                                      |
|  [PLAYER] [THORNE] [LYRA] [MATTHIAS]                            |
|           ^selected                                              |
+------------------------------------------------------------------+
|                                                                  |
|  [ WEAPONS ]  [ ARMOR ]                                          |
|   ^selected                                                      |
|                                                                  |
|  +------------------+  +------------------+                      |
|  | IRON SWORD       |  | STEEL SWORD      |                      |
|  | Damage: 1d8      |  | Damage: 1d8+1    |                      |
|  | 100 GOLD         |  | 300 GOLD         |                      |
|  +------------------+  +------------------+                      |
|   ^selected                                                      |
|                                                                  |
+------------------------------------------------------------------+
|  COMPARISON: Player                                              |
|  +------------------------------------------------------------+  |
|  |  Current          |  Iron Sword                            |  |
|  |  Iron Sword       |  Damage: 1d8                           |  |
|  |  Damage: 1d8      |  (No change)                           |  |
|  |                   |                                        |  |
|  |                   |  [ PURCHASE - 100g ]                   |  |
|  +------------------------------------------------------------+  |
+------------------------------------------------------------------+
```

### Components
- **Header Bar:** Back button, title "MERCHANT", gold display
- **Party Selector:** Horizontal row of party member buttons
- **Category Tabs:** Toggle between Weapons and Armor
- **Item Grid:** Cards showing available items (2 per row)
- **Comparison Panel:** Side-by-side current vs new equipment stats
- **Purchase Button:** Large button with price, disabled if can't afford

### Visual States

| Element | State | Appearance |
|---------|-------|------------|
| Item Card | Available | Normal colors, gold cost visible |
| Item Card | Hover | Brightened border, slight scale |
| Item Card | Selected | Yellow border, comparison shown |
| Item Card | Equipped | Green "EQUIPPED" badge overlay |
| Item Card | Unaffordable | Grayed out, cost in red |
| Party Button | Not Selected | Dimmed, normal size |
| Party Button | Selected | Bright, slight scale up |
| Stat Change | Improvement | Green text, ‚Üë arrow |
| Stat Change | Reduction | Red text, ‚Üì arrow |
| Stat Change | Same | Gray text |

### Style Guidelines
- Match existing hub UI style (dark backgrounds, clean borders)
- Use gold/yellow accent for costs and purchase buttons
- Green accent for improvements and equipped state
- Red accent for unaffordable and stat reductions
- Category tabs follow button styling

---

## Technical Implementation

### Scene Structure
```
MerchantScreen (Control)
‚îú‚îÄ‚îÄ TopBar (HBoxContainer)
‚îÇ   ‚îú‚îÄ‚îÄ BackButton (Button) - "< BACK"
‚îÇ   ‚îú‚îÄ‚îÄ TitleLabel (Label) - "MERCHANT"
‚îÇ   ‚îî‚îÄ‚îÄ GoldDisplay (HBoxContainer)
‚îÇ       ‚îú‚îÄ‚îÄ GoldLabel (Label) - "GOLD:"
‚îÇ       ‚îî‚îÄ‚îÄ GoldAmount (Label) - Dynamic
‚îú‚îÄ‚îÄ ContentPanel (Panel)
‚îÇ   ‚îî‚îÄ‚îÄ VBoxContainer
‚îÇ       ‚îú‚îÄ‚îÄ PartySelector (HBoxContainer)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ PlayerButton (Button)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ThorneButton (Button)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ LyraButton (Button)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ MatthiasButton (Button)
‚îÇ       ‚îú‚îÄ‚îÄ CategoryTabs (HBoxContainer)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ WeaponsTab (Button) - "WEAPONS"
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ArmorTab (Button) - "ARMOR"
‚îÇ       ‚îú‚îÄ‚îÄ ItemsContainer (GridContainer, columns=2)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [Item cards added dynamically]
‚îÇ       ‚îî‚îÄ‚îÄ ComparisonPanel (PanelContainer)
‚îÇ           ‚îî‚îÄ‚îÄ HBoxContainer
‚îÇ               ‚îú‚îÄ‚îÄ CurrentEquipment (VBoxContainer)
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ CurrentLabel (Label) - "CURRENT"
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ CurrentName (Label)
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ CurrentStats (VBoxContainer)
‚îÇ               ‚îú‚îÄ‚îÄ VSeparator
‚îÇ               ‚îî‚îÄ‚îÄ NewEquipment (VBoxContainer)
‚îÇ                   ‚îú‚îÄ‚îÄ NewLabel (Label) - "NEW"
‚îÇ                   ‚îú‚îÄ‚îÄ NewName (Label)
‚îÇ                   ‚îú‚îÄ‚îÄ NewStats (VBoxContainer)
‚îÇ                   ‚îî‚îÄ‚îÄ PurchaseButton (Button)
```

### Data Structures

#### Equipment Resource (scripts/resources/equipment.gd)
```gdscript
class_name Equipment
extends Resource

enum EquipmentType { WEAPON, ARMOR }

@export var id: String = ""
@export var display_name: String = ""
@export var equipment_type: EquipmentType = EquipmentType.WEAPON
@export var cost: int = 0

# Weapon stats
@export var damage_die: int = 0  # e.g., 8 for 1d8
@export var damage_bonus: int = 0  # e.g., 1 for +1 damage
@export var weapon_range: int = 1  # 1 = melee, 8 = ranged
@export var is_ranged: bool = false

# Armor stats
@export var armor_bonus: int = 0  # Defense bonus
@export var movement_modifier: int = 0  # Change to movement (negative for heavy)
```

#### Character Equipment State (in GameState)
```gdscript
# Add to game_state.gd
var character_equipment: Dictionary = {
    "player": {"weapon": null, "armor": null},
    "thorne": {"weapon": null, "armor": null},
    "lyra": {"weapon": null, "armor": null},
    "matthias": {"weapon": null, "armor": null},
}

func equip_item(character_id: String, equipment: Equipment) -> void:
    var slot = "weapon" if equipment.equipment_type == Equipment.EquipmentType.WEAPON else "armor"
    character_equipment[character_id][slot] = equipment
    equipment_changed.emit(character_id, slot, equipment)

func get_equipped(character_id: String, slot: String) -> Equipment:
    return character_equipment[character_id].get(slot)
```

### Script Responsibilities

#### merchant_screen.gd
- Extends BaseHubScreen for consistent navigation
- Manages party member selection
- Manages category tab switching
- Creates item cards from equipment data
- Shows comparison when item selected
- Handles purchase flow with confirmation
- Updates GameState on purchase

**Key Methods:**
```gdscript
func _select_party_member(member_id: String) -> void
func _select_category(category: Equipment.EquipmentType) -> void
func _select_item(equipment: Equipment) -> void
func _update_comparison() -> void
func _calculate_stat_change(current: int, new: int) -> Dictionary
func _on_purchase_pressed() -> void
func _refresh_item_cards() -> void
```

### Integration Points

| System | Integration |
|--------|-------------|
| **GameState** | Read/write character_equipment, spend_gold, gold_changed signal |
| **Unit** | Apply equipment stats in `_configure_stats_for_type()` override |
| **Combat** | Equipment affects attack rolls, damage, defense, movement |
| **Hub** | Navigation button, sub-screen display |
| **Save/Load** | character_equipment saved in game state |

### Signals
- `equipment_purchased(character_id: String, equipment: Equipment)` - Emitted on purchase
- `back_pressed` - Emitted when back button clicked (from BaseHubScreen)

### Configuration
Equipment data stored as .tres resources:

```
resources/equipment/
‚îú‚îÄ‚îÄ weapons/
‚îÇ   ‚îú‚îÄ‚îÄ iron_sword.tres
‚îÇ   ‚îî‚îÄ‚îÄ steel_sword.tres
‚îî‚îÄ‚îÄ armor/
    ‚îú‚îÄ‚îÄ leather_armor.tres
    ‚îú‚îÄ‚îÄ chain_shirt.tres
    ‚îî‚îÄ‚îÄ scale_mail.tres
```

Or as constants in merchant_screen.gd for prototype:
```gdscript
const WEAPONS := [
    {"id": "iron_sword", "name": "Iron Sword", "cost": 100, "damage_die": 8, "damage_bonus": 0},
    {"id": "steel_sword", "name": "Steel Sword", "cost": 300, "damage_die": 8, "damage_bonus": 1},
]
const ARMOR := [
    {"id": "leather", "name": "Leather Armor", "cost": 50, "armor_bonus": 2, "movement": 6},
    {"id": "chain_shirt", "name": "Chain Shirt", "cost": 150, "armor_bonus": 4, "movement": 5},
    {"id": "scale_mail", "name": "Scale Mail", "cost": 300, "armor_bonus": 5, "movement": 5},
]
```

---

## Acceptance Criteria

- [ ] Merchant screen accessible from hub MERCHANT button
- [ ] Shows weapons and armor for sale with correct prices
- [ ] Can select different party members
- [ ] Clicking item shows comparison with current equipment
- [ ] Stat improvements shown in green, reductions in red
- [ ] Can purchase items with sufficient gold
- [ ] Gold deducted on purchase
- [ ] Equipment marked as "EQUIPPED" after purchase
- [ ] Unaffordable items grayed out with red cost
- [ ] Equipment stats persist and affect combat
- [ ] Back button returns to hub

---

## Testing Checklist

### Functional Tests
- [ ] Screen loads without errors from hub
- [ ] All 5 items displayed (2 weapons, 3 armor)
- [ ] Party member buttons switch selected character
- [ ] Category tabs switch between weapons and armor
- [ ] Clicking item selects it and shows comparison
- [ ] Purchase button works when affordable
- [ ] Gold decreases by correct amount
- [ ] "EQUIPPED" badge appears after purchase
- [ ] Purchase button disabled when unaffordable

### Edge Case Tests
- [ ] Cannot purchase with exactly 1 gold less than cost
- [ ] Can purchase with exactly enough gold
- [ ] Buying same item for different characters works
- [ ] Switching characters updates comparison correctly
- [ ] Item state correct when character already has that item

### Integration Tests
- [ ] GameState.gold updated correctly after purchase
- [ ] Equipment persists after leaving merchant screen
- [ ] Equipment stats applied in combat (damage, defense, movement)
- [ ] Save/load preserves equipment state

### Polish Tests
- [ ] Hover effects on item cards
- [ ] Selection highlight visible
- [ ] Stat change colors correct (green up, red down)
- [ ] Gold display updates immediately
- [ ] Responsive layout at different resolutions

---

## Implementation Notes

### Approach
- Extend BaseHubScreen for consistent hub navigation
- Use constants for equipment data (simpler than resource files for prototype)
- Store equipment as string IDs in GameState for easy serialization
- Apply equipment stats at combat start, not permanently to Unit scenes

### Equipment Application Strategy
For the prototype, equipment stats are applied when combat begins:
1. GameState stores `character_equipment` with equipment IDs
2. Before combat, check each party member's equipment
3. Override base stats with equipment stats
4. Unit.gd `_configure_stats_for_type()` checks GameState for equipment

Example in Unit:
```gdscript
func _configure_stats_for_type() -> void:
    match unit_type:
        UnitType.PLAYER:
            # Base stats...
            # Apply equipment overrides
            var weapon = GameState.get_equipped("player", "weapon")
            if weapon:
                weapon_damage_die = weapon.damage_die
                damage_bonus = weapon.damage_bonus
            var armor = GameState.get_equipped("player", "armor")
            if armor:
                armor_bonus = armor.armor_bonus
                movement_range = armor.movement
```

### Gotchas
- Lyra is ranged by default; buying a sword would make her melee (may want to warn or restrict)
- Equipment replaces previous - no "sell back" system for prototype
- Movement reduction from heavy armor affects tactical options
- Ensure equipment stats don't stack with base stats incorrectly

### Future Enhancements (Out of Scope)
- Inventory system (store unequipped items)
- Sell back equipment for partial gold
- Equipment requirements (STR for heavy armor)
- More weapon variety (axes, spears, bows)
- Equipment enchantments
- Visual equipment changes on character sprites

---

## Files

**New Files:**
- `scripts/hub/screens/merchant_screen.gd` - Replace placeholder, full implementation
- `scenes/hub/screens/MerchantScreen.tscn` - Update scene with full UI

**Modified Files:**
- `scripts/autoload/game_state.gd` - Add character_equipment tracking
- `scripts/combat/unit.gd` - Apply equipment stats at configuration

**Optional Resource Files (if not using constants):**
- `resources/equipment/weapons/iron_sword.tres`
- `resources/equipment/weapons/steel_sword.tres`
- `resources/equipment/armor/leather_armor.tres`
- `resources/equipment/armor/chain_shirt.tres`
- `resources/equipment/armor/scale_mail.tres`
