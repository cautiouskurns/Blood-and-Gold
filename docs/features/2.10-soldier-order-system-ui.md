# Task 2.10: Soldier Order System UI

**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 2 hours
**Dependencies:** Task 2.8 (soldier unit type - infantry), Task 2.9 (soldier unit type - archer)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The Order Panel is the player's primary interface for commanding their mercenary soldiers. Without it, soldiers are stuck on their default order forever. This UI enables the "Build & Command" design pillar - allowing players to issue strategic orders to soldiers while focusing their direct tactical control on party members. The GDD explicitly states that commanding soldiers should feel like being a commander, not micromanagement.

**What does it enable?**
- Players can dynamically change soldier orders during combat, adapting to tactical situations
- Strategic control over soldier behavior without micromanaging individual units
- Clear visual feedback showing which order is being assigned and to whom
- The full 5-order system (ADVANCE, HOLD, FOCUS FIRE, RETREAT, PROTECT) becomes usable
- Group tactics become possible (e.g., "archers hold, infantry advance")

**Success criteria:**
- Order panel is visible and accessible during combat
- Player can select an order, then click a soldier to assign it
- Order icon above soldier immediately updates to reflect new order
- All 5 orders are selectable via distinct buttons
- Clear visual feedback during order assignment mode

---

## How It Works

### Overview

The Order Panel is a compact UI element positioned on the right side of the screen during combat. It displays 5 order buttons - one for each standing order a soldier can follow. When the player clicks an order button, the game enters "order assignment mode" where the next soldier clicked will receive that order.

This interaction pattern (select action, then select target) mirrors ability targeting, making it intuitive for players already familiar with the combat system. The panel is always visible during combat but only interactive when it's a friendly unit's turn (can issue orders during any friendly turn, not just the current unit's turn).

Orders take effect immediately - when assigned, the soldier's order icon updates, and they will follow the new order on their next turn. This allows players to set up tactical formations before soldiers act.

### User Flow

```
1. Combat is active, Order Panel visible on right side of screen
2. Player sees soldier with undesired order (e.g., HOLD when they want ADVANCE)
3. Player clicks "ADVANCE" button on Order Panel
4. Button highlights, cursor changes to indicate targeting mode
5. Valid targets (soldiers) show highlight overlay
6. Player clicks on a soldier
7. Soldier's order changes to ADVANCE
8. Order icon above soldier updates immediately
9. Targeting mode ends, panel returns to default state
10. On soldier's next turn, they execute ADVANCE behavior
```

### Rules & Constraints

- **Order Assignment Timing:** Orders can be issued at any point during a friendly unit's turn
- **Target Restriction:** Can only assign orders to soldiers (not party members or enemies)
- **Immediate Update:** Order icon updates instantly when order is assigned
- **No Turn Cost:** Assigning orders does not cost actions or end turns
- **Cancel Assignment:** Right-click or clicking another order button cancels current assignment mode
- **Single Target:** Each order click assigns to one soldier; must click order again for additional soldiers
- **Enemy Turn Lock:** Cannot assign orders during enemy turns (panel disabled/grayed)
- **All Orders Available:** All 5 orders are always available (no unlock system for prototype)

### Edge Cases

- **No soldiers on field:** Panel visible but all buttons disabled
- **Soldier dies during assignment:** Cancel assignment mode, show no error
- **Click same order soldier already has:** Accept silently (no change needed)
- **Click party member during assignment:** Cancel assignment, show tooltip "Can only give orders to soldiers"
- **Click enemy during assignment:** Cancel assignment, no action
- **Click empty tile during assignment:** Cancel assignment mode
- **Battle ends during assignment:** Cancel assignment, hide panel

---

## User Interaction

### Controls

| Input | Action |
|-------|--------|
| Left-click order button | Enter order assignment mode for that order |
| Left-click soldier (in assignment mode) | Assign selected order to soldier |
| Right-click (in assignment mode) | Cancel order assignment mode |
| Escape key (in assignment mode) | Cancel order assignment mode |
| Left-click another order button (in assignment mode) | Switch to that order's assignment mode |
| Hover order button | Show tooltip with order description |

### Visual Feedback

- **Order Button States:**
  - Default: Icon visible with subtle background
  - Hovered: Lighten background, show tooltip
  - Selected (assignment mode): Bright highlight, pulsing border
  - Disabled (enemy turn/no soldiers): Grayed out, no interaction

- **Assignment Mode Indicators:**
  - Cursor changes to command/pointer style
  - Selected order button pulses with highlight
  - Valid target soldiers show green highlight overlay
  - Invalid targets (party members, enemies) show no overlay
  - Small "Assigning: [ORDER NAME]" text near cursor or at top of panel

- **Order Assignment Confirmation:**
  - Brief flash on soldier when order assigned
  - Order icon above soldier updates immediately
  - Optional: Small floating text "+ADVANCE" above soldier (0.5s fade)

### Audio Feedback (if applicable)

- Order button click: UI click sound
- Order assigned to soldier: Distinct "command accepted" sound (military horn or acknowledgment)
- Cancel assignment: Soft cancel/back sound

---

## Visual Design

### Layout

```
Order Panel (positioned right side of screen):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ORDERS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ âš” ADV   â”‚  â”‚ ðŸ›¡ HOLD â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ ðŸŽ¯ FOCUSâ”‚  â”‚ â† RETR  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚    ðŸ‘¤ PROTECT       â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

- **Panel Container:** 180px wide, semi-transparent dark background
- **Title Label:** "ORDERS" text, centered at top
- **Order Buttons (5):** 80x40 each, arranged in 2x2 grid + 1 wide button
  - Each button has: Icon (left), Short label (right)
- **Tooltip Popup:** Appears on hover, shows full order description

### Visual Style

- **Panel Background:** #1a1a2e with 85% opacity (dark blue-black)
- **Panel Border:** #4a4a6a, 2px
- **Button Background (default):** #2d2d44
- **Button Background (hover):** #3d3d5c
- **Button Background (selected):** #4a90d9 with pulse animation
- **Button Background (disabled):** #1d1d2e, 50% opacity
- **Icon Color:** White (#ffffff)
- **Label Color:** #e0e0e0
- **Title Color:** #f0c040 (gold accent)

### Order Button Icons (32x32)

| Order | Icon Description | Color Accent |
|-------|-----------------|--------------|
| ADVANCE | Sword pointing right | Green (#2ecc71) |
| HOLD | Shield | Red (#e74c3c) |
| FOCUS FIRE | Crosshair/target | Orange (#f39c12) |
| RETREAT | Arrow pointing left | Purple (#9b59b6) |
| PROTECT | Person with shield | Blue (#3498db) |

### States

- **Default:** Panel visible, buttons interactive (during friendly turns)
- **Assignment Mode:** Selected button highlighted, valid soldiers highlighted on grid
- **Disabled:** All buttons grayed out (during enemy turns or no soldiers)
- **Hidden:** Panel not visible (outside of combat)

---

## Technical Implementation

### Scene Structure

```
OrderPanel.tscn (Control node)
â”œâ”€â”€ PanelContainer
â”‚   â”œâ”€â”€ VBoxContainer
â”‚   â”‚   â”œâ”€â”€ TitleLabel ("ORDERS")
â”‚   â”‚   â”œâ”€â”€ GridContainer (2 columns)
â”‚   â”‚   â”‚   â”œâ”€â”€ AdvanceButton (TextureButton)
â”‚   â”‚   â”‚   â”œâ”€â”€ HoldButton (TextureButton)
â”‚   â”‚   â”‚   â”œâ”€â”€ FocusFireButton (TextureButton)
â”‚   â”‚   â”‚   â””â”€â”€ RetreatButton (TextureButton)
â”‚   â”‚   â””â”€â”€ ProtectButton (TextureButton, full width)
â”‚   â””â”€â”€ StatusLabel (shows "Assigning: X" or empty)
â””â”€â”€ TooltipPopup (PopupPanel, hidden by default)
    â””â”€â”€ TooltipLabel
```

### Script Responsibilities

- **order_panel.gd:**
  - `_ready()` - Connect button signals, setup initial state
  - `_on_order_button_pressed(order: int)` - Enter assignment mode for order
  - `_on_soldier_clicked(soldier: Unit)` - Assign pending order to soldier
  - `enter_assignment_mode(order: Unit.SoldierOrder)` - Start targeting
  - `exit_assignment_mode()` - Cancel targeting, reset state
  - `assign_order_to_soldier(soldier: Unit, order: Unit.SoldierOrder)` - Execute assignment
  - `_update_button_states()` - Enable/disable based on game state
  - `set_panel_enabled(enabled: bool)` - Enable/disable entire panel
  - `show_tooltip(order: Unit.SoldierOrder)` - Display order description
  - `hide_tooltip()` - Hide tooltip popup

### Signals

```gdscript
signal order_assignment_started(order: Unit.SoldierOrder)
signal order_assignment_cancelled()
signal order_assigned(soldier: Unit, order: Unit.SoldierOrder)
```

### Integration Points

- **Connects to:**
  - `CombatManager` - Listen for turn changes, battle state
  - `Unit` - Call `set_order()` when assigning
  - Mouse/Input system - Detect soldier clicks during assignment

- **Listens for:**
  - `CombatManager.turn_started` - Enable panel on friendly turn
  - `CombatManager.turn_ended` - Check if should disable
  - `CombatManager.battle_ended` - Hide panel
  - `Unit.input_event` - Detect soldier clicks during assignment mode

- **Modifies:**
  - `Unit.current_order` - Updates soldier's standing order
  - Grid highlighting - Shows valid soldiers during assignment mode

### Configuration

Order descriptions (for tooltips):
```gdscript
const ORDER_DESCRIPTIONS: Dictionary = {
    Unit.SoldierOrder.ADVANCE: "Move toward the nearest enemy and attack when adjacent.",
    Unit.SoldierOrder.HOLD: "Stay in position. Attack any enemy that comes into range.",
    Unit.SoldierOrder.FOCUS_FIRE: "All soldiers with this order attack the same target.",
    Unit.SoldierOrder.RETREAT: "Fall back toward the starting edge of the map.",
    Unit.SoldierOrder.PROTECT: "Stay near and guard a specific ally.",
}
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Order Panel is visible on right side of screen during combat
- [ ] Panel has 5 distinct order buttons (Advance, Hold, Focus Fire, Retreat, Protect)
- [ ] Clicking an order button enters assignment mode with visual feedback
- [ ] In assignment mode, clicking a soldier assigns that order to them
- [ ] Soldier's order icon updates immediately when order is assigned
- [ ] Right-click or Escape cancels assignment mode
- [ ] Panel is disabled/grayed during enemy turns
- [ ] Hovering order buttons shows tooltip with order description
- [ ] Cannot assign orders to party members or enemies (graceful handling)
- [ ] Multiple orders can be assigned in succession (re-click order button)

---

## Testing Checklist

### Functional Tests

- [ ] **Panel Visibility:** Order Panel appears when combat starts
- [ ] **Button Click:** Clicking each order button enters assignment mode
- [ ] **Soldier Assignment:** Clicking soldier during assignment mode changes their order
- [ ] **Order Icon Update:** Icon above soldier changes immediately after assignment
- [ ] **Cancel with Right-Click:** Right-click exits assignment mode
- [ ] **Cancel with Escape:** Escape key exits assignment mode
- [ ] **Enemy Turn Disabled:** Panel buttons disabled during enemy turns
- [ ] **Tooltip Display:** Hovering buttons shows correct tooltip text

### Edge Case Tests

- [ ] **No Soldiers:** Panel visible but buttons disabled when no soldiers exist
- [ ] **Click Party Member:** Assignment cancelled, no error crash
- [ ] **Click Enemy:** Assignment cancelled, no error crash
- [ ] **Click Empty Tile:** Assignment cancelled
- [ ] **Same Order:** Assigning order soldier already has works silently
- [ ] **Soldier Dies:** If targeted soldier dies before click, handle gracefully
- [ ] **Battle Ends:** Panel hides when battle concludes

### Integration Tests

- [ ] **Works with Infantry:** Can assign orders to infantry soldiers (Task 2.8)
- [ ] **Works with Archers:** Can assign orders to archer soldiers (Task 2.9)
- [ ] **Turn System:** Panel correctly enables/disables with turn flow
- [ ] **Ability Bar:** Order panel doesn't conflict with ability bar usage
- [ ] **Combat Grid:** Soldier highlights appear correctly on grid

### Polish Tests

- [ ] **Button Animations:** Hover and selected states animate smoothly
- [ ] **Assignment Feedback:** Visual/audio feedback on successful assignment
- [ ] **Tooltip Positioning:** Tooltips don't go off-screen
- [ ] **Panel Positioning:** Panel doesn't overlap critical combat UI

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Reuse Targeting Pattern:** The order assignment mode is similar to ability targeting (Task 2.3). Consider reusing the targeting state machine pattern from CombatManager.

2. **Soldier Detection:** Use the `is_soldier` flag on Unit to determine valid targets. Party members have `is_soldier = false`.

3. **Panel Toggle:** The panel should be a child of the UI layer, positioned with anchors to stay on right side regardless of resolution.

4. **Order Enum:** Use the existing `Unit.SoldierOrder` enum from Task 2.8 implementation.

5. **Immediate Feedback:** Call `soldier.set_order(order)` which already handles icon updates (implemented in Task 2.8).

### Integration with Existing Code

The Unit class already has:
```gdscript
enum SoldierOrder { HOLD, ADVANCE, FOCUS_FIRE, RETREAT, PROTECT }
var current_order: SoldierOrder = SoldierOrder.HOLD
func set_order(order: SoldierOrder) -> void  # Updates order and icon
signal order_changed(unit: Unit, new_order: int)
```

### State Machine for Assignment Mode

```gdscript
enum PanelState { IDLE, ASSIGNING }
var _panel_state: PanelState = PanelState.IDLE
var _pending_order: Unit.SoldierOrder

func enter_assignment_mode(order: Unit.SoldierOrder) -> void:
    _panel_state = PanelState.ASSIGNING
    _pending_order = order
    order_assignment_started.emit(order)
    # Highlight valid soldiers on grid
    _highlight_valid_soldiers()

func exit_assignment_mode() -> void:
    _panel_state = PanelState.IDLE
    _pending_order = -1
    order_assignment_cancelled.emit()
    _clear_soldier_highlights()
```

### Soldier Click Detection During Assignment

Option A: Connect to each soldier's Area2D input signal
Option B: Use CombatManager to track clicks and route to OrderPanel
Option C: OrderPanel handles input directly, queries grid for soldier at click position

Recommended: Option B - keeps input handling centralized, similar to ability targeting.

### Alternative Approaches Considered

1. **Drag-and-drop orders:** Rejected - more complex, less precise on grid
2. **Select soldier first, then order:** Rejected - requires extra clicks for multi-soldier orders
3. **Group selection:** Considered for future - allows selecting multiple soldiers, applying one order to all

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| Panel Width | 180px | Fixed width on right side |
| Panel Position | Right edge, vertical center | Anchored to right |
| Button Size | 80x40 px | 2-column grid layout |
| Icon Size | 32x32 px | Same as soldier order icons |
| Tooltip Delay | 0.5 seconds | Before showing tooltip |
| Panel Background | #1a1a2e @ 85% | Semi-transparent |
| Selected Button Color | #4a90d9 | Blue highlight |
| Disabled Button Opacity | 50% | Grayed out appearance |

---

## Asset Requirements

### Icons Needed (32x32 PNG)

1. `assets/sprites/ui/order_icons/advance_icon.png` - Sword pointing right
2. `assets/sprites/ui/order_icons/hold_icon.png` - Shield
3. `assets/sprites/ui/order_icons/focus_fire_icon.png` - Crosshair/target
4. `assets/sprites/ui/order_icons/retreat_icon.png` - Arrow pointing left
5. `assets/sprites/ui/order_icons/protect_icon.png` - Person with shield

### Audio (Optional)

1. `assets/audio/sfx/ui_click.wav` - Button click
2. `assets/audio/sfx/order_assigned.wav` - Confirmation sound

---
