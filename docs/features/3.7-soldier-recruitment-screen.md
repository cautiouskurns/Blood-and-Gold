# Soldier Recruitment Screen

**Feature ID:** 3.7
**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 2-3 hours
**Dependencies:** Task 3.6 (Fort Management Screen)
**Assigned To:** AI Assistant

---

## Purpose

### Why does this feature exist?
The Soldier Recruitment screen allows players to spend hard-earned gold to expand their fighting force, directly supporting the "Build & Command" design pillar. This creates meaningful economic decisions between saving for fort upgrades vs building immediate combat strength.

### What does it enable?
- Players can hire Infantry and Archer soldier units to fight alongside their party
- Creates tactical roster-building decisions (melee vs ranged composition)
- Provides a tangible reward loop: contracts earn gold â†’ gold buys soldiers â†’ more soldiers help complete harder contracts
- Establishes the mercenary company growth fantasy central to the game's identity

### Success Criteria
- Players can view available soldier types with clear stat information
- Players can hire soldiers when they have sufficient gold AND capacity
- Hired soldiers persist in the company roster
- Hired soldiers appear in the next combat encounter
- Capacity limits prevent infinite army accumulation

---

## How It Works

### Overview
The Soldier Recruitment screen is accessible from the hub navigation, either as part of the Barracks or as a standalone screen. It displays the player's current roster status (soldiers owned vs capacity), available gold, and a list of soldier types that can be hired.

Each soldier type is presented as a recruitment card showing the unit's name, visual preview, key stats (HP, Attack, Defense, Movement), cost, and a "HIRE" button. When the player clicks hire, if they have sufficient gold and roster capacity, the soldier is added to their company, gold is deducted, and the UI updates to reflect the new state.

The screen should communicate capacity constraints clearly. If the roster is full, the hire buttons are disabled with a message indicating "ROSTER FULL - Upgrade Barracks for more capacity." If the player cannot afford a soldier, the hire button is grayed out with the cost displayed in red.

### User Flow
```
1. Player navigates to Hub and clicks "BARRACKS" or "RECRUITMENT" button
2. Recruitment screen displays showing:
   - Current roster count (e.g., "2/4 SOLDIERS")
   - Available gold
   - Soldier type cards
3. Player reviews soldier stats and costs
4. Player clicks "HIRE" on an Infantry card
5. System checks: gold >= 50 AND roster < capacity
6. If valid: Gold deducted, soldier added to roster, UI refreshes
7. If invalid: Shake animation, error feedback
8. Player can continue hiring or return to hub
9. In next combat, hired soldiers spawn with party
```

### Rules & Constraints
- **Capacity System:**
  - Base capacity: 4 soldiers
  - With Barracks upgrade: 8 soldiers
  - Cannot exceed capacity (hard limit)
- **Gold Requirements:**
  - Infantry: 50 gold
  - Archer: 100 gold
  - Must have exact amount or more to hire
- **Roster Persistence:**
  - Hired soldiers persist across contracts
  - Soldiers lost in combat are permanently removed
  - Roster state saved in GameState
- **Combat Spawning:**
  - All owned soldiers spawn at battle start
  - Soldiers use their respective spawn positions based on type

### Soldier Types

| Type | Cost | HP | ATK | DEF | Move | Special |
|------|------|-----|-----|-----|------|---------|
| Infantry | 50g | 20 | 1d6+1 | 13 | 4 | Melee fighter, follows orders |
| Archer | 100g | 15 | 1d6 | 11 | 5 | Ranged (8 tiles), follows orders |

### Edge Cases
- **Roster Full:** Hire buttons disabled, display "ROSTER FULL" message
- **Insufficient Gold:** Hire button grayed, cost in red, denied animation on click
- **Gold Exactly Equal:** Allow purchase, gold becomes 0
- **No Soldiers Owned:** Display "No soldiers recruited. Hire some mercenaries!" message
- **All Soldiers Lost in Combat:** Roster empties, capacity still available
- **Barracks Purchased Mid-Session:** Capacity should update immediately

---

## User Interaction

### Controls
- **Mouse Click:** Select soldier card, click hire button
- **Mouse Hover:** Show detailed tooltip with full stat breakdown
- **ESC / Back Button:** Return to hub main view

### Visual Feedback
- **Hover on Card:** Slight scale up, border glow, detailed stats tooltip
- **Hover on Hire Button:** Button brightens
- **Successful Hire:**
  - Gold counter animates down
  - Card flashes green briefly
  - Roster counter increments with animation
  - New soldier icon appears in roster display
- **Failed Hire (No Gold):**
  - Card shakes
  - Cost flashes red
  - Error sound
- **Failed Hire (Full Roster):**
  - Button shows "FULL"
  - Tooltip suggests upgrading Barracks

### Audio Feedback
- **Hover:** Subtle UI hover sound
- **Successful Hire:** Coin sound + recruitment fanfare
- **Failed Hire:** Denied/error buzz
- **Opening Screen:** Ambient barracks/camp sounds (optional)

---

## Visual Design

### Layout
```
+----------------------------------------------------------+
|  SOLDIER RECRUITMENT                         Gold: 450    |
+----------------------------------------------------------+
|                                                          |
|  CURRENT ROSTER: [==---] 2/4 SOLDIERS                   |
|  (Upgrade Barracks for more capacity)                    |
|                                                          |
|  +------------------------+  +------------------------+  |
|  |      INFANTRY          |  |       ARCHER           |  |
|  |                        |  |                        |  |
|  |     [Unit Image]       |  |     [Unit Image]       |  |
|  |                        |  |                        |  |
|  |  HP: 20   ATK: 1d6+1   |  |  HP: 15   ATK: 1d6     |  |
|  |  DEF: 13  MOVE: 4      |  |  DEF: 11  MOVE: 5      |  |
|  |                        |  |  Range: 8 tiles        |  |
|  |  "Reliable melee       |  |  "Deadly at range,     |  |
|  |   fighters"            |  |   fragile up close"    |  |
|  |                        |  |                        |  |
|  |  [HIRE - 50 GOLD]      |  |  [HIRE - 100 GOLD]     |  |
|  +------------------------+  +------------------------+  |
|                                                          |
|  YOUR SOLDIERS:                                          |
|  [Infantry] [Infantry] [Empty] [Empty]                   |
|                                                          |
|                    [ BACK TO HUB ]                       |
+----------------------------------------------------------+
```

### Components
- **Header Bar:** Title "SOLDIER RECRUITMENT" + current gold display
- **Roster Status Bar:** Visual capacity meter showing owned/max soldiers
- **Soldier Cards (x2):** Each contains unit portrait, stats, description, hire button
- **Owned Roster Display:** Row of icons showing currently owned soldiers
- **Back Button:** Returns to hub main navigation

### Visual Style
- **Colors:**
  - Background: Dark blue-gray (#1a1a2e)
  - Card backgrounds: Slightly lighter (#2d2d44)
  - Infantry accent: Green-blue (#2ecc71)
  - Archer accent: Purple (#9b59b6)
  - Gold cost: Yellow (#f1c40f)
  - Affordable: Green text
  - Unaffordable: Red text (#e74c3c)
- **Fonts:**
  - Headers: Bold, 24px
  - Stats: Regular, 16px
  - Descriptions: Italic, 14px
- **Animations:**
  - Card hover: Scale 1.02, 0.15s ease
  - Hire success: Flash green, 0.3s
  - Counter change: Number tick animation

### Visual States

| State | Card Appearance | Button State |
|-------|-----------------|--------------|
| **Available** | Normal colors, full opacity | "HIRE - [cost] GOLD" enabled |
| **Hover** | Bright border, slight scale up | Button highlighted |
| **Unaffordable** | Slightly dimmed | Grayed out, cost in red |
| **Roster Full** | Normal card | "ROSTER FULL" disabled |
| **After Hire** | Brief green flash | Momentarily disabled during animation |

---

## Technical Implementation

### Scene Structure
```
Recruitment (Control)
â”œâ”€â”€ Background (ColorRect)
â”œâ”€â”€ Header (HBoxContainer)
â”‚   â”œâ”€â”€ TitleLabel (Label) - "SOLDIER RECRUITMENT"
â”‚   â””â”€â”€ GoldDisplay (HBoxContainer)
â”‚       â”œâ”€â”€ GoldIcon (TextureRect)
â”‚       â””â”€â”€ GoldAmount (Label)
â”œâ”€â”€ RosterStatus (VBoxContainer)
â”‚   â”œâ”€â”€ RosterLabel (Label) - "CURRENT ROSTER:"
â”‚   â”œâ”€â”€ CapacityBar (ProgressBar)
â”‚   â””â”€â”€ CapacityText (Label) - "2/4 SOLDIERS"
â”œâ”€â”€ SoldiersContainer (HBoxContainer)
â”‚   â”œâ”€â”€ InfantryCard (PanelContainer)
â”‚   â”‚   â””â”€â”€ VBoxContainer
â”‚   â”‚       â”œâ”€â”€ NameLabel (Label) - "INFANTRY"
â”‚   â”‚       â”œâ”€â”€ PortraitRect (TextureRect)
â”‚   â”‚       â”œâ”€â”€ StatsContainer (GridContainer)
â”‚   â”‚       â”‚   â”œâ”€â”€ HPLabel, HPValue
â”‚   â”‚       â”‚   â”œâ”€â”€ ATKLabel, ATKValue
â”‚   â”‚       â”‚   â”œâ”€â”€ DEFLabel, DEFValue
â”‚   â”‚       â”‚   â””â”€â”€ MOVELabel, MOVEValue
â”‚   â”‚       â”œâ”€â”€ DescriptionLabel (Label)
â”‚   â”‚       â””â”€â”€ HireButton (Button) - "HIRE - 50 GOLD"
â”‚   â””â”€â”€ ArcherCard (PanelContainer)
â”‚       â””â”€â”€ VBoxContainer
â”‚           â””â”€â”€ [Same structure as Infantry]
â”œâ”€â”€ OwnedRosterDisplay (HBoxContainer)
â”‚   â”œâ”€â”€ OwnedLabel (Label) - "YOUR SOLDIERS:"
â”‚   â””â”€â”€ SoldierIcons (HBoxContainer) - Dynamic icons
â”œâ”€â”€ BackButton (Button) - "BACK TO HUB"
â””â”€â”€ HireConfirmation (Panel) - Optional confirmation dialog
```

### Script Responsibilities

#### recruitment.gd
Main screen controller handling display, hiring logic, and UI updates.

```gdscript
## Soldier Recruitment Screen - Hire soldiers for your mercenary company
## Part of: Blood & Gold Prototype
## Spec: docs/features/3.7-soldier-recruitment-screen.md
class_name Recruitment
extends Control

# ===== SIGNALS =====
signal soldier_hired(soldier_type: String)
signal back_pressed

# ===== CONSTANTS =====
const SOLDIER_DATA := {
    "infantry": {
        "name": "Infantry",
        "cost": 50,
        "hp": 20,
        "atk": "1d6+1",
        "defense": 13,
        "movement": 4,
        "description": "Reliable melee fighters",
    },
    "archer": {
        "name": "Archer",
        "cost": 100,
        "hp": 15,
        "atk": "1d6",
        "defense": 11,
        "movement": 5,
        "range": 8,
        "description": "Deadly at range, fragile up close",
    }
}

const BASE_CAPACITY := 4
const BARRACKS_BONUS := 4

# ===== NODE REFERENCES =====
@onready var gold_amount: Label = $Header/GoldDisplay/GoldAmount
@onready var capacity_bar: ProgressBar = $RosterStatus/CapacityBar
@onready var capacity_text: Label = $RosterStatus/CapacityText
@onready var infantry_card: PanelContainer = $SoldiersContainer/InfantryCard
@onready var archer_card: PanelContainer = $SoldiersContainer/ArcherCard
@onready var infantry_hire_btn: Button = $SoldiersContainer/InfantryCard/VBoxContainer/HireButton
@onready var archer_hire_btn: Button = $SoldiersContainer/ArcherCard/VBoxContainer/HireButton
@onready var owned_icons: HBoxContainer = $OwnedRosterDisplay/SoldierIcons
@onready var back_button: Button = $BackButton

# ===== LIFECYCLE =====
func _ready() -> void:
    _connect_signals()
    _refresh_display()

func _connect_signals() -> void:
    infantry_hire_btn.pressed.connect(_on_hire_infantry)
    archer_hire_btn.pressed.connect(_on_hire_archer)
    back_button.pressed.connect(_on_back_pressed)
    GameState.gold_changed.connect(_on_gold_changed)

# ===== PUBLIC API =====
func get_max_capacity() -> int:
    ## Returns max soldier capacity based on upgrades
    var capacity := BASE_CAPACITY
    if GameState.has_upgrade("barracks"):
        capacity += BARRACKS_BONUS
    return capacity

func get_current_roster_size() -> int:
    ## Returns number of soldiers currently owned
    return GameState.get_soldier_count()

func can_hire() -> bool:
    ## Returns true if there's room for more soldiers
    return get_current_roster_size() < get_max_capacity()

# ===== INTERNAL METHODS =====
func _refresh_display() -> void:
    _update_gold_display()
    _update_capacity_display()
    _update_soldier_cards()
    _update_owned_roster_display()

func _update_gold_display() -> void:
    gold_amount.text = str(GameState.gold)

func _update_capacity_display() -> void:
    var current := get_current_roster_size()
    var max_cap := get_max_capacity()
    capacity_bar.max_value = max_cap
    capacity_bar.value = current
    capacity_text.text = "%d/%d SOLDIERS" % [current, max_cap]

func _update_soldier_cards() -> void:
    _update_card(infantry_hire_btn, "infantry")
    _update_card(archer_hire_btn, "archer")

func _update_card(button: Button, soldier_type: String) -> void:
    var data := SOLDIER_DATA[soldier_type]
    var cost: int = data.cost
    var can_afford := GameState.can_afford(cost)
    var has_room := can_hire()

    if not has_room:
        button.text = "ROSTER FULL"
        button.disabled = true
    elif not can_afford:
        button.text = "HIRE - %d GOLD" % cost
        button.disabled = true
        # TODO: Add red color to cost
    else:
        button.text = "HIRE - %d GOLD" % cost
        button.disabled = false

func _update_owned_roster_display() -> void:
    # Clear existing icons
    for child in owned_icons.get_children():
        child.queue_free()

    # Add icons for owned soldiers
    var soldiers := GameState.get_soldiers()
    var max_cap := get_max_capacity()

    for i in range(max_cap):
        var icon := TextureRect.new()
        icon.custom_minimum_size = Vector2(40, 40)
        if i < soldiers.size():
            # Show soldier icon based on type
            icon.modulate = _get_soldier_color(soldiers[i])
        else:
            # Show empty slot
            icon.modulate = Color(0.3, 0.3, 0.3, 0.5)
        owned_icons.add_child(icon)

func _get_soldier_color(soldier_type: String) -> Color:
    match soldier_type:
        "infantry": return Color("#2ecc71")
        "archer": return Color("#9b59b6")
    return Color.WHITE

func _hire_soldier(soldier_type: String) -> void:
    var data := SOLDIER_DATA[soldier_type]
    var cost: int = data.cost

    if not GameState.can_afford(cost):
        _play_denied_feedback(soldier_type)
        return

    if not can_hire():
        _play_denied_feedback(soldier_type)
        return

    # Execute purchase
    if GameState.spend_gold(cost):
        GameState.add_soldier(soldier_type)
        _play_success_feedback(soldier_type)
        soldier_hired.emit(soldier_type)
        _refresh_display()

func _play_success_feedback(soldier_type: String) -> void:
    var card := infantry_card if soldier_type == "infantry" else archer_card
    var tween := create_tween()
    tween.tween_property(card, "modulate", Color(0.5, 1.0, 0.5), 0.15)
    tween.tween_property(card, "modulate", Color.WHITE, 0.15)
    print("[Recruitment] Hired %s" % soldier_type)

func _play_denied_feedback(soldier_type: String) -> void:
    var card := infantry_card if soldier_type == "infantry" else archer_card
    var original_pos := card.position
    var tween := create_tween()
    tween.tween_property(card, "position:x", original_pos.x + 10, 0.05)
    tween.tween_property(card, "position:x", original_pos.x - 10, 0.05)
    tween.tween_property(card, "position:x", original_pos.x, 0.05)
    print("[Recruitment] Cannot hire %s - insufficient gold or capacity" % soldier_type)

# ===== SIGNAL HANDLERS =====
func _on_hire_infantry() -> void:
    _hire_soldier("infantry")

func _on_hire_archer() -> void:
    _hire_soldier("archer")

func _on_back_pressed() -> void:
    back_pressed.emit()

func _on_gold_changed(_new_amount: int) -> void:
    _refresh_display()
```

#### GameState Extensions (game_state.gd)
Add soldier roster tracking to existing GameState autoload:

```gdscript
# Add to existing game_state.gd

# ===== SOLDIER ROSTER =====
var soldiers: Array[String] = []  # ["infantry", "archer", "infantry"]

signal soldiers_changed()

func add_soldier(soldier_type: String) -> void:
    ## Add a soldier to the roster
    soldiers.append(soldier_type)
    soldiers_changed.emit()
    print("[GameState] Soldier added: %s (Total: %d)" % [soldier_type, soldiers.size()])

func remove_soldier(soldier_type: String) -> bool:
    ## Remove first matching soldier from roster (for deaths)
    var idx := soldiers.find(soldier_type)
    if idx >= 0:
        soldiers.remove_at(idx)
        soldiers_changed.emit()
        print("[GameState] Soldier removed: %s (Total: %d)" % [soldier_type, soldiers.size()])
        return true
    return false

func get_soldiers() -> Array[String]:
    ## Get copy of current soldier roster
    return soldiers.duplicate()

func get_soldier_count() -> int:
    ## Get total soldiers owned
    return soldiers.size()

func get_soldier_count_by_type(soldier_type: String) -> int:
    ## Get count of specific soldier type
    return soldiers.count(soldier_type)

func clear_soldiers() -> void:
    ## Remove all soldiers (for game reset)
    soldiers.clear()
    soldiers_changed.emit()
```

### Integration Points

| System | Integration |
|--------|-------------|
| **GameState** | Read/write gold, read/write soldier roster, check upgrades |
| **Hub** | Navigation button, SubScreenContainer display |
| **Fort Management** | Barracks upgrade affects capacity |
| **Combat (CombatManager)** | Spawn soldiers at battle start |
| **Save/Load** | Soldier roster saved in game state |
| **Unit Death** | Remove soldier from roster on death |

### Signals
- `soldier_hired(soldier_type: String)` - Emitted when player successfully hires a soldier
- `back_pressed` - Emitted when player clicks back button
- `GameState.soldiers_changed` - Emitted when roster changes

### Combat Integration
The combat system needs to spawn owned soldiers:

```gdscript
# In combat setup (e.g., contract scene or CombatManager)
func _spawn_player_soldiers() -> void:
    var soldiers := GameState.get_soldiers()
    var spawn_positions := _get_soldier_spawn_positions()

    for i in range(min(soldiers.size(), spawn_positions.size())):
        var soldier_type := soldiers[i]
        var spawn_pos := spawn_positions[i]
        _spawn_soldier_unit(soldier_type, spawn_pos)

func _spawn_soldier_unit(soldier_type: String, grid_pos: Vector2i) -> Unit:
    var scene: PackedScene
    match soldier_type:
        "infantry":
            scene = preload("res://scenes/combat/units/InfantrySoldier.tscn")
        "archer":
            scene = preload("res://scenes/combat/units/ArcherSoldier.tscn")

    var unit := scene.instantiate() as Unit
    unit.place_on_grid(grid_pos)
    # Connect death signal to remove from roster
    unit.unit_died.connect(func(): GameState.remove_soldier(soldier_type))
    return unit
```

### Configuration
Constants defined in recruitment.gd:

```gdscript
const SOLDIER_DATA := {
    "infantry": {
        "name": "Infantry",
        "cost": 50,
        "hp": 20,
        "atk": "1d6+1",
        "defense": 13,
        "movement": 4,
        "description": "Reliable melee fighters",
    },
    "archer": {
        "name": "Archer",
        "cost": 100,
        "hp": 15,
        "atk": "1d6",
        "defense": 11,
        "movement": 5,
        "range": 8,
        "description": "Deadly at range, fragile up close",
    }
}

const BASE_CAPACITY := 4
const BARRACKS_BONUS := 4
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Recruitment screen accessible from hub navigation
- [ ] Both soldier types (Infantry, Archer) displayed with full stats
- [ ] Current gold displayed in header
- [ ] Roster capacity displayed as visual bar and text (e.g., "2/4 SOLDIERS")
- [ ] Clicking "HIRE" with sufficient gold and capacity adds soldier to roster
- [ ] Gold is correctly deducted after hiring
- [ ] Roster display updates immediately after hiring
- [ ] Cannot hire when roster is at capacity
- [ ] Cannot hire when gold is insufficient
- [ ] Barracks upgrade correctly increases capacity from 4 to 8
- [ ] Hired soldiers persist in GameState across scenes
- [ ] Hired soldiers appear in combat encounters
- [ ] Soldier death in combat removes them from roster

---

## Testing Checklist

### Functional Tests
- [ ] Screen loads without errors when accessed from hub
- [ ] Both soldier cards render with correct stats
- [ ] Gold display shows correct current value
- [ ] Capacity bar shows correct fill level
- [ ] Hire button works for Infantry (50g deducted)
- [ ] Hire button works for Archer (100g deducted)
- [ ] Roster counter increments after hire
- [ ] Back button navigates to hub

### Edge Case Tests
- [ ] Cannot hire when gold is 49 (Infantry costs 50)
- [ ] Can hire when gold is exactly 50 (Infantry)
- [ ] Cannot hire when roster is 4/4 (no Barracks)
- [ ] Cannot hire when roster is 8/8 (with Barracks)
- [ ] Capacity updates immediately when Barracks is purchased
- [ ] Hiring with 0 soldiers shows first soldier correctly

### Integration Tests
- [ ] GameState.soldiers array updated correctly
- [ ] GameState.gold updated correctly
- [ ] Soldiers spawn in combat after hiring
- [ ] Soldier death removes from GameState.soldiers
- [ ] Barracks upgrade detected (has_upgrade check)
- [ ] Save/load preserves soldier roster

### Polish Tests
- [ ] Hover effects work on soldier cards
- [ ] Success animation plays on hire
- [ ] Denied animation plays when clicking unaffordable
- [ ] Denied animation plays when roster full
- [ ] UI updates immediately after hire (no delay)
- [ ] Capacity bar animates on change

---

## Implementation Notes

### Approach
- Follow existing hub sub-screen pattern (similar to FortManagement)
- Store soldier roster as Array[String] in GameState for simplicity
- Use string identifiers ("infantry", "archer") that map to scenes
- Capacity check should query GameState.has_upgrade("barracks")

### Gotchas
- Ensure gold display updates when returning from combat (may have earned more)
- Soldier death in combat must update roster immediately
- If player dismisses soldiers manually (future feature), need confirmation
- Spawning soldiers in combat requires spawn position management
- Save/load must include soldiers array

### Relationship to Fort Management
- Recruitment and Fort Management are separate screens
- Barracks upgrade in Fort Management increases recruitment capacity
- Could potentially combine into single "Barracks" screen in future
- Keep separate for cleaner separation of concerns in prototype

### Future Enhancements (Out of Scope)
- Soldier quality tiers (Veteran Infantry, Elite Archer)
- Soldier names and individual stats
- Soldier equipment upgrades
- Dismissing soldiers for partial gold refund
- Soldier healing/recovery after combat
- Tavern upgrade affecting recruit quality (per GDD)

---

## Files

**New Files:**
- `scenes/hub/Recruitment.tscn` - Recruitment screen scene
- `scripts/hub/recruitment.gd` - Screen controller script

**Modified Files:**
- `scripts/autoload/game_state.gd` - Add soldiers array and roster methods
- `scenes/hub/Hub.tscn` - Add Recruitment/Barracks button to navigation
- `scripts/hub/hub.gd` - Add Recruitment screen navigation handler
- Contract scenes - Update to spawn owned soldiers in combat
