# Task 2.16: Combat Map - Forest Clearing

**Status:** üü¢ Implemented
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 1.5 hours
**Dependencies:** Task 2.12 (cover and high ground system)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The prototype currently uses a procedurally generated test grid with scattered terrain. A proper combat map demonstrates how terrain creates tactical puzzles. The Forest Clearing map establishes the template for all future combat maps - how terrain is placed, how spawn points work, and how the map supports interesting tactical decisions. The GDD emphasizes "use terrain, flank, set up ambushes" - this map must create those opportunities.

**What does it enable?**
- First "real" combat map with intentional terrain layout
- Trees provide cover for advancing infantry
- Stream creates a tactical divide (difficult terrain costs double movement)
- Defined spawn zones ensure consistent battle setup
- Sets template for creating additional maps (Ruined Fort, etc.)
- Tests whether terrain placement creates meaningful tactical decisions

**Success criteria:**
- Map renders with visually distinct terrain types (grass, trees, stream)
- Trees provide +2 Defense cover bonus (uses existing Task 2.12 system)
- Stream tiles cost double movement to traverse
- Party spawns at south end, enemies spawn at north end
- Battle feels tactically interesting with positioning decisions

---

## How It Works

### Overview

The Forest Clearing is a 12x12 combat map representing a woodland clearing crossed by a stream. The map is designed to create tactical choices: the stream divides the battlefield, forcing players to either cross the difficult terrain or go around. Trees on both flanks provide cover for units to advance safely. A raised area (high ground) overlooks the clearing.

The map uses the existing CombatGrid system but extends it with a new "difficult terrain" tile type (stream) that costs double movement. The map is defined as a separate scene that can be loaded into combat encounters, replacing the default procedural grid.

### Map Layout

```
    0   1   2   3   4   5   6   7   8   9  10  11
  +---+---+---+---+---+---+---+---+---+---+---+---+
0 | E | E | E |   | H | H |   |   | E | E | E |   |  <- Enemy spawn zone
  +---+---+---+---+---+---+---+---+---+---+---+---+
1 | T |   |   |   |   |   |   |   |   |   |   | T |
  +---+---+---+---+---+---+---+---+---+---+---+---+
2 |   | T |   |   |   |   |   |   |   |   | T |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
3 |   |   |   | ~ | ~ | ~ | ~ | ~ | ~ |   |   |   |  <- Stream (difficult terrain)
  +---+---+---+---+---+---+---+---+---+---+---+---+
4 |   | T |   | ~ |   |   |   |   | ~ |   | T |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
5 |   |   |   | ~ |   |   |   |   | ~ |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
6 |   |   |   | ~ |   |   |   |   | ~ |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
7 |   | T |   |   |   |   |   |   |   |   | T |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
8 |   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
9 | T |   |   |   |   |   |   |   |   |   |   | T |
  +---+---+---+---+---+---+---+---+---+---+---+---+
10|   | T |   |   |   |   |   |   |   |   | T |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
11| P | P | P |   |   |   |   |   | P | P | P |   |  <- Party spawn zone
  +---+---+---+---+---+---+---+---+---+---+---+---+

Legend:
  (blank) = Walkable grass
  T = Tree (cover tile, +2 Defense)
  ~ = Stream (difficult terrain, double movement cost)
  H = High ground (elevated rock, +2 ranged attack)
  E = Enemy spawn point
  P = Party spawn point
```

### User Flow

```
BATTLE START:
1. Combat scene loads ForestClearing map
2. Party units placed at party spawn points (Y=11)
3. Enemy units placed at enemy spawn points (Y=0)
4. Player sees the map with distinct terrain
5. Battle proceeds using standard turn system

TACTICAL DECISIONS:
- "Do I send my infantry through the trees for cover, or around the stream?"
- "Should Lyra take the high ground for +2 ranged attacks?"
- "The enemy archer is on high ground - I need to dislodge them"
- "Crossing the stream will slow me down - the enemy will get extra attacks"
```

### Rules & Constraints

- **Map Size:** 12 x 12 tiles (standard combat grid)
- **Trees (Cover):** 10 trees placed on flanks, provide +2 Defense
- **Stream (Difficult Terrain):** 2-tile wide band, costs 2 movement per tile
- **High Ground:** 2 tiles overlooking the clearing, +2 ranged attack
- **Spawn Points:** 6 party spawn points (south), 6 enemy spawn points (north)
- **Obstacles:** None (all terrain is traversable, some just costs more)

### Edge Cases

- **Stream + Unit:** Units can stand in stream (no combat penalty, just movement cost)
- **Diagonal Stream Crossing:** Diagonal movement through stream still costs double
- **Pathfinding:** Pathfinding respects difficult terrain costs
- **Flying Units (future):** Would ignore difficult terrain (not implemented in prototype)
- **Spawn Point Occupied:** If spawn point blocked, find nearest valid tile
- **AI Pathfinding:** Enemy AI considers difficult terrain when pathfinding

---

## User Interaction

### Controls

| Input | Action |
|-------|--------|
| Hover tile | Show terrain info tooltip (cover/high ground/difficult terrain) |
| Click to move | Path preview shows movement cost accounting for difficult terrain |
| Select enemy spawn | (Editor only) Place enemies at spawn points |

### Visual Feedback

- **Grass Tiles:** Standard green walkable tiles
- **Tree Tiles:** Darker green with tree/foliage icon overlay (cover indicator)
- **Stream Tiles:** Blue-tinted tiles with wave pattern
- **High Ground:** Tan/brown elevated tiles with up-arrow icon
- **Spawn Points:** (Debug only) Colored highlights showing spawn zones

### Audio Feedback (if applicable)

- Water/stream ambient sound when hovering stream tiles (optional polish)
- Footstep variation when moving through stream (optional polish)

---

## Visual Design

### Layout

```
FOREST CLEARING MAP - Visual Composition:

+------------------------------------------+
|   [Trees]          [High Ground]         |
|     |||                ###               |
|     |||              [Enemy Spawn]       |
|                                          |
|   [Trees]  ~~~~~~~~~~~~~~~~~~~~~~~~      |
|     |||    ~      STREAM         ~       |
|            ~~~~~~~~~~~~~~~~~~~~~~~~      |
|   [Trees]                                |
|     |||                                  |
|            [Open Clearing]               |
|                                          |
|   [Trees]          [Party Spawn]         |
|     |||                                  |
+------------------------------------------+
```

### Components

- **Base Terrain:** Green grass tiles (existing TILE_WALKABLE)
- **Cover Terrain:** Dark green tree tiles (existing TILE_COVER)
- **High Ground:** Tan/brown elevated tiles (existing TILE_HIGH_GROUND)
- **Difficult Terrain:** New blue stream tiles (new TILE_DIFFICULT)
- **Spawn Markers:** (Debug) Colored circles indicating spawn points

### Visual Style

- **Grass Color:** `#4a6741` (existing walkable color)
- **Tree Color:** `#3d5636` (existing cover color)
- **Stream Color:** `#3498db` with 30% blue tint (new)
- **Stream Border:** `#2980b9` (darker blue)
- **High Ground Color:** `#8b7355` (existing)

### States

- **Default:** All terrain visible with appropriate colors
- **Movement Preview:** Valid move tiles highlighted, path shows through difficult terrain
- **Unit on Stream:** Unit sprite may have subtle blue tint (optional)

---

## Technical Implementation

### Scene Structure

```
scenes/combat/maps/ForestClearing.tscn
‚îú‚îÄ‚îÄ ForestClearing (Node2D) - Root node with map script
‚îÇ   ‚îî‚îÄ‚îÄ CombatGrid (existing) - Uses modified combat_grid.gd
‚îÇ       ‚îú‚îÄ‚îÄ TileMapLayer - Renders the tiles
‚îÇ       ‚îú‚îÄ‚îÄ MovementOverlay - Shows valid moves
‚îÇ       ‚îú‚îÄ‚îÄ PathPreview - Shows movement path
‚îÇ       ‚îî‚îÄ‚îÄ AttackRangeOverlay - Shows attack range

Alternative: Map data could be stored in a resource file
resources/maps/forest_clearing.tres
‚îú‚îÄ‚îÄ map_width: 12
‚îú‚îÄ‚îÄ map_height: 12
‚îú‚îÄ‚îÄ tile_data: Array of tile types
‚îú‚îÄ‚îÄ party_spawn_points: Array[Vector2i]
‚îî‚îÄ‚îÄ enemy_spawn_points: Array[Vector2i]
```

### Script Responsibilities

**combat_grid.gd (modify):**
- Add `TILE_DIFFICULT: int = 5` constant for difficult terrain
- Add `COLOR_DIFFICULT` and `COLOR_DIFFICULT_BORDER` for stream tiles
- Add `is_difficult_terrain(coords)` method
- Add `get_movement_cost(coords)` method (returns 1 or 2)
- Modify `_create_tile_atlas_texture()` to include difficult terrain tile
- Add `load_map_data(map_resource)` method to load terrain from resource

**pathfinding.gd (modify):**
- Modify `get_path()` to account for tile movement costs
- Modify `_calculate_cost()` to check `grid.get_movement_cost()`

**combat_manager.gd (modify):**
- Add `spawn_party_at_points(spawn_points: Array[Vector2i])`
- Add `spawn_enemies_at_points(spawn_points: Array[Vector2i])`
- Add `load_combat_map(map_name: String)`

**forest_clearing.gd (create):**
- Static class or resource that defines the Forest Clearing map
- `get_tile_data() -> Array` returns the full tile layout
- `get_party_spawn_points() -> Array[Vector2i]`
- `get_enemy_spawn_points() -> Array[Vector2i]`

### Integration Points

- **Connects to:**
  - `CombatGrid` - Loads terrain data into grid
  - `Pathfinding` - Uses movement cost for path calculation
  - `CombatManager` - Uses spawn points for unit placement
  - `AttackResolver` - Cover/high ground bonuses (existing)

- **Listens for:**
  - Nothing new - map is data that gets loaded at combat start

- **Modifies:**
  - `CombatGrid._grid_data` - Populated with map terrain
  - Unit starting positions based on spawn points

### Configuration

**New Tile Type (combat_grid.gd):**
```gdscript
const TILE_DIFFICULT: int = 5  # Difficult terrain (stream, mud, etc.)
const DIFFICULT_TERRAIN_COST: int = 2  # Movement cost multiplier

const COLOR_DIFFICULT: Color = Color("#3498db")  # Blue for water
const COLOR_DIFFICULT_BORDER: Color = Color("#2980b9")
```

**Map Data Structure:**
```gdscript
# Forest Clearing map definition
const FOREST_CLEARING_DATA: Dictionary = {
    "name": "Forest Clearing",
    "width": 12,
    "height": 12,
    "tiles": [
        # Row 0 (north - enemy side)
        [0, 0, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0],
        # Row 1
        [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
        # ... (full 12x12 grid)
    ],
    "party_spawns": [
        Vector2i(0, 11), Vector2i(1, 11), Vector2i(2, 11),
        Vector2i(8, 11), Vector2i(9, 11), Vector2i(10, 11)
    ],
    "enemy_spawns": [
        Vector2i(0, 0), Vector2i(1, 0), Vector2i(2, 0),
        Vector2i(8, 0), Vector2i(9, 0), Vector2i(10, 0)
    ]
}
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Forest Clearing map loads and renders correctly
- [ ] Trees (8-10 tiles) display with cover icon and provide +2 Defense
- [ ] Stream (2-tile wide band) displays with blue color
- [ ] Stream tiles cost 2 movement instead of 1
- [ ] High ground tiles (2) provide +2 ranged attack bonus
- [ ] Party units spawn at south spawn points
- [ ] Enemy units spawn at north spawn points
- [ ] Pathfinding correctly accounts for difficult terrain cost
- [ ] Movement preview shows correct range accounting for stream
- [ ] Map creates interesting tactical decisions during combat

---

## Testing Checklist

### Functional Tests

- [ ] **Map Rendering:** Forest Clearing loads with correct terrain layout
- [ ] **Cover Bonus:** Unit on tree tile receives +2 Defense
- [ ] **High Ground Bonus:** Ranged unit on high ground receives +2 attack
- [ ] **Difficult Terrain Cost:** Moving through stream costs double movement
- [ ] **Spawn Points:** Party spawns at Y=11, enemies at Y=0
- [ ] **Pathfinding:** AI correctly navigates around/through stream

### Edge Case Tests

- [ ] **Stream + Cover:** No tile should be both stream and cover (invalid combo)
- [ ] **Diagonal Stream:** Diagonal movement through stream still costs 2
- [ ] **Path Through Stream:** Path preview correctly shows cost through stream
- [ ] **All Spawns Used:** 6 party + 6 enemy units spawn correctly
- [ ] **Overflow Spawns:** Extra units find nearest valid spawn tile

### Integration Tests

- [ ] **With Enemy AI:** Enemies navigate around stream intelligently
- [ ] **With Soldier AI:** Soldiers respect difficult terrain costs
- [ ] **With Attack System:** Cover and high ground bonuses apply correctly
- [ ] **With Turn System:** Normal turn flow with map loaded

### Visual Tests

- [ ] **Terrain Clarity:** Each terrain type is visually distinct
- [ ] **Movement Preview:** Shows correct tiles reachable with stream cost
- [ ] **Tile Tooltips:** Hovering shows "Difficult Terrain" for stream tiles

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **New Tile Type:** The difficult terrain (stream) requires a 6th tile type in the tileset. Extend `_create_tile_atlas_texture()` to create a blue water tile with wave icon.

2. **Movement Cost Integration:** The pathfinding system needs to query tile movement cost. Currently assumes cost=1 for all walkable tiles. Add `get_movement_cost(coords)` that returns 2 for difficult terrain.

3. **Map Loading Pattern:** Rather than hardcoding the map in `_generate_default_grid()`, create a map data structure that can be loaded. This sets up the pattern for future maps (Ruined Fort, etc.).

4. **Spawn Point System:** Spawn points should be stored as part of map data. The CombatManager queries these when setting up combat.

5. **Visual Polish:** The stream tiles should have a distinct wave/water pattern icon, similar to how cover tiles have a shield icon.

### Integration with Existing Code

Current `_generate_default_grid()` in combat_grid.gd hardcodes terrain placement:
```gdscript
func _generate_default_grid() -> void:
    # Fill with walkable tiles
    for x in range(GRID_WIDTH):
        for y in range(GRID_HEIGHT):
            _set_tile(Vector2i(x, y), TILE_WALKABLE)
    # Add some obstacles, cover, high ground...
```

Should become:
```gdscript
func load_map(map_data: Dictionary) -> void:
    # Clear existing
    clear_grid()

    # Load tiles from map data
    for y in range(map_data.height):
        for x in range(map_data.width):
            var tile_type = map_data.tiles[y][x]
            _set_tile(Vector2i(x, y), tile_type)

    print("[CombatGrid] Loaded map: %s" % map_data.name)
```

### Pathfinding Cost Modification

Current pathfinding assumes uniform cost. Modify to:
```gdscript
func _calculate_cost(from: Vector2i, to: Vector2i) -> float:
    var base_cost = 1.0
    if _is_diagonal(from, to):
        base_cost = 1.5

    # Task 2.16: Account for difficult terrain
    var terrain_cost = _combat_grid.get_movement_cost(to)
    return base_cost * terrain_cost
```

### Alternative Approaches Considered

1. **Separate Scene per Map:** Each map as its own .tscn file. Rejected - too much duplication, harder to maintain.

2. **JSON Map Files:** Store maps as external JSON. Could work but adds file I/O complexity. Simpler to use GDScript dictionaries for prototype.

3. **TileMap Editor:** Use Godot's TileMap editor to paint maps visually. Would be nice but requires more asset setup. Programmatic approach is faster for prototype.

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| Map Size | 12 x 12 | Standard combat grid size |
| Tree Count | 10 | Scattered on flanks |
| Stream Width | 2 tiles | Runs north-south in center-west |
| High Ground Tiles | 2 | Overlooking clearing from north |
| Party Spawn Points | 6 | Y=11 (south edge) |
| Enemy Spawn Points | 6 | Y=0 (north edge) |
| Difficult Terrain Cost | 2x | Double movement cost |
| Stream Color | #3498db | Blue tint |
| Stream Border | #2980b9 | Darker blue |

---

## Asset Requirements

### New Tile Graphics

1. **Difficult Terrain Tile (Stream)**
   - Size: 64x64 pixels
   - Color: Blue (#3498db) with darker border (#2980b9)
   - Icon: Wave/water pattern overlay at 60% opacity

### No External Assets Required

All graphics generated programmatically using the existing tile drawing system in combat_grid.gd.

### Future Polish (Out of Scope)

- Water animation (subtle wave movement)
- Splash particle effects when units enter stream
- Ambient water sound effects

---
