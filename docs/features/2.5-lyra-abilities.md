# Feature Spec: Lyra Abilities

| Property | Value |
|----------|-------|
| **Feature ID** | 2.5 |
| **Status** | üî¥ Planned |
| **Priority** | ‚¨ÜÔ∏è High |
| **Estimated Time** | 2 hours |
| **Phase** | Phase 2: Abilities & Party Interaction |
| **Dependencies** | Task 2.3 (Player Abilities - ability system exists) |

---

## 1. Purpose

### Why This Feature Exists

Lyra Swiftblade is the party's rogue - a flanker and priority target assassin who excels at repositioning and dealing massive damage from unexpected angles. Her abilities define a distinct hit-and-run playstyle focused on mobility, positioning for advantage, and sustained damage output. Without Lyra's abilities, she would be just another fragile melee unit rather than the "shadow striker" fantasy the GDD describes. This feature directly supports the **Tactical Combat** pillar by rewarding smart positioning and target prioritization.

### What It Enables

- **Backstab**: High-risk, high-reward positional damage - rewards flanking maneuvers
- **Shadowstep**: Instant repositioning - enables hit-and-run tactics, escape from danger
- **Poison Blade**: Sustained damage buff - makes every attack count for multiple turns
- Foundation for assassin/flanker tactical role in party composition
- Visible demonstration that Lyra plays completely differently from Thorne
- Tests the ability system with positional requirements, teleportation, and attack-count buffs

### Success Criteria

| Criterion | Measurement |
|-----------|-------------|
| Backstab doubles damage | Deals 2x damage when attacking from behind target |
| Behind detection works | System correctly identifies attacker behind target based on facing |
| Shadowstep teleports | Lyra instantly moves up to 4 tiles without pathfinding |
| Shadowstep ignores obstacles | Can teleport over enemies and blocked tiles |
| Poison Blade buffs attacks | Next 3 attacks deal +2 damage each |
| Abilities visible | All 4 abilities appear in Lyra's ability bar |
| Strategic impact | Playtesters use Lyra to flank and assassinate priority targets |

---

## 2. Design Pillar Alignment

| Pillar | How This Feature Supports It |
|--------|------------------------------|
| **Tactical Combat** | Lyra's abilities create tactical decisions: How do I get behind that enemy? Should I Shadowstep now or save it for escape? Poison Blade before a big fight? Each ability rewards planning and positioning. |
| **Build & Command** | Lyra fills the "assassin" role in the mercenary company. Her abilities make her essential for eliminating archers, mages, and enemy leaders. This reinforces party composition strategy - Thorne holds the line while Lyra flanks. |
| **Meaningful Choice** | Using Shadowstep offensively leaves Lyra vulnerable. Backstab requires setup time. Poison Blade is wasted if combat ends quickly. Each ability involves meaningful risk/reward tradeoffs. |
| **Character Progression** | Lyra's abilities reflect her personality: cunning (Backstab - strike from shadows), agility (Shadowstep - impossible mobility), preparation (Poison Blade - plan ahead). |

---

## 3. How It Works

### Overview

Lyra has 4 abilities that define her role as a mobile assassin and flanker:

1. **Basic Attack** - Standard melee attack using her dagger (1d4 + DEX, uses finesse)
2. **Backstab** - Attack with 2x damage if striking from behind the target
3. **Shadowstep** - Teleport up to 4 tiles instantly (no pathfinding, ignores obstacles)
4. **Poison Blade** - Self-buff: next 3 attacks deal +2 bonus damage

All abilities except Basic Attack can only be used once per battle. Backstab and Poison Blade end the turn when used. Shadowstep does NOT end the turn (enabling hit-and-run).

### User Flow

```
BACKSTAB FLOW:
1. Player selects Lyra (her turn)
2. Player positions Lyra behind an enemy (manually move first if needed)
3. Click Backstab ability in ability bar
4. Valid targets highlighted (adjacent enemies, with "behind" indicator)
5. Click an adjacent enemy
6. System checks: Is Lyra behind target?
7. If YES: Attack roll with 2x damage multiplier
8. If NO: Normal attack (no bonus, ability still consumed)
9. Damage numbers appear (larger/different color for backstab)
10. Backstab marked as used (grayed out)
11. Turn ends

SHADOWSTEP FLOW:
1. Player selects Lyra (her turn)
2. Click Shadowstep ability in ability bar
3. Valid destination tiles highlighted (up to 4 tiles away, any direction)
4. Tiles highlight even if blocked/occupied by enemies (teleport ignores obstacles)
5. Cannot teleport to occupied tiles (must be empty)
6. Click valid empty tile
7. Lyra instantly appears at destination (poof effect at start and end)
8. Shadowstep marked as used (grayed out)
9. Turn CONTINUES (can still attack/move after Shadowstep)

POISON BLADE FLOW:
1. Player selects Lyra (her turn)
2. Click Poison Blade ability in ability bar
3. No targeting needed - activates immediately on self
4. Visual effect: Green glow on Lyra's weapon
5. Status effect applied: "Poisoned Blade (3 attacks remaining)"
6. For next 3 attacks, each deals +2 bonus damage
7. Counter decrements after each attack
8. Effect persists across turns until 3 attacks used
9. Poison Blade marked as used (grayed out)
10. Turn ends
```

### Rules & Constraints

| Rule | Description |
|------|-------------|
| Backstab requires adjacency | Lyra must be adjacent to target |
| Backstab requires "behind" | Target must be facing away from Lyra |
| Behind = opposite facing | If enemy faces North, Lyra must be South of them |
| Backstab consumes on use | Even if positioning is wrong, ability is spent |
| Shadowstep range is 4 tiles | Chebyshev distance (diagonal = 1 tile) |
| Shadowstep ignores obstacles | Can teleport over walls, enemies, pits |
| Shadowstep requires empty destination | Cannot teleport onto occupied tile |
| Shadowstep doesn't end turn | Lyra can attack after teleporting |
| Poison Blade is self-only | No targeting, instant activation |
| Poison Blade lasts 3 attacks | Not 3 turns - specifically 3 attack actions |
| Poison Blade stacks with other damage | Adds to base, multiplied by backstab |
| Abilities once per battle | Backstab, Shadowstep, Poison Blade each usable once |

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Backstab from side (not behind) | Normal attack damage, ability consumed |
| Backstab with Poison Blade active | 2x damage + 2 (Poison applied before multiplier) |
| Shadowstep to current tile | Invalid, cannot select current position |
| Shadowstep blocked by walls in path | Still works - teleport ignores path |
| Shadowstep to tile 5 tiles away | Invalid, out of range |
| Poison Blade with 0 attacks remaining | Effect removed, no bonus |
| Lyra dies with Poison Blade active | Effect lost (no carry-over) |
| Multiple enemies facing same direction | Each valid for backstab from behind |
| Enemy with no facing (future: isometric) | Default facing based on last movement |
| Backstab on stunned enemy | Works normally, stunned enemy still has facing |

---

## 4. User Interaction

### Controls

| Input | Action | Context |
|-------|--------|---------|
| Click Backstab button | Enter melee targeting mode | Lyra selected, adjacent enemies exist |
| Click adjacent enemy | Execute Backstab | Targeting mode, enemy adjacent |
| Click Shadowstep button | Enter teleport targeting mode | Lyra selected |
| Click valid tile | Execute Shadowstep | Teleport mode, tile in range and empty |
| Click Poison Blade button | Activate buff immediately | Lyra selected |
| Right-click / ESC | Cancel ability selection | Any targeting mode |

### Visual Feedback

| Event | Visual |
|-------|--------|
| Backstab targeting | Adjacent enemies highlighted, "behind" indicator on valid targets |
| Behind indicator | Dagger icon or directional arrow showing optimal position |
| Backstab execution | Quick slash animation, larger damage numbers |
| Backstab bonus damage | Purple/different color damage numbers for bonus |
| Shadowstep targeting | 4-tile radius highlighted around Lyra |
| Valid teleport tiles | Green highlight for empty tiles in range |
| Invalid teleport tiles | Red/dimmed for occupied tiles |
| Shadowstep execution | Smoke puff at start, Lyra disappears, smoke puff at destination, Lyra appears |
| Poison Blade activation | Green particles around Lyra's weapon |
| Poison Blade active | Persistent green glow on weapon, counter in status area |
| Poison Blade hit | Green damage numbers or poison icon with damage |

### Audio Feedback (Future)

| Event | Sound |
|-------|-------|
| Backstab hit | Sharp stabbing sound |
| Backstab bonus | Additional "critical" flourish |
| Shadowstep start | Whoosh/vanish sound |
| Shadowstep end | Reappear/materialize sound |
| Poison Blade activation | Liquid/coating sound |
| Poison Blade hit | Sizzle/poison hiss |

*Note: Audio is out of scope for prototype but noted for future.*

---

## 5. Visual Design

### Backstab Position Detection

```
Enemy Facing Direction Examples:

Enemy facing NORTH (up):
      [N]
       |
   W---E---E    <- Backstab valid from SOUTH (below enemy)
       |
      [S] <- LYRA HERE = BACKSTAB

Enemy facing EAST (right):
       [N]
        |
   W--->E   <- Enemy faces right
        |
       [S]

   LYRA HERE = BACKSTAB (West of enemy)

The 8 directions (for grid):
- N, NE, E, SE, S, SW, W, NW
- "Behind" = 180 degrees from facing (opposite)
```

### Shadowstep Range Indicator

```
Range = 4 tiles (Chebyshev distance)

        . . . . .
      . . . . . . .
    . . . . . . . . .
  . . . . . . . . . . .
. . . . . [L] . . . . . .  <- L = Lyra, . = valid tiles
  . . . . . . . . . . .
    . . . . . . . . .
      . . . . . . .
        . . . . .

Note: All tiles within 4 steps (including diagonal) are valid
      Occupied tiles show as red/invalid
```

### Status Effect Display

| Icon | Meaning | Position |
|------|---------|----------|
| Poison vial | Poison Blade active (with counter: 3, 2, 1) | Above Lyra HP bar |
| Dagger with shadow | Backstab used | Ability bar (grayed) |
| Smoke cloud | Shadowstep used | Ability bar (grayed) |

### Color Scheme

| Element | Color |
|---------|-------|
| Backstab valid target | Purple (#8e44ad) highlight |
| Backstab "behind" indicator | Bright purple (#9b59b6) |
| Backstab damage numbers | Purple (#9b59b6) |
| Shadowstep range | Blue (#3498db) at 30% opacity |
| Shadowstep valid tile | Green (#27ae60) |
| Shadowstep invalid tile | Red (#e74c3c) at 50% opacity |
| Poison Blade glow | Green (#27ae60) |
| Poison damage numbers | Green (#2ecc71) |

---

## 6. Technical Implementation

### Ability Resource Structure

**resources/abilities/backstab.tres:**
```gdscript
[gd_resource type="Resource" script_class="Ability"]

[resource]
id = "backstab"
name = "Backstab"
description = "Deal double damage when attacking from behind the target."
icon = "res://assets/sprites/ui/ability_icons/backstab.png"
ability_type = MELEE_ATTACK  # Uses standard melee attack with modifier
target_type = ENEMY_ADJACENT
range = 1
damage_multiplier = 1.0  # Base multiplier (doubled by executor if behind)
uses_per_battle = 1
ends_turn = true
requires_behind = true  # Custom flag for backstab check
```

**resources/abilities/shadowstep.tres:**
```gdscript
[gd_resource type="Resource" script_class="Ability"]

[resource]
id = "shadowstep"
name = "Shadowstep"
description = "Teleport up to 4 tiles, ignoring obstacles."
icon = "res://assets/sprites/ui/ability_icons/shadowstep.png"
ability_type = TELEPORT  # New type for movement abilities
target_type = TILE  # Targets a tile, not a unit
range = 4
uses_per_battle = 1
ends_turn = false  # Key: Can still act after Shadowstep
ignores_obstacles = true
```

**resources/abilities/poison_blade.tres:**
```gdscript
[gd_resource type="Resource" script_class="Ability"]

[resource]
id = "poison_blade"
name = "Poison Blade"
description = "Your next 3 attacks deal +2 bonus damage."
icon = "res://assets/sprites/ui/ability_icons/poison_blade.png"
ability_type = SELF_BUFF
target_type = SELF
applies_status = "POISON_BLADE"
status_duration = 0  # Not turn-based
status_value = 3  # 3 attacks
bonus_damage = 2  # +2 per attack
uses_per_battle = 1
ends_turn = true
```

### Script Responsibilities

**scripts/resources/ability.gd (MODIFY):**
- Add new AbilityType: `TELEPORT`
- Add new TargetType: `TILE`
- Add properties: `requires_behind`, `ignores_obstacles`

**scripts/combat/ability_executor.gd (MODIFY):**
- Add `_execute_backstab(caster, ability, target)` - Check behind, apply multiplier
- Add `_execute_teleport(caster, ability, destination)` - Handle Shadowstep
- Add `_execute_self_buff(caster, ability)` - Handle Poison Blade

**scripts/autoload/status_effect_manager.gd (MODIFY):**
- Add `EFFECT_POISON_BLADE` constant
- Track attack count instead of turns for Poison Blade
- Decrement on attack, not on turn end

**scripts/combat/unit.gd (MODIFY):**
- Add `facing_direction: Vector2i` - Track which way unit is facing
- Add `get_facing_direction()` - Return current facing
- Add `set_facing_direction(dir)` - Update facing (after movement)
- Modify `move_along_path()` to update facing based on movement direction
- Add `is_behind(attacker: Unit)` - Check if attacker is behind this unit
- Modify attack damage calculation to check for Poison Blade effect

**scripts/autoload/combat_manager.gd (MODIFY):**
- Add `get_valid_teleport_tiles(unit, range)` - For Shadowstep targeting
- Add `teleport_unit(unit, destination)` - Execute teleport without pathfinding

### Detailed Implementation: Facing Direction

```gdscript
## In unit.gd

# ===== FACING (Task 2.5) =====
var facing_direction: Vector2i = Vector2i(0, 1)  # Default facing South

func get_facing_direction() -> Vector2i:
    return facing_direction

func set_facing_direction(direction: Vector2i) -> void:
    if direction != Vector2i.ZERO:
        facing_direction = direction.sign()  # Normalize to -1, 0, or 1

func _update_facing_from_movement(from: Vector2i, to: Vector2i) -> void:
    ## Update facing based on movement direction
    var delta = to - from
    if delta != Vector2i.ZERO:
        set_facing_direction(delta)

func is_behind(attacker: Unit) -> bool:
    ## Check if attacker is positioned behind this unit
    var attacker_direction = attacker.grid_position - grid_position

    # Normalize to get direction
    var attack_from = attacker_direction.sign()

    # Behind = opposite of facing direction
    var behind_direction = -facing_direction

    # Check if attacker is in the "behind" zone
    # For 8-direction grid: behind includes the 3 tiles behind
    # Strict: Only directly behind (180 degrees)
    return attack_from == behind_direction
```

### Detailed Implementation: Backstab

```gdscript
## In ability_executor.gd

static func _execute_backstab(user: Unit, ability: Ability, target: Unit) -> Dictionary:
    ## Execute Backstab attack - double damage if behind
    var result = {
        "success": false,
        "damage_dealt": 0,
        "is_backstab": false,
        "targets_affected": [],
        "hit": false,
        "roll": 0,
        "total_attack": 0,
        "message": ""
    }

    if not target or not target.is_alive():
        result.message = "Invalid target"
        return result

    if not AttackResolver.is_adjacent(user, target):
        result.message = "Target not adjacent"
        return result

    result.targets_affected = [target]

    # Check if behind target
    result.is_backstab = target.is_behind(user)
    var damage_multiplier = 2.0 if result.is_backstab else 1.0

    # Standard attack roll
    var attack_bonus = user.get_attack_bonus() + ability.attack_modifier
    result.roll = randi_range(1, 20)
    result.total_attack = result.roll + attack_bonus
    var target_defense = target.get_defense()
    var is_critical = (result.roll == 20)

    result.hit = result.total_attack >= target_defense or is_critical

    if result.hit:
        # Calculate damage
        var base_damage = randi_range(1, user.get_damage_die()) + user.get_damage_modifier()

        # Add Poison Blade bonus if active
        var poison_bonus = user.get_poison_blade_bonus()
        base_damage += poison_bonus

        # Apply backstab multiplier
        var modified_damage = int(base_damage * damage_multiplier)

        if is_critical:
            modified_damage *= 2

        result.damage_dealt = max(1, modified_damage)
        result.success = true

        # Spawn damage number (purple for backstab)
        _spawn_damage_number(target, result.damage_dealt, is_critical, result.is_backstab)

        target.take_damage(result.damage_dealt)

        # Consume Poison Blade charge
        if poison_bonus > 0:
            user.consume_poison_blade_charge()

        if result.is_backstab:
            result.message = "%s BACKSTABS %s for %d damage!" % [
                user.unit_name, target.unit_name, result.damage_dealt
            ]
            print("[Combat] BACKSTAB! %s deals %d damage to %s" % [
                user.unit_name, result.damage_dealt, target.unit_name
            ])
        else:
            result.message = "%s hits %s for %d damage" % [
                user.unit_name, target.unit_name, result.damage_dealt
            ]
    else:
        _spawn_miss_number(target)
        result.message = "%s misses %s" % [user.unit_name, target.unit_name]

    return result
```

### Detailed Implementation: Shadowstep

```gdscript
## In ability_executor.gd

static func _execute_teleport(user: Unit, ability: Ability, destination: Vector2i) -> Dictionary:
    ## Execute teleport ability (Shadowstep)
    var result = {
        "success": false,
        "from_position": user.grid_position,
        "to_position": destination,
        "distance": 0,
        "message": ""
    }

    # Check range
    var distance = CombatManager._calculate_grid_distance(user.grid_position, destination)
    result.distance = distance

    if distance > ability.ability_range:
        result.message = "Destination out of range"
        return result

    if distance == 0:
        result.message = "Already at destination"
        return result

    # Check if destination is occupied
    if CombatManager.is_tile_occupied(destination):
        result.message = "Destination tile occupied"
        return result

    # Execute teleport
    user.teleport_to(destination)
    result.success = true

    result.message = "%s shadowsteps to %s" % [user.unit_name, destination]
    print("[Combat] %s uses Shadowstep: %s -> %s (%d tiles)" % [
        user.unit_name, result.from_position, result.to_position, distance
    ])

    return result
```

### Detailed Implementation: Poison Blade

```gdscript
## In ability_executor.gd

static func _execute_self_buff(user: Unit, ability: Ability) -> Dictionary:
    ## Execute self-buff ability (Poison Blade)
    var result = {
        "success": true,
        "status_applied": ability.applies_status,
        "attacks_remaining": ability.status_value,
        "bonus_damage": ability.bonus_damage,
        "message": ""
    }

    # Apply Poison Blade effect
    user.apply_poison_blade(ability.status_value, ability.bonus_damage)

    result.message = "%s applies %s - next %d attacks deal +%d damage" % [
        user.unit_name,
        ability.display_name,
        ability.status_value,
        ability.bonus_damage
    ]

    print("[Combat] %s uses %s: +%d damage for %d attacks" % [
        user.unit_name, ability.display_name, ability.bonus_damage, ability.status_value
    ])

    return result


## In unit.gd - Poison Blade tracking

var _poison_blade_charges: int = 0
var _poison_blade_damage: int = 0

func apply_poison_blade(attacks: int, bonus_damage: int) -> void:
    ## Apply Poison Blade buff
    _poison_blade_charges = attacks
    _poison_blade_damage = bonus_damage
    print("[Unit] %s Poison Blade active: +%d damage for %d attacks" % [
        unit_name, bonus_damage, attacks
    ])

func get_poison_blade_bonus() -> int:
    ## Get current Poison Blade bonus (0 if not active)
    if _poison_blade_charges > 0:
        return _poison_blade_damage
    return 0

func consume_poison_blade_charge() -> void:
    ## Use one Poison Blade charge
    if _poison_blade_charges > 0:
        _poison_blade_charges -= 1
        print("[Unit] %s Poison Blade: %d charges remaining" % [
            unit_name, _poison_blade_charges
        ])
        if _poison_blade_charges == 0:
            _poison_blade_damage = 0
            print("[Unit] %s Poison Blade expired" % unit_name)
```

### Integration Points

| System | Integration |
|--------|-------------|
| AbilityBar | Shows Backstab, Shadowstep, Poison Blade, Basic Attack |
| AbilityExecutor | Executes Backstab, Shadowstep, Poison Blade logic |
| Unit | Tracks facing direction, Poison Blade charges |
| CombatManager | Provides teleport helpers, tile validity checks |
| CombatGrid | Highlights valid teleport tiles |
| DamageNumber | Shows purple numbers for backstab damage |

### Signals

| Signal | Emitter | Parameters | Purpose |
|--------|---------|------------|---------|
| `ability_executed` | AbilityExecutor | `(caster, ability_id, targets)` | Trigger VFX/SFX |
| `unit_teleported` | CombatManager | `(unit, from, to)` | Trigger teleport VFX |
| `poison_blade_applied` | Unit | `(unit, charges)` | Show buff indicator |
| `poison_blade_consumed` | Unit | `(unit, remaining)` | Update buff counter |

---

## 7. File Structure

```
scripts/
‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îî‚îÄ‚îÄ ability.gd                    # MODIFY: Add TELEPORT type, TILE target
‚îú‚îÄ‚îÄ combat/
‚îÇ   ‚îú‚îÄ‚îÄ ability_executor.gd           # MODIFY: Add Backstab, Shadowstep, Poison Blade
‚îÇ   ‚îî‚îÄ‚îÄ unit.gd                       # MODIFY: Facing, teleport, Poison Blade
‚îî‚îÄ‚îÄ autoload/
    ‚îî‚îÄ‚îÄ combat_manager.gd             # MODIFY: Teleport helpers

resources/
‚îî‚îÄ‚îÄ abilities/
    ‚îú‚îÄ‚îÄ backstab.tres                 # NEW: Backstab ability resource
    ‚îú‚îÄ‚îÄ shadowstep.tres               # NEW: Shadowstep ability resource
    ‚îî‚îÄ‚îÄ poison_blade.tres             # NEW: Poison Blade ability resource

assets/sprites/ui/ability_icons/
‚îú‚îÄ‚îÄ backstab.png                      # NEW: Backstab icon (placeholder)
‚îú‚îÄ‚îÄ shadowstep.png                    # NEW: Shadowstep icon (placeholder)
‚îî‚îÄ‚îÄ poison_blade.png                  # NEW: Poison Blade icon (placeholder)
```

---

## 8. Acceptance Criteria

| # | Criterion | Test Method |
|---|-----------|-------------|
| 1 | Backstab doubles damage from behind | Position Lyra behind enemy, use Backstab |
| 2 | Backstab normal damage if not behind | Position Lyra beside enemy, use Backstab |
| 3 | Behind detection correct for all 8 directions | Test each facing direction |
| 4 | Shadowstep moves without pathfinding | Teleport over blocked tiles |
| 5 | Shadowstep range is exactly 4 tiles | Test at 4, 5 tiles distance |
| 6 | Shadowstep doesn't end turn | Teleport then attack in same turn |
| 7 | Shadowstep cannot target occupied tiles | Try to teleport onto enemy |
| 8 | Poison Blade adds +2 damage | Attack after using Poison Blade |
| 9 | Poison Blade lasts exactly 3 attacks | Count attacks, verify 4th has no bonus |
| 10 | Poison Blade persists across turns | Use, end turn, verify still active |
| 11 | All 4 abilities appear in Lyra's bar | Select Lyra, check bar |
| 12 | Used abilities grayed out | Use Backstab, verify grayed |

---

## 9. Testing Checklist

### Functional Tests - Backstab
- [ ] Backstab available when adjacent to enemy
- [ ] Backstab unavailable with no adjacent enemies
- [ ] Behind detection works for North-facing enemy
- [ ] Behind detection works for South-facing enemy
- [ ] Behind detection works for East-facing enemy
- [ ] Behind detection works for West-facing enemy
- [ ] Behind detection works for diagonal facings
- [ ] Backstab doubles damage when behind
- [ ] Backstab normal damage when beside/front
- [ ] Backstab marked as used after execution
- [ ] Backstab ends Lyra's turn

### Functional Tests - Shadowstep
- [ ] Shadowstep shows 4-tile range indicator
- [ ] Valid empty tiles highlighted
- [ ] Occupied tiles shown as invalid
- [ ] Tiles beyond 4 not selectable
- [ ] Shadowstep teleports instantly (no movement animation)
- [ ] Shadowstep ignores obstacles in path
- [ ] Shadowstep does NOT end turn
- [ ] Can attack after Shadowstep
- [ ] Shadowstep updates unit facing toward destination
- [ ] Shadowstep marked as used after execution

### Functional Tests - Poison Blade
- [ ] Poison Blade activates immediately (no targeting)
- [ ] Visual indicator shows active status
- [ ] Counter shows "3" initially
- [ ] First attack deals +2 damage
- [ ] Counter decrements to "2"
- [ ] Second attack deals +2 damage
- [ ] Counter decrements to "1"
- [ ] Third attack deals +2 damage
- [ ] Counter removed, effect ends
- [ ] Fourth attack has no bonus
- [ ] Effect persists across turns
- [ ] Poison Blade marked as used after activation

### Integration Tests
- [ ] Abilities appear in AbilityBar for Lyra only
- [ ] Backstab + Poison Blade stack correctly (poison + 2x)
- [ ] Facing direction updates after movement
- [ ] Facing direction updates after Shadowstep
- [ ] Damage numbers show correct colors (purple for backstab, green for poison)
- [ ] Turn continues correctly after Shadowstep

### Edge Cases
- [ ] Backstab from exact side (90 degrees) - not behind
- [ ] Shadowstep to tile 0 distance - invalid
- [ ] Shadowstep over pit/wall - works
- [ ] Poison Blade with 0 charges - no effect
- [ ] Enemy facing changes mid-combat - backstab detects new facing
- [ ] Lyra dies with Poison Blade active - effect lost

---

## 10. Implementation Notes

### Approach Rationale

**Why track facing direction?**
- Backstab mechanic requires knowing enemy orientation
- Natural extension: units face the direction they moved
- Enables future abilities that care about facing (flank attacks, etc.)
- Simple implementation: just track last movement direction

**Why does Shadowstep not end turn?**
- Enables the fantasy of "appear behind enemy, stab, disappear"
- Creates tactical depth: teleport for positioning OR for escape
- Differentiates Lyra from other characters
- High-risk, high-reward: commit early, but can still act

**Why is Poison Blade attack-based not turn-based?**
- More intuitive: "3 attacks" is clearer than "3 turns"
- Rewards aggressive play: use it, then attack a lot
- Prevents exploits: can't just wait it out
- Creates tension: do I save attacks or use them now?

**Why once per battle for all abilities?**
- Prevents Shadowstep spam (would trivialize positioning)
- Makes each ability use a meaningful decision
- Matches prototype scope (no cooldown system)
- Can expand to cooldowns in full production

### Gotchas to Watch

1. **Facing direction initialization**: Units need default facing on spawn
2. **Diagonal facing**: Decide if diagonal counts as behind (recommend: no)
3. **Shadowstep landing**: Must update grid occupancy immediately
4. **Poison Blade on miss**: Still consumes a charge (attack happened)
5. **Turn order after Shadowstep**: Ensure unit can still act
6. **Ability bar refresh**: Gray out abilities IMMEDIATELY after use

### Alternative Approaches Considered

| Approach | Pros | Cons | Decision |
|----------|------|------|----------|
| Backstab auto-detects behind | Simpler | Less tactical | Rejected |
| **Backstab requires manual positioning** | Tactical depth | More setup | **Chosen** |
| Shadowstep ends turn | Safer balance | Less fun | Rejected |
| **Shadowstep allows action after** | More tactical | Potentially OP | **Chosen** |
| Poison Blade turn-based | Simpler tracking | Confusing | Rejected |
| **Poison Blade attack-based** | Clearer, intuitive | Track attacks | **Chosen** |

### Dependencies on Previous Tasks

- **Task 2.2 (Ability UI)**: AbilityBar must show Lyra's abilities
- **Task 2.3 (Player Abilities)**: Ability system and AbilityExecutor must exist
- **Task 2.1 (Party Members)**: Lyra unit must exist with correct stats
- **Task 1.7 (Attack System)**: Damage resolution for Backstab

### Future Enhancements (Out of Scope)

- Backstab upgrade: Can backstab from sides (flanking)
- Shadowstep upgrade: 6-tile range
- Poison Blade upgrade: +3 damage, 5 attacks
- Visual effects: Smoke particles for Shadowstep
- Audio: Lyra voice lines ("From the shadows!")
- Synergies: Shadowstep behind enemy = automatic backstab positioning indicator

---

## 11. Definition of Done

- [ ] `resources/abilities/backstab.tres` created
- [ ] `resources/abilities/shadowstep.tres` created
- [ ] `resources/abilities/poison_blade.tres` created
- [ ] Facing direction tracked on all units
- [ ] Facing updates on movement
- [ ] Backstab detects "behind" correctly
- [ ] Backstab doubles damage when behind
- [ ] Shadowstep teleports up to 4 tiles
- [ ] Shadowstep ignores obstacles
- [ ] Shadowstep doesn't end turn
- [ ] Poison Blade adds +2 damage
- [ ] Poison Blade lasts 3 attacks
- [ ] All 4 abilities appear in Lyra's ability bar
- [ ] Abilities grayed out after use
- [ ] All acceptance criteria pass
- [ ] Console logging shows ability execution
- [ ] Code follows GDScript style guidelines

---

## 12. References

### From GDD

- **Lyra Swiftblade** (Section 4: Party Members):
  - Stats: STR 10, DEX 16, CON 10, INT 14, WIS 12, CHA 12
  - HP: 25
  - Abilities: Backstab (double damage from behind), Shadowstep (teleport 4 tiles), Poison Blade (+2 damage for 3 turns)
  - Purpose: Flanker, priority target assassin
  - Loyalty triggers: Protecting team (+), Betrayal (-)

- **Combat System** (Section 3):
  - Attack Roll: d20 + modifier vs Defense
  - Grid-based positioning matters
  - Flanking grants advantage on attacks

### From Roadmap

- **Task 2.5**: Implement Lyra Abilities (Phase 2, 2 hours)
- **What**: Lyra's 4 abilities: Backstab, Shadowstep, Poison Blade, Basic Attack
- **Hardcoded Values**:
  - Backstab damage multiplier: 2x
  - Shadowstep range: 4 tiles
  - Poison Blade bonus damage: +2
  - Poison Blade duration: 3 attacks
- **Dependencies**: Task 2.3 (ability system exists)
- **Related Tasks**: 2.4 (Thorne), 2.6 (Matthias)

### Godot Documentation

- [Resource](https://docs.godotengine.org/en/stable/classes/class_resource.html)
- [Signals](https://docs.godotengine.org/en/stable/getting_started/step_by_step/signals.html)
- [Vector2i](https://docs.godotengine.org/en/stable/classes/class_vector2i.html)
