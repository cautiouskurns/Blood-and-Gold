# The Border Dispute - Choice Contract

**Status:** üî¥ Planned
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 3.5 hours
**Dependencies:** Task 3.4 (Contract Flow), Task 3.9 (Loyalty System)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The Border Dispute introduces meaningful player choice to Blood & Gold, demonstrating that contracts aren't just combat encounters‚Äîthey're moral decisions that shape your company's identity and relationships with companions. This contract forces players to weigh gold rewards against loyalty consequences.

**What does it enable?**
Players will experience a branching narrative where their decisions have mechanical consequences. They'll see how different choices affect companion loyalty (Thorne, Matthias), learn that not every contract requires combat, and understand that charismatic leadership offers alternative solutions. This establishes the "commander's burden" pillar from the GDD.

**Success criteria:**
- Players feel genuine tension when making the choice (not an obvious "best" answer)
- Each path feels meaningfully different in gameplay and narrative
- Loyalty changes are immediately visible and feel consequential
- Players discuss/debate the "right" choice (good design creates disagreement)
- At least 30% of players attempt the negotiation path

---

## How It Works

### Overview

The Border Dispute is the third contract available after completing Clear the Ruins. When accepted from the Contract Board, instead of immediately starting combat, players enter a pre-combat dialogue scene at the Ironmark border checkpoint.

The scene presents a moral dilemma: Ironmark Commander Harwick has hired the company to "deal with" refugees trying to cross the border. Upon arrival, players see the refugees are families‚Äîwomen, children, elderly‚Äîfleeing some unnamed threat. Commander Harwick wants them "removed" but refuses to dirty his own hands.

Players must choose one of three paths:
- **Option A - Comply:** Drive off the refugees by force. Combat against 4 refugee defenders. Earn 600 gold but lose Matthias's respect (-20 loyalty). Thorne approves slightly (+5).
- **Option B - Refuse:** Let the refugees pass. No combat. Earn only 300 gold (half payment for "partial completion"). Matthias approves (+10), Thorne approves (+5). Ironmark reputation damaged.
- **Option C - Negotiate:** Attempt a Charisma check (DC 15) to convince Harwick to let refugees through as "temporary laborers." Success: 500 gold, positive loyalty with all companions. Failure: Falls back to Option A or B (player's subsequent choice).

After resolution, a camp scene triggers where companions discuss the decision, reinforcing the narrative weight of the choice.

### User Flow

```
1. Player selects "The Border Dispute" from Contract Board
2. Briefing screen displays: "Ironmark border patrol requests assistance"
3. Player clicks "Accept Contract"
4. Scene transitions to BorderDispute.tscn (dialogue scene, not combat)
5. Dialogue plays: Commander Harwick introduces situation
6. Camera pans to show refugees (families, not warriors)
7. Companion reactions appear:
   - Matthias: "These are civilians, not bandits..."
   - Thorne: "We took the contract. Honor demands we fulfill it."
8. Choice panel appears with three options:
   - [A] "We'll handle it." (Combat, 600g)
   - [B] "We're mercenaries, not butchers." (No combat, 300g)
   - [C] "Perhaps there's another way..." (CHA check DC 15)
9a. If Option A: Combat scene loads, fight 4 refugee defenders
9b. If Option B: Refugees pass, Harwick pays half, scene ends
9c. If Option C: CHA check popup, success = negotiate resolution, fail = choose A or B
10. Contract Results screen shows gold and loyalty changes
11. Transition to camp scene: "Difficult Decisions" discussion
12. Return to Hub
```

### Rules & Constraints

- **Choice Permanence:** Once a choice is made, it cannot be undone. The game auto-saves before the choice.
- **CHA Check:** Uses player character's Charisma stat. DC 15 means ~50% success rate for average characters, ~75% for CHA-focused builds.
- **Combat Difficulty:** Option A combat is moderate difficulty‚Äîrefugees are desperate, not trained warriors. 4 defenders (2 with makeshift weapons, 2 with improvised ranged).
- **Gold Scaling:** Option A pays 600g (premium for "dirty work"), Option B pays 300g (Harwick is furious), Option C success pays 500g (compromise).
- **Loyalty is Visible:** Loyalty changes display immediately in a popup: "Matthias loyalty: -20" with companion portrait.
- **No Wagon/Objective:** Unlike Merchant's Escort, this is a straight combat (if combat happens).
- **One-Time Contract:** Cannot be repeated. Choice is permanent for the playthrough.

### Edge Cases

- **What if player has low Charisma and picks Option C?** CHA check fails, player must then choose Option A or B. No penalty for trying.
- **What if player loses the Option A combat?** Standard defeat screen. Retry puts player back at the choice (not combat start).
- **What if all companions die in Option A combat?** Standard game over. Retry restores choice moment.
- **What if player quits during choice?** Auto-save before choice ensures progress isn't lost. Reloading returns to choice moment.
- **What if loyalty is already very low?** Loyalty can go negative. No floor. Companions with <-50 loyalty may have special dialogue in camp scene.

---

## User Interaction

### Controls

- **Left Click on Choice Option:** Select that option
- **Hover over Choice:** Shows tooltip with consequences (gold reward, combat/no combat indicator)
- **Right Click / Escape:** Cancel selection (returns to choice panel)
- **Continue Button:** Advance dialogue during pre-combat scene
- **Standard Combat Controls:** If combat triggers, same as other contracts

### Visual Feedback

- **Choice Panel:** Three large buttons with distinct visual theming
  - Option A: Red-tinted, sword icon, "600 gold" badge
  - Option B: Blue-tinted, peace/hand icon, "300 gold" badge
  - Option C: Gold-tinted, speech bubble icon, "Requires: CHA check" badge
- **Companion Reactions:** Portrait appears with speech bubble during key moments
- **Loyalty Change Popup:** Large floating text "+10 Matthias Loyalty" or "-20 Matthias Loyalty" with portrait
- **CHA Check UI:** Dice roll animation showing DC 15, player's CHA bonus, and result
- **Refugee Visualization:** Actual refugee sprites visible in dialogue scene (not just described)

### Audio Feedback

- **Dialogue Scene:** Ambient border checkpoint sounds, distant murmuring crowd
- **Choice Hover:** Subtle click/highlight sound
- **Choice Select:** Weighty "thunk" sound indicating permanence
- **CHA Check Roll:** Dice rolling sound effect
- **CHA Success:** Triumphant chime
- **CHA Failure:** Disappointed tone (not harsh failure)
- **Loyalty Gain:** Positive relationship chime
- **Loyalty Loss:** Negative/warning tone
- **Combat (Option A):** Desperate, chaotic combat music (different from standard)

---

## Visual Design

### Layout

**Pre-Combat Dialogue Scene:**
```
+--------------------------------------------------+
|                    [SCENE ART]                    |
|   Commander Harwick (left)    Refugees (right)    |
|                                                   |
+--------------------------------------------------+
|                                                   |
|   [DIALOGUE BOX - Speaker portrait + text]        |
|                                                   |
|   [CONTINUE]                                      |
+--------------------------------------------------+
```

**Choice Panel:**
```
+--------------------------------------------------+
|              THE BORDER DISPUTE                   |
|    What will you do about the refugees?          |
+--------------------------------------------------+
|  +------------+  +------------+  +------------+  |
|  | [A] COMPLY |  | [B] REFUSE |  |[C] NEGOTIATE| |
|  |  [sword]   |  |  [peace]   |  |  [speech]   | |
|  |   600g     |  |   300g     |  | CHA DC 15   | |
|  |Combat: Yes |  |Combat: No  |  |Combat: Maybe| |
|  +------------+  +------------+  +------------+  |
|                                                   |
|  Thorne: "Honor demands..."                      |
|  Matthias: "These are civilians..."              |
+--------------------------------------------------+
```

**Loyalty Change Popup:**
```
+----------------------------------+
|  [Matthias Portrait]             |
|  LOYALTY CHANGED                 |
|  -20                             |
|  "I expected better from you."   |
+----------------------------------+
```

### Components

- **Dialogue Scene Background:** Painted illustration of Ironmark border checkpoint
- **Character Portraits:** Commander Harwick (stern Ironmark officer), Refugee Elder (sympathetic elder)
- **Choice Buttons:** Large, clearly distinct options with icons and reward preview
- **Companion Reaction Bar:** Bottom of screen showing companion opinions during dialogue
- **CHA Check Popup:** Modal showing dice roll, target number, and result
- **Loyalty Notification:** Floating notification with companion portrait
- **Camp Scene:** Post-choice discussion environment

### Visual Style

- **Colors:**
  - Option A (Comply): Red/orange tint (#c0392b)
  - Option B (Refuse): Blue/calm tint (#2980b9)
  - Option C (Negotiate): Gold/diplomatic tint (#f39c12)
  - Loyalty Gain: Green glow (#27ae60)
  - Loyalty Loss: Red glow (#e74c3c)

- **Fonts:**
  - Choice headers: Bold, 22px
  - Choice descriptions: Regular, 16px
  - Dialogue text: Regular, 18px
  - Loyalty numbers: Bold, 36px

- **Animations:**
  - Choice hover: Subtle scale up (1.05x)
  - Choice select: Brief flash and "lock in" animation
  - Loyalty change: Number floats up from portrait
  - CHA check: Dice tumble animation, lands on result
  - Companion reaction: Portrait slides in from side

### States

- **Dialogue (Pre-Choice):**
  - Standard dialogue UI
  - Continue button advances
  - No choice panel visible yet

- **Choice Moment:**
  - Dialogue pauses
  - Three choice options displayed
  - Companion opinions visible
  - No timer (player can deliberate)

- **Choice Confirmed:**
  - Selected option highlights and locks
  - Brief confirmation animation
  - Transition to consequence

- **CHA Check (Option C):**
  - Modal popup with dice animation
  - Shows DC, player CHA, roll result
  - Success/fail clearly indicated

- **Combat (Option A):**
  - Standard combat UI
  - Enemies labeled "Refugee Defender"
  - Darker, more somber tone

- **Results:**
  - Contract complete panel
  - Gold earned + loyalty changes displayed
  - "Continue to Camp" button

---

## Technical Implementation

### Scene Structure

```
BorderDispute.tscn
‚îú‚îÄ‚îÄ DialogueLayer (CanvasLayer)
‚îÇ   ‚îú‚îÄ‚îÄ Background (TextureRect)
‚îÇ   ‚îú‚îÄ‚îÄ DialogueBox (PanelContainer)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Portrait (TextureRect)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NameLabel (Label)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DialogueText (RichTextLabel)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ContinueButton (Button)
‚îÇ   ‚îî‚îÄ‚îÄ CompanionReactions (HBoxContainer)
‚îÇ       ‚îú‚îÄ‚îÄ ThorneReaction (HBoxContainer)
‚îÇ       ‚îî‚îÄ‚îÄ MatthiasReaction (HBoxContainer)
‚îú‚îÄ‚îÄ ChoiceLayer (CanvasLayer)
‚îÇ   ‚îú‚îÄ‚îÄ ChoicePanel (PanelContainer)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Header (Label)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChoicesContainer (HBoxContainer)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OptionA (Button)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OptionB (Button)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OptionC (Button)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CompanionOpinions (VBoxContainer)
‚îÇ   ‚îî‚îÄ‚îÄ CHACheckPopup (PanelContainer)
‚îÇ       ‚îú‚îÄ‚îÄ DiceAnimation (AnimatedSprite2D)
‚îÇ       ‚îú‚îÄ‚îÄ DCLabel (Label)
‚îÇ       ‚îú‚îÄ‚îÄ BonusLabel (Label)
‚îÇ       ‚îú‚îÄ‚îÄ ResultLabel (Label)
‚îÇ       ‚îî‚îÄ‚îÄ ContinueButton (Button)
‚îú‚îÄ‚îÄ CombatScene (Node2D) [instantiated if Option A]
‚îÇ   ‚îú‚îÄ‚îÄ BorderCheckpointMap (TileMapLayer)
‚îÇ   ‚îú‚îÄ‚îÄ UnitManager (Node2D)
‚îÇ   ‚îî‚îÄ‚îÄ CombatUI (CanvasLayer)
‚îú‚îÄ‚îÄ ResultsLayer (CanvasLayer)
‚îÇ   ‚îú‚îÄ‚îÄ ContractResults (PanelContainer)
‚îÇ   ‚îî‚îÄ‚îÄ LoyaltyChangePopup (PanelContainer)
‚îî‚îÄ‚îÄ AudioManager (Node)
```

### Script Responsibilities

- **border_dispute.gd:** Main contract controller
  - Manages contract state machine (dialogue ‚Üí choice ‚Üí consequence ‚Üí results)
  - Handles choice selection and branching logic
  - Performs CHA check calculation
  - Triggers combat or skip based on choice
  - Awards gold and modifies loyalty
  - Transitions to camp scene

- **choice_panel.gd:** Choice UI controller
  - Displays three options with tooltips
  - Emits `choice_made(option: String)` signal
  - Handles hover states and selection animation
  - Shows companion opinion indicators

- **cha_check_popup.gd:** Skill check UI
  - Displays dice roll animation
  - Shows DC, player bonus, result
  - Emits `check_completed(success: bool)` signal

- **loyalty_popup.gd:** Loyalty change notification
  - Displays companion portrait and loyalty change
  - Animates number change
  - Shows companion reaction quote

- **companion_reaction_bar.gd:** During-dialogue companion opinions
  - Shows companion portraits with speech bubbles
  - Updates based on dialogue triggers

### Integration Points

- **Connects to:**
  - `LoyaltyManager` (autoload, Task 3.9) - Modifies companion loyalty
  - `CombatManager` (autoload) - Combat if Option A chosen
  - `GameState` (autoload) - Gold tracking, game state
  - `DialogueManager` - Pre-combat dialogue playback
  - `CampSceneManager` - Trigger post-contract discussion

- **Emits signals:**
  - `contract_started(contract_id: String)`
  - `choice_made(choice: String)` # "A", "B", or "C"
  - `cha_check_performed(dc: int, roll: int, success: bool)`
  - `loyalty_changed(companion_id: String, delta: int)`
  - `contract_completed(contract_id: String, gold_earned: int)`
  - `contract_failed(contract_id: String, reason: String)`

- **Listens for:**
  - `CombatManager.battle_ended(victory: bool)` - If Option A combat
  - `DialogueManager.dialogue_finished()` - Advance to choice
  - `CHACheckPopup.check_completed(success)` - Handle Option C result

- **Modifies:**
  - `GameState.gold` - Add reward based on choice
  - `GameState.contracts_completed` - Add "border_dispute"
  - `LoyaltyManager.loyalty[companion_id]` - Adjust loyalty values
  - `GameState.choice_history` - Record choice for future reference

### Configuration

- **Contract Data:** `resources/contracts/border_dispute.tres`
  ```gdscript
  # Contract resource properties
  contract_id = "border_dispute"
  display_name = "The Border Dispute"
  description = "Ironmark border patrol requests assistance with a... sensitive matter."
  map_scene = "res://scenes/contracts/BorderDispute.tscn"
  reward_gold = 600  # Max reward (Option A)
  reward_gold_min = 300  # Min reward (Option B)
  difficulty = "Medium"
  is_tutorial = false
  has_pre_combat_dialogue = true
  has_choice = true
  triggers_camp_scene = true
  camp_scene_id = "difficult_decisions"
  ```

- **Choice Configuration:** (in script constants)
  ```gdscript
  const CHOICES = {
    "A": {
      "label": "We'll handle it.",
      "description": "Drive off the refugees by force.",
      "gold_reward": 600,
      "has_combat": true,
      "loyalty_changes": {
        "matthias": -20,
        "thorne": +5
      }
    },
    "B": {
      "label": "We're mercenaries, not butchers.",
      "description": "Refuse the contract and let refugees pass.",
      "gold_reward": 300,
      "has_combat": false,
      "loyalty_changes": {
        "matthias": +10,
        "thorne": +5
      }
    },
    "C": {
      "label": "Perhaps there's another way...",
      "description": "Attempt to negotiate a peaceful solution.",
      "requires_check": "CHA",
      "check_dc": 15,
      "success_gold": 500,
      "success_loyalty": {
        "matthias": +5,
        "thorne": +5,
        "lyra": +5
      },
      "failure_fallback": true  # Allows choosing A or B on failure
    }
  }
  ```

- **Combat Setup (Option A):**
  ```gdscript
  const REFUGEE_DEFENDER_COUNT := 4
  const REFUGEE_MELEE_SPAWN := [Vector2i(8, 4), Vector2i(8, 6)]
  const REFUGEE_RANGED_SPAWN := [Vector2i(9, 5), Vector2i(9, 7)]
  const PARTY_SPAWN := [Vector2i(2, 4), Vector2i(2, 5), Vector2i(2, 6), Vector2i(2, 7)]
  ```

- **Dialogue Script:** `resources/dialogues/border_dispute.json`
  ```json
  {
    "scenes": [
      {
        "speaker": "Commander Harwick",
        "portrait": "harwick_stern",
        "text": "Ah, the mercenaries. Good. I have a task that requires... discretion."
      },
      {
        "speaker": "Commander Harwick",
        "portrait": "harwick_stern",
        "text": "Refugees from the east. Hundreds of them. Trying to cross into Ironmark territory."
      },
      {
        "type": "camera_pan",
        "target": "refugees"
      },
      {
        "speaker": "Narrator",
        "text": "You see families huddled together. Children clutching parents. The elderly supported by the young."
      },
      {
        "speaker": "Matthias",
        "portrait": "matthias_concerned",
        "text": "Commander, these are civilians. Women and children..."
      },
      {
        "speaker": "Commander Harwick",
        "portrait": "harwick_cold",
        "text": "They are unauthorized trespassers. Ironmark cannot absorb every vagrant from the borderlands."
      },
      {
        "speaker": "Thorne",
        "portrait": "thorne_neutral",
        "text": "We took a contract. Gold changes hands, we do the job. That's how it works."
      },
      {
        "speaker": "Commander Harwick",
        "portrait": "harwick_stern",
        "text": "Precisely. Remove them. I don't care how. Six hundred gold for your trouble."
      },
      {
        "type": "choice_trigger"
      }
    ]
  }
  ```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Contract appears on Contract Board with correct name, description, and "Choice" indicator
- [ ] Clicking "Accept" transitions to dialogue scene (not immediate combat)
- [ ] Pre-combat dialogue plays with Commander Harwick and shows refugees
- [ ] Companion reactions (Thorne, Matthias) display during dialogue
- [ ] Choice panel presents all three options with clear consequences
- [ ] Option A: Triggers combat against 4 refugee defenders, awards 600 gold, Matthias -20 loyalty
- [ ] Option B: Skips combat, awards 300 gold, Matthias +10 loyalty, Thorne +5 loyalty
- [ ] Option C: Performs CHA check (DC 15), success awards 500 gold and positive loyalty for all
- [ ] Option C failure: Returns to choice of Option A or B
- [ ] Loyalty changes display immediately with companion portrait and reaction quote
- [ ] After resolution, game transitions to "Difficult Decisions" camp scene
- [ ] Contract is marked complete and removed from board after any resolution
- [ ] Choice is recorded in GameState for future reference

---

## Testing Checklist

### Functional Tests

- [ ] **Contract Selection:** Selecting contract from board opens dialogue scene
- [ ] **Dialogue Playback:** All dialogue lines display correctly with portraits
- [ ] **Camera Pan:** Refugee visualization is visible during scene
- [ ] **Companion Reactions:** Thorne and Matthias comments appear at correct moments
- [ ] **Choice Display:** All three options show with correct labels and tooltips
- [ ] **Option A Selection:** Combat initiates with 4 refugee defenders
- [ ] **Option A Victory:** 600 gold awarded, Matthias -20, Thorne +5
- [ ] **Option A Defeat:** Standard retry, returns to choice moment
- [ ] **Option B Selection:** No combat, 300 gold awarded, Matthias +10, Thorne +5
- [ ] **Option C Selection:** CHA check popup appears with correct DC (15)
- [ ] **Option C Success:** 500 gold, all companions gain loyalty
- [ ] **Option C Failure:** Returns to reduced choice (A or B only)
- [ ] **Loyalty Popup:** Shows correct values and companion portraits
- [ ] **Camp Scene Trigger:** "Difficult Decisions" camp scene loads after any resolution

### Edge Case Tests

- [ ] **Very low CHA (< 10):** Check can still be attempted, just likely to fail
- [ ] **Very high CHA (> 18):** Check succeeds reliably
- [ ] **Quit during dialogue:** Progress saved at contract start
- [ ] **Quit during choice:** Returns to choice moment on reload
- [ ] **Quit during combat (Option A):** Returns to combat start on reload
- [ ] **Already low loyalty companion:** Can go further negative
- [ ] **Party member death in combat:** Mission can still succeed

### Integration Tests

- [ ] **Works with LoyaltyManager:** Loyalty changes persist correctly
- [ ] **Works with CombatManager:** Option A combat functions normally
- [ ] **Works with GameState:** Gold persists, choice recorded
- [ ] **Works with ContractBoard:** Contract removed after completion
- [ ] **Works with CampScene:** Correct discussion loads based on choice
- [ ] **Doesn't break other contracts:** Other contracts remain accessible

### Polish Tests

- [ ] Choice hover states animate smoothly
- [ ] CHA check dice animation plays correctly
- [ ] Loyalty popup animates smoothly (fade in, number rise)
- [ ] Dialogue text typewriter effect (if implemented)
- [ ] Combat music (Option A) feels appropriate (somber, not triumphant)
- [ ] All UI elements fit within screen bounds
- [ ] Performance acceptable (60 FPS) during dialogue and combat

---

## Implementation Notes

*(For AI assistant or future developer)*

- **Choice Architecture:** This is the first "choice contract" - build the choice system to be reusable. Future contracts will use similar branching. Consider a `ChoiceContract` base class that extends base contract.

- **Skill Check System:** The CHA check here is the prototype's first skill check. Implement a generic `SkillCheckManager` that can be reused for future checks (STR, INT, WIS). Store the formula: `roll = randi() % 20 + 1 + stat_bonus; success = roll >= DC`.

- **Loyalty System Dependency:** This contract REQUIRES Task 3.9 (Loyalty System) to be implemented first. The loyalty changes are central to the feature's purpose. If loyalty system isn't ready, stub it with print statements.

- **Moral Ambiguity by Design:** Don't make any option "obviously correct." Option A is cruel but profitable. Option B is moral but costly. Option C is the "golden path" but requires investment in CHA. This creates interesting choices.

- **Combat Tone:** Option A combat should feel different from standard encounters. Consider: different music, enemy names ("Refugee Defender" not "Enemy"), no victory fanfare (somber end-of-combat).

- **Camp Scene Content:** The "Difficult Decisions" camp scene should vary based on which option was chosen. Store `GameState.border_dispute_choice` and branch dialogue accordingly.

- **Ironmark Reputation:** The GDD mentions reputation with factions. Consider tracking Ironmark reputation: Option A = +rep, Option B = -rep, Option C = neutral. This can affect future Ironmark contracts.

- **Refugee Faction:** Consider if refugees should have a faction for future content. Option B defenders could come back as allies later. Store this choice for potential callbacks.

- **Alternative Considered:** Originally considered making Option C automatic success for high-CHA characters. Rejected because even a good roll is more engaging than auto-success. The dice roll creates tension.

---
