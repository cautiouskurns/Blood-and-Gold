# Task 2.12: Cover and High Ground System

**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 1.5 hours
**Dependencies:** Task 1.1 (combat grid display)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
Tactical positioning is a core pillar of Blood & Gold's combat system. Without terrain bonuses, the grid becomes just a movement constraint rather than a tactical puzzle. Cover and high ground create meaningful positioning decisions - do you advance to attack or stay in cover? Do you fight for the tower? The GDD explicitly calls out "+2 Defense from cover" and "+2 ranged attacks from high ground" as core tactical interactions.

**What does it enable?**
- Units behind cover gain +2 Defense, making defensive positions valuable
- Units on high ground gain +2 to ranged attacks, creating "king of the hill" dynamics
- Players must weigh offensive positioning vs defensive positioning
- Maps become more interesting with strategic chokepoints and elevation
- Archers on high ground become a threat that must be addressed
- Infantry can use cover to survive approach against ranged enemies

**Success criteria:**
- Units behind cover receive +2 Defense bonus
- Units on high ground receive +2 ranged attack bonus
- Cover and high ground tiles are visually distinct on the map
- Bonuses are displayed in attack roll tooltips and combat log
- Bonuses apply correctly in all attack calculations

---

## How It Works

### Overview

The Cover and High Ground system adds tile properties to the combat grid that provide combat bonuses to units standing on them. Cover tiles (trees, rocks, low walls) grant a +2 Defense bonus to any unit occupying them. High ground tiles (towers, elevated platforms) grant a +2 bonus to ranged attacks made by units standing on them.

These bonuses are passive - a unit receives them automatically just by being on the correct tile type. The system integrates with the existing attack resolution to modify defense values and attack rolls before the hit calculation. Visual indicators on tiles help players identify strategic positions at a glance.

This supports the "Tactical Combat" design pillar by making positioning meaningful. A unit in cover is harder to hit, encouraging players to advance through cover rather than charging across open ground. High ground creates focal points on maps that both sides want to control, adding strategic depth beyond "attack the nearest enemy."

### User Flow

```
COVER USAGE:
1. Player sees a tree tile marked with cover indicator
2. Player moves unit onto the cover tile
3. Unit's effective Defense increases by +2 (visible in UI)
4. Enemy attacks the unit
5. Attack roll must beat the higher Defense value
6. Combat log shows "Defense 15 (+2 cover)"

HIGH GROUND USAGE:
1. Player sees elevated tower tile with high ground indicator
2. Player moves archer onto the high ground tile
3. Archer's ranged attack bonus increases by +2
4. Archer attacks enemy at range
5. Attack roll includes the +2 high ground bonus
6. Combat log shows "Attack +6 (+2 high ground)"
```

### Rules & Constraints

- **Cover Defense Bonus:** +2 to Defense while standing on a cover tile
- **High Ground Attack Bonus:** +2 to ranged attacks while standing on a high ground tile
- **Ranged Only:** High ground bonus only applies to ranged attacks, not melee
- **Stacking:** A tile can be both cover AND high ground (both bonuses apply)
- **Passive Effect:** Bonuses apply automatically, no action required
- **Same Tile:** Both attacker and target bonuses are calculated independently
- **No Direction:** Cover provides equal protection from all directions (simplified)
- **Enemies Too:** Enemy units also benefit from cover and high ground

### Edge Cases

- **Melee on High Ground:** No bonus - high ground only affects ranged
- **Cover vs Cover:** Both units get their own cover bonus (net effect: harder to hit each other)
- **High Ground vs High Ground:** Both ranged units get +2 (no advantage/disadvantage)
- **Moving Off Cover:** Defense bonus removed immediately when leaving tile
- **Dead Unit on Cover:** Cover tile still grants bonus to new unit that moves there
- **Ability Attacks:** Cover and high ground bonuses apply to ability-based attacks too
- **Obstacle Tiles:** Obstacle tiles are NOT cover (can't stand on them)

---

## User Interaction

### Controls

| Input | Action |
|-------|--------|
| Hover tile | Show tile info tooltip including cover/high ground status |
| Move to tile | Automatically gain any tile bonuses |
| Attack | Bonuses automatically applied to roll |

### Visual Feedback

- **Cover Tile Indicator:**
  - Subtle icon overlay on tile (shield icon or foliage pattern)
  - Lighter green tint for natural cover (trees, bushes)
  - Gray tint for structural cover (walls, rocks)
  - Tooltip: "Cover: +2 Defense"

- **High Ground Tile Indicator:**
  - Elevated appearance (darker edge to simulate shadow)
  - Up-arrow icon overlay
  - Distinct tile color (tan/brown for tower)
  - Tooltip: "High Ground: +2 Ranged Attack"

- **Combined Tile (Cover + High Ground):**
  - Both indicators visible
  - Tooltip shows both bonuses

- **Unit with Bonus:**
  - Small shield icon near HP bar when in cover
  - Small up-arrow icon near HP bar when on high ground
  - Stat tooltip shows modified values

- **Attack Roll Display:**
  - Combat log: "Archer attacks Bandit: 1d20(14) + 4 + 2(high ground) = 20 vs Defense 14. HIT!"
  - Combat log: "Bandit attacks Thorne: 1d20(12) + 3 = 15 vs Defense 17(+2 cover). MISS!"

### Audio Feedback (if applicable)

- No specific audio for passive bonuses
- Standard attack hit/miss sounds apply

---

## Visual Design

### Layout

```
Tile Visual States:

WALKABLE TILE:          COVER TILE:              HIGH GROUND TILE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚        â”‚  ðŸŒ²          â”‚         â”‚      â†‘       â”‚
â”‚   (green)    â”‚        â”‚   (cover)    â”‚         â”‚  (elevated)  â”‚
â”‚              â”‚        â”‚              â”‚         â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Unit with Cover:        Unit with High Ground:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [HP Bar]    â”‚        â”‚  [HP Bar]    â”‚
â”‚  ðŸ›¡ï¸ [Unit]   â”‚        â”‚  â†‘ [Unit]    â”‚
â”‚              â”‚        â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

- **Tile Overlay:** Semi-transparent icon drawn on tile (32x32 icon scaled)
- **Bonus Indicator:** Small icon (16x16) positioned near unit's HP bar
- **Tooltip Popup:** Shows tile properties on hover

### Visual Style

- **Cover Tile Color:** #3d5636 (darker forest green) with tree/rock overlay
- **High Ground Tile Color:** #8b7355 (tan/brown) with shadow edge effect
- **Cover Icon:** Shield or foliage symbol, 50% opacity overlay
- **High Ground Icon:** Up arrow, 50% opacity overlay
- **Bonus Indicator (Cover):** Small blue shield, positioned left of HP bar
- **Bonus Indicator (High Ground):** Small orange up-arrow, positioned right of HP bar

### States

- **Default Tile:** Normal walkable appearance
- **Cover Tile:** Darker green with cover overlay icon
- **High Ground Tile:** Tan/brown with elevated shadow and arrow icon
- **Combined Tile:** Both visual treatments applied
- **Unit on Special Tile:** Shows bonus indicator icon near HP bar

---

## Technical Implementation

### Scene Structure

No new scenes required. Modifications to existing CombatGrid and attack resolution.

```
CombatGrid.tscn (modifications)
â”œâ”€â”€ TileMap (existing)
â”‚   â””â”€â”€ Now supports tile types: WALKABLE, OBSTACLE, COVER, HIGH_GROUND, COVER_HIGH_GROUND
â”œâ”€â”€ CoverOverlay (new Node2D child)
â”‚   â””â”€â”€ Draws cover icons on cover tiles
â””â”€â”€ HighGroundOverlay (new Node2D child)
    â””â”€â”€ Draws high ground icons on high ground tiles
```

### Script Responsibilities

- **combat_grid.gd (modify):**
  - Add tile type constants: `TILE_COVER`, `TILE_HIGH_GROUND`, `TILE_COVER_HIGH_GROUND`
  - Add `is_cover(coords)` - Check if tile provides cover
  - Add `is_high_ground(coords)` - Check if tile provides high ground
  - Add `get_cover_bonus(coords)` - Returns +2 if cover, 0 otherwise
  - Add `get_high_ground_bonus(coords)` - Returns +2 if high ground, 0 otherwise
  - Add `_draw_tile_overlays()` - Draw cover/high ground icons
  - Modify `_create_tileset()` - Add new tile types to tileset

- **attack_resolver.gd (modify):**
  - Modify `resolve_attack()` - Apply cover bonus to defender's defense
  - Modify `resolve_attack()` - Apply high ground bonus to ranged attacker
  - Add `_get_terrain_defense_bonus(unit)` - Get cover bonus for unit's position
  - Add `_get_terrain_attack_bonus(unit, is_ranged)` - Get high ground bonus for unit
  - Modify result to include terrain bonus info for combat log

- **unit.gd (modify):**
  - Add `get_terrain_defense_bonus()` - Query grid for cover bonus
  - Add `get_terrain_attack_bonus()` - Query grid for high ground bonus
  - Optionally show bonus indicators near HP bar

### Integration Points

- **Connects to:**
  - `CombatGrid` - Queries tile type at unit position
  - `AttackResolver` - Applies bonuses during attack calculation
  - `Unit` - Gets position to check tile bonuses

- **Listens for:**
  - Nothing new - bonuses are calculated on-demand during attacks

- **Modifies:**
  - `AttackResult` - Include terrain bonus info for combat log display
  - Defense calculation in attack resolution
  - Attack roll calculation for ranged attacks

### Configuration

**Tile Type Constants (combat_grid.gd):**
```gdscript
const TILE_WALKABLE: int = 0
const TILE_OBSTACLE: int = 1
const TILE_COVER: int = 2
const TILE_HIGH_GROUND: int = 3
const TILE_COVER_HIGH_GROUND: int = 4  # Combined type
```

**Bonus Constants (attack_resolver.gd or combat_grid.gd):**
```gdscript
const COVER_DEFENSE_BONUS: int = 2
const HIGH_GROUND_ATTACK_BONUS: int = 2
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Cover tiles are visually distinct from regular walkable tiles
- [ ] High ground tiles are visually distinct from regular walkable tiles
- [ ] Units on cover tiles receive +2 Defense bonus in combat
- [ ] Units on high ground tiles receive +2 ranged attack bonus
- [ ] High ground bonus does NOT apply to melee attacks
- [ ] Bonuses appear in combat log with clear notation
- [ ] Enemy units also benefit from cover and high ground
- [ ] At least one tile of each type exists in Forest Clearing map
- [ ] Hovering a tile shows its terrain properties in tooltip
- [ ] Moving off a special tile removes the bonus immediately

---

## Testing Checklist

### Functional Tests

- [ ] **Cover Defense:** Unit on cover tile has +2 Defense in attack calculation
- [ ] **High Ground Ranged:** Unit on high ground has +2 ranged attack
- [ ] **High Ground Melee:** Unit on high ground does NOT get bonus for melee attack
- [ ] **Enemy Cover:** Enemy unit on cover is harder to hit (+2 Defense)
- [ ] **Both Units Cover:** When both attacker and defender on cover, both get Defense bonus
- [ ] **Combat Log:** Bonuses displayed correctly in combat log entries

### Edge Case Tests

- [ ] **Combined Tile:** Tile with both cover AND high ground grants both bonuses
- [ ] **Move On/Off:** Bonus applies immediately when moving to tile, removes when leaving
- [ ] **Ability Attacks:** Smite, Backstab, etc. respect cover and high ground
- [ ] **Ranged from Cover:** Ranged unit on cover gets Defense but no attack bonus
- [ ] **Melee on High Ground:** Melee unit on high ground gets no attack bonus

### Integration Tests

- [ ] **With Pathfinding:** Cover/high ground tiles are still walkable for pathfinding
- [ ] **With Turn System:** Bonuses persist across turns while unit on tile
- [ ] **With All Unit Types:** Party members, soldiers, and enemies all benefit
- [ ] **With Ranged System (Task 2.7):** High ground bonus applies to ranged attacks

### Polish Tests

- [ ] **Visual Clarity:** Cover and high ground tiles clearly identifiable at a glance
- [ ] **Tooltip Info:** Hovering tiles shows terrain properties
- [ ] **Bonus Indicators:** Small icons show when unit has active terrain bonus
- [ ] **Combat Log Clarity:** Bonus notation is clear and not confusing

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Tile Type Expansion:** The current grid uses 0 (walkable) and 1 (obstacle). Expand to support 2 (cover), 3 (high ground), and 4 (both). The tileset texture needs to be expanded.

2. **Backward Compatibility:** Cover and high ground tiles should still be walkable. The `is_walkable()` function needs to return `true` for cover and high ground tiles.

3. **Combined Tiles:** A tile can be both cover AND high ground (e.g., a defensive position on a tower). Use a dedicated tile type (4) or bitflags.

4. **Combat Log Integration:** The `AttackResult` class should store terrain bonus info so the combat log can display it.

5. **Map Placement:** The Forest Clearing map should have trees as cover. The Ruined Fort map should have walls as cover and tower as high ground.

### Integration with Existing Code

The current attack resolution in `attack_resolver.gd`:
```gdscript
static func resolve_attack(attacker: Unit, target: Unit) -> AttackResult:
    var attack_bonus = _get_attack_bonus(attacker)
    result.target_defense = _get_defense(target)
    # ... roll logic
```

Should become:
```gdscript
static func resolve_attack(attacker: Unit, target: Unit) -> AttackResult:
    var attack_bonus = _get_attack_bonus(attacker)
    var terrain_attack_bonus = _get_terrain_attack_bonus(attacker)
    result.target_defense = _get_defense(target) + _get_terrain_defense_bonus(target)
    result.terrain_attack_bonus = terrain_attack_bonus
    result.terrain_defense_bonus = _get_terrain_defense_bonus(target)
    # ... roll logic with terrain_attack_bonus added
```

### Alternative Approaches Considered

1. **Directional Cover:** Cover only protects from certain directions. Rejected for prototype - adds complexity without clear value.

2. **Cover Destruction:** Cover can be destroyed by attacks. Rejected for prototype - environmental destruction is out of scope.

3. **Elevation Levels:** Multiple height levels (0, 1, 2, etc.). Rejected - binary high ground is simpler and sufficient for prototype.

4. **Line of Sight Cover:** Cover blocks LoS like obstacles. Rejected - cover should be occupiable, not blocking.

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| Cover Defense Bonus | +2 | Defense increase while on cover tile |
| High Ground Attack Bonus | +2 | Ranged attack increase while on high ground |
| Cover Tile Color | #3d5636 | Darker forest green |
| High Ground Tile Color | #8b7355 | Tan/brown |
| Cover Icon Opacity | 50% | Semi-transparent overlay |
| High Ground Icon Opacity | 50% | Semi-transparent overlay |
| Bonus Indicator Size | 16x16 px | Small icon near HP bar |
| Tile Overlay Size | 32x32 px | Icon on tile |

---

## Asset Requirements

### Icons Needed (32x32 PNG)

1. `assets/sprites/tiles/cover_overlay.png` - Shield or foliage icon for cover tiles
2. `assets/sprites/tiles/high_ground_overlay.png` - Up arrow icon for high ground tiles

### Bonus Indicators (16x16 PNG)

1. `assets/sprites/ui/cover_indicator.png` - Small shield for unit bonus display
2. `assets/sprites/ui/high_ground_indicator.png` - Small up arrow for unit bonus display

### Tileset Updates

- Extend tileset texture to include cover and high ground tile variants
- Cover tile: Forest green with foliage pattern
- High ground tile: Tan/brown with shadowed edge

---
