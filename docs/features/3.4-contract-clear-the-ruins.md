# Contract 2 - Clear the Ruins (Full Combat)

**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 2.5 hours
**Dependencies:** Task 3.3 (Contract 1 - Merchant's Escort complete), Task 3.2 (Contract Board UI complete)
**Assigned To:** AI assistant (Claude Code)

---

## Purpose

**Why does this feature exist?**
Clear the Ruins is the second contract in the prototype, designed to test full tactical combat against a larger enemy force with a leader unit. It validates that the soldier order system, party abilities, and terrain-based tactics work together in a challenging scenario.

**What does it enable?**
Players experience their first "real" combat challenge after the tutorial - a battle against 10 enemies including a leader who buffs allies. The hidden cache objective introduces optional exploration during combat. The post-combat camp scene advances the companion narrative arc.

**Success criteria:**
- Combat feels harder than the tutorial (more enemies, leader abilities)
- Players must use tactics (cover, abilities, soldier orders) to succeed
- Hidden cache provides meaningful optional objective (exploration reward)
- Leader enemy creates tactical priority decision (kill leader early or deal with buffed minions)
- Post-combat camp scene with Lyra reveals her distrust of Ironmark, setting up Contract 3
- Supports "Tactical Combat" design pillar with larger-scale engagement

---

## How It Works

### Overview

Clear the Ruins is a pure combat contract set in the Ruined Fort map. The player's company (4 party members + recruited soldiers) faces off against 10 bandits: 6 Melee, 3 Archers positioned on high ground, and 1 Bandit Leader. The Leader uses the "Rally Bandits" ability to buff nearby allies, creating a tactical priority target.

The map features defensive structures (walls, rubble, tower) that enemies use effectively. Archers start on the tower with high ground advantage. The Leader stays protected, buffing minions until forced to engage. Players must break through defensive positions while managing multiple threats.

A hidden cache can be discovered by moving any unit to a specific tile in the ruins (marked subtly with environmental storytelling - broken chest, glint effect). Finding the cache grants +200 gold bonus, encouraging exploration during combat.

After victory, the camp scene system triggers Lyra's first major dialogue, where she questions the player's decision to work for Ironmark, foreshadowing the moral choice in Contract 3.

### User Flow
```
1. Player selects "Clear the Ruins" from Contract Board
2. Contract detail panel shows: 500g reward, Medium difficulty, objectives
3. Player accepts contract
4. Transition to ClearTheRuins.tscn combat scene
5. Pre-battle briefing panel shows tactical intel
6. Combat begins: Party + soldiers vs 10 bandits on Ruined Fort map
7. During combat:
   - Leader uses Rally Bandits every 3 turns
   - Archers on tower fire with high ground bonus
   - Player can discover hidden cache (optional)
8. Victory: All enemies defeated
9. Victory screen shows: Base reward + cache bonus (if found)
10. Transition to camp scene: Lyra confrontation
11. Return to hub with gold added
```

### Combat Setup

**Map:** Ruined Fort (14x14 tiles)
- Tower section (high ground) - 2x2 tiles, elevated
- Crumbling walls - provide full cover, block movement
- Rubble piles - difficult terrain
- Courtyard - open area for main engagement
- Hidden cache location - specific tile in ruins corner

**Enemy Placement:**
```
+-------------------------------------------+
|  [TOWER - Archers x3 on high ground]      |
|     â†“                                     |
|  [WALL]        [RUBBLE]     [WALL]        |
|     â†“                                     |
|  [Melee x2]    [LEADER]    [Melee x2]     |
|     â†“            â†“            â†“           |
|              [COURTYARD]                  |
|     â†“                                     |
|  [Melee x2]                [CACHE]        |
|     â†“                                     |
|  === PARTY SPAWN ZONE ===                 |
+-------------------------------------------+
```

**Party Spawn:** South edge of map, spread formation

### Enemy Roster

| Enemy Type | Count | HP | DEF | ATK | Special |
|-----------|-------|-----|-----|-----|---------|
| Bandit Melee | 6 | 15 | 12 | 1d6+2 | Rush nearest target |
| Bandit Archer | 3 | 10 | 11 | 1d6 (range 8) | High ground (+2 ATK), stay at range |
| Bandit Leader | 1 | 30 | 14 | 1d8+3 | Rally Bandits ability |

**Bandit Leader - Rally Bandits:**
- Ability cooldown: 3 turns
- Effect: All bandits within 5 tiles get +2 to attack rolls for 2 turns
- Visual: Shout animation, buff icons appear on affected bandits
- AI Behavior: Uses Rally when 3+ bandits in range, then stays protected

### Hidden Cache Mechanic

**Location:** Fixed tile in northeast ruins corner (marked by broken chest prop)

**Discovery:**
- Any unit (party or soldier) moving onto the cache tile triggers discovery
- No action required - just occupy the tile
- Subtle visual hint: Environmental storytelling (broken chest, slight sparkle)

**Reward:**
- +200 gold added to contract reward
- Discovery notification: "Hidden Cache Found! +200 gold"
- Tracked in GameState for victory screen display

**Design Intent:** Encourages players to explore the map rather than rushing enemies, rewards tactical awareness and unit positioning.

### Rules & Constraints
- Victory condition: All 10 enemies defeated
- Defeat condition: All party members incapacitated (soldiers can die)
- Leader does not flee - fights to the death
- Archers remain on tower unless forced off by player abilities
- Cache can only be discovered once per playthrough
- If cache found, bonus gold added immediately to total
- Soldier permadeath applies (lost soldiers gone)

### Edge Cases
- What if player discovers cache before engaging enemies? Discovery works, combat continues
- What if Leader dies first? Remaining bandits fight normally (no more Rally buffs)
- What if all archers killed? Tower becomes safe position for player ranged units
- What if player retreats all units? No retreat mechanic in prototype - must fight
- What if player has no soldiers? Harder fight but possible with party abilities

---

## User Interaction

### Controls
- Standard combat controls (see Phase 2 implementation)
- Click tile to discover cache (if unit moves there)
- No special input for this contract

### Visual Feedback
- Rally Bandits: Leader raises weapon, golden shout effect radiates outward
- Buffed bandits: Gold glow or +ATK icon above their heads
- Hidden cache discovery: Chest open animation, gold particles, "+200g" floating text
- High ground indicator: Elevation lines around tower
- Wall cover: Cover indicator when unit adjacent

### Audio Feedback (if applicable)
- Rally Bandits: War cry sound effect
- Cache discovery: Coin jingle, treasure sound
- Combat sounds: Standard attack/damage sounds

---

## Visual Design

### Pre-Battle Briefing Panel
```
+----------------------------------------------------------+
|                    CONTRACT: CLEAR THE RUINS              |
+----------------------------------------------------------+
|                                                           |
|  TACTICAL INTEL:                                          |
|                                                           |
|  - Bandits have fortified the old watchtower ruins        |
|  - Expect archers on the tower with height advantage      |
|  - Their leader rallies them - prioritize taking him out  |
|  - Rumors of a hidden cache in the ruins...               |
|                                                           |
|  OBJECTIVES:                                              |
|  [!] Eliminate all bandits                                |
|  [?] Find the hidden cache (optional)                     |
|                                                           |
|              +---------------------------+                |
|              |        BEGIN BATTLE       |                |
|              +---------------------------+                |
+----------------------------------------------------------+
```

### Victory Screen
```
+----------------------------------------------------------+
|                      VICTORY!                             |
+----------------------------------------------------------+
|                                                           |
|  CONTRACT COMPLETE: Clear the Ruins                       |
|                                                           |
|  REWARDS:                                                 |
|  Base Reward .................... 500 gold               |
|  Hidden Cache Bonus ............. 200 gold  [FOUND!]     |
|  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                |
|  TOTAL .......................... 700 gold               |
|                                                           |
|  CASUALTIES:                                              |
|  Party: None                                              |
|  Soldiers: 1 Infantry lost                                |
|                                                           |
|              +---------------------------+                |
|              |         CONTINUE          |                |
|              +---------------------------+                |
+----------------------------------------------------------+
```

### Components
- **PreBattleBriefing (PanelContainer)**: Intel panel before combat
- **VictoryScreen (PanelContainer)**: Post-combat results
- **RallyEffect (CPUParticles2D)**: Visual for Leader's ability
- **CacheMarker (Area2D)**: Hidden cache trigger zone
- **BuffIndicator (Sprite2D)**: Icon showing buffed enemies

---

## Technical Implementation

### Scene Structure
```
ClearTheRuins.tscn (Node2D) [clear_the_ruins.gd]
â”œâ”€â”€ CombatSetup (Node)
â”‚   â”œâ”€â”€ MapReference: RuinedFort.tscn
â”‚   â”œâ”€â”€ PartySpawnPoints (Node2D)
â”‚   â”‚   â””â”€â”€ [Marker2D nodes for spawn positions]
â”‚   â”œâ”€â”€ EnemySpawnPoints (Node2D)
â”‚   â”‚   â”œâ”€â”€ MeleeSpawn1-6 (Marker2D)
â”‚   â”‚   â”œâ”€â”€ ArcherSpawn1-3 (Marker2D)
â”‚   â”‚   â””â”€â”€ LeaderSpawn (Marker2D)
â”‚   â””â”€â”€ CacheLocation (Area2D)
â”‚       â”œâ”€â”€ CollisionShape2D
â”‚       â””â”€â”€ CacheVisual (Sprite2D) [subtle broken chest]
â”œâ”€â”€ PreBattleBriefing (CanvasLayer)
â”‚   â””â”€â”€ BriefingPanel (PanelContainer)
â””â”€â”€ VictoryScreen (CanvasLayer)
    â””â”€â”€ VictoryPanel (PanelContainer)
```

### Script Responsibilities

**clear_the_ruins.gd:**
- Extends base contract scene (if exists) or Node
- On ready: Configure combat with enemy roster and map
- Spawn party at south spawn points
- Spawn enemies at configured positions
- Register cache discovery zone
- Listen for combat_ended signal
- Show victory screen with cache status
- Trigger Lyra camp scene on continue

**cache_discovery.gd (or inline):**
- Area2D body_entered signal handler
- Check if entering body is unit (party or soldier)
- If not already discovered: trigger discovery
- Add 200g to contract bonus
- Show discovery notification
- Play discovery effects

**bandit_leader_ai.gd (extends enemy_ai.gd):**
- Override standard enemy AI
- Track Rally Bandits cooldown
- On turn: Check if Rally available and allies in range
- If yes: Use Rally ability, reset cooldown
- Otherwise: Standard leader behavior (stay protected, attack if cornered)

### Integration Points

- Connects to: CombatManager for battle flow
- Connects to: GameState for gold/contract tracking
- Connects to: TurnManager for Leader AI timing
- Emits signals:
  - `cache_discovered()` - when cache found
  - `contract_completed(gold_total: int, cache_found: bool)` - on victory
- Listens for:
  - `CombatManager.combat_ended(victory: bool)`
  - `unit_entered_tile(unit, tile_position)`
- Modifies:
  - GameState.gold (on victory)
  - GameState.completed_contract_ids (adds "clear_the_ruins")
  - GameState.active_contract (sets to null)

### Configuration

**Contract Resource Updates (clear_the_ruins.tres):**
```gdscript
id = "clear_the_ruins"
display_name = "Clear the Ruins"
brief_description = "Clear the bandit infestation from the old watchtower ruins."
full_briefing = "Ironmark has put a bounty on clearing the ancient watchtower ruins..."
difficulty = Difficulty.MEDIUM
gold_reward = 500
gold_reward_max = 0  # Base reward, cache is separate
bonus_reward_description = "+200g if hidden cache found"
map_scene = "res://scenes/combat/maps/RuinedFort.tscn"
enemy_description = "Bandits (6 Melee, 3 Archer, 1 Leader)"
enemy_count = 10
contract_type = ContractType.COMBAT
has_pre_combat_dialogue = false
triggers_camp_scene = true
camp_scene_id = "lyra_camp_1"
```

**Tunable Constants:**
```gdscript
const CACHE_BONUS_GOLD: int = 200
const RALLY_COOLDOWN_TURNS: int = 3
const RALLY_RANGE_TILES: int = 5
const RALLY_ATK_BONUS: int = 2
const RALLY_DURATION_TURNS: int = 2
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Contract flows from board selection to combat to resolution
- [ ] Combat uses Ruined Fort map with correct enemy placement
- [ ] 6 Bandit Melee spawn and behave correctly (rush nearest)
- [ ] 3 Bandit Archers spawn on tower with high ground bonus
- [ ] 1 Bandit Leader spawns with Rally Bandits ability
- [ ] Rally Bandits ability activates every 3 turns, buffs nearby bandits
- [ ] Hidden cache discoverable by moving unit to specific tile
- [ ] Cache discovery grants +200 gold bonus
- [ ] Victory screen shows base reward + cache bonus separately
- [ ] Combat is noticeably harder than tutorial contract
- [ ] Camp scene (Lyra) triggers after victory
- [ ] Gold properly added to GameState on completion
- [ ] Contract marked as completed in GameState

---

## Testing Checklist

### Functional Tests
- [ ] Select contract from board: Transitions to combat setup
- [ ] Pre-battle briefing displays with correct intel
- [ ] All 10 enemies spawn in correct positions
- [ ] Archers start on tower with high ground bonus
- [ ] Leader uses Rally Bandits when conditions met
- [ ] Rally visually shows on affected bandits
- [ ] Moving to cache tile triggers discovery
- [ ] Cache bonus (+200g) added to reward
- [ ] Victory triggers when all enemies dead
- [ ] Victory screen shows correct gold breakdown
- [ ] Continue button triggers Lyra camp scene

### Edge Case Tests
- [ ] Kill Leader first: Remaining bandits fight without Rally buffs
- [ ] Find cache before engaging any enemy: Works correctly
- [ ] All party members die: Defeat screen, contract not completed
- [ ] Soldiers all die but party survives: Victory still possible
- [ ] Leave cache undiscovered: Base reward only (500g)
- [ ] Leader dies while Rally is active: Existing buffs persist their duration

### Integration Tests
- [ ] GameState.gold increases by correct amount (500 or 700)
- [ ] GameState.completed_contract_ids includes "clear_the_ruins"
- [ ] GameState.active_contract cleared after completion
- [ ] Contract removed from Contract Board
- [ ] Lyra camp scene data loads correctly
- [ ] Returning to hub shows updated gold

### Balance Tests
- [ ] Combat takes 8-10 minutes (harder than tutorial's 5 min)
- [ ] Player likely loses 1-2 soldiers (not trivial)
- [ ] Rally ability feels impactful (noticeable when active)
- [ ] Cache location is discoverable but not obvious
- [ ] Victory feels earned, not guaranteed

### Polish Tests
- [ ] Rally Bandits animation clear and readable
- [ ] Buff indicators visible on affected enemies
- [ ] Cache discovery effect satisfying
- [ ] Victory screen layout clear
- [ ] No softlocks or crashes

---

## Implementation Notes

**Enemy AI Priority:**
- Leader AI needs special handling - don't just use generic enemy_ai.gd
- Leader should prefer using Rally over attacking if allies benefit
- Archers should stay on tower unless pushed off or tower destroyed

**Rally Bandits Implementation:**
Consider adding a buff system if not already implemented:
```gdscript
# In unit.gd or separate buff_manager.gd
var active_buffs: Array[Buff] = []

func apply_buff(buff: Buff) -> void:
    active_buffs.append(buff)
    _update_stats_from_buffs()

func _tick_buffs() -> void:
    for buff in active_buffs:
        buff.remaining_turns -= 1
        if buff.remaining_turns <= 0:
            active_buffs.erase(buff)
    _update_stats_from_buffs()
```

**Cache Discovery:**
- Use Area2D with body_entered signal
- Set collision mask to detect unit CharacterBody2D
- Visual hint: broken chest sprite with slight sparkle
- Don't make it too obvious - reward exploration
- Consider using tile data instead of Area2D if simpler

**Map Modifications:**
- Ensure RuinedFort.tscn has:
  - Tower tiles marked as high_ground
  - Wall tiles blocking movement/LOS
  - Rubble tiles as difficult terrain
  - Cache tile position noted

**Camp Scene Trigger:**
- After victory screen Continue pressed
- Check contract.triggers_camp_scene and camp_scene_id
- Transition to camp scene system with "lyra_camp_1"
- Lyra questions why player took Ironmark contract

**Lyra Camp Scene Content (lyra_camp_1.json):**
- Lyra expresses distrust of Ironmark
- Player choices: Defend Ironmark, Agree with suspicion, Stay neutral
- Loyalty effects: Defend (-5 Lyra, +5 Thorne), Agree (+5 Lyra, -5 Thorne), Neutral (0)
- Foreshadows Contract 3 moral choice

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `scenes/contracts/ClearTheRuins.tscn` | Create | Contract combat scene |
| `scripts/contracts/clear_the_ruins.gd` | Create | Contract flow controller |
| `resources/contracts/clear_the_ruins.tres` | Modify | Update with camp trigger |
| `scripts/combat/bandit_leader_ai.gd` | Create | Leader-specific AI |
| `scripts/systems/buff_manager.gd` | Create | Buff/debuff system (if needed) |
| `resources/abilities/rally_bandits.tres` | Create | Leader ability resource |
| `resources/dialogue/lyra_camp_1.json` | Create | Post-contract camp scene |
| `scenes/combat/maps/RuinedFort.tscn` | Modify | Add cache location marker |

---

## Design Alignment

### Design Pillars Supported

**Tactical Combat:** This contract directly tests the combat system at scale. With 10 enemies, varied unit types, terrain advantages, and a leader ability, players must use all available tactics:
- Cover to avoid archer fire
- Focus Fire to prioritize Leader
- Flanking to reach archers on tower
- Ability timing (stun Leader before Rally)

**Meaningful Choice:** The hidden cache creates a micro-decision during combat - push aggressively or explore for bonus gold? The camp scene afterward presents another choice affecting companion loyalty.

**Build & Command:** Successfully completing this harder contract rewards more gold (500-700), enabling company growth. Soldier losses matter - recruiting replacements costs money.

### Player Fantasy Reinforcement

Clear the Ruins reinforces the "mercenary company taking dangerous jobs" fantasy. Unlike the tutorial's scripted bandit ambush, this is a proper military operation against a fortified position. The Bandit Leader commanding his troops mirrors the player's own role, creating a commander-vs-commander dynamic.

---

## Hardcoded Values Reference

| Value | Amount | Location |
|-------|--------|----------|
| Total enemies | 10 | clear_the_ruins.gd |
| Bandit Melee count | 6 | clear_the_ruins.gd |
| Bandit Archer count | 3 | clear_the_ruins.gd |
| Bandit Leader count | 1 | clear_the_ruins.gd |
| Base gold reward | 500g | clear_the_ruins.tres |
| Cache bonus gold | 200g | clear_the_ruins.gd |
| Rally cooldown | 3 turns | bandit_leader_ai.gd |
| Rally range | 5 tiles | bandit_leader_ai.gd |
| Rally ATK bonus | +2 | rally_bandits.tres |
| Rally duration | 2 turns | rally_bandits.tres |
| Bandit Leader HP | 30 | enemy unit config |
| Bandit Leader DEF | 14 | enemy unit config |
| Bandit Leader ATK | 1d8+3 | enemy unit config |
| Map size | 14x14 | RuinedFort.tscn |
| Target combat time | 8-10 minutes | balance target |
