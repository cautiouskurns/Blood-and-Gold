# Feature Spec: Combat UI Polish

| Property | Value |
|----------|-------|
| **Feature ID** | 4.3 |
| **Status** | üü¢ Implemented |
| **Priority** | ‚¨ÜÔ∏è High |
| **Estimated Time** | 6-8 hours |
| **Phase** | Phase 4: Polish, Balance & Playtest |
| **Dependencies** | Phase 2 complete (all party members, abilities, combat systems) |

---

## 1. Purpose

### Why This Feature Exists

The current combat UI provides only minimal feedback to players. Units lack visual differentiation beyond color, selected units don't display meaningful stats or information, abilities have no tooltips or visual indicators, and there's no combat log to track what happened. This makes the game feel unpolished and confusing for new players. Without proper UI polish, playtesters will struggle to understand the systems being tested, defeating the purpose of the prototype.

This feature directly supports all four design pillars:
- **Tactical Combat**: Clear information enables better tactical decisions
- **Build & Command**: Unit info displays reinforce the mercenary company fantasy
- **Meaningful Choice**: Ability tooltips help players understand their options
- **Character Progression**: Stats and status displays show character capabilities

### What It Enables

- **Unit Nameplates**: At-a-glance unit identification with role/class indicators
- **Selection Panel**: Comprehensive stats display when a unit is selected
- **Ability Tooltips**: Detailed ability information on hover
- **Targeting Mode Indicators**: Clear feedback when selecting targets
- **Ability Execution Feedback**: Visual animations and effects for ability use
- **Turn Order Enhancement**: Improved turn order display with unit portraits
- **Combat Log**: Scrolling text log of combat events
- **Status Effect Display**: Clear icons showing active buffs/debuffs

### Success Criteria

| Criterion | Measurement |
|-----------|-------------|
| Unit identification | Playtesters can identify all units at a glance |
| Stats visible | Selected unit shows HP, stats, abilities, status effects |
| Ability understanding | Playtesters understand abilities without external explanation |
| Combat log useful | Players can review what happened during enemy turns |
| Turn order clear | Always obvious whose turn it is and who acts next |
| Tooltip coverage | 100% of abilities and status effects have tooltips |

---

## 2. Design Pillar Alignment

| Pillar | How This Feature Supports It |
|--------|------------------------------|
| **Tactical Combat** | Clear UI enables informed tactical decisions. Players need to know unit stats, ability ranges, and status effects to make optimal plays. Information visibility IS tactical depth. |
| **Build & Command** | Nameplates showing unit roles (Fighter, Rogue, Cleric) and soldier types (Infantry, Archer) reinforce the mercenary company fantasy. The selection panel shows your company's capabilities. |
| **Meaningful Choice** | Ability tooltips show damage, range, effects, and remaining uses. Players can't make meaningful choices without understanding their options. |
| **Character Progression** | Stats display shows STR, DEX, current HP, armor, etc. Players see how powerful their characters are. Status effects show temporary modifiers clearly. |

---

## 3. How It Works

### Overview

The Combat UI Polish feature adds six interconnected UI systems that provide comprehensive combat information:

1. **Unit Nameplates** - Floating UI above each unit showing name, role, and HP bar
2. **Selection Panel** - Right-side panel displaying detailed stats when a unit is selected
3. **Enhanced Ability Bar** - Bottom bar with ability buttons, tooltips, and visual feedback
4. **Targeting Indicators** - Visual overlays during ability targeting
5. **Turn Order Panel** - Top bar with unit portraits and turn sequence
6. **Combat Log** - Scrolling text panel showing combat events

All systems update in real-time as combat state changes and work together to provide complete situational awareness.

### User Flow

```
UNIT NAMEPLATE FLOW:
1. Combat begins
2. Each unit displays nameplate above their sprite:
   - Unit name (e.g., "Thorne", "Infantry 1", "Bandit Melee")
   - Role/class icon (sword for fighter, dagger for rogue, etc.)
   - HP bar (color-coded by faction)
   - Status effect icons (if any active)
3. Nameplates update when:
   - Unit takes damage (HP bar animates)
   - Status effect applied/removed (icon appears/disappears)
   - Unit dies (nameplate fades out)

SELECTION PANEL FLOW:
1. Player clicks friendly unit
2. Selection Panel slides in from right side
3. Panel displays:
   - Large portrait
   - Unit name and class
   - Core stats (STR, DEX, CON, HP/Max HP)
   - Attack/Defense values
   - Movement remaining
   - Abilities list with uses remaining
   - Active status effects with durations
4. Player clicks enemy unit:
   - Panel shows reduced info (HP, Defense, status effects)
   - Some stats hidden ("???" for unknown enemy stats)
5. Player clicks empty tile:
   - Panel slides out (hidden)

ABILITY TOOLTIP FLOW:
1. Player hovers over ability button in ability bar
2. After 0.3 second delay, tooltip appears above button
3. Tooltip shows:
   - Ability name (large)
   - Description (what it does)
   - Stats (damage, range, duration)
   - Uses remaining / Uses per battle
   - Special conditions (requires behind, ends turn, etc.)
4. Mouse leaves button ‚Üí tooltip fades out
5. Clicking ability hides tooltip immediately

TARGETING MODE FLOW:
1. Player clicks ability button
2. Ability bar shows "TARGETING" state (ability highlighted)
3. Valid targets highlighted on grid:
   - Green overlay for valid tiles/units
   - Red outline for current hover target
   - Range indicator showing ability reach
4. Ability-specific targeting:
   - Arc abilities: Show arc overlay following mouse
   - AOE abilities: Show affected area
   - Line abilities: Show line of effect
5. Click valid target ‚Üí execute ability
6. Right-click or ESC ‚Üí cancel targeting

COMBAT LOG FLOW:
1. Combat log panel visible in bottom-left
2. As events occur, messages added:
   - "[Unit] attacks [Target] for [X] damage!"
   - "[Unit] misses [Target]!"
   - "[Unit] uses [Ability]!"
   - "[Target] is now [Status Effect]!"
   - "[Unit] moves from [A] to [B]"
3. Messages scroll up as new ones added
4. Can scroll through history
5. Color-coded by event type:
   - Damage dealt: Red
   - Damage taken: Orange
   - Healing: Green
   - Ability use: Blue
   - Status effects: Purple
   - Movement: Gray
```

### Rules & Constraints

| Rule | Description |
|------|-------------|
| Nameplates always visible | Unit nameplates shown for all units regardless of selection |
| Selection shows one unit | Only one unit's details shown at a time |
| Tooltips appear after delay | 0.3 second hover delay before tooltip appears |
| Tooltips fit on screen | Tooltips reposition to avoid screen edges |
| Combat log max lines | Shows last 8 lines, scrollable to see more |
| Log persists between turns | Full combat log preserved for entire battle |
| Targeting cancellable | Right-click or ESC always cancels targeting mode |
| Enemy info limited | Some enemy stats hidden to preserve uncertainty |

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Unit under another unit's nameplate | Nameplates offset to avoid overlap |
| Long ability descriptions | Tooltip expands vertically, max 300px wide |
| Combat log overflow | Older messages removed after 100 entries |
| Tooltip at screen edge | Tooltip flips to opposite side of button |
| Selection during enemy turn | Selection panel shows enemy info briefly |
| Status effect on status effect | Icons stack horizontally, wrap if too many |
| Very long unit name | Truncate with "..." after 15 characters |
| Mouse leaves screen during tooltip | Tooltip hidden immediately |

---

## 4. User Interaction

### Controls

| Input | Action | Context |
|-------|--------|---------|
| Click unit | Select unit, show details | Any time during combat |
| Hover ability | Show tooltip | Unit selected |
| Click ability | Enter targeting mode | Unit selected, ability available |
| Hover valid target | Highlight target | Targeting mode |
| Click valid target | Execute ability | Targeting mode |
| Right-click / ESC | Cancel targeting | Targeting mode |
| Click empty space | Deselect unit | Unit selected |
| Scroll combat log | View older messages | Combat log panel |
| Hover status icon | Show status tooltip | Any unit with status |

### Visual Feedback

| Event | Visual |
|-------|--------|
| Unit selected | Selection indicator, panel slides in |
| Ability hovered | Button highlight, tooltip appears |
| Ability unavailable | Button grayed out, "X" overlay |
| Targeting mode active | Ability button glows, grid overlays shown |
| Valid target hovered | Red outline on target |
| Ability executed | Button flashes, animation plays |
| Damage dealt | Damage number + HP bar animates |
| Status applied | Icon appears with "+" animation |
| Status expired | Icon fades out with "-" animation |
| Turn changed | Turn order panel animates, current unit glows |

### Audio Feedback (Future)

| Event | Sound |
|-------|-------|
| Unit selected | Soft click |
| Ability clicked | Interface beep |
| Targeting confirmed | Confirmation tone |
| Targeting cancelled | Cancel tone |
| Log message added | Subtle notification |

*Note: Audio is out of scope for prototype but noted for future.*

---

## 5. Visual Design

### Unit Nameplate Layout

```
    +---------------------------+
    |  [icon] Unit Name         |
    |  +---------------------+  |
    |  |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë|  |  <- HP Bar
    |  +---------------------+  |
    |  [buff1] [buff2] [debuff] |  <- Status icons (if any)
    +---------------------------+

Party: Blue HP bar, gold text
Enemy: Red HP bar, white text
Soldier: Green HP bar, white text

Icon Legend:
‚öîÔ∏è Fighter    üó°Ô∏è Rogue    ‚úùÔ∏è Cleric    üõ°Ô∏è Infantry    üèπ Archer
```

### Selection Panel Layout

```
+--------------------------------+
|        [PORTRAIT]              |
|                                |
|   THORNE BLACKWOOD             |
|   Fighter - Loyal              |
+--------------------------------+
|  HP:  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 32/40         |
|  STR: 16 (+3)   DEX: 10 (+0)   |
|  CON: 14 (+2)   WIS: 12 (+1)   |
+--------------------------------+
|  Attack:  +5     Defense: 15   |
|  Movement: 5/5 tiles           |
+--------------------------------+
| ABILITIES                      |
| [Cleave]     [Taunt]           |
| [Last Stand] [Attack]          |
| Uses: 1/1    Uses: 0/1         |
+--------------------------------+
| STATUS EFFECTS                 |
| [Blessed +2] 2 turns           |
| [Taunted] 1 turn               |
+--------------------------------+
```

### Ability Tooltip Layout

```
+----------------------------------+
|  CLEAVE                          |
|  --------------------------------|
|  Swing in a wide arc, hitting    |
|  up to 2 adjacent enemies.       |
|  --------------------------------|
|  Damage: Normal attack           |
|  Range: Adjacent (1 tile)        |
|  Arc: 90 degrees                 |
|  Max Targets: 2                  |
|  --------------------------------|
|  Uses: 1/1 per battle            |
|  ‚ö†Ô∏è Ends turn                    |
+----------------------------------+

Colors:
- Title: Gold (#f1c40f)
- Description: White (#ffffff)
- Stats: Light gray (#bdc3c7)
- Warning: Orange (#e67e22)
- Available: Green (#27ae60)
- Used: Red (#e74c3c)
```

### Turn Order Panel Layout

```
+----------------------------------------------------------------+
|  [P]  [T]  [L]  [M]  [I1]  [I2]  ||  [E1]  [E2]  [E3]  [E4]   |
|  ^^^                                                            |
|  Current turn (glowing border)                                  |
+----------------------------------------------------------------+

P = Player    T = Thorne    L = Lyra    M = Matthias
I = Infantry  E = Enemy

Current turn: Gold glowing border
Dead units: Grayed out, X overlay
```

### Combat Log Layout

```
+----------------------------------+
| COMBAT LOG                    ‚ñ≤  |
|----------------------------------|
| Thorne attacks Bandit for 8!     |
| Bandit Archer shoots Lyra for 5! |
| Lyra uses Shadowstep!            |
| Lyra appears at (4, 7)!          |
| Matthias heals Thorne for 12!    |
| Bandit Melee moves to (3, 5)     |
| >> YOUR TURN <<                  |
|----------------------------------|
|                               ‚ñº  |
+----------------------------------+

Color coding:
- Damage dealt: #e74c3c (red)
- Damage taken: #e67e22 (orange)
- Healing: #27ae60 (green)
- Ability use: #3498db (blue)
- Movement: #95a5a6 (gray)
- Turn marker: #f1c40f (gold)
```

### Targeting Overlay

```
MELEE TARGETING:
    . . . . .
    . . [E] .     <- Valid target (green)
    . . [T] . .   <- Thorne (attacker)
    . . . . .

ABILITY TARGETING (Taunt - 3 tile radius):
    . . . . . . .
    . # # # # # .
    . # # # # # .     <- # = Affected area
    . # # [T] # # .   <- T = Thorne
    . # # # # # .
    . # # # # # .
    . . . . . . .

ARC TARGETING (Cleave):
        [E1]
       /
    [90¬∞ ARC]
         \
    [T]---[E2]

    T = Thorne (attacker)
    E1, E2 = Valid targets in arc
```

### Color Scheme

| Element | Color | Hex |
|---------|-------|-----|
| Panel background | Dark blue | #1a1a2e |
| Panel border | Gold | #f1c40f |
| Text primary | White | #ffffff |
| Text secondary | Light gray | #bdc3c7 |
| HP bar (party) | Blue | #3498db |
| HP bar (enemy) | Red | #e74c3c |
| HP bar (soldier) | Green | #27ae60 |
| HP bar (low) | Orange | #e67e22 |
| Ability available | Bright blue | #3498db |
| Ability unavailable | Dark gray | #4a5568 |
| Valid target | Green overlay | #27ae60 @ 40% |
| Current target | Red border | #e74c3c |
| Tooltip background | Very dark | #0d0d1a @ 95% |

---

## 6. Technical Implementation

### Scene Structure

**scenes/UI/UnitNameplate.tscn:**
```
UnitNameplate (Control)
‚îú‚îÄ‚îÄ NameContainer (HBoxContainer)
‚îÇ   ‚îú‚îÄ‚îÄ ClassIcon (TextureRect) - 16x16 role icon
‚îÇ   ‚îî‚îÄ‚îÄ NameLabel (Label) - Unit name
‚îú‚îÄ‚îÄ HPBarContainer (MarginContainer)
‚îÇ   ‚îî‚îÄ‚îÄ HPBar (ProgressBar) - Color-coded HP
‚îî‚îÄ‚îÄ StatusContainer (HBoxContainer)
    ‚îî‚îÄ‚îÄ [StatusIcon instances added dynamically]
```

**scenes/UI/SelectionPanel.tscn:**
```
SelectionPanel (PanelContainer)
‚îú‚îÄ‚îÄ MarginContainer
‚îÇ   ‚îî‚îÄ‚îÄ VBoxContainer
‚îÇ       ‚îú‚îÄ‚îÄ PortraitSection (CenterContainer)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Portrait (TextureRect) - 128x128
‚îÇ       ‚îú‚îÄ‚îÄ NameSection (VBoxContainer)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ UnitName (Label)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ClassLoyalty (Label)
‚îÇ       ‚îú‚îÄ‚îÄ StatsSection (GridContainer)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [Stat labels]
‚îÇ       ‚îú‚îÄ‚îÄ CombatStatsSection (HBoxContainer)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [Attack, Defense, Movement]
‚îÇ       ‚îú‚îÄ‚îÄ AbilitiesSection (GridContainer)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [Ability mini-buttons]
‚îÇ       ‚îî‚îÄ‚îÄ StatusSection (VBoxContainer)
‚îÇ           ‚îî‚îÄ‚îÄ [Status effect rows]
```

**scenes/UI/AbilityTooltip.tscn:**
```
AbilityTooltip (PanelContainer)
‚îú‚îÄ‚îÄ MarginContainer
‚îÇ   ‚îî‚îÄ‚îÄ VBoxContainer
‚îÇ       ‚îú‚îÄ‚îÄ TitleLabel (Label) - Ability name
‚îÇ       ‚îú‚îÄ‚îÄ HSeparator
‚îÇ       ‚îú‚îÄ‚îÄ DescriptionLabel (RichTextLabel)
‚îÇ       ‚îú‚îÄ‚îÄ HSeparator
‚îÇ       ‚îú‚îÄ‚îÄ StatsContainer (VBoxContainer)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [Damage, Range, etc.]
‚îÇ       ‚îî‚îÄ‚îÄ UsesContainer (HBoxContainer)
‚îÇ           ‚îî‚îÄ‚îÄ [Uses remaining, warnings]
```

**scenes/UI/CombatLog.tscn:**
```
CombatLog (PanelContainer)
‚îú‚îÄ‚îÄ VBoxContainer
‚îÇ   ‚îú‚îÄ‚îÄ HeaderLabel (Label) - "COMBAT LOG"
‚îÇ   ‚îî‚îÄ‚îÄ ScrollContainer
‚îÇ       ‚îî‚îÄ‚îÄ LogContainer (VBoxContainer)
‚îÇ           ‚îî‚îÄ‚îÄ [LogEntry labels added dynamically]
```

### Script Responsibilities

**scripts/UI/unit_nameplate.gd:**
```gdscript
class_name UnitNameplate
extends Control

## Floating nameplate above a unit showing name, HP, and status

@onready var class_icon: TextureRect = $NameContainer/ClassIcon
@onready var name_label: Label = $NameContainer/NameLabel
@onready var hp_bar: ProgressBar = $HPBarContainer/HPBar
@onready var status_container: HBoxContainer = $StatusContainer

var attached_unit: Unit

func setup(unit: Unit) -> void:
    ## Initialize nameplate for a unit
    attached_unit = unit
    name_label.text = unit.unit_name
    class_icon.texture = _get_class_icon(unit.unit_class)
    _update_hp_bar()
    _update_status_icons()

    # Connect to unit signals
    unit.unit_damaged.connect(_on_unit_damaged)
    unit.status_effect_added.connect(_on_status_added)
    unit.status_effect_removed.connect(_on_status_removed)

func _update_hp_bar() -> void:
    hp_bar.max_value = attached_unit.max_hp
    hp_bar.value = attached_unit.current_hp
    hp_bar.modulate = _get_hp_color()

func _update_status_icons() -> void:
    # Clear existing icons
    for child in status_container.get_children():
        child.queue_free()

    # Add icon for each status effect
    for effect in attached_unit.get_status_effects():
        var icon = StatusIcon.new()
        icon.setup(effect)
        status_container.add_child(icon)
```

**scripts/UI/selection_panel.gd:**
```gdscript
class_name SelectionPanel
extends PanelContainer

## Right-side panel showing detailed unit information

@onready var portrait: TextureRect = $MarginContainer/VBoxContainer/PortraitSection/Portrait
@onready var unit_name: Label = $MarginContainer/VBoxContainer/NameSection/UnitName
@onready var class_loyalty: Label = $MarginContainer/VBoxContainer/NameSection/ClassLoyalty
@onready var stats_container: GridContainer = $MarginContainer/VBoxContainer/StatsSection
@onready var abilities_container: GridContainer = $MarginContainer/VBoxContainer/AbilitiesSection
@onready var status_container: VBoxContainer = $MarginContainer/VBoxContainer/StatusSection

var current_unit: Unit
var _is_visible: bool = false

func show_unit(unit: Unit) -> void:
    ## Display detailed information for a unit
    current_unit = unit

    # Set basic info
    portrait.texture = unit.portrait_texture
    unit_name.text = unit.unit_name
    class_loyalty.text = "%s - %s" % [unit.unit_class, _get_loyalty_text(unit)]

    # Update stats
    _populate_stats(unit)

    # Update abilities
    _populate_abilities(unit)

    # Update status effects
    _populate_status_effects(unit)

    # Animate panel in
    if not _is_visible:
        _slide_in()

func hide_panel() -> void:
    ## Hide the selection panel
    if _is_visible:
        _slide_out()

func _slide_in() -> void:
    _is_visible = true
    var tween = create_tween()
    tween.tween_property(self, "position:x", 0, 0.2).from(300)

func _slide_out() -> void:
    _is_visible = false
    var tween = create_tween()
    tween.tween_property(self, "position:x", 300, 0.2)

func _populate_stats(unit: Unit) -> void:
    # Clear and repopulate stats grid
    for child in stats_container.get_children():
        child.queue_free()

    _add_stat_row("HP", "%d/%d" % [unit.current_hp, unit.max_hp])
    _add_stat_row("STR", "%d (%+d)" % [unit.strength, unit.get_modifier(unit.strength)])
    _add_stat_row("DEX", "%d (%+d)" % [unit.dexterity, unit.get_modifier(unit.dexterity)])
    _add_stat_row("CON", "%d (%+d)" % [unit.constitution, unit.get_modifier(unit.constitution)])
    _add_stat_row("Attack", "%+d" % unit.get_attack_bonus())
    _add_stat_row("Defense", "%d" % unit.get_defense())
    _add_stat_row("Movement", "%d/%d" % [unit.movement_remaining, unit.movement_speed])
```

**scripts/UI/ability_tooltip.gd:**
```gdscript
class_name AbilityTooltip
extends PanelContainer

## Tooltip showing detailed ability information

@onready var title_label: Label = $MarginContainer/VBoxContainer/TitleLabel
@onready var description_label: RichTextLabel = $MarginContainer/VBoxContainer/DescriptionLabel
@onready var stats_container: VBoxContainer = $MarginContainer/VBoxContainer/StatsContainer
@onready var uses_label: Label = $MarginContainer/VBoxContainer/UsesContainer/UsesLabel

func show_ability(ability: Ability, uses_remaining: int, uses_max: int) -> void:
    ## Display tooltip for an ability
    title_label.text = ability.display_name
    description_label.text = ability.description

    # Clear and populate stats
    for child in stats_container.get_children():
        child.queue_free()

    # Add relevant stats
    if ability.ability_type in [Ability.AbilityType.MELEE_ATTACK, Ability.AbilityType.BACKSTAB]:
        _add_stat("Damage", _get_damage_text(ability))
        _add_stat("Range", "Adjacent (1 tile)")

    if ability.ability_type == Ability.AbilityType.RANGED_ATTACK:
        _add_stat("Damage", _get_damage_text(ability))
        _add_stat("Range", "%d tiles" % ability.ability_range)

    if ability.ability_type == Ability.AbilityType.TELEPORT:
        _add_stat("Range", "%d tiles" % ability.ability_range)

    if ability.ability_type == Ability.AbilityType.ARC_ATTACK:
        _add_stat("Arc", "%d degrees" % ability.arc_angle)
        _add_stat("Max Targets", "%d" % ability.max_targets)

    if ability.applies_status != "":
        _add_stat("Applies", ability.applies_status)
        if ability.status_duration > 0:
            _add_stat("Duration", "%d turns" % ability.status_duration)

    # Uses remaining
    if uses_max > 0:
        uses_label.text = "Uses: %d/%d per battle" % [uses_remaining, uses_max]
        uses_label.modulate = Color.RED if uses_remaining == 0 else Color.WHITE
    else:
        uses_label.text = "Unlimited uses"

    # Warning if ends turn
    if ability.ends_turn:
        _add_warning("Ends turn")

    if ability.requires_behind:
        _add_warning("Requires attacking from behind")

    show()

func _add_stat(stat_name: String, stat_value: String) -> void:
    var label = Label.new()
    label.text = "%s: %s" % [stat_name, stat_value]
    label.add_theme_color_override("font_color", Color("#bdc3c7"))
    stats_container.add_child(label)

func _add_warning(warning_text: String) -> void:
    var label = Label.new()
    label.text = "! %s" % warning_text
    label.add_theme_color_override("font_color", Color("#e67e22"))
    stats_container.add_child(label)
```

**scripts/UI/combat_log.gd:**
```gdscript
class_name CombatLogPanel
extends PanelContainer

## Scrolling log of combat events

@onready var scroll_container: ScrollContainer = $VBoxContainer/ScrollContainer
@onready var log_container: VBoxContainer = $VBoxContainer/ScrollContainer/LogContainer

const MAX_ENTRIES = 100
const COLOR_DAMAGE_DEALT = Color("#e74c3c")
const COLOR_DAMAGE_TAKEN = Color("#e67e22")
const COLOR_HEALING = Color("#27ae60")
const COLOR_ABILITY = Color("#3498db")
const COLOR_MOVEMENT = Color("#95a5a6")
const COLOR_TURN = Color("#f1c40f")

func _ready() -> void:
    # Connect to combat manager signals
    CombatManager.ability_executed.connect(_on_ability_executed)
    CombatManager.unit_damaged.connect(_on_unit_damaged)
    CombatManager.unit_healed.connect(_on_unit_healed)
    CombatManager.unit_moved.connect(_on_unit_moved)
    CombatManager.turn_started.connect(_on_turn_started)

func add_entry(message: String, color: Color = Color.WHITE) -> void:
    ## Add a new log entry
    var label = Label.new()
    label.text = message
    label.add_theme_color_override("font_color", color)
    label.autowrap_mode = TextServer.AUTOWRAP_WORD
    log_container.add_child(label)

    # Remove oldest entries if over limit
    while log_container.get_child_count() > MAX_ENTRIES:
        log_container.get_child(0).queue_free()

    # Scroll to bottom
    await get_tree().process_frame
    scroll_container.scroll_vertical = scroll_container.get_v_scroll_bar().max_value

func _on_ability_executed(user: Unit, ability_id: String, targets: Array) -> void:
    var ability_name = _get_ability_name(ability_id)
    add_entry("%s uses %s!" % [user.unit_name, ability_name], COLOR_ABILITY)

func _on_unit_damaged(unit: Unit, amount: int, source: Unit) -> void:
    if source:
        add_entry("%s deals %d damage to %s!" % [source.unit_name, amount, unit.unit_name], COLOR_DAMAGE_DEALT)
    else:
        add_entry("%s takes %d damage!" % [unit.unit_name, amount], COLOR_DAMAGE_TAKEN)

func _on_unit_healed(unit: Unit, amount: int, source: Unit) -> void:
    add_entry("%s heals %s for %d HP!" % [source.unit_name, unit.unit_name, amount], COLOR_HEALING)

func _on_unit_moved(unit: Unit, from: Vector2i, to: Vector2i) -> void:
    add_entry("%s moves to (%d, %d)" % [unit.unit_name, to.x, to.y], COLOR_MOVEMENT)

func _on_turn_started(unit: Unit) -> void:
    if unit.is_player_controlled:
        add_entry(">> %s'S TURN <<" % unit.unit_name.to_upper(), COLOR_TURN)
```

### Integration Points

| System | Integration |
|--------|-------------|
| CombatManager | Emit signals for combat log, selection changes |
| Unit | Emit signals for damage, healing, status effects |
| AbilityBar | Show tooltips on hover, targeting feedback |
| TurnManager | Update turn order panel, turn indicators |
| StatusEffects | Display icons on nameplates and selection panel |
| CombatGrid | Show targeting overlays during ability use |

### Signals

| Signal | Emitter | Parameters | Purpose |
|--------|---------|------------|---------|
| `unit_selected` | CombatManager | `(unit)` | Show selection panel |
| `unit_deselected` | CombatManager | `()` | Hide selection panel |
| `ability_hover_started` | AbilityButton | `(ability)` | Show tooltip |
| `ability_hover_ended` | AbilityButton | `()` | Hide tooltip |
| `targeting_started` | CombatManager | `(ability, valid_targets)` | Show targeting overlays |
| `targeting_ended` | CombatManager | `()` | Hide targeting overlays |
| `combat_log_entry` | Various | `(message, color)` | Add log entry |

---

## 7. File Structure

```
scenes/UI/
‚îú‚îÄ‚îÄ UnitNameplate.tscn           # NEW: Floating nameplate
‚îú‚îÄ‚îÄ SelectionPanel.tscn          # NEW: Right-side detail panel
‚îú‚îÄ‚îÄ AbilityTooltip.tscn          # NEW: Ability hover tooltip
‚îú‚îÄ‚îÄ StatusTooltip.tscn           # NEW: Status effect tooltip
‚îú‚îÄ‚îÄ CombatLog.tscn               # NEW: Scrolling event log
‚îú‚îÄ‚îÄ TurnOrderPanel.tscn          # MODIFY: Enhanced with portraits
‚îú‚îÄ‚îÄ AbilityBar.tscn              # MODIFY: Add tooltip support
‚îú‚îÄ‚îÄ AbilityButton.tscn           # MODIFY: Add hover signals
‚îú‚îÄ‚îÄ StatusIcon.tscn              # NEW: Individual status icon
‚îî‚îÄ‚îÄ TargetingOverlay.tscn        # NEW: Grid overlay for targeting

scripts/UI/
‚îú‚îÄ‚îÄ unit_nameplate.gd            # NEW: Nameplate logic
‚îú‚îÄ‚îÄ selection_panel.gd           # NEW: Selection panel logic
‚îú‚îÄ‚îÄ ability_tooltip.gd           # NEW: Tooltip logic
‚îú‚îÄ‚îÄ status_tooltip.gd            # NEW: Status tooltip logic
‚îú‚îÄ‚îÄ combat_log.gd                # NEW: Combat log logic
‚îú‚îÄ‚îÄ turn_order_panel.gd          # MODIFY: Enhanced logic
‚îú‚îÄ‚îÄ ability_bar.gd               # MODIFY: Add tooltip integration
‚îú‚îÄ‚îÄ ability_button.gd            # MODIFY: Add hover detection
‚îú‚îÄ‚îÄ status_icon.gd               # NEW: Status icon logic
‚îî‚îÄ‚îÄ targeting_overlay.gd         # NEW: Targeting overlay logic

assets/sprites/ui/
‚îú‚îÄ‚îÄ class_icons/                 # NEW: Role/class icons
‚îÇ   ‚îú‚îÄ‚îÄ fighter.png
‚îÇ   ‚îú‚îÄ‚îÄ rogue.png
‚îÇ   ‚îú‚îÄ‚îÄ cleric.png
‚îÇ   ‚îú‚îÄ‚îÄ infantry.png
‚îÇ   ‚îî‚îÄ‚îÄ archer.png
‚îú‚îÄ‚îÄ status_icons/                # EXISTS: Expand with more icons
‚îú‚îÄ‚îÄ portraits/                   # EXISTS or NEW: Unit portraits
‚îÇ   ‚îú‚îÄ‚îÄ player.png
‚îÇ   ‚îú‚îÄ‚îÄ thorne.png
‚îÇ   ‚îú‚îÄ‚îÄ lyra.png
‚îÇ   ‚îî‚îÄ‚îÄ matthias.png
‚îî‚îÄ‚îÄ panel_backgrounds/           # NEW: Panel textures
    ‚îú‚îÄ‚îÄ selection_panel_bg.png
    ‚îú‚îÄ‚îÄ tooltip_bg.png
    ‚îî‚îÄ‚îÄ combat_log_bg.png
```

---

## 8. Acceptance Criteria

| # | Criterion | Test Method |
|---|-----------|-------------|
| 1 | Unit nameplates visible above all units | Start combat, verify all units have nameplates |
| 2 | Nameplates show name, HP bar, status icons | Visual inspection during combat |
| 3 | Selection panel shows when unit clicked | Click friendly unit, verify panel appears |
| 4 | Selection panel shows correct stats | Compare displayed stats to unit data |
| 5 | Selection panel hides on deselect | Click empty tile, verify panel hidden |
| 6 | Ability tooltips appear on hover | Hover ability button for 0.5s |
| 7 | Tooltips show correct ability info | Compare tooltip to ability resource |
| 8 | Tooltips reposition at screen edges | Hover ability near screen edge |
| 9 | Combat log records all events | Execute abilities, take damage, verify log |
| 10 | Combat log scrollable | Generate many events, scroll through |
| 11 | Turn order panel shows all units | Verify all combatants in panel |
| 12 | Current turn clearly indicated | Verify gold border on current unit |
| 13 | Targeting overlays show valid targets | Click ability, verify overlays |
| 14 | Targeting cancellable with ESC | Enter targeting, press ESC |
| 15 | Status effects visible on nameplates | Apply status, verify icon appears |

---

## 9. Testing Checklist

### Functional Tests - Nameplates
- [ ] Nameplate appears for party members
- [ ] Nameplate appears for soldiers
- [ ] Nameplate appears for enemies
- [ ] HP bar updates on damage
- [ ] HP bar color changes at low HP
- [ ] Status icons appear when applied
- [ ] Status icons disappear when expired
- [ ] Nameplate fades on unit death
- [ ] Nameplates don't overlap

### Functional Tests - Selection Panel
- [ ] Panel slides in on selection
- [ ] Panel slides out on deselection
- [ ] Portrait displays correctly
- [ ] Stats display correctly
- [ ] Abilities listed with uses
- [ ] Status effects listed with durations
- [ ] Enemy selection shows limited info
- [ ] Panel updates in real-time

### Functional Tests - Tooltips
- [ ] Tooltip appears after hover delay
- [ ] Tooltip shows ability name
- [ ] Tooltip shows description
- [ ] Tooltip shows stats
- [ ] Tooltip shows uses remaining
- [ ] Tooltip shows warnings
- [ ] Tooltip repositions at edges
- [ ] Tooltip hides on click
- [ ] Tooltip hides on mouse leave

### Functional Tests - Combat Log
- [ ] Damage events logged
- [ ] Ability use events logged
- [ ] Movement events logged
- [ ] Healing events logged
- [ ] Status effect events logged
- [ ] Turn changes logged
- [ ] Log scrollable
- [ ] Old entries removed at limit
- [ ] Colors correct per event type

### Functional Tests - Targeting
- [ ] Valid targets highlighted
- [ ] Hovered target has distinct indicator
- [ ] Arc targeting shows arc overlay
- [ ] Range shown visually
- [ ] ESC cancels targeting
- [ ] Right-click cancels targeting
- [ ] Click on valid target executes ability

### Integration Tests
- [ ] All systems update in real-time
- [ ] Performance acceptable with all UI active
- [ ] UI doesn't block game interaction
- [ ] Panel Z-ordering correct
- [ ] Tooltips don't persist incorrectly

### Edge Cases
- [ ] Very long unit names truncated
- [ ] Many status effects handled
- [ ] Rapid selection changes handled
- [ ] Tooltip at all screen edges
- [ ] Combat log with 100+ entries

---

## 10. Implementation Notes

### Approach Rationale

**Why nameplates instead of just HP bars?**
- Nameplates provide immediate unit identification
- Role icons reinforce character fantasies
- Status icons on nameplates reduce need to select units
- Consistent presentation across all unit types

**Why slide-in panel instead of overlay?**
- Doesn't obscure the combat grid
- Clear relationship between selection and information
- Can be dismissed easily
- Familiar pattern from many games

**Why 0.3 second tooltip delay?**
- Prevents tooltip spam when moving mouse
- Fast enough to feel responsive
- Standard UI pattern users expect
- Balances visibility with non-intrusiveness

**Why combat log instead of floating text only?**
- Players can review enemy turns
- Helps understand what happened
- Reduces information overload during combat
- Provides history for strategic review

### Gotchas to Watch

1. **Nameplate positioning**: Must follow unit smoothly during movement
2. **Panel blocking**: Ensure selection panel doesn't block abilities at edge
3. **Tooltip flickering**: Properly handle mouse enter/exit edge cases
4. **Log performance**: Don't create too many log entries per frame
5. **Z-ordering**: Tooltips must appear above all other UI
6. **Screen size**: Test at different resolutions for panel sizing

### Alternative Approaches Considered

| Approach | Pros | Cons | Decision |
|----------|------|------|----------|
| Info on hover only | Less clutter | Requires hovering | Rejected |
| **Persistent nameplates** | Always visible | Minor clutter | **Chosen** |
| Full screen panel | More space | Blocks view | Rejected |
| **Slide-in panel** | Compact, accessible | Limited space | **Chosen** |
| Instant tooltips | Fast | Annoying | Rejected |
| **Delayed tooltips** | Comfortable | Slight delay | **Chosen** |
| No combat log | Less UI | Information lost | Rejected |
| **Scrolling log** | History preserved | Extra panel | **Chosen** |

### Performance Considerations

- Use object pooling for nameplate status icons
- Limit combat log entry count to prevent memory growth
- Cache tooltip content to avoid repeated generation
- Use visibility culling for off-screen nameplates
- Batch UI updates where possible

---

## 11. Definition of Done

- [ ] `scenes/UI/UnitNameplate.tscn` created and functional
- [ ] `scenes/UI/SelectionPanel.tscn` created and functional
- [ ] `scenes/UI/AbilityTooltip.tscn` created and functional
- [ ] `scenes/UI/CombatLog.tscn` created and functional
- [ ] Unit nameplates display for all units with HP bars
- [ ] Selection panel shows comprehensive unit information
- [ ] Ability tooltips display on hover with all details
- [ ] Combat log records all combat events
- [ ] Turn order panel enhanced with portraits
- [ ] Targeting overlays show valid targets
- [ ] All acceptance criteria pass
- [ ] UI performs well with many units
- [ ] Code follows GDScript style guidelines
- [ ] Playtester can understand all systems without explanation

---

## 12. References

### From GDD

- **UI Section** (Section 5: Prototype Scope):
  - Combat HUD (HP bars, turn order, ability buttons)
  - Simple character sheet

- **Phase 4 Goals** (Section 6):
  - Combat UI polish (turn indicator, ability tooltips)
  - Clear feedback on state changes

- **Success Metrics** (Section 7):
  - "Playtesters understand the systems"
  - "Clear whose turn it is"
  - "Abilities have tooltip descriptions"

### From Roadmap

- **Task 4.3**: Combat UI Polish (Phase 4, 3 hours estimated)
- **What**: Make combat UI clear and readable
- **Deliverables**:
  - Improve turn indicator visibility
  - Add ability tooltips
  - Add action confirmation
  - Add combat log

### Related Tasks

- Task 1.3 (HP Bars) - Existing HP bar system
- Task 1.6 (Turn Order Panel) - Existing turn order display
- Task 2.2 (Ability UI Panel) - Existing ability bar

### Godot Documentation

- [Control nodes](https://docs.godotengine.org/en/stable/classes/class_control.html)
- [PanelContainer](https://docs.godotengine.org/en/stable/classes/class_panelcontainer.html)
- [Tweening](https://docs.godotengine.org/en/stable/classes/class_tween.html)
- [ScrollContainer](https://docs.godotengine.org/en/stable/classes/class_scrollcontainer.html)
- [RichTextLabel](https://docs.godotengine.org/en/stable/classes/class_richtextlabel.html)
