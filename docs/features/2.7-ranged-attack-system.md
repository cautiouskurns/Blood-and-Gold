# Task 2.7: Ranged Attack System

**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 4-6 hours
**Dependencies:** Task 1.7 (Basic Melee Attack - attack system foundation)
**Assigned To:** AI Assistant

---

## Purpose

**Why does this feature exist?**
Units equipped with bows or crossbows currently have no way to utilize their ranged capabilities. The game needs a ranged attack system to support diverse combat tactics, allow positioning-based gameplay, and enable ranged-focused characters like Lyra to fulfill their combat role.

**What does it enable?**
Players can attack enemies from a distance using ranged weapons, adding tactical depth through line-of-sight requirements and positioning decisions. Ranged units can stay behind the front line while contributing damage, and enemies with ranged weapons become more threatening. This creates meaningful choices about unit placement and target prioritization.

**Success criteria:**
- Units with ranged weapons (shortbow, crossbow) can attack enemies within their weapon's range
- Line-of-sight checking prevents shooting through walls and obstacles
- Range indicator shows valid attack tiles when ranged attack is selected
- Ranged attacks do NOT provoke opportunity attacks (unlike movement)
- Shortbow has 8-tile range, Crossbow has 10-tile range
- Attack resolution uses same d20 + ATK vs DEF system as melee

---

## How It Works

### Overview

The ranged attack system extends the existing melee attack infrastructure to support weapons that can strike targets at a distance. Unlike melee attacks which only work on adjacent tiles, ranged attacks can hit any enemy within the weapon's range, provided there is a clear line of sight between attacker and target.

**Weapon Range Property**: Each weapon now has a `weapon_range` property. Melee weapons have range 1 (adjacent only), while ranged weapons have extended ranges: Shortbow (8 tiles) and Crossbow (10 tiles). This property determines the maximum distance at which a unit can attack.

**Line of Sight (LoS)**: Before a ranged attack can be made, the system checks if there's an unobstructed path between the attacker and target using the Bresenham line algorithm. Obstacles (walls, impassable terrain) block line of sight. Other units do NOT block line of sight (you can shoot over/past allies and enemies).

**Range Indicator**: When a ranged attack ability is selected, tiles within range AND with valid line of sight are highlighted, showing the player exactly where they can attack. Invalid tiles (out of range or blocked LoS) remain unhighlighted.

**Opportunity Attacks**: Unlike movement which can trigger opportunity attacks from adjacent enemies, ranged attacks are performed without moving, so they never provoke opportunity attacks. This makes ranged units safer but requires them to maintain distance.

### User Flow

```
=== Ranged Attack Flow ===
1. Player selects a unit with a ranged weapon (e.g., Lyra)
2. Player clicks "Attack" ability in AbilityBar
3. System calculates valid targets:
   a. Find all enemies within weapon range
   b. For each enemy, check line of sight
   c. Highlight valid targets (red) within range indicator
4. Range overlay shows all tiles within weapon range with LoS
5. Player clicks on a valid enemy target
6. System resolves attack:
   a. Roll d20 + attacker's attack bonus
   b. Compare to target's Defense
   c. If hit: roll weapon damage + modifiers
   d. Apply damage to target
7. Floating damage number appears over target (or "Miss")
8. Attacker's turn ends (if ability ends turn)

=== Range Indicator Flow ===
1. When ranged attack targeting begins:
2. System draws range overlay:
   a. Diamond/circle shape showing max range (8 or 10 tiles)
   b. Tiles with blocked LoS shown dimmed or excluded
   c. Valid enemy targets within range highlighted red
3. Player can see exactly where they can attack before choosing target
```

### Rules & Constraints

**Weapon Range:**
- Melee weapons: Range 1 (adjacent tiles only)
- Shortbow: Range 8 tiles
- Crossbow: Range 10 tiles
- Range is calculated using Chebyshev distance (king moves) for consistency with movement

**Line of Sight:**
- Uses Bresenham line algorithm from attacker to target
- Blocked by: Walls, impassable terrain tiles
- NOT blocked by: Other units (allies or enemies), passable terrain
- If ANY tile on the line is blocked, LoS is blocked
- Attacker's and target's tiles are always considered clear

**Attack Resolution:**
- Same as melee: d20 + attack_bonus vs target's Defense
- Hit: Roll weapon damage dice + strength/dexterity modifier
- Miss: No damage dealt, "Miss" shown
- Critical hit on natural 20: Double damage
- Ranged weapons may use DEX modifier (bow/crossbow) instead of STR

**Opportunity Attacks:**
- Ranged attacks do NOT provoke opportunity attacks
- Moving while adjacent to enemies still provokes (unchanged)
- This encourages ranged units to maintain distance

**Range Calculation:**
- Chebyshev distance: max(|x1-x2|, |y1-y2|)
- This matches diagonal movement costing 1 tile
- Example: Target 5 tiles east and 3 tiles north = 5 tiles away

### Edge Cases

- **What happens if target moves behind cover during targeting?**
  - Can't happen in turn-based system - units don't move during another unit's turn

- **What happens if attacker has melee weapon but clicks ranged target?**
  - Target won't be valid (out of range), can't be clicked

- **What happens if target is exactly at max range?**
  - Valid target if LoS is clear (range is inclusive)

- **What happens if obstacle partially blocks target tile?**
  - Use center-to-center LoS check; partial cover is not implemented yet

- **What happens if there are no valid ranged targets?**
  - Attack ability shows as available but no targets highlight
  - Player can click Attack, see no valid targets, right-click to cancel

- **What happens with diagonal line of sight?**
  - Bresenham handles diagonals; a wall on the diagonal blocks LoS

---

## User Interaction

### Controls

- **Left-click on Attack ability:** Begin ranged attack targeting (shows range indicator)
- **Left-click on valid target:** Execute ranged attack on that enemy
- **Right-click or ESC during targeting:** Cancel attack targeting
- **Mouse hover over tiles:** Show whether tile is in range and has LoS

### Visual Feedback

**Range Indicator:**
- Diamond/circle overlay showing weapon range from attacker's position
- Blue-tinted tiles for valid attack positions (in range + LoS clear)
- Dimmed or excluded tiles for blocked LoS
- Enemy units in valid positions highlighted with red glow

**Attack Execution:**
- Attack animation plays (placeholder: attacker flashes, projectile line drawn)
- Target flashes on hit
- Floating damage number appears (red) or "Miss" text
- Target health bar updates immediately

**Ability Button States:**
- Available: Normal appearance when unit has ranged weapon
- Selected: Highlighted when targeting mode active
- Unavailable: Grayed out if no valid targets exist in range

### Audio Feedback (if applicable)

- Bow shot: Twang/whoosh sound
- Crossbow shot: Click/thunk sound
- Hit: Impact sound
- Miss: Whoosh/arrow hitting ground sound

---

## Visual Design

### Layout

Range indicator overlay displays as a diamond shape (Chebyshev distance) centered on the attacking unit. Valid tiles within range and line of sight are highlighted. Enemy targets within valid tiles show additional targeting indicator.

### Components

**Range Overlay:**
- Semi-transparent blue fill for tiles in range with clear LoS
- No fill for tiles out of range
- Darker/gray fill for tiles in range but blocked LoS
- Red highlight on valid enemy targets

**Projectile Indicator (optional):**
- Simple line from attacker to target when attack executes
- Arrow/bolt sprite traveling along line (stretch goal)

### Visual Style

- Range overlay: Blue tint (#4a90d9 at 30% opacity) matching movement range style
- Blocked LoS: Gray (#888888 at 20% opacity) or excluded entirely
- Target highlight: Red glow (#e74c3c) matching melee target highlight
- Projectile line: White/yellow temporary line effect

### States

- **Default (no targeting):** No range overlay shown
- **Targeting active:** Full range overlay with LoS checks, valid targets highlighted
- **Target hovered:** Additional bright highlight on hovered valid target
- **Executing:** Projectile animation, then damage/miss feedback

---

## Technical Implementation

### Scene Structure

No new scenes required. Modifications to existing systems:
- `CombatGrid` - Add range indicator rendering and LoS calculation
- `AttackResolver` - Extend to support ranged attacks

### Script Modifications

**1. scripts/resources/weapon.gd - Add range property:**

```gdscript
# Existing weapon resource
@export var weapon_range: int = 1  # 1 = melee, 8 = shortbow, 10 = crossbow
@export var is_ranged: bool = false  # true for bows, crossbows
@export var uses_dexterity: bool = false  # ranged weapons use DEX for attack/damage
```

**2. scripts/combat/attack_resolver.gd - Add ranged attack support:**

```gdscript
static func can_attack_target(attacker: Unit, target: Unit) -> bool:
    ## Check if attacker can attack target with their weapon
    var weapon = attacker.get_equipped_weapon()
    var distance = _get_distance(attacker.grid_position, target.grid_position)

    # Check range
    if distance > weapon.weapon_range:
        return false

    # Check line of sight for ranged weapons
    if weapon.is_ranged and distance > 1:
        if not _has_line_of_sight(attacker.grid_position, target.grid_position):
            return false

    return true

static func _get_distance(from: Vector2i, to: Vector2i) -> int:
    ## Chebyshev distance (king moves)
    return maxi(absi(to.x - from.x), absi(to.y - from.y))

static func _has_line_of_sight(from: Vector2i, to: Vector2i) -> bool:
    ## Bresenham line algorithm to check LoS
    var points = _get_line_points(from, to)
    for point in points:
        if point == from or point == to:
            continue
        if CombatManager.is_tile_blocked(point):
            return false
    return true

static func _get_line_points(from: Vector2i, to: Vector2i) -> Array[Vector2i]:
    ## Bresenham's line algorithm
    var points: Array[Vector2i] = []
    var dx = absi(to.x - from.x)
    var dy = absi(to.y - from.y)
    var sx = 1 if from.x < to.x else -1
    var sy = 1 if from.y < to.y else -1
    var err = dx - dy
    var x = from.x
    var y = from.y

    while true:
        points.append(Vector2i(x, y))
        if x == to.x and y == to.y:
            break
        var e2 = 2 * err
        if e2 > -dy:
            err -= dy
            x += sx
        if e2 < dx:
            err += dx
            y += sy

    return points

static func resolve_attack(attacker: Unit, target: Unit) -> Dictionary:
    ## Resolve attack - works for both melee and ranged
    var weapon = attacker.get_equipped_weapon()

    # Validate target is in range and LoS
    if not can_attack_target(attacker, target):
        return {"success": false, "reason": "Invalid target"}

    # Get attack modifier (use DEX for ranged weapons)
    var attack_mod = attacker.get_attack_bonus()
    if weapon.uses_dexterity:
        attack_mod = attacker.get_dexterity_modifier() + attacker.get_attack_buff()

    # Roll d20 + modifier vs Defense
    var roll = _roll_d20()
    var total = roll + attack_mod
    var hit = total >= target.defense or roll == 20
    var critical = roll == 20

    if not hit:
        return {"success": true, "hit": false, "roll": roll, "total": total}

    # Roll damage
    var damage = _roll_damage(weapon, attacker, critical)
    target.take_damage(damage)

    return {
        "success": true,
        "hit": true,
        "critical": critical,
        "roll": roll,
        "total": total,
        "damage": damage
    }
```

**3. scripts/combat/combat_grid.gd - Add range indicator:**

```gdscript
var _range_indicator_tiles: Array[Vector2i] = []
var _range_indicator_visible: bool = false

func show_attack_range(unit: Unit) -> void:
    ## Display attack range indicator for unit's weapon
    var weapon = unit.get_equipped_weapon()
    if weapon == null:
        return

    _range_indicator_tiles.clear()
    var origin = unit.grid_position
    var weapon_range = weapon.weapon_range

    # Calculate all tiles in range with LoS
    for x in range(origin.x - weapon_range, origin.x + weapon_range + 1):
        for y in range(origin.y - weapon_range, origin.y + weapon_range + 1):
            var tile = Vector2i(x, y)
            if tile == origin:
                continue
            var distance = AttackResolver._get_distance(origin, tile)
            if distance <= weapon_range:
                if weapon.is_ranged:
                    if AttackResolver._has_line_of_sight(origin, tile):
                        _range_indicator_tiles.append(tile)
                else:
                    _range_indicator_tiles.append(tile)

    _range_indicator_visible = true
    queue_redraw()

func hide_attack_range() -> void:
    ## Hide attack range indicator
    _range_indicator_visible = false
    _range_indicator_tiles.clear()
    queue_redraw()

func _draw() -> void:
    # ... existing draw code ...

    # Draw range indicator
    if _range_indicator_visible:
        for tile in _range_indicator_tiles:
            var rect = Rect2(tile * tile_size, Vector2(tile_size, tile_size))
            draw_rect(rect, Color(0.29, 0.56, 0.85, 0.3))  # Blue tint
```

**4. scripts/autoload/combat_manager.gd - Add LoS helper:**

```gdscript
func is_tile_blocked(tile: Vector2i) -> bool:
    ## Check if tile blocks line of sight (walls, obstacles)
    # Check against tilemap or obstacle list
    if not _is_tile_in_bounds(tile):
        return true
    if _is_tile_obstacle(tile):
        return true
    return false

func get_enemies_in_weapon_range(unit: Unit) -> Array[Unit]:
    ## Get all enemies unit can attack with current weapon
    var enemies: Array[Unit] = []
    for enemy in get_all_enemies():
        if AttackResolver.can_attack_target(unit, enemy):
            enemies.append(enemy)
    return enemies
```

**5. Weapon Resources - Update with range:**

`resources/weapons/shortbow.tres`:
```
weapon_range = 8
is_ranged = true
uses_dexterity = true
damage_dice = 1
damage_die_size = 6
```

`resources/weapons/crossbow.tres`:
```
weapon_range = 10
is_ranged = true
uses_dexterity = true
damage_dice = 1
damage_die_size = 8
```

### Integration Points

- **Connects to:** AttackResolver (attack execution), CombatGrid (range display), CombatManager (target validation)
- **Emits signals:**
  - `attack_range_shown(unit)` - when range indicator displayed
  - `attack_range_hidden()` - when range indicator hidden
- **Listens for:**
  - `ability_button_pressed(ability_id)` - to show range on attack select
  - `targeting_cancelled()` - to hide range indicator
- **Modifies:**
  - Target unit's HP (on hit)
  - No modification to attacker position (stationary attack)

### Configuration

**Weapon Range Values:**
| Weapon | Range | Notes |
|--------|-------|-------|
| Sword | 1 | Melee only |
| Staff | 1 | Melee only |
| Dagger | 1 | Melee only |
| Shortbow | 8 | Ranged, uses DEX |
| Crossbow | 10 | Ranged, uses DEX |

---

## Acceptance Criteria

Feature is complete when:

- [ ] Weapons have a `weapon_range` property distinguishing melee (1) from ranged (8-10)
- [ ] Line of sight calculation using Bresenham algorithm correctly identifies blocked paths
- [ ] Range indicator displays when selecting attack ability with ranged weapon
- [ ] Range indicator shows tiles in range with clear LoS (blue highlight)
- [ ] Enemy targets within valid range are highlighted (red)
- [ ] Clicking valid target executes ranged attack with d20 + DEX vs Defense
- [ ] Damage calculated using weapon damage dice + DEX modifier
- [ ] Ranged attacks do NOT trigger opportunity attacks from adjacent enemies
- [ ] Shortbow works at 8 tile range
- [ ] Crossbow works at 10 tile range
- [ ] Melee attacks unchanged (range 1, no LoS check required)

---

## Testing Checklist

### Functional Tests

- [ ] **Shortbow range:** Verify attacks work at exactly 8 tiles, fail at 9
- [ ] **Crossbow range:** Verify attacks work at exactly 10 tiles, fail at 11
- [ ] **LoS clear:** Attack succeeds when clear diagonal line to target
- [ ] **LoS blocked:** Attack fails when wall between attacker and target
- [ ] **Attack roll:** d20 + DEX modifier correctly calculated for ranged
- [ ] **Damage roll:** Weapon damage + DEX modifier applied on hit
- [ ] **Miss display:** "Miss" floating text on failed attack roll
- [ ] **Critical hit:** Natural 20 doubles damage for ranged attacks

### Edge Case Tests

- [ ] **Target at max range:** Attack works at exactly 8/10 tiles
- [ ] **Target behind multiple enemies:** Attack still works (units don't block LoS)
- [ ] **Diagonal LoS through corner:** Test wall on diagonal correctly blocks
- [ ] **Attacker adjacent to enemy:** Ranged attack still works (no LoS issue for range 1)
- [ ] **No ranged weapon equipped:** Attack only valid for adjacent targets

### Integration Tests

- [ ] **Works with ability system:** Attack ability triggers ranged flow
- [ ] **Works with turn system:** Turn ends after ranged attack
- [ ] **Works with damage numbers:** Floating damage appears over ranged target
- [ ] **Opportunity attacks NOT triggered:** Moving away triggers OA, ranged attack doesn't

### Polish Tests

- [ ] **Range indicator visible:** Blue overlay clearly shows attack range
- [ ] **Target highlighting:** Valid targets clearly indicated with red
- [ ] **Smooth transitions:** Range indicator appears/disappears cleanly
- [ ] **Performance:** No lag when calculating LoS for max range weapons

---

## Implementation Notes

*(For AI assistant or future developer)*

- **Bresenham vs Raycast:** Use Bresenham line algorithm rather than raycast for grid-based consistency. Bresenham gives predictable, tile-based results that match the grid system.

- **LoS checking obstacles:** Need to identify what blocks LoS. Likely need a method in CombatGrid or CombatManager that checks tile collision data. For prototype, hardcode obstacle tiles or use TileMap collision layers.

- **Range indicator performance:** For 10-tile range, checking ~400 tiles for LoS. This should be fast enough, but if slow, consider caching or limiting recalculation.

- **DEX vs STR for damage:** Ranged weapons should use DEX for both attack AND damage modifiers. This differs from melee which uses STR for damage. Mark weapons with `uses_dexterity` flag.

- **Opportunity attacks integration:** Task 2.8 or later adds opportunity attacks. When implementing, ensure ranged attacks don't call the OA trigger. Only movement should trigger OA checks.

- **Future: Cover system:** This spec doesn't include cover mechanics (half cover, three-quarters cover reducing accuracy). That would be a future enhancement.

- **Consistent distance formula:** Use Chebyshev distance (max of dx, dy) everywhere for consistency. This matches how movement works where diagonal costs 1.

---
