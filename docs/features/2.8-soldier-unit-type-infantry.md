# Task 2.8: Soldier Unit Type (Infantry)

**Status:** üî¥ Planned
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 1.5 hours
**Dependencies:** Task 2.1 (unit system), Task 1.8 (turn system)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The core fantasy of Blood & Gold is commanding a mercenary company with NPC soldiers who follow your orders. Infantry soldiers are the backbone of this system - melee fighters who execute standing orders autonomously during their turns, freeing the player to focus on party tactics rather than micromanaging every unit.

**What does it enable?**
- Players experience the "Build & Command" design pillar - leading soldiers, not just controlling party members
- Larger-scale tactical battles (8-12 units vs 15-20 enemies) that feel like commanding a warband
- Strategic depth through order management rather than individual unit micromanagement

**Success criteria:**
- Infantry soldiers appear with distinct teal/green sprites distinguishable from party and enemies
- Soldiers act autonomously on their turn based on their current order (ADVANCE or HOLD)
- Order icon is clearly visible above the soldier showing their current standing order
- Soldiers target and engage appropriate enemies based on their order logic

---

## How It Works

### Overview

Infantry soldiers are NPC allies that the player recruits to join their mercenary company. Unlike party members (who the player directly controls each action), soldiers follow **standing orders** and act autonomously during their turn based on that order.

When an infantry soldier's turn comes up in initiative order, they evaluate their current order and execute appropriate actions:
- **ADVANCE:** Move toward the nearest enemy and attack if adjacent
- **HOLD:** Stay in current position, attack any enemy that enters range

This creates the "commander" fantasy - the player issues strategic orders to groups of soldiers while focusing their tactical attention on party member abilities. The GDD specifically calls out that soldiers should "feel like a commander" not "micromanagement hell."

Infantry are melee specialists with moderate stats (HP 20, DEF 13, ATK 1d6+1). They're more expendable than party members - soldier deaths don't trigger defeat, but losing too many affects combat effectiveness. Their teal color scheme visually distinguishes them from the blue party members and red enemies.

### User Flow

```
1. Battle begins - Infantry soldiers placed on grid alongside party
2. Initiative rolled - Infantry appears in turn order with other units
3. Infantry's turn arrives
4. System checks soldier's current_order property
5. If ADVANCE: Find nearest enemy, pathfind toward them, attack if adjacent
6. If HOLD: Stay in place, attack any adjacent enemy
7. Order icon above soldier shows current order
8. Turn ends, next unit acts
9. Player can change orders via Order Panel (Task 2.10)
```

### Rules & Constraints

- **Order Persistence:** Orders persist until the player issues a new order
- **Self-Defense:** If attacked while on HOLD, soldier defends (attacks back) but doesn't chase
- **Target Priority:** ADVANCE prioritizes nearest enemy by tile distance
- **Movement:** Infantry can move up to 4 tiles per turn (slower than most party members)
- **Attack:** Standard melee attack (1d6+1), must be adjacent to target
- **Death:** Soldier deaths don't trigger defeat condition, but soldier is removed from combat
- **No Direct Control:** Player cannot manually move soldiers or choose their attack targets
- **Turn Grouping (Future):** For now, each soldier acts individually; Phase 4 may group soldier turns

### Edge Cases

- **No enemies reachable (ADVANCE):** Move toward closest enemy even if can't reach this turn
- **All enemies dead:** Soldier stands idle, order icon remains
- **Multiple equidistant enemies:** Pick one (first found in enemy list)
- **Path blocked:** Find alternative path; if completely blocked, stay in place
- **Adjacent to multiple enemies (HOLD):** Attack one (first found), doesn't move to attack others
- **Soldier starts adjacent to enemy:** Attack immediately without moving

---

## User Interaction

### Controls

- **No direct control:** Soldiers cannot be clicked to select for movement/attack
- **Order Panel (Task 2.10):** Player clicks order button, then clicks soldier to assign
- **Selection indicator:** Soldiers don't show selection ring (only party members do)

### Visual Feedback

- **Order Icon:** 32x32 icon floating above soldier showing current order
  - Sword icon for ADVANCE (aggressive)
  - Shield icon for HOLD (defensive)
- **Turn Indicator:** Current soldier's turn highlighted in turn order panel
- **Movement Animation:** Soldier moves along path same as party members (0.15s per tile)
- **Attack Animation:** Same attack feedback as party (damage numbers, flash)
- **Death Animation:** Same death animation as other units (fade out)

### Audio Feedback (if applicable)

- Placeholder: Same attack/movement sounds as other units
- Future: Distinct "grunt" or "hrah" for soldier attacks

---

## Visual Design

### Layout

```
Infantry Soldier Unit:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   [Order Icon]  ‚îÇ  <- 32x32 icon, centered above unit
‚îÇ        ‚Üì        ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ   ‚îÇ    I    ‚îÇ   ‚îÇ  <- 56x56 teal square with "I" letter
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ   [===HP===]    ‚îÇ  <- HP bar below
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Components

- **Sprite2D:** Teal colored square (56x56) with "I" letter
- **Order Icon:** Small sprite above unit showing current order
- **HP Bar:** Standard health bar (same as other units)
- **Letter Label:** "I" for Infantry identification

### Visual Style

- **Base Color:** #1abc9c (Teal) - distinguishes from blue party / red enemy
- **Border Color:** #17a589 (Darker Teal)
- **Letter:** "I" in white, centered on sprite
- **Order Icon:** White/cream colored, 32x32 with dark outline
- **Icon Position:** 20 pixels above sprite top

### States

- **Default:** Teal sprite with current order icon
- **Taking Turn:** Slight pulse/glow (same as party members)
- **Damaged:** Red flash on sprite
- **Low HP:** HP bar turns red (< 25%)
- **Dead:** Fade out animation, removed from grid

---

## Technical Implementation

### Scene Structure

```
InfantrySoldier.tscn (inherits Unit.tscn)
‚îú‚îÄ‚îÄ Sprite2D (teal colored, inherits setup)
‚îú‚îÄ‚îÄ LetterLabel ("I")
‚îú‚îÄ‚îÄ HPBar
‚îú‚îÄ‚îÄ SelectionIndicator (hidden - soldiers not selectable)
‚îú‚îÄ‚îÄ ClickArea (disabled for soldiers)
‚îú‚îÄ‚îÄ OrderIcon (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ Sprite2D (order icon texture)
‚îî‚îÄ‚îÄ (inherited nodes from Unit.tscn)
```

### Script Responsibilities

- **unit.gd (modified):**
  - Add `current_order: String = "HOLD"` property
  - Add `order_icon: Sprite2D` node reference
  - `_configure_stats_for_type()` sets infantry stats
  - `set_order(order_name)` updates order and icon
  - `get_current_order()` returns current order

- **soldier_ai.gd (NEW):**
  - `execute_turn(soldier: Unit)` - Main entry point from turn_manager
  - `_execute_advance_order(soldier)` - Move toward enemy, attack if adjacent
  - `_execute_hold_order(soldier)` - Stay in place, attack adjacent enemies
  - `_find_nearest_enemy(soldier)` - Returns closest enemy unit
  - `_find_adjacent_enemy(soldier)` - Returns enemy in melee range
  - `_move_toward_target(soldier, target)` - Pathfind and move
  - `_perform_attack(soldier, target)` - Execute melee attack

- **turn_manager.gd (modified):**
  - Check if current unit is soldier with `is_soldier` flag
  - If soldier, call `SoldierAI.execute_turn()` instead of waiting for player input

### Integration Points

- **Connects to:** CombatManager (battle state), TurnManager (turn execution)
- **Emits signals:**
  - `order_changed(soldier, new_order)` when order updates
- **Listens for:**
  - Turn system signals to know when it's soldier's turn
- **Modifies:**
  - Turn flow (soldiers act automatically, don't wait for input)

### Configuration

- **Stats in unit.gd:** Hardcoded in `_configure_stats_for_type()` switch
- **Order Icons:** `assets/sprites/ui/order_icons/` directory
  - `advance_icon.png` (32x32)
  - `hold_icon.png` (32x32)

---

## Acceptance Criteria

Feature is complete when:

- [ ] Infantry soldier appears on grid with distinct teal sprite and "I" letter
- [ ] Soldier has correct stats: HP 20, DEF 13, ATK 1d6+1, Move 4
- [ ] Order icon (sword/shield) visible above soldier showing current order
- [ ] When soldier's turn arrives, they act automatically (no player input needed)
- [ ] ADVANCE order: Soldier moves toward nearest enemy, attacks if adjacent
- [ ] HOLD order: Soldier stays in place, attacks adjacent enemies
- [ ] Soldier death doesn't trigger defeat (only party deaths do)
- [ ] Multiple infantry soldiers can exist and act independently
- [ ] Soldier appears in turn order panel with correct icon

---

## Testing Checklist

### Functional Tests

- [ ] **Spawn Test:** Infantry spawns at correct grid position with teal sprite
- [ ] **Stats Test:** Verify HP=20, DEF=13, weapon die=6, move=4
- [ ] **Turn Test:** Soldier acts on their turn without player input
- [ ] **ADVANCE Test:** Soldier moves toward enemy and attacks
- [ ] **HOLD Test:** Soldier stays in place, attacks adjacent enemy
- [ ] **Order Icon Test:** Icon updates when order changes
- [ ] **Death Test:** Soldier dies correctly, removed from grid and turn order

### Edge Case Tests

- [ ] **No path available:** Soldier handles blocked path gracefully
- [ ] **Multiple enemies same distance:** Soldier picks one target
- [ ] **No enemies:** Soldier stands idle on ADVANCE
- [ ] **Already adjacent (ADVANCE):** Attacks instead of moving
- [ ] **No adjacent enemies (HOLD):** Stands idle

### Integration Tests

- [ ] Works with turn order panel (appears correctly)
- [ ] Works with damage number system (shows damage)
- [ ] Works with pathfinding system (moves correctly)
- [ ] Works with attack resolver (damage calculated correctly)
- [ ] Doesn't break party member selection/control

### Polish Tests

- [ ] Movement animation smooth (0.15s per tile)
- [ ] Attack animations play correctly
- [ ] Order icon clearly visible
- [ ] HP bar updates correctly
- [ ] Death animation plays

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Use existing UnitType.INFANTRY:** Already defined in unit.gd enum and color dictionaries
2. **Set is_soldier = true:** This flag already exists and prevents defeat on soldier death
3. **Disable click selection:** Soldiers shouldn't be selectable like party members
4. **Auto-turn execution:** TurnManager needs to detect soldiers and auto-execute their turn
5. **Order icon positioning:** Add as child node of Unit, position above sprite

### Stats Configuration (in _configure_stats_for_type)

```gdscript
UnitType.INFANTRY:
    is_enemy = false
    is_soldier = true
    unit_name = unit_name if unit_name != "Unit" else "Infantry"
    max_hp = 20
    current_hp = 20
    strength = 12  # +1 modifier
    dexterity = 10  # +0 modifier
    armor_bonus = 3  # DEF 10 + 3 = 13
    skill_rank = 1
    weapon_damage_die = 6  # 1d6
    movement_range = 4
    weapon_range = 1  # Melee
    is_ranged_weapon = false
```

### Soldier AI Approach

The SoldierAI script should be a simple utility class (could be autoload or static):

```gdscript
# Pseudocode for soldier_ai.gd
static func execute_turn(soldier: Unit) -> void:
    var order = soldier.current_order

    match order:
        "ADVANCE":
            var target = _find_nearest_enemy(soldier)
            if target:
                if _is_adjacent(soldier, target):
                    _perform_attack(soldier, target)
                else:
                    _move_toward_target(soldier, target)
                    # Check again after moving
                    if _is_adjacent(soldier, target):
                        _perform_attack(soldier, target)
        "HOLD":
            var target = _find_adjacent_enemy(soldier)
            if target:
                _perform_attack(soldier, target)

    # End soldier's turn
    CombatManager.end_current_turn()
```

### Alternative Approaches Considered

1. **Separate InfantrySoldier class:** Rejected because Unit already handles UnitType variations well. Adding complexity for little benefit.

2. **Coroutine-based AI:** Could use await for smoother animations, but adds complexity. Start simple with immediate execution, add await later if needed.

3. **Behavior tree:** Overkill for simple two-order system. Match statement is sufficient for prototype scope.

### Dependencies on Other Tasks

- **Task 2.10 (Order Panel):** Will add UI to change orders. For now, orders can be set in code or default to HOLD.
- **Task 2.11 (Order Behaviors):** Extends this with FOCUS FIRE, RETREAT, PROTECT orders.
- **Task 2.9 (Archer):** Similar implementation but with ranged attacks.

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| HP | 20 | Lower than party (25-40) |
| Defense | 13 | Base 10 + 3 armor |
| Attack | 1d6 + 1 | STR 12 = +1 modifier |
| Movement | 4 tiles | Slower than most (party is 5-6) |
| Sprite Color | #1abc9c | Teal (distinct from blue party) |
| Border Color | #17a589 | Darker teal |
| Letter | "I" | Infantry identifier |
| Order Icon Size | 32x32 | Positioned above unit |
| Icon Offset Y | -60 pixels | Above sprite and HP bar |

---
