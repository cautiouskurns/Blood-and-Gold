# Feature Implementation Report: Implement Player Abilities

**Feature:** Implement Player Abilities (Task 2.3)
**Spec File:** docs/features/2.3-implement-player-abilities.md
**Implemented:** 2026-01-12
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts created: 3
- Scenes created: 0
- Data files created: 4 (.tres ability resources)
- Files modified: 4
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: **Build & Command** (Rally buffs soldiers, reinforcing the commander fantasy)
- Supports design pillar: **Tactical Combat** (Power Attack vs Basic Attack tradeoff, Shield Bash crowd control)
- Reinforces player fantasy: Commander who leads from the front with tactical options
- Within scope boundaries

---

## What Was Done

### Overview

The player ability system was implemented, giving the Player character 4 distinct abilities that define their role as a mercenary commander:

1. **Basic Attack** - Standard melee attack, unlimited uses
2. **Power Attack** - High damage (+50%) but harder to hit (-2 penalty), once per battle
3. **Shield Bash** - Deals damage and stuns the target for 1 turn, once per battle
4. **Rally** - Inspires all friendly soldiers, giving them +2 attack for 2 turns, once per battle

The implementation includes a data-driven Ability resource system, a StatusEffectManager autoload for tracking buffs/debuffs, and an AbilityExecutor for processing ability effects. The system integrates with the existing turn system to handle stun effects (stunned units skip their turn) and with the combat system for modified damage calculations.

### Technical Changes

- Created Ability resource class for data-driven ability definitions
- Created StatusEffectManager autoload singleton for global status effect tracking
- Created AbilityExecutor for executing ability effects
- Modified Unit to track ability usage and query status effects
- Modified TurnManager to skip turns for stunned units
- Modified CombatManager with helper methods and ability execution API

---

## Files Created

### Scripts

#### 1. scripts/resources/ability.gd
**Purpose:** Data class defining ability properties as a Godot Resource

**Key Properties:**
- `id`, `display_name`, `description` - Identification
- `ability_type` - MELEE_ATTACK, SOLDIER_BUFF, etc.
- `uses_per_battle` - -1 for unlimited, 1+ for limited
- `damage_multiplier`, `attack_modifier`, `bonus_damage` - Combat modifiers
- `applies_status`, `status_duration`, `status_value` - Status effect data

**Key Methods:**
- `is_available_for_unit(unit)` - Check if ability can be used

**Enums:**
- `AbilityType`: MELEE_ATTACK, RANGED_ATTACK, SELF_BUFF, ALLY_BUFF, SOLDIER_BUFF, AOE_ATTACK
- `TargetType`: NONE, ENEMY_ADJACENT, ENEMY_RANGE, ALLY, SELF

---

#### 2. scripts/autoload/status_effect_manager.gd
**Purpose:** Global singleton managing status effects on all units

**Key Methods:**
- `apply_effect(target, effect_type, duration, value)` - Apply effect to unit
- `has_effect(unit, effect_type)` - Check if unit has effect
- `get_effect_value(unit, effect_type)` - Get effect value (e.g., +2 attack)
- `remove_effect(unit, effect_type)` - Remove specific effect
- `clear_all_effects()` - Clear all effects (battle end)
- `get_unit_effects(unit)` - Get all effects on a unit

**Signals:**
- `effect_applied(unit, effect_type, duration, value)`
- `effect_removed(unit, effect_type)`
- `effect_tick(unit, effect_type, remaining)`

**Effect Types:**
- `STUNNED` - Unit skips their turn
- `ATTACK_BUFF` - Unit gains bonus to attack rolls

---

#### 3. scripts/combat/ability_executor.gd
**Purpose:** Executes ability effects, calculating damage and applying status

**Key Methods:**
- `execute(user, ability, target)` - Main execution entry point
- `_execute_melee_attack(user, ability, target)` - Handle attack abilities
- `_execute_soldier_buff(user, ability)` - Handle buff abilities (Rally)
- `_spawn_damage_number(target, damage, is_critical)` - Visual feedback
- `_spawn_miss_number(target)` - Miss indicator

**Returns Dictionary with:**
- `success`, `hit`, `damage_dealt`, `status_applied`, `targets_affected`, `message`

---

### Data Files

#### 1. resources/abilities/basic_attack.tres
- **Type:** MELEE_ATTACK
- **Uses:** Unlimited (-1)
- **Damage Multiplier:** 1.0x
- **Attack Modifier:** 0
- **Status:** None

#### 2. resources/abilities/power_attack.tres
- **Type:** MELEE_ATTACK
- **Uses:** 1 per battle
- **Damage Multiplier:** 1.5x (+50%)
- **Attack Modifier:** -2
- **Status:** None

#### 3. resources/abilities/shield_bash.tres
- **Type:** MELEE_ATTACK
- **Uses:** 1 per battle
- **Damage Multiplier:** 1.0x
- **Attack Modifier:** 0
- **Status:** STUNNED for 1 turn

#### 4. resources/abilities/rally.tres
- **Type:** SOLDIER_BUFF
- **Uses:** 1 per battle
- **Target:** All friendly soldiers
- **Status:** ATTACK_BUFF +2 for 2 turns

---

## Files Modified

### 1. project.godot
**Changes:**
- Added autoload: `StatusEffectManager` -> `res://scripts/autoload/status_effect_manager.gd`

### 2. scripts/combat/unit.gd
**Changes:**
- Added `_ability_uses: Dictionary` for tracking per-battle usage
- Added `_ability_resources: Dictionary` for caching loaded abilities
- Added `use_ability(ability_id)` - Record ability usage
- Added `get_ability_uses(ability_id)` - Get usage count
- Added `reset_ability_uses()` - Reset at battle start
- Added `get_ability_resource(ability_id)` - Load Ability resource
- Added `is_stunned()` - Check stun status
- Added `get_attack_buff()` - Get attack buff value
- Added `get_all_status_effects()` - Get all effects
- Modified `get_attack_bonus()` - Now includes attack buff
- Modified `is_ability_available()` - Uses Ability resource validation

### 3. scripts/combat/turn_manager.gd
**Changes:**
- Modified `start_battle()` - Resets ability uses for all units
- Modified `_start_current_turn()` - Checks for stun, skips turn if stunned

### 4. scripts/autoload/combat_manager.gd
**Changes:**
- Added `has_adjacent_enemies(unit)` - Check for adjacent enemies
- Added `get_adjacent_enemies(unit)` - Get list of adjacent enemies
- Added `get_friendly_soldiers(unit)` - Get all friendly soldiers
- Added `get_all_friendly_units(unit)` - Get all friendly units
- Added `notify_unit_death(unit)` - Notify turn manager of death
- Added `execute_ability(user, ability_id, target)` - Main ability execution API

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- Player character could only use Basic Attack (via direct attack clicking)
- No status effects system
- No way to buff soldiers
- No crowd control options

**After Implementation:**
- Player has 4 distinct tactical options each turn
- Power Attack for burst damage against high-value targets
- Shield Bash for crowd control (stun prevents enemy action)
- Rally for force multiplication (buffing soldier attacks)
- Status effects persist and tick down each turn

### New Mechanics Introduced

1. **Once-Per-Battle Abilities:** Special abilities (Power Attack, Shield Bash, Rally) can only be used once per battle, creating meaningful decisions about timing.

2. **Status Effects:**
   - STUNNED: Affected unit automatically skips their turn
   - ATTACK_BUFF: Affected units gain bonus to attack rolls

3. **Damage Modifiers:** Power Attack applies a 1.5x damage multiplier but -2 to attack roll.

4. **Soldier Buffing:** Rally specifically targets units with `is_soldier = true`, reinforcing the commander fantasy.

### Systems Affected

- **Combat System:** Now checks for attack buffs when calculating attack bonus
- **Turn System:** Now checks for stun status before starting a unit's turn
- **Unit System:** Now tracks ability usage and status effects

---

## What the Player Should Now See

### Visible Differences

#### During Gameplay
- When using **Power Attack**, damage numbers will be larger (~50% more damage)
- When using **Shield Bash** and hitting, the target will skip their next turn
- When using **Rally**, all friendly soldiers will have +2 added to their attack rolls
- The console log will show detailed ability usage information

#### Console Output (Debug)

When abilities are used, you'll see:
```
[Combat] Player uses Power Attack on Enemy 1
[Combat] Attack roll: 15 + 4 - 2 = 17 vs DEF 12 -> HIT
[Combat] Power Attack deals 12 damage to Enemy 1 (CRITICAL!)

[Combat] Player uses Shield Bash on Enemy 2
[Combat] Attack roll: 18 + 6 = 24 vs DEF 12 -> HIT
[Combat] Shield Bash deals 8 damage to Enemy 2
[Combat] Enemy 2 is STUNNED for 1 turn(s)

[Combat] Player uses Rally
[Combat] 2 soldiers gain +2 attack for 2 turns

[TurnManager] Enemy 2's turn - STUNNED, skipping...
[StatusEffect] STUNNED expired on Enemy 2
```

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. Press F5 to run the game
3. Start a battle with enemies
4. When it's the Player's turn, click an adjacent enemy to attack
5. Check the console log for attack messages
6. Check that StatusEffectManager appears in the autoloads

**Success if:** Console shows attack messages and damage calculations

### Comprehensive Testing Checklist

#### Core Functionality
- [ ] **Test 1: Basic Attack**
  - **Steps:** Click adjacent enemy during Player's turn
  - **Expected:** Normal damage dealt (weapon die + STR mod)

- [ ] **Test 2: Power Attack Damage**
  - **Steps:** Use Power Attack ability on adjacent enemy
  - **Expected:** ~50% more damage than Basic Attack

- [ ] **Test 3: Power Attack Penalty**
  - **Steps:** Check console log for Power Attack
  - **Expected:** Shows -2 in attack calculation

- [ ] **Test 4: Shield Bash Stun**
  - **Steps:** Use Shield Bash on enemy, wait for their turn
  - **Expected:** Enemy's turn is skipped, console shows "STUNNED - skipping turn"

- [ ] **Test 5: Rally Buff**
  - **Steps:** Use Rally with friendly soldiers in battle
  - **Expected:** Console shows soldiers gaining +2 attack

- [ ] **Test 6: Buff Duration**
  - **Steps:** Use Rally, count soldier turns
  - **Expected:** Buff expires after 2 soldier turns

- [ ] **Test 7: Once Per Battle**
  - **Steps:** Use Power Attack twice
  - **Expected:** Second use should fail (ability unavailable)

#### Acceptance Criteria Verification

| Criterion | How to Test | Expected Result |
|-----------|-------------|-----------------|
| Power Attack damage 50% more | Compare damage numbers | 1.5x base damage |
| Power Attack -2 penalty | Check console log | Shows -2 in roll |
| Shield Bash stuns | Watch enemy turn | Enemy skips turn |
| Rally buffs soldiers | Check console | Shows +2 attack |
| Rally lasts 2 turns | Count turns | Expires after 2 |
| Special abilities once | Try to reuse | Fails/unavailable |
| Basic Attack unlimited | Use every turn | Always works |

---

## Troubleshooting

### Issue: Ability not found
**Symptom:** Console shows "Ability not found: [ability_id]"
**Cause:** Ability resource file missing or not at expected path
**Fix:** Verify `resources/abilities/[ability_id].tres` exists

### Issue: StatusEffectManager not working
**Symptom:** Status effects not applying, stun not working
**Cause:** StatusEffectManager not registered as autoload
**Fix:** Check Project Settings > Autoload for StatusEffectManager entry

### Issue: Stunned unit still acts
**Symptom:** Unit with STUNNED effect takes their turn normally
**Cause:** TurnManager not checking stun at turn start
**Fix:** Verify `_start_current_turn()` calls `unit.is_stunned()` before emitting turn_started

### Issue: Attack buff not applying
**Symptom:** Soldiers don't get +2 attack after Rally
**Cause:** `get_attack_bonus()` not calling `get_attack_buff()`
**Fix:** Verify Unit.gd modification to include buff in attack calculation

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest to check integration
2. [ ] Implement Ability UI integration (Task 2.2 connection)
3. [ ] Implement Thorne abilities (Task 2.4)
4. [ ] Implement Lyra abilities (Task 2.5)
5. [ ] Implement Matthias abilities (Task 2.6)
6. [ ] Add status effect visual indicators (icons above units)
7. [ ] Update changelog

---

## Definition of Done Checklist

- [x] `scripts/resources/ability.gd` created with all properties
- [x] `scripts/combat/ability_executor.gd` implements all ability types
- [x] `scripts/autoload/status_effect_manager.gd` tracks effects
- [x] `resources/abilities/basic_attack.tres` created
- [x] `resources/abilities/power_attack.tres` created
- [x] `resources/abilities/shield_bash.tres` created
- [x] `resources/abilities/rally.tres` created
- [x] Unit.gd modified for ability tracking and status queries
- [x] TurnManager.gd checks for stun at turn start
- [x] Power Attack configured for 50% more damage with -2 hit penalty
- [x] Shield Bash configured to stun target for 1 turn
- [x] Rally configured to buff soldiers +2 attack for 2 turns
- [x] Special abilities usable once per battle
- [x] Basic Attack usable every turn
- [ ] Status effect icons visible above affected units (visual polish - future)
- [x] Combat log shows ability usage
- [x] Code follows GDScript style guidelines
