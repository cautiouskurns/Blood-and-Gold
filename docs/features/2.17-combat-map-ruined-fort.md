# Task 2.17: Combat Map - Ruined Fort

**Status:** üü¢ Implemented
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 1.5 hours
**Dependencies:** Task 2.16 (Combat Map - Forest Clearing)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The Forest Clearing map tests open terrain and difficult terrain (stream). The Ruined Fort map tests a fundamentally different tactical environment: defensive play with walls, chokepoints, and elevated positions. The GDD explicitly calls for "walls (full cover), rubble (difficult terrain), high ground (tower)" to "test elevation, defensive play." This map creates scenarios where players must break enemy defensive formations or defend a fortified position.

**What does it enable?**
- Second combat map with distinct tactical feel (defensive vs. open)
- Walls that completely block movement AND line of sight (new mechanic)
- Rubble terrain creates difficult terrain areas within ruins
- Tower provides commanding high ground position (2x2 area)
- Tests whether wall/chokepoint mechanics create interesting tactical decisions
- Used by Contract 2 "Clear the Ruins" encounter
- Supports the GDD's emphasis on "break formations" tactics against Ironmark enemies

**Success criteria:**
- Map renders at 14x14 tiles (larger than Forest Clearing)
- Wall tiles block both movement and line of sight (ranged attacks)
- Rubble tiles use existing difficult terrain system (double movement cost)
- Tower area (2x2 tiles) provides +2 ranged attack bonus
- Spawn points support "siege" scenarios (defenders in fort, attackers outside)
- Battle feels tactically different from Forest Clearing

---

## How It Works

### Overview

The Ruined Fort is a 14x14 combat map representing the crumbling remains of an ancient fortification. Unlike the open Forest Clearing, this map emphasizes defensive positioning and chokepoint control. A central ruined tower provides commanding high ground, while partially collapsed walls create both cover and obstacles. Rubble from the collapsed sections creates difficult terrain that slows movement.

The key new mechanic is **wall tiles** that completely block both movement and line of sight. Ranged units cannot shoot through walls, forcing tactical repositioning. This creates natural chokepoints at wall gaps where melee combat becomes inevitable.

The tower is a 2x2 high ground area that offers significant ranged advantage - whoever controls the tower controls the battlefield. The map is designed for Contract 2 "Clear the Ruins" where players must assault a bandit-held position, but can also support defensive scenarios.

### Map Layout

```
    0   1   2   3   4   5   6   7   8   9  10  11  12  13
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
0 | E | E |   |   |   |   |   |   |   |   |   |   | E | E |  <- Enemy spawn (exterior)
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
1 |   |   |   | W | W | W |   |   | W | W | W |   |   |   |  <- Outer wall (north)
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
2 |   |   | W |   |   |   | R | R |   |   |   | W |   |   |  <- Rubble in gaps
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
3 |   | W |   |   |   |   |   |   |   |   |   |   | W |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
4 |   | W |   |   | H | H |   |   |   | C | C |   | W |   |  <- Tower(H) and Cover(C)
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
5 |   | W |   |   | H | H |   |   |   | C |   |   | W |   |  <- Tower (2x2)
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
6 |   | W |   |   |   |   |   |   |   |   |   |   | W |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
7 |   | W |   |   |   |   |   |   |   |   |   |   | W |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
8 |   | W |   |   | C |   |   |   |   | R |   |   | W |   |  <- Interior cover and rubble
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
9 |   | W |   |   | C | C |   |   | R | R |   |   | W |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
10|   |   | W |   |   |   | R | R |   |   |   | W |   |   |  <- Rubble in south gap
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
11|   |   |   | W | W | W |   |   | W | W | W |   |   |   |  <- Outer wall (south)
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
12|   |   |   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+
13| P | P | P |   |   |   |   |   |   |   |   | P | P | P |  <- Party spawn (exterior)
  +---+---+---+---+---+---+---+---+---+---+---+---+---+---+

Legend:
  (blank) = Walkable ground (dirt/stone)
  W = Wall (blocks movement AND line of sight)
  R = Rubble (difficult terrain, double movement cost)
  H = Tower High Ground (2x2 area, +2 ranged attack)
  C = Cover (partial cover, +2 Defense)
  E = Enemy spawn point (inside fort or at north entrances)
  P = Party spawn point (south, outside fort)
```

### User Flow

```
BATTLE START (Contract 2 - Clear the Ruins):
1. Combat scene loads RuinedFort map
2. Party units placed at party spawn points (Y=13, south - outside fort)
3. Enemy units placed inside fort (various positions)
4. Player sees fortified position with walls, tower, rubble
5. Battle proceeds using standard turn system

TACTICAL DECISIONS:
- "The bandit archers are on the tower - they have +2 attack. I need to assault the tower."
- "The walls block line of sight - I can't shoot through them. I must go through the gaps."
- "The rubble slows my advance - the enemies will get extra shots while I cross."
- "Should I split my forces through both gaps, or concentrate on one entry point?"
- "Thorne can tank in the chokepoint while Lyra flanks through the other gap."
- "The enemy leader is hiding behind the inner cover - I need to close distance."
```

### Rules & Constraints

- **Map Size:** 14 x 14 tiles (larger than Forest Clearing's 12x12)
- **Walls (Blocking):** Completely block movement AND line of sight (cannot walk or shoot through)
- **Rubble (Difficult Terrain):** Costs 2 movement per tile (same as stream in Forest Clearing)
- **Tower (High Ground):** 2x2 area, provides +2 ranged attack bonus
- **Cover (Partial):** Provides +2 Defense bonus (same as trees in Forest Clearing)
- **Chokepoints:** Wall gaps force units through narrow passages
- **Spawn Points:** Party spawns outside (south), enemies spawn inside/north

### Edge Cases

- **Line of Sight Through Diagonal Walls:** Diagonal adjacency to wall DOES block LoS (strict blocking)
- **Wall + Unit:** Units cannot occupy wall tiles under any circumstances
- **Rubble + Cover:** A tile can be EITHER rubble OR cover, not both
- **Tower Edge:** Units on tower edge still get high ground bonus
- **Pathfinding:** Pathfinding treats walls as impassable (infinite cost)
- **Spawn Point Behind Wall:** If spawn point becomes blocked, find nearest valid tile outside walls
- **AI Pathfinding:** Enemy AI correctly navigates through gaps, not through walls
- **AoO at Chokepoints:** Attack of Opportunity triggers normally at wall gaps

---

## User Interaction

### Controls

| Input | Action |
|-------|--------|
| Hover tile | Show terrain info tooltip (wall/rubble/tower/cover) |
| Click to move | Path preview routes around walls, through gaps |
| Select attack target | Shows if target is blocked by walls (red X indicator) |

### Visual Feedback

- **Ground Tiles:** Tan/brown stone and dirt (distinct from Forest Clearing's grass)
- **Wall Tiles:** Dark gray stone blocks with brick pattern
- **Rubble Tiles:** Light gray broken stones, debris pattern
- **Tower Tiles:** Elevated tan platform with up-arrow icon
- **Cover Tiles:** Stacked stone barriers with shield icon
- **Spawn Points:** (Debug only) Colored highlights showing spawn zones
- **LoS Blocked Indicator:** Red X when targeting through walls

### Audio Feedback (if applicable)

- Stone footstep sounds when moving on fort tiles (optional polish)
- Wind/ambience suggesting open ruins (optional polish)

---

## Visual Design

### Layout

```
RUINED FORT MAP - Visual Composition:

+--------------------------------------------------+
|       [Open Ground]      [Open Ground]           |
|                                                  |
|    +====+     [Gap]     +====+     [Gap]  +====+ |
|    |WALL|               |WALL|            |WALL| |
|    |    |    [Rubble]   |    |            |    | |
|    |    |    ~~~~~~~~   |    |            |    | |
|    |    |               |    |            |    | |
|    |    |      +===+    |    |   [Cover]  |    | |
|    |    |      |TWR|    |    |     ***    |    | |
|    |    |      |   |    |    |            |    | |
|    |    |      +===+    |    |            |    | |
|    |    |               |    |            |    | |
|    |    |  [Cover]      |    |  [Rubble]  |    | |
|    |    |    ***        |    |  ~~~~~~~~  |    | |
|    +====+     [Gap]     +====+     [Gap]  +====+ |
|                                                  |
|       [Party Spawn Zone - South]                 |
+--------------------------------------------------+
```

### Components

- **Base Terrain:** Tan/brown stone tiles (new COLOR_STONE)
- **Wall Terrain:** Dark gray blocking tiles (new TILE_WALL)
- **Rubble Terrain:** Light gray difficult terrain (uses TILE_DIFFICULT)
- **Tower Terrain:** Elevated platform tiles (uses TILE_HIGH_GROUND)
- **Cover Terrain:** Stone barriers (uses TILE_COVER)
- **Spawn Markers:** (Debug) Colored circles indicating spawn points

### Visual Style

- **Ground Color:** `#a0937d` (tan/brown stone)
- **Ground Border:** `#8b8070` (darker tan)
- **Wall Color:** `#4a4a4a` (dark gray stone)
- **Wall Border:** `#333333` (very dark gray)
- **Rubble Color:** `#9e9e9e` (light gray)
- **Rubble Border:** `#7a7a7a` (medium gray)
- **Tower Color:** `#8b7355` (existing high ground color)
- **Cover Color:** `#6b6b6b` (gray stone barrier)

### States

- **Default:** All terrain visible with appropriate colors
- **Movement Preview:** Valid move tiles highlighted, walls shown as impassable
- **Attack Preview:** Blocked LoS shows red X indicator on target
- **Path Preview:** Path routes around walls through gaps

---

## Technical Implementation

### Scene Structure

```
scenes/combat/maps/RuinedFort.tscn
‚îú‚îÄ‚îÄ RuinedFort (Node2D) - Root node with map script
‚îÇ   ‚îî‚îÄ‚îÄ CombatGrid (existing) - Uses modified combat_grid.gd
‚îÇ       ‚îú‚îÄ‚îÄ TileMapLayer - Renders the tiles
‚îÇ       ‚îú‚îÄ‚îÄ MovementOverlay - Shows valid moves
‚îÇ       ‚îú‚îÄ‚îÄ PathPreview - Shows movement path
‚îÇ       ‚îî‚îÄ‚îÄ AttackRangeOverlay - Shows attack range

resources/maps/ruined_fort_data.gd (or embedded in combat_grid.gd)
‚îú‚îÄ‚îÄ Map data dictionary with tile layout
‚îú‚îÄ‚îÄ party_spawn_points: Array[Vector2i]
‚îî‚îÄ‚îÄ enemy_spawn_points: Array[Vector2i]
```

### Script Responsibilities

**combat_grid.gd (modify):**
- Add `TILE_WALL: int = 6` constant for wall tiles
- Add `COLOR_WALL` and `COLOR_WALL_BORDER` for wall visuals
- Add `COLOR_STONE` and `COLOR_STONE_BORDER` for fort ground
- Add `is_wall(coords) -> bool` method
- Modify `is_walkable(coords)` to return false for walls
- Modify `_create_tile_atlas_texture()` to include wall tile graphic
- Add `RUINED_FORT_DATA` map definition dictionary

**pathfinding.gd (modify):**
- Ensure walls return infinite cost (already handled if is_walkable returns false)
- Verify diagonal movement past walls is blocked

**attack_resolver.gd (modify):**
- Add `has_line_of_sight(from: Vector2i, to: Vector2i) -> bool` method
- Check for walls blocking LoS using Bresenham line algorithm
- Block ranged attacks if wall intersects line of sight

**unit.gd (modify):**
- Call `has_line_of_sight()` before ranged attacks
- Show "Blocked" feedback if LoS blocked

### Integration Points

- **Connects to:**
  - `CombatGrid` - Loads terrain data into grid
  - `Pathfinding` - Treats walls as impassable
  - `AttackResolver` - Checks LoS through walls for ranged attacks
  - `CombatManager` - Uses spawn points for unit placement

- **Listens for:**
  - Nothing new - map is data that gets loaded at combat start

- **Modifies:**
  - `CombatGrid._grid_data` - Populated with map terrain
  - Unit starting positions based on spawn points
  - `AttackResolver` - Now checks line of sight for ranged attacks

### Configuration

**New Tile Type (combat_grid.gd):**
```gdscript
const TILE_WALL: int = 6  # Wall - blocks movement AND line of sight

const COLOR_WALL: Color = Color("#4a4a4a")  # Dark gray stone
const COLOR_WALL_BORDER: Color = Color("#333333")

const COLOR_STONE: Color = Color("#a0937d")  # Tan/brown for fort ground
const COLOR_STONE_BORDER: Color = Color("#8b8070")
```

**Map Data Structure:**
```gdscript
# Ruined Fort map definition
const RUINED_FORT_DATA: Dictionary = {
    "name": "Ruined Fort",
    "width": 14,
    "height": 14,
    "default_tile": TILE_WALKABLE,  # Uses stone coloring
    "tiles": [
        # Row 0 (north - outside fort)
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 1 (north wall with gaps)
        [0, 0, 0, 6, 6, 6, 0, 0, 6, 6, 6, 0, 0, 0],
        # Row 2
        [0, 0, 6, 0, 0, 0, 5, 5, 0, 0, 0, 6, 0, 0],
        # Row 3
        [0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0],
        # Row 4 (tower row 1)
        [0, 6, 0, 0, 3, 3, 0, 0, 0, 2, 2, 0, 6, 0],
        # Row 5 (tower row 2)
        [0, 6, 0, 0, 3, 3, 0, 0, 0, 2, 0, 0, 6, 0],
        # Row 6
        [0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0],
        # Row 7
        [0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0],
        # Row 8
        [0, 6, 0, 0, 2, 0, 0, 0, 0, 5, 0, 0, 6, 0],
        # Row 9
        [0, 6, 0, 0, 2, 2, 0, 0, 5, 5, 0, 0, 6, 0],
        # Row 10
        [0, 0, 6, 0, 0, 0, 5, 5, 0, 0, 0, 6, 0, 0],
        # Row 11 (south wall with gaps)
        [0, 0, 0, 6, 6, 6, 0, 0, 6, 6, 6, 0, 0, 0],
        # Row 12 (south - outside fort)
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 13 (party spawn)
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    ],
    "party_spawns": [
        Vector2i(0, 13), Vector2i(1, 13), Vector2i(2, 13),
        Vector2i(11, 13), Vector2i(12, 13), Vector2i(13, 13)
    ],
    "enemy_spawns": [
        Vector2i(0, 0), Vector2i(1, 0),  # Outside north-west
        Vector2i(12, 0), Vector2i(13, 0),  # Outside north-east
        Vector2i(4, 4), Vector2i(5, 4),  # On tower
    ]
}
# Tile type reference:
# 0 = TILE_WALKABLE
# 2 = TILE_COVER
# 3 = TILE_HIGH_GROUND
# 5 = TILE_DIFFICULT (rubble)
# 6 = TILE_WALL (new)
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Ruined Fort map loads and renders at 14x14 tiles
- [ ] Wall tiles display with dark gray brick pattern
- [ ] Wall tiles block movement (units cannot walk through)
- [ ] Wall tiles block line of sight (ranged attacks blocked)
- [ ] Rubble tiles display with broken stone pattern
- [ ] Rubble tiles cost 2 movement (same as stream)
- [ ] Tower area (2x2 tiles) provides +2 ranged attack bonus
- [ ] Cover tiles provide +2 Defense bonus
- [ ] Party units spawn at south spawn points (outside fort)
- [ ] Enemy units spawn at designated spawn points (inside/north)
- [ ] Pathfinding routes around walls through gaps
- [ ] Ranged attack preview shows blocked indicator when wall obstructs
- [ ] Map creates tactically different experience from Forest Clearing

---

## Testing Checklist

### Functional Tests

- [ ] **Map Rendering:** Ruined Fort loads with correct terrain layout (14x14)
- [ ] **Wall Blocking Movement:** Unit cannot move to or through wall tile
- [ ] **Wall Blocking LoS:** Ranged attack blocked when wall between attacker and target
- [ ] **Rubble Cost:** Moving through rubble costs double movement
- [ ] **Tower Bonus:** Ranged unit on tower receives +2 attack
- [ ] **Cover Bonus:** Unit on cover tile receives +2 Defense
- [ ] **Spawn Points:** Party spawns at Y=13, enemies at designated positions
- [ ] **Pathfinding:** Path correctly routes around walls through gaps

### Edge Case Tests

- [ ] **Diagonal LoS Through Wall Corner:** Should block LoS
- [ ] **Adjacent to Wall:** Can stand next to wall, cannot move into it
- [ ] **Melee Through Wall:** Melee attack blocked if wall between (diagonal)
- [ ] **Multiple Gaps:** Path finds shortest route through correct gap
- [ ] **All Spawns Used:** All spawn points work correctly
- [ ] **LoS Along Wall Edge:** Shooting along wall edge (not through) should work

### Integration Tests

- [ ] **With Enemy AI:** Enemies navigate through gaps, don't try to walk through walls
- [ ] **With Soldier AI:** Soldiers respect walls when following orders
- [ ] **With Attack System:** Cover, high ground, and LoS all apply correctly
- [ ] **With AoO System:** Attack of opportunity works at chokepoints
- [ ] **With Turn System:** Normal turn flow with map loaded

### Visual Tests

- [ ] **Terrain Clarity:** Each terrain type visually distinct
- [ ] **Movement Preview:** Shows reachable tiles accounting for walls
- [ ] **Attack Preview:** Shows blocked indicator when LoS obstructed
- [ ] **Different from Forest:** Clearly a different map type (stone vs grass)

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Line of Sight System:** This is the key new mechanic. Need to implement a proper LoS check using Bresenham line algorithm. The check must determine if any wall tiles intersect the line between attacker and target.

2. **Wall Tile Type:** The new TILE_WALL type must:
   - Return false from `is_walkable()`
   - Return true from a new `is_wall()` or `blocks_los()` method
   - Have distinct visual appearance (dark gray brick pattern)

3. **Pathfinding Already Handles Blocking:** If `is_walkable()` returns false for walls, existing pathfinding should already treat them as impassable. Verify this works.

4. **Ranged Attack Integration:** The attack system needs to call LoS check before ranged attacks resolve. If blocked, show feedback and prevent attack.

5. **Map Size Change:** This map is 14x14 vs 12x12. The CombatGrid should handle dynamic sizes via the map data dictionary's width/height fields.

### Line of Sight Implementation

```gdscript
# In attack_resolver.gd or combat_grid.gd
func has_line_of_sight(from: Vector2i, to: Vector2i) -> bool:
    # Bresenham line algorithm
    var dx = abs(to.x - from.x)
    var dy = abs(to.y - from.y)
    var sx = 1 if from.x < to.x else -1
    var sy = 1 if from.y < to.y else -1
    var err = dx - dy

    var x = from.x
    var y = from.y

    while x != to.x or y != to.y:
        var e2 = 2 * err
        if e2 > -dy:
            err -= dy
            x += sx
        if e2 < dx:
            err += dx
            y += sy

        # Skip the final tile (the target)
        if x == to.x and y == to.y:
            break

        # Check if this tile blocks LoS
        if _combat_grid.is_wall(Vector2i(x, y)):
            return false

    return true
```

### Integration with Attack System

```gdscript
# In attack_resolver.gd
func can_attack(attacker: Unit, target: Unit, ability: Ability) -> Dictionary:
    var result = {"can_attack": true, "reason": ""}

    # Range check
    var distance = _calculate_distance(attacker.grid_position, target.grid_position)
    if distance > ability.range:
        result.can_attack = false
        result.reason = "Out of range"
        return result

    # LoS check for ranged attacks (range > 1)
    if ability.range > 1:
        if not has_line_of_sight(attacker.grid_position, target.grid_position):
            result.can_attack = false
            result.reason = "Line of sight blocked"
            return result

    return result
```

### Alternative Approaches Considered

1. **Separate LoS System:** Create a dedicated los_manager.gd. Rejected - LoS is closely tied to grid/attack systems, simpler to integrate directly.

2. **Per-Tile LoS Properties:** Each tile has a "blocks_los" property. Simpler than our approach but walls are the only blocking type for now, so a direct `is_wall()` check is sufficient.

3. **Partial Cover Affecting LoS:** Cover tiles could provide partial LoS obstruction. Too complex for prototype - stick to binary blocking (walls) vs non-blocking.

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| Map Size | 14 x 14 | Larger than Forest Clearing |
| Wall Count | ~24 | Forms fort perimeter with gaps |
| Rubble Count | ~12 | In wall gaps and interior |
| Tower Size | 2 x 2 tiles | Central elevated position |
| Cover Count | ~8 | Stone barriers inside fort |
| Party Spawn Points | 6 | Y=13 (south, outside fort) |
| Enemy Spawn Points | 6 | Various (tower, north) |
| Wall Color | #4a4a4a | Dark gray stone |
| Wall Border | #333333 | Very dark gray |
| Rubble Color | #9e9e9e | Light gray (uses difficult terrain) |
| Ground Color | #a0937d | Tan/brown stone |

---

## Asset Requirements

### New Tile Graphics

1. **Wall Tile**
   - Size: 64x64 pixels
   - Color: Dark gray (#4a4a4a) with brick pattern overlay
   - Border: Very dark gray (#333333)
   - Should look solid and impassable

2. **Stone Ground Tile** (optional - could reuse walkable with different palette)
   - Size: 64x64 pixels
   - Color: Tan/brown (#a0937d)
   - Distinct from Forest Clearing's grass

### No External Assets Required

All graphics generated programmatically using the existing tile drawing system in combat_grid.gd.

### Future Polish (Out of Scope)

- Crumbling wall particle effects
- Ambient wind/ruin sounds
- Dynamic shadows from walls
- Fog of war based on LoS

---

## Relationship to Contract 2

This map is used by Contract 2 "Clear the Ruins" from the GDD:

**Contract 2 Setup:**
- Combat: Ruined Fort map
- Enemies: 6 Bandit Melee + 3 Bandit Archer + 1 Bandit Leader
- Hidden cache: Find by moving to specific tile (bonus objective)
- Leader uses Rally Bandits ability

**Suggested Enemy Placement:**
- Bandit Leader: Behind cover in fort interior
- Bandit Archers: On tower (high ground advantage)
- Bandit Melee: At wall gaps (chokepoint defense)

This placement creates the tactical puzzle: players must decide whether to:
1. Rush through one gap and face concentrated melee
2. Split forces through both gaps
3. Take time to eliminate archers on tower first
4. Use abilities to break the defensive formation

---
