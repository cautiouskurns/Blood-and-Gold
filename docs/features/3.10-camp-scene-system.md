# Camp Scene System

**Feature ID:** 3.10
**Status:** ðŸ”´ Planned
**Priority:** â¬†ï¸ High
**Estimated Time:** 2.5-3 hours
**Dependencies:** Task 3.9 (Loyalty System Implementation)
**Assigned To:** AI Assistant

---

## Purpose

### Why does this feature exist?
Camp scenes create emotional investment in companion characters by providing intimate dialogue moments between combat contracts. The GDD specifically calls out camp conversations as a key mechanic to test: "Do camp scenes create emotional investment in companions?" This system transforms companions from combat statistics into characters players care about.

### What does it enable?
- Story-driven dialogue between contracts with character portraits
- Player choices during camp conversations that affect companion loyalty
- Companions express their values and react to recent player decisions
- Visual feedback on loyalty changes through the existing LoyaltyPopup
- Deeper understanding of companion personalities and motivations
- A bridge between the "hub management" phase and the "contract execution" phase

### Success Criteria
- Camp scenes display with character portraits and dialogue box
- Dialogue advances on click/input
- Choices are presented as distinct clickable options
- Selecting a choice triggers loyalty change in LoyaltyManager
- LoyaltyPopup displays the loyalty change after selection
- Camp scenes can be triggered after specific contracts
- Dialogue data loads from JSON files for easy content creation

---

## How It Works

### Overview
The Camp Scene System creates narrative moments with companions after contracts. When triggered (typically after a contract completion), the player is taken to a dedicated CampScene where one or more companions initiate conversation. The scene displays character portraits, speaker names, and dialogue text in a visual novel style.

Dialogue is structured as a tree with speaker nodes and choice nodes. When the player reaches a choice, they're presented with 2-4 options. Selecting an option advances the dialogue and may trigger loyalty changes via the existing LoyaltyManager. Changes are displayed using the LoyaltyPopup component.

The system leverages the existing dialogue editor addon for content creation, allowing designers to create camp scenes using the visual node graph editor and export them as JSON for runtime use.

### User Flow
```
1. Contract completes (or manual trigger from hub)
2. Game checks if camp scene should trigger
3. CampScene loads with appropriate dialogue JSON
4. Background and character portraits display
5. Dialogue text appears with speaker name
6. Player clicks/presses to advance dialogue
7. When choices appear, player selects one
8. Choice triggers loyalty change (if configured)
9. LoyaltyPopup shows "+5 Thorne" or similar
10. Dialogue continues until END node reached
11. Player returns to hub
```

### Rules & Constraints

**Dialogue Structure:**
- Each camp scene is a dialogue tree in JSON format
- Trees contain: Start, Speaker, Choice, End nodes
- Speaker nodes have: speaker_name, portrait_id, text
- Choice nodes have: text, loyalty_changes (optional)
- Dialogue must have exactly one Start node
- Dialogue must have at least one End node

**Portrait System:**
- Portrait size: 200x250 pixels (configurable)
- Portrait positions: Left (companion), Right (player response)
- Portrait sprites stored in: assets/sprites/portraits/
- Fallback to colored placeholder if sprite not found

**Dialogue Box:**
- Position: Bottom third of screen
- Contains: Speaker name (colored), dialogue text, continue indicator
- Text appears with optional typewriter effect
- Continue on click, space, or enter

**Choice Display:**
- Maximum 4 choices displayed
- Choices appear below dialogue box
- Each choice shows text and loyalty indicator (+Thorne, -Matthias)
- Disabled choices grayed out (if conditions not met - future)

**Loyalty Changes:**
- Changes defined per choice in dialogue JSON
- Format: {"companion_id": delta, ...}
- Applied via LoyaltyManager.modify_loyalty()
- Displayed via LoyaltyPopup.show_multiple_changes()
- Typical range: +/- 2 to 10 per choice

### Edge Cases
- **No portrait found:** Display colored placeholder with initials
- **Empty dialogue text:** Skip to next node automatically
- **No choices connected:** Treat as end of dialogue
- **All companions departed:** Skip camp scene, return to hub
- **Multiple loyalty changes:** Show sequentially in popup
- **Camp scene interrupted:** Save progress (future feature)
- **Portrait loading failure:** Log warning, use placeholder

---

## User Interaction

### Controls
| Input | Action |
|-------|--------|
| Left Click | Advance dialogue / Select choice |
| Space | Advance dialogue |
| Enter | Advance dialogue / Confirm choice |
| 1-4 Keys | Quick-select choice by number |
| Escape | Pause menu (future) |

### Visual Feedback
- **Dialogue appearing:** Text reveals with typewriter effect (configurable speed)
- **Continue indicator:** Pulsing arrow/triangle when waiting for input
- **Choice hover:** Highlight effect on hovered choice
- **Choice select:** Flash/pulse effect on selection
- **Loyalty change:** LoyaltyPopup slides in with change display
- **Portrait speaking:** Subtle glow or highlight around active speaker
- **Portrait reaction:** Portrait can swap to reaction sprite (happy/angry/sad)

### Audio Feedback (Placeholder)
- **Text advance:** Soft click/blip per character (optional)
- **Choice confirm:** Selection sound
- **Loyalty up:** Pleasant chime
- **Loyalty down:** Discordant tone
- **Scene start:** Ambient camp sounds (fire crackling)

---

## Visual Design

### Camp Scene Layout
```
+------------------------------------------------------------------+
|                                                                  |
|                    [Camp Background Image]                       |
|                                                                  |
|  +----------+                                     +----------+  |
|  | Portrait |                                     | Portrait |  |
|  | (Left)   |                                     | (Right)  |  |
|  | 200x250  |                                     | 200x250  |  |
|  +----------+                                     +----------+  |
|                                                                  |
+------------------------------------------------------------------+
|  THORNE BLACKWOOD                                                |
|  ----------------------------------------------------------------|
|  "You did well out there, Captain. But I wonder...               |
|   do you ever regret the choices we've had to make?"             |
|                                                        [â–¼ More]  |
+------------------------------------------------------------------+
|  [1] "Regret is a luxury we can't afford."                       |
|  [2] "Some decisions weigh heavily on me."        (+Matthias)    |
|  [3] "We do what we must for the company."        (+Thorne)      |
+------------------------------------------------------------------+
```

### Portrait Placeholder (When sprite missing)
```
+----------+
|          |
|   THO    |
|          |
|  [color] |
+----------+
Colored box with 3-letter abbreviation
```

### Speaker Name Colors
| Character | Color |
|-----------|-------|
| Player | White (#FFFFFF) |
| Thorne | Blue (#2c3e50) |
| Lyra | Yellow (#f1c40f) |
| Matthias | Red (#c0392b) |
| Narrator | Gray (#95a5a6) |

### Choice Button States
| State | Appearance |
|-------|------------|
| Default | Dark panel, white text |
| Hover | Lighter panel, highlighted text |
| Pressed | Inverted colors briefly |
| Disabled | Grayed out, italic text |

---

## Technical Implementation

### Scene Structure
```
CampScene (Node2D)
â”œâ”€â”€ Background (TextureRect)
â”œâ”€â”€ PortraitLayer (CanvasLayer)
â”‚   â”œâ”€â”€ LeftPortrait (TextureRect)
â”‚   â”‚   â””â”€â”€ PortraitFrame (ColorRect)
â”‚   â””â”€â”€ RightPortrait (TextureRect)
â”‚       â””â”€â”€ PortraitFrame (ColorRect)
â”œâ”€â”€ DialogueLayer (CanvasLayer)
â”‚   â””â”€â”€ DialoguePanel (PanelContainer)
â”‚       â””â”€â”€ MarginContainer (MarginContainer)
â”‚           â””â”€â”€ VBoxContainer (VBoxContainer)
â”‚               â”œâ”€â”€ SpeakerLabel (Label)
â”‚               â”œâ”€â”€ DialogueText (RichTextLabel)
â”‚               â””â”€â”€ ContinueIndicator (TextureRect)
â”œâ”€â”€ ChoiceLayer (CanvasLayer)
â”‚   â””â”€â”€ ChoiceContainer (VBoxContainer)
â”‚       â”œâ”€â”€ Choice1 (Button)
â”‚       â”œâ”€â”€ Choice2 (Button)
â”‚       â”œâ”€â”€ Choice3 (Button)
â”‚       â””â”€â”€ Choice4 (Button)
â””â”€â”€ LoyaltyPopup (preloaded instance)
```

### Script Responsibilities

#### camp_scene.gd
Main controller for camp dialogue flow.

```gdscript
## CampScene - Dialogue scenes with companions between contracts
## Part of: Blood & Gold Prototype
## Task 3.10: Camp Scene System
## Spec: docs/features/3.10-camp-scene-system.md
extends Node2D

signal scene_started(scene_id: String)
signal scene_ended(scene_id: String)
signal dialogue_advanced(node_id: String)
signal choice_selected(choice_index: int, choice_text: String)

# Current scene data
var _scene_id: String = ""
var _dialogue_data: Dictionary = {}
var _current_node_id: String = ""
var _is_showing_choices: bool = false

# Preloaded scenes
const LoyaltyPopupScene = preload("res://scenes/ui/LoyaltyPopup.tscn")

func load_scene(scene_id: String) -> bool:
    ## Load a camp scene from JSON
    pass

func start_dialogue() -> void:
    ## Begin the dialogue from the Start node
    pass

func advance_dialogue() -> void:
    ## Move to the next dialogue node
    pass

func select_choice(choice_index: int) -> void:
    ## Handle player choice selection
    pass

func _apply_loyalty_changes(changes: Dictionary) -> void:
    ## Apply loyalty changes from choice
    pass
```

#### dialogue_manager.gd
Handles dialogue tree parsing and navigation.

```gdscript
## DialogueManager - Parses and navigates dialogue trees
## Part of: Blood & Gold Prototype
## Task 3.10: Camp Scene System
class_name DialogueManager
extends RefCounted

signal node_reached(node_data: Dictionary)
signal choices_available(choices: Array[Dictionary])
signal dialogue_ended(end_type: String)

var _dialogue_data: Dictionary = {}
var _current_node: String = ""
var _visited_nodes: Array[String] = []

func load_dialogue(json_path: String) -> bool:
    ## Load dialogue tree from JSON file
    pass

func start() -> Dictionary:
    ## Start dialogue, returns first speaker node data
    pass

func advance() -> Dictionary:
    ## Advance to next node, returns node data or empty if choices/end
    pass

func get_available_choices() -> Array[Dictionary]:
    ## Get choices connected to current node
    pass

func select_choice(choice_id: String) -> Dictionary:
    ## Follow a choice to its target node
    pass

func _find_start_node() -> String:
    ## Find the Start node ID
    pass

func _get_connections_from(node_id: String) -> Array[Dictionary]:
    ## Get all connections from a node
    pass
```

### Dialogue JSON Format

Camp scene dialogue is exported from the dialogue editor addon or hand-authored.

```json
{
  "id": "camp_scene_1",
  "title": "After the Border Dispute",
  "trigger_contract": "border_dispute",
  "nodes": {
    "start_1": {
      "type": "Start",
      "connections": [{"to": "speaker_1", "port": 0}]
    },
    "speaker_1": {
      "type": "Speaker",
      "speaker": "thorne",
      "portrait": "thorne_neutral",
      "text": "You did well out there, Captain. But I wonder... do you ever regret the choices we've had to make?",
      "connections": [
        {"to": "choice_1", "port": 0},
        {"to": "choice_2", "port": 1},
        {"to": "choice_3", "port": 2}
      ]
    },
    "choice_1": {
      "type": "Choice",
      "text": "Regret is a luxury we can't afford.",
      "loyalty_changes": {},
      "connections": [{"to": "speaker_2a", "port": 0}]
    },
    "choice_2": {
      "type": "Choice",
      "text": "Some decisions weigh heavily on me.",
      "loyalty_changes": {"matthias": 5},
      "connections": [{"to": "speaker_2b", "port": 0}]
    },
    "choice_3": {
      "type": "Choice",
      "text": "We do what we must for the company.",
      "loyalty_changes": {"thorne": 5},
      "connections": [{"to": "speaker_2c", "port": 0}]
    },
    "speaker_2a": {
      "type": "Speaker",
      "speaker": "thorne",
      "portrait": "thorne_approving",
      "text": "Hm. Cold, but practical. I suppose that's why you're the captain.",
      "connections": [{"to": "end_1", "port": 0}]
    },
    "end_1": {
      "type": "End",
      "end_type": "normal"
    }
  }
}
```

### Integration Points

| System | Integration |
|--------|-------------|
| **LoyaltyManager** | Call `modify_loyalty()` when choice has loyalty_changes |
| **LoyaltyPopup** | Display changes via `show_multiple_changes()` |
| **GameState** | Check `get_choice()` for previous contract choices |
| **Hub/Contracts** | Trigger camp scene after contract completion |
| **Dialogue Editor** | Export JSON format for camp scene content |
| **Portrait Assets** | Load from `assets/sprites/portraits/` |

### Contract Integration

In contract completion flow:
```gdscript
func _on_contract_completed(contract_id: String, gold: int) -> void:
    # Check if this contract triggers a camp scene
    var camp_scene_id = _get_camp_scene_for_contract(contract_id)
    if camp_scene_id:
        # Transition to camp scene
        _load_camp_scene(camp_scene_id)
    else:
        # Return to hub
        get_tree().change_scene_to_file("res://scenes/hub/Hub.tscn")
```

### Signals
- `scene_started(scene_id: String)` - Camp scene begins
- `scene_ended(scene_id: String)` - Camp scene ends normally
- `dialogue_advanced(node_id: String)` - Moved to new dialogue node
- `choice_selected(choice_index: int, choice_text: String)` - Player made a choice

---

## Acceptance Criteria

- [ ] Camp scene displays with background and character portraits
- [ ] Portraits display at 200x250 pixels (or configurable size)
- [ ] Dialogue box shows speaker name with character-specific color
- [ ] Dialogue text displays in the bottom third of screen
- [ ] Dialogue advances on click, space, or enter
- [ ] Choices presented as distinct clickable buttons (2-4 options)
- [ ] Choices show loyalty change indicator when applicable (+Thorne, -Matthias)
- [ ] Selecting a choice triggers LoyaltyManager.modify_loyalty()
- [ ] LoyaltyPopup displays after choice selection
- [ ] Camp scene can load dialogue from JSON file
- [ ] Multiple speaker nodes work correctly
- [ ] End node returns player to hub
- [ ] Missing portraits display colored placeholder with initials

---

## Testing Checklist

### Functional Tests
- [ ] Camp scene loads without errors
- [ ] Dialogue JSON parses correctly
- [ ] Start node found and dialogue begins
- [ ] Speaker text displays with correct speaker name
- [ ] Click advances to next speaker node
- [ ] Choices appear when speaker has choice connections
- [ ] Choice selection advances dialogue
- [ ] Loyalty changes apply via LoyaltyManager
- [ ] LoyaltyPopup displays loyalty changes
- [ ] End node triggers scene completion
- [ ] Scene returns to hub after ending

### Portrait Tests
- [ ] Portrait loads from assets/sprites/portraits/
- [ ] Missing portrait shows colored placeholder
- [ ] Placeholder shows 3-letter abbreviation
- [ ] Portrait position correct (left/right)
- [ ] Portrait swaps when speaker changes

### Edge Case Tests
- [ ] Empty dialogue text skipped
- [ ] No choices = dialogue ends
- [ ] All companions departed = scene skipped
- [ ] Multiple loyalty changes in one choice
- [ ] Invalid JSON gracefully handled
- [ ] Missing node reference logged as warning

### Integration Tests
- [ ] Contract completion triggers camp scene
- [ ] GameState tracks if camp scene viewed
- [ ] Loyalty changes persist after scene
- [ ] Hub displays updated loyalty values
- [ ] Combat reflects loyalty stat modifiers

### Polish Tests
- [ ] Typewriter effect works (if enabled)
- [ ] Continue indicator pulses/animates
- [ ] Choice hover state visible
- [ ] Scene transitions smoothly
- [ ] No visual glitches during dialogue

---

## Implementation Notes

### Approach
1. Create CampScene.tscn with UI structure
2. Implement DialogueManager for JSON parsing and navigation
3. Create camp_scene.gd controller
4. Wire up UI elements to script
5. Add contract integration trigger
6. Create sample camp scene JSON for testing
7. Integrate with existing LoyaltyPopup

### Portrait Strategy
For prototype, use colored rectangles with character initials as placeholders. This allows the system to be fully functional without blocking on art assets. Portrait sprites can be added later as drop-in replacements.

```gdscript
const PORTRAIT_COLORS := {
    "player": Color("#3498db"),
    "thorne": Color("#2c3e50"),
    "lyra": Color("#f1c40f"),
    "matthias": Color("#c0392b"),
}

func _create_placeholder_portrait(character_id: String) -> ColorRect:
    var rect = ColorRect.new()
    rect.custom_minimum_size = Vector2(200, 250)
    rect.color = PORTRAIT_COLORS.get(character_id, Color.GRAY)
    # Add label with initials
    var label = Label.new()
    label.text = character_id.left(3).to_upper()
    label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
    label.vertical_alignment = VERTICAL_ALIGNMENT_CENTER
    rect.add_child(label)
    return rect
```

### Dialogue Editor Compatibility
The dialogue editor addon exports JSON in a compatible format. Key differences to handle:
- Editor uses node names as IDs, runtime uses string keys
- Editor connections include port numbers for multi-output nodes
- Editor may include metadata fields (position, color) that runtime ignores

### Gotchas
- LoyaltyPopup needs to await completion before advancing dialogue
- Portrait TextureRect may need aspect ratio handling
- RichTextLabel BBCode can be used for text styling
- Typewriter effect should be skippable on click
- Choice buttons need consistent sizing regardless of text length
- JSON files should be in res://data/camp_scenes/ for organization

### Sample Content
Create 3 sample camp scenes for prototype testing:

1. **camp_scene_1_thorne.json** - After Merchant's Escort
   - Thorne discusses mercenary life philosophy
   - Choices affect Thorne loyalty

2. **camp_scene_2_lyra.json** - After Clear the Ruins
   - Lyra shares concerns about Ironmark
   - Choices affect Lyra loyalty, reveal backstory

3. **camp_scene_3_matthias.json** - After Border Dispute
   - Matthias reflects on refugee encounter
   - Choices reference player's contract decision
   - Uses GameState.get_choice("border_dispute") for branching

---

## Files

**New Files:**
- `scenes/camp/CampScene.tscn` - Main camp scene
- `scripts/camp/camp_scene.gd` - Camp scene controller
- `scripts/systems/dialogue_manager.gd` - Dialogue tree navigator
- `data/camp_scenes/camp_scene_1_thorne.json` - Sample dialogue
- `data/camp_scenes/camp_scene_2_lyra.json` - Sample dialogue
- `data/camp_scenes/camp_scene_3_matthias.json` - Sample dialogue

**Modified Files:**
- Contract scenes (optional trigger integration)
- Hub navigation (optional direct access for testing)

**Existing Files Used:**
- `scenes/ui/LoyaltyPopup.tscn` - Loyalty change display
- `scripts/ui/loyalty_popup.gd` - Popup controller
- `scripts/autoload/loyalty_manager.gd` - Loyalty modification
- `scripts/autoload/game_state.gd` - Choice tracking

**Future Files (assets):**
- `assets/sprites/portraits/thorne_neutral.png`
- `assets/sprites/portraits/thorne_approving.png`
- `assets/sprites/portraits/lyra_neutral.png`
- `assets/sprites/portraits/matthias_neutral.png`
- `assets/sprites/backgrounds/camp_night.png`

---

## Hardcoded Values

| Value | Default | Description |
|-------|---------|-------------|
| Portrait Size | 200x250 px | Character portrait dimensions |
| Dialogue Box Height | 33% screen | Bottom third of screen |
| Max Choices | 4 | Maximum choices displayed |
| Typewriter Speed | 0.03s | Delay between characters |
| Continue Indicator Pulse | 0.5s | Animation cycle time |
| Loyalty Change Range | -10 to +10 | Typical per-choice delta |
