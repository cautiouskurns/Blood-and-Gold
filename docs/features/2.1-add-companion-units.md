# Feature Spec: Add Thorne, Lyra, Matthias Units (Full Stats)

| Property | Value |
|----------|-------|
| **Feature ID** | 2.1 |
| **Status** | Planning |
| **Priority** | High |
| **Estimated Time** | 2 hours |
| **Phase** | Phase 2: Full Combat with Abilities & Soldiers |
| **Dependencies** | Phase 1 complete |

---

## 1. Purpose

### Why This Feature Exists

Phase 1 established the basic combat loop with placeholder units. Now we need to expand the party with fully-statted companion units that have distinct combat roles. The three companions - Thorne (Fighter/Tank), Lyra (Rogue/Assassin), and Matthias (Cleric/Healer) - form the core tactical team alongside the Player character. Each companion needs proper D&D-style stats (STR, DEX, CON, INT, WIS, CHA) that will drive combat calculations, ability effectiveness, and character identity.

This directly supports the **Tactical Combat** design pillar by creating distinct unit roles that encourage varied tactical approaches, and the **Character Progression** pillar by establishing each companion's mechanical identity.

### What It Enables

- Four distinct party members with unique combat roles and stat distributions
- Foundation for ability effectiveness calculations (Task 2.3-2.6)
- Varied defense and attack values creating tactical diversity
- Movement range differences based on armor/class
- Clear visual and mechanical identity for each companion
- Inheritance-based scene architecture for future unit variants

### Success Criteria

| Criterion | Measurement |
|-----------|-------------|
| All 4 party members appear at battle start | Visual confirmation |
| Each has distinct visual appearance | Unique colors as per GDD |
| Each has correct HP value | Player: 35, Thorne: 40, Lyra: 25, Matthias: 30 |
| Each has full stat block | All 6 stats properly assigned |
| Defense values calculate correctly | 10 + DEX mod + armor bonus |
| Attack bonuses calculate correctly | STR/DEX mod + skill rank |
| All can be selected and moved | Functional test |

---

## 2. Design Pillar Alignment

| Pillar | How This Feature Supports It |
|--------|------------------------------|
| **Build & Command** | The four-person party represents the core of your mercenary company - the named heroes you command directly |
| **Tactical Combat** | Distinct stats create tactical variety: Thorne absorbs damage, Lyra deals burst damage from flanking, Matthias keeps the team alive |
| **Character Progression** | Full stat blocks establish each companion's mechanical identity that abilities will build upon |
| **Meaningful Choice** | Different stat strengths encourage positioning certain companions for certain tasks |

---

## 3. How It Works

### Overview

Each companion is defined by a full D&D-style stat block that drives all combat calculations. The six core stats (STR, DEX, CON, INT, WIS, CHA) generate modifiers using the standard formula: `modifier = floor((stat - 10) / 2)`.

Stats determine:
- **HP**: Base + CON modifier per level (we use fixed values for prototype)
- **Attack Bonus**: STR mod (melee) or DEX mod (ranged) + skill rank
- **Defense**: 10 + DEX mod + armor bonus
- **Ability Effectiveness**: Relevant stat mod (WIS for Matthias's healing, etc.)
- **Initiative**: DEX mod (already implemented in Turn Manager)

### Companion Stat Blocks

**Player Character (Fighter)**
| Stat | Value | Modifier |
|------|-------|----------|
| STR | 14 | +2 |
| DEX | 12 | +1 |
| CON | 14 | +2 |
| INT | 10 | +0 |
| WIS | 10 | +0 |
| CHA | 12 | +1 |

- **HP**: 35
- **Attack Bonus**: +4 (STR +2, Skill +2)
- **Defense**: 14 (10 + DEX +1 + Chain Shirt +3)
- **Movement**: 5 tiles
- **Role**: Balanced frontliner, soldier commander

---

**Thorne Blackwood (Fighter - Heavy)**
| Stat | Value | Modifier |
|------|-------|----------|
| STR | 16 | +3 |
| DEX | 10 | +0 |
| CON | 14 | +2 |
| INT | 10 | +0 |
| WIS | 12 | +1 |
| CHA | 8 | -1 |

- **HP**: 40
- **Attack Bonus**: +5 (STR +3, Skill +2)
- **Defense**: 15 (10 + DEX +0 + Plate +5)
- **Movement**: 4 tiles (heavy armor)
- **Role**: Damage sponge, high damage, low mobility

---

**Lyra Swiftblade (Rogue)**
| Stat | Value | Modifier |
|------|-------|----------|
| STR | 10 | +0 |
| DEX | 16 | +3 |
| CON | 10 | +0 |
| INT | 14 | +2 |
| WIS | 12 | +1 |
| CHA | 12 | +1 |

- **HP**: 25
- **Attack Bonus**: +5 (DEX +3, Skill +2)
- **Defense**: 15 (10 + DEX +3 + Leather +2)
- **Movement**: 6 tiles (light armor)
- **Role**: High mobility flanker, burst damage, fragile

---

**Brother Matthias (Cleric)**
| Stat | Value | Modifier |
|------|-------|----------|
| STR | 10 | +0 |
| DEX | 10 | +0 |
| CON | 12 | +1 |
| INT | 12 | +1 |
| WIS | 16 | +3 |
| CHA | 14 | +2 |

- **HP**: 30
- **Attack Bonus**: +2 (STR +0, Skill +2)
- **Defense**: 14 (10 + DEX +0 + Scale Mail +4)
- **Movement**: 5 tiles
- **Role**: Healer, buffer, ranged holy damage

---

### Stat Calculation Formulas

```
Modifier = floor((stat - 10) / 2)

Attack Roll = d20 + STR_mod (melee) or DEX_mod (ranged) + skill_rank
Defense = 10 + DEX_mod + armor_bonus

Damage = weapon_die + STR_mod (melee) or DEX_mod (finesse)
Initiative = d20 + DEX_mod (already implemented)
```

### Armor Types

| Armor | Defense Bonus | Movement Penalty |
|-------|---------------|------------------|
| None | +0 | 6 tiles |
| Leather | +2 | 6 tiles |
| Chain Shirt | +3 | 5 tiles |
| Scale Mail | +4 | 5 tiles |
| Plate | +5 | 4 tiles |

---

## 4. User Interaction

### This Task

**No new user interaction** - this task extends existing unit functionality with full stats. Players interact with companions through the existing selection and movement systems.

### What Players Experience

| Element | Experience |
|---------|------------|
| Battle start | All 4 party members appear with distinct colors |
| Selection | Each companion feels mechanically distinct (movement speed varies) |
| Combat | Different attack/defense values create meaningful choices |
| Turn order | Initiative varies by DEX (Lyra often acts first) |

---

## 5. Visual Design

### Unit Appearance (Already Implemented)

Visual appearance remains as implemented in Task 1.2:

| Character | Color | Hex | Letter |
|-----------|-------|-----|--------|
| Player | Blue | #3498db | P |
| Thorne | Dark Blue | #2980b9 | T |
| Lyra | Purple | #9b59b6 | L |
| Matthias | Orange | #f39c12 | M |

### Potential Enhancements (Optional)

- Add small armor icon to indicate defense level
- Add class icon (sword, dagger, staff) in corner
- Vary border thickness based on HP pool

---

## 6. Technical Implementation

### Current Implementation Analysis

The current codebase already has:
- `Unit.tscn` with UnitType enum (PLAYER, THORNE, LYRA, MATTHIAS, ENEMY)
- HP values set per unit type in `main.gd:_spawn_unit()`
- Distinct colors per unit type defined in `unit.gd`
- Movement range property (`movement_range: int = 5`)

What needs to be added:
- Full stat block (STR, DEX, CON, INT, WIS, CHA)
- Stat modifier calculation
- Defense value calculation
- Attack bonus calculation
- Per-unit movement range based on armor

### Scene Structure

**Option A: Single Unit Scene with Configuration (Current Approach)**
```
Unit.tscn
├── Unit (Node2D) [root]
│   ├── Sprite2D
│   ├── LetterLabel
│   ├── HPBar
│   ├── SelectionIndicator
│   └── ClickArea (Area2D)

Configuration via exported properties + UnitType enum
```

**Option B: Inherited Scenes (Recommended for Phase 2+)**
```
scenes/combat/units/
├── Unit.tscn              # Base unit scene
├── PlayerUnit.tscn        # Inherits Unit, Player stats
├── ThorneUnit.tscn        # Inherits Unit, Thorne stats
├── LyraUnit.tscn          # Inherits Unit, Lyra stats
├── MatthiasUnit.tscn      # Inherits Unit, Matthias stats
└── enemies/
    └── BanditMelee.tscn   # Enemy variant
```

For this task, we'll use **Option A** with stats stored in the Unit script and configured per UnitType.

### Script Changes

**unit.gd - Add Stats System**

```gdscript
## Unit Stats System
# Core stats (D&D style)
@export var strength: int = 10
@export var dexterity: int = 10
@export var constitution: int = 10
@export var intelligence: int = 10
@export var wisdom: int = 10
@export var charisma: int = 10

# Derived stats
@export var armor_bonus: int = 0
@export var skill_rank: int = 2  # Base skill rank for attacks

# Stat modifier calculation
func get_stat_modifier(stat_value: int) -> int:
    return int(floor((stat_value - 10) / 2.0))

func get_str_mod() -> int:
    return get_stat_modifier(strength)

func get_dex_mod() -> int:
    return get_stat_modifier(dexterity)

func get_con_mod() -> int:
    return get_stat_modifier(constitution)

func get_int_mod() -> int:
    return get_stat_modifier(intelligence)

func get_wis_mod() -> int:
    return get_stat_modifier(wisdom)

func get_cha_mod() -> int:
    return get_stat_modifier(charisma)

# Combat calculations
func get_defense() -> int:
    ## Calculate defense value: 10 + DEX mod + armor
    return 10 + get_dex_mod() + armor_bonus

func get_melee_attack_bonus() -> int:
    ## Calculate melee attack bonus: STR mod + skill
    return get_str_mod() + skill_rank

func get_ranged_attack_bonus() -> int:
    ## Calculate ranged attack bonus: DEX mod + skill
    return get_dex_mod() + skill_rank

func get_attack_bonus() -> int:
    ## Get appropriate attack bonus based on unit type
    # Lyra uses DEX for attacks (finesse), others use STR
    if unit_type == UnitType.LYRA:
        return get_ranged_attack_bonus()
    return get_melee_attack_bonus()
```

**Unit Stats Configuration (in _ready or via setter)**

```gdscript
func _configure_stats_for_type() -> void:
    ## Set stats based on unit type (from GDD)
    match unit_type:
        UnitType.PLAYER:
            strength = 14
            dexterity = 12
            constitution = 14
            intelligence = 10
            wisdom = 10
            charisma = 12
            max_hp = 35
            armor_bonus = 3  # Chain Shirt
            movement_range = 5

        UnitType.THORNE:
            strength = 16
            dexterity = 10
            constitution = 14
            intelligence = 10
            wisdom = 12
            charisma = 8
            max_hp = 40
            armor_bonus = 5  # Plate
            movement_range = 4

        UnitType.LYRA:
            strength = 10
            dexterity = 16
            constitution = 10
            intelligence = 14
            wisdom = 12
            charisma = 12
            max_hp = 25
            armor_bonus = 2  # Leather
            movement_range = 6

        UnitType.MATTHIAS:
            strength = 10
            dexterity = 10
            constitution = 12
            intelligence = 12
            wisdom = 16
            charisma = 14
            max_hp = 30
            armor_bonus = 4  # Scale Mail
            movement_range = 5

        UnitType.ENEMY:
            # Basic bandit stats
            strength = 12
            dexterity = 12
            constitution = 10
            intelligence = 8
            wisdom = 8
            charisma = 8
            max_hp = 15
            armor_bonus = 2
            movement_range = 5

    current_hp = max_hp
```

### Integration with Attack Resolver

Update `attack_resolver.gd` to use unit stats:

```gdscript
static func get_attack_bonus(attacker: Unit) -> int:
    ## Get attack bonus from unit's stats
    return attacker.get_attack_bonus()

static func get_defense(target: Unit) -> int:
    ## Get defense value from unit's stats
    return target.get_defense()
```

### Integration Points

| System | Integration |
|--------|-------------|
| Attack Resolver | Uses `get_attack_bonus()` and `get_defense()` |
| Movement System | Uses `movement_range` property |
| Turn Manager | Uses `get_dex_mod()` for initiative |
| Ability System (Task 2.3+) | Uses stat mods for damage/healing calculations |

---

## 7. File Structure

### Files to Modify

```
scripts/combat/unit.gd          # Add stats system
scripts/combat/attack_resolver.gd  # Use unit stats
scripts/main/main.gd            # Remove hardcoded HP (now in unit)
```

### Files to Create (Optional - for cleaner architecture)

```
scenes/combat/units/
├── PlayerUnit.tscn
├── ThorneUnit.tscn
├── LyraUnit.tscn
└── MatthiasUnit.tscn

scripts/resources/
└── unit_stats.gd               # (Optional) Stats as Resource
```

---

## 8. Acceptance Criteria

| # | Criterion | Test Method |
|---|-----------|-------------|
| 1 | All 4 party members appear at battle start | Visual confirmation |
| 2 | Player has HP 35, Defense 14, Attack +4 | Debug print stats |
| 3 | Thorne has HP 40, Defense 15, Attack +5 | Debug print stats |
| 4 | Lyra has HP 25, Defense 15, Attack +5 | Debug print stats |
| 5 | Matthias has HP 30, Defense 14, Attack +2 | Debug print stats |
| 6 | Lyra moves 6 tiles (fastest) | Movement range test |
| 7 | Thorne moves 4 tiles (slowest) | Movement range test |
| 8 | Attack resolver uses unit stats | Combat test shows correct bonuses |
| 9 | Each companion has unique color | Visual verification |
| 10 | All companions can be selected and moved | Functional test |

---

## 9. Testing Checklist

### Functional Tests
- [ ] All 6 stats accessible via getter methods
- [ ] Stat modifiers calculate correctly (14 = +2, 16 = +3, 8 = -1)
- [ ] Defense calculation: 10 + DEX mod + armor
- [ ] Attack bonus calculation: STR/DEX mod + skill
- [ ] Movement range varies by unit type

### Stat Verification Tests
- [ ] Player: STR 14, DEX 12, CON 14, HP 35, DEF 14, ATK +4, Move 5
- [ ] Thorne: STR 16, DEX 10, CON 14, HP 40, DEF 15, ATK +5, Move 4
- [ ] Lyra: STR 10, DEX 16, CON 10, HP 25, DEF 15, ATK +5, Move 6
- [ ] Matthias: STR 10, DEX 10, CON 12, HP 30, DEF 14, ATK +2, Move 5

### Integration Tests
- [ ] Attack resolver uses `unit.get_attack_bonus()` not hardcoded values
- [ ] Attack resolver uses `unit.get_defense()` not hardcoded values
- [ ] Movement system respects unit's `movement_range`
- [ ] Initiative calculation uses `get_dex_mod()`

### Combat Tests
- [ ] Lyra's high DEX gives her better initiative
- [ ] Thorne's high STR gives him higher damage potential
- [ ] Thorne's plate armor gives him highest defense
- [ ] Combat log shows correct attack/defense values

---

## 10. Implementation Notes

### Approach Rationale

**Why D&D-style 6-stat system?**
- Familiar to CRPG players
- Provides clear mechanical hooks for abilities
- Stat modifiers are intuitive (+2 for 14, etc.)
- Supports future character progression

**Why configure in Unit script vs external Resource?**
- Simpler for prototype scope
- All data visible in one place
- Easy to adjust during playtesting
- Can refactor to Resources in full production

**Why movement range varies by armor?**
- Creates meaningful tactical tradeoffs
- Thorne's tankiness costs him mobility
- Lyra's mobility compensates for fragility
- Matches expectations from tactical RPGs

### Gotchas to Watch

1. **Integer division**: Use `floor()` for stat modifiers to handle negative cases correctly
2. **Existing attack resolver**: Must update to use unit stats, not hardcoded values
3. **HP initialization**: Stats must be configured before `current_hp = max_hp`
4. **Movement range**: Already exists in Unit - ensure it's being used

### Migration from Hardcoded Values

Current hardcoded locations to update:
- `main.gd:_spawn_unit()` - HP values per type (move to Unit)
- `attack_resolver.gd` - Attack bonus calculations (use Unit methods)
- Any defense values (currently hardcoded at 12 for bandits)

---

## 11. Definition of Done

- [ ] Unit script has all 6 stat properties (STR, DEX, CON, INT, WIS, CHA)
- [ ] Stat modifier calculation implemented correctly
- [ ] `get_defense()` returns 10 + DEX mod + armor bonus
- [ ] `get_attack_bonus()` returns appropriate stat mod + skill
- [ ] All 4 party members have correct stats from GDD
- [ ] Movement range varies by unit type (4-6 tiles)
- [ ] Attack resolver uses unit stat methods
- [ ] HP values moved from main.gd to Unit stats configuration
- [ ] All acceptance criteria pass
- [ ] Ready for Task 2.2 (Ability UI Panel)

---

## 12. References

### From GDD

**Party Members (Section 4):**
- Player Character: STR 14, DEX 12, CON 14, INT 10, WIS 10, CHA 12, HP 35
- Thorne: STR 16, DEX 10, CON 14, INT 10, WIS 12, CHA 8, HP 40
- Lyra: STR 10, DEX 16, CON 10, INT 14, WIS 12, CHA 12, HP 25
- Matthias: STR 10, DEX 10, CON 12, INT 12, WIS 16, CHA 14, HP 30

**Combat System (Section 3):**
- Attack Roll: d20 + STR/DEX modifier + Skill rank
- Defense Value: 10 + DEX modifier + Armor bonus
- Movement ranges: Light 6, Medium 5, Heavy 4

### From Roadmap

- Task 2.1: Add Thorne, Lyra, Matthias Units (Phase 2, 2 hours)
- Dependencies: Phase 1 complete
- Hardcoded values: HP, STR, DEX as specified

### Godot Documentation

- [Export properties](https://docs.godotengine.org/en/stable/tutorials/scripting/gdscript/gdscript_exports.html)
- [Resources](https://docs.godotengine.org/en/stable/tutorials/scripting/resources.html)
