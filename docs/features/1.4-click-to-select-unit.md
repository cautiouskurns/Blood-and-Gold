# Feature Spec: Click-to-Select Unit

| Property | Value |
|----------|-------|
| **Feature ID** | 1.4 |
| **Status** | Planning |
| **Priority** | Critical |
| **Estimated Time** | 1.5 hours |
| **Phase** | Phase 1: Combat Visuals & Basic Interaction |
| **Dependencies** | Task 1.2 (Unit Placeholder Sprites), Task 1.3 (HP Bars) |

---

## 1. Purpose

### Why This Feature Exists

Unit selection is the foundational interaction for tactical combat. Without the ability to click and select units, players cannot issue commands, use abilities, or direct movement. This feature transforms passive observation into active tactical control, which is essential for the **Tactical Combat** design pillar. Selection must feel responsive and provide immediate visual feedback.

### What It Enables

- Players can click on friendly units to select them for commands
- Clear visual indication of which unit is currently selected
- Foundation for movement (Task 1.5) and ability usage (Task 2.2+)
- Single-selection model prevents confusion in large-scale battles
- Clicking elsewhere provides intuitive deselection

### Success Criteria

| Criterion | Measurement |
|-----------|-------------|
| Click responsiveness | Selection occurs within 1 frame of click |
| Visual clarity | Selection indicator visible from any camera distance |
| Single selection | Only one unit selected at any time |
| Deselection | Clicking empty tile or enemy clears selection |
| Integration ready | CombatManager tracks selected unit for other systems |

---

## 2. Design Pillar Alignment

| Pillar | How This Feature Supports It |
|--------|------------------------------|
| **Tactical Combat** | Selection is the first step in issuing tactical commands - move, attack, ability. Clear selection enables confident decision-making. |
| **Build & Command** | Selecting party members (vs issuing orders to soldiers) reinforces the distinction between direct control and command. |

---

## 3. How It Works

### Overview

When the player clicks on a friendly unit, that unit becomes "selected" and displays a yellow outline indicator. The CombatManager autoload tracks which unit is currently selected, allowing other systems (movement, abilities, attacks) to know which unit should receive commands.

Only one unit can be selected at a time. Clicking a different friendly unit switches selection. Clicking on an enemy unit, an empty tile, or outside the grid deselects the current unit.

The selection indicator is a yellow (#f1c40f) outline rendered around the unit sprite, clearly visible against all unit colors and terrain.

### User Flow

```
1. Player sees units on grid (no selection)
2. Player clicks on friendly unit (e.g., Player character)
3. Yellow selection indicator appears around clicked unit
4. CombatManager.selected_unit is set to that unit
5. UI systems can now show ability bar, movement range, etc.
6. Player clicks different friendly unit
7. Previous unit's indicator disappears
8. New unit shows selection indicator
9. Player clicks empty tile
10. Selection indicator disappears
11. CombatManager.selected_unit is set to null
```

### Rules & Constraints

| Rule | Description |
|------|-------------|
| Friendly only | Can only select friendly (party) units, not enemies |
| Single selection | Maximum one unit selected at any time |
| Click priority | Units have priority over tiles (clicking unit selects, not the tile beneath) |
| Selection persists | Selection remains until explicitly changed or cleared |
| Dead units | Cannot select dead/incapacitated units |

### Edge Cases

| Scenario | Behavior |
|----------|----------|
| Click on enemy unit | Deselects current unit (enemy cannot be selected) |
| Click on dead friendly unit | No selection change (dead units not selectable) |
| Click outside grid bounds | Deselects current unit |
| Click on obstacle tile | Deselects current unit |
| Click on currently selected unit | Unit remains selected (no toggle) |
| Multiple units overlapping | Topmost unit (highest z-index) receives click |

---

## 4. User Interaction

### Controls

| Input | Action |
|-------|--------|
| Left-click on friendly unit | Select that unit |
| Left-click on enemy unit | Deselect current unit |
| Left-click on empty tile | Deselect current unit |
| Left-click outside grid | Deselect current unit |

### Visual Feedback

| State | Visual |
|-------|--------|
| No selection | No selection indicators visible |
| Unit selected | Yellow (#f1c40f) outline around unit, 3px width |
| Hover over friendly (future) | Subtle highlight (not in this task) |

### Audio Feedback (Future)

| Event | Sound |
|-------|-------|
| Unit selected | Soft "click" or "confirm" sound |
| Unit deselected | Subtle "release" sound |

*Note: Audio is out of scope for prototype but noted for future.*

---

## 5. Visual Design

### Selection Indicator Appearance

```
┌─────────────────────────────────────────────┐
│                                             │
│   ╔═══════════════════════════════════╗     │
│   ║                                   ║     │
│   ║   ┌───────────────────────────┐   ║     │
│   ║   │                           │   ║     │
│   ║   │      56x56 Unit Sprite    │   ║     │
│   ║   │           [P]             │   ║     │
│   ║   │                           │   ║     │
│   ║   └───────────────────────────┘   ║     │
│   ║                                   ║     │
│   ╚═══════════════════════════════════╝     │
│                                             │
│   Yellow outline (#f1c40f), 3px width       │
│   Total size: 62x62 (sprite + 3px each side)│
└─────────────────────────────────────────────┘
```

### Color Specification

| Element | Color | Hex | Usage |
|---------|-------|-----|-------|
| Selection outline | Gold/Yellow | #f1c40f | 3px border around selected unit |
| Selection outline (dark) | Darker gold | #d4ac0d | Optional inner shadow for depth |

### Selection Indicator Sizing

| Property | Value | Rationale |
|----------|-------|-----------|
| Outline width | 3px | Visible but not overwhelming |
| Offset from sprite | 0px | Outline touches sprite edge |
| Total visual size | 62x62px | 56px sprite + 3px border each side |
| Z-index | Above sprite, below UI | Rendered between unit and HP bar |

### Animation (Optional Enhancement)

For added polish (if time permits):
- Subtle pulse animation (scale 1.0 to 1.02 over 0.5s)
- Or gentle glow effect

---

## 6. Technical Implementation

### Scene Structure

**Modified Unit.tscn:**
```
Unit (Node2D) [z_index: 10]
├── SelectionIndicator (Sprite2D) [z_index: 0, hidden by default]
│   └── Texture: Programmatic yellow outline
├── Sprite2D (Sprite2D) [z_index: 1]
├── LetterLabel (Label) [z_index: 2]
├── HPBar (ProgressBar) [z_index: 3]
└── ClickArea (Area2D) [for input detection]
    └── CollisionShape2D (CircleShape2D, radius: 28)
```

**New Autoload: CombatManager**
```
scripts/autoload/combat_manager.gd
- Tracks selected_unit
- Emits selection_changed signal
- Provides select/deselect API
```

### Script Responsibilities

**unit.gd (modifications):**
```gdscript
# Add selection state
var is_selected: bool = false

# Add node references
@onready var selection_indicator: Sprite2D = $SelectionIndicator
@onready var click_area: Area2D = $ClickArea

# Selection methods
func select() -> void
func deselect() -> void
func _on_click_area_input_event(viewport, event, shape_idx) -> void
```

**combat_manager.gd (new autoload):**
```gdscript
extends Node

signal unit_selected(unit: Unit)
signal unit_deselected(unit: Unit)
signal selection_changed(old_unit: Unit, new_unit: Unit)

var selected_unit: Unit = null

func select_unit(unit: Unit) -> void
func deselect_unit() -> void
func get_selected_unit() -> Unit
func has_selection() -> bool
```

### Detailed Script: combat_manager.gd

```gdscript
## CombatManager - Global combat state management
## Part of: Blood & Gold Prototype
## Handles: Unit selection, turn management (future), combat flow (future)
extends Node

# ===== SIGNALS =====
signal unit_selected(unit: Unit)
signal unit_deselected(unit: Unit)
signal selection_changed(old_unit: Unit, new_unit: Unit)

# ===== STATE =====
var selected_unit: Unit = null

# ===== LIFECYCLE =====
func _ready() -> void:
    print("[CombatManager] Initialized")

# ===== SELECTION API =====
func select_unit(unit: Unit) -> void:
    ## Select a unit, deselecting any previously selected unit
    if unit == null:
        deselect_unit()
        return

    # Can only select friendly, living units
    if unit.is_enemy or not unit.is_alive():
        deselect_unit()
        return

    # Don't re-select already selected unit (but don't deselect either)
    if unit == selected_unit:
        return

    var old_unit = selected_unit

    # Deselect previous unit
    if selected_unit != null:
        selected_unit.deselect()
        unit_deselected.emit(selected_unit)

    # Select new unit
    selected_unit = unit
    selected_unit.select()
    unit_selected.emit(selected_unit)
    selection_changed.emit(old_unit, selected_unit)

    print("[CombatManager] Selected: %s" % unit.unit_name)

func deselect_unit() -> void:
    ## Deselect the currently selected unit
    if selected_unit == null:
        return

    var old_unit = selected_unit
    selected_unit.deselect()
    selected_unit = null

    unit_deselected.emit(old_unit)
    selection_changed.emit(old_unit, null)

    print("[CombatManager] Deselected")

func get_selected_unit() -> Unit:
    ## Get the currently selected unit (or null)
    return selected_unit

func has_selection() -> bool:
    ## Check if any unit is selected
    return selected_unit != null

func is_unit_selected(unit: Unit) -> bool:
    ## Check if a specific unit is selected
    return selected_unit == unit
```

### Detailed Script: Unit Selection Additions

```gdscript
# Add to unit.gd constants
const COLOR_SELECTION: Color = Color("#f1c40f")  # Yellow
const SELECTION_OUTLINE_WIDTH: int = 3
const CLICK_RADIUS: int = 28  # Half of sprite size

# Add to unit.gd node references
@onready var selection_indicator: Sprite2D = $SelectionIndicator
@onready var click_area: Area2D = $ClickArea

# Add to unit.gd internal state
var is_selected: bool = false

# Add to unit.gd _ready()
func _ready() -> void:
    # ... existing code ...
    _setup_selection_indicator()
    _setup_click_detection()

func _setup_selection_indicator() -> void:
    ## Create yellow outline texture for selection
    var indicator_size = SPRITE_SIZE + (SELECTION_OUTLINE_WIDTH * 2)
    var image = Image.create(indicator_size, indicator_size, false, Image.FORMAT_RGBA8)

    # Draw hollow rectangle (outline only)
    for x in range(indicator_size):
        for y in range(indicator_size):
            var is_outline = (
                x < SELECTION_OUTLINE_WIDTH or
                x >= indicator_size - SELECTION_OUTLINE_WIDTH or
                y < SELECTION_OUTLINE_WIDTH or
                y >= indicator_size - SELECTION_OUTLINE_WIDTH
            )
            if is_outline:
                image.set_pixel(x, y, COLOR_SELECTION)
            else:
                image.set_pixel(x, y, Color.TRANSPARENT)

    var texture = ImageTexture.create_from_image(image)
    selection_indicator.texture = texture
    selection_indicator.centered = true
    selection_indicator.visible = false  # Hidden by default

func _setup_click_detection() -> void:
    ## Configure Area2D for click detection
    click_area.input_event.connect(_on_click_area_input_event)

func _on_click_area_input_event(_viewport: Node, event: InputEvent, _shape_idx: int) -> void:
    ## Handle click input on unit
    if event is InputEventMouseButton:
        if event.button_index == MOUSE_BUTTON_LEFT and event.pressed:
            _handle_click()

func _handle_click() -> void:
    ## Process click on this unit
    unit_clicked.emit(self)

    # Let CombatManager handle selection logic
    if not is_enemy and is_alive():
        CombatManager.select_unit(self)
    else:
        # Clicking enemy or dead unit deselects
        CombatManager.deselect_unit()

# ===== SELECTION API =====
func select() -> void:
    ## Mark this unit as selected and show indicator
    is_selected = true
    selection_indicator.visible = true

func deselect() -> void:
    ## Mark this unit as not selected and hide indicator
    is_selected = false
    selection_indicator.visible = false
```

### Integration Points

| System | Integration |
|--------|-------------|
| Main scene | CombatManager autoload available globally |
| Unit | Emits `unit_clicked` signal, calls CombatManager |
| Movement (Task 1.5) | Uses `CombatManager.selected_unit` to determine who moves |
| Abilities (Task 2.2+) | Uses selection to determine ability source |
| Turn system (Task 1.8) | May auto-select unit whose turn it is |

### Signals

| Signal | Emitter | Parameters | Purpose |
|--------|---------|------------|---------|
| `unit_clicked` | Unit | `(unit: Unit)` | Notify that unit was clicked |
| `unit_selected` | CombatManager | `(unit: Unit)` | Notify that unit was selected |
| `unit_deselected` | CombatManager | `(unit: Unit)` | Notify that unit was deselected |
| `selection_changed` | CombatManager | `(old: Unit, new: Unit)` | Notify selection state change |

---

## 7. File Structure

```
scripts/
├── autoload/
│   └── combat_manager.gd          # NEW: Selection tracking autoload
└── combat/
    └── unit.gd                    # MODIFIED: Add selection logic

scenes/
└── combat/
    └── Unit.tscn                  # MODIFIED: Add SelectionIndicator, ClickArea

project.godot                       # MODIFIED: Add CombatManager autoload
```

---

## 8. Acceptance Criteria

| # | Criterion | Test Method |
|---|-----------|-------------|
| 1 | Clicking friendly unit shows selection indicator | Click Player unit, verify yellow outline appears |
| 2 | Only one unit selected at a time | Click Player, then Thorne, verify only Thorne has indicator |
| 3 | Clicking elsewhere deselects current unit | Select unit, click empty tile, verify indicator disappears |
| 4 | Clicking enemy deselects (doesn't select enemy) | Select Player, click Enemy, verify no selection |
| 5 | Selection indicator is clearly visible | Yellow outline visible against all backgrounds |
| 6 | CombatManager tracks selection | Check `CombatManager.selected_unit` matches visual state |
| 7 | Cannot select dead units | Kill unit (debug), try to click, verify no selection |
| 8 | Selection persists until changed | Select unit, wait 5 seconds, verify still selected |
| 9 | Clicking selected unit keeps it selected | Click unit twice, verify it stays selected |
| 10 | Click detection area appropriate | Click near edge of unit, verify selection works |

---

## 9. Testing Checklist

### Functional Tests
- [ ] Click on Player unit - selection indicator appears
- [ ] Click on Thorne unit - Player deselects, Thorne selects
- [ ] Click on empty grid tile - current unit deselects
- [ ] Click on enemy unit - current unit deselects
- [ ] Click outside grid - current unit deselects
- [ ] `CombatManager.selected_unit` matches visual state
- [ ] `CombatManager.has_selection()` returns correct boolean

### Visual Tests
- [ ] Selection indicator is yellow (#f1c40f)
- [ ] Selection indicator is 3px outline around unit
- [ ] Indicator visible against dark background
- [ ] Indicator visible when unit on green tile
- [ ] Indicator visible when unit on gray (obstacle) tile
- [ ] Indicator z-order correct (below HP bar, above sprite)

### Integration Tests
- [ ] CombatManager autoload loads correctly
- [ ] `unit_selected` signal emits on selection
- [ ] `unit_deselected` signal emits on deselection
- [ ] `selection_changed` signal emits with correct parameters
- [ ] Other scripts can access `CombatManager.selected_unit`

### Edge Cases
- [ ] Click dead unit - no selection
- [ ] Click same unit twice - stays selected
- [ ] Rapid clicking between units - correct unit selected
- [ ] Click on unit overlap area - topmost unit selected

---

## 10. Implementation Notes

### Approach Rationale

**Why Area2D for click detection?**
- Built-in input_event handling
- Works with collision shapes for precise click areas
- Can be disabled/enabled easily
- Better than checking mouse position manually every frame

**Why CombatManager autoload?**
- Selection state needs to be globally accessible
- Movement, abilities, UI all need to know selected unit
- Autoload ensures single source of truth
- Signals allow loose coupling with other systems

**Why programmatic selection indicator?**
- Consistent with existing unit sprite generation
- No external asset dependencies
- Easy to adjust size/color in code
- Matches prototype's visual style

### Gotchas to Watch

1. **Input priority**: Ensure Unit's Area2D receives clicks before grid does
2. **Z-index**: SelectionIndicator must be below sprite to appear as outline
3. **Autoload registration**: Must add CombatManager to project.godot autoloads
4. **Signal connections**: Connect in _ready(), not _init()
5. **Null checks**: Always check if selected_unit is null before accessing

### Alternative Approaches Considered

| Approach | Pros | Cons | Decision |
|----------|------|------|----------|
| Shader-based outline | Smooth, scalable | Complex, requires shader knowledge | Not for prototype |
| 9-slice sprite | Art-driven, flexible | Requires asset, more setup | Not for prototype |
| Programmatic texture | Simple, no assets | Less polished look | **Chosen** |
| AnimationPlayer pulse | Adds life | Extra complexity | Optional enhancement |

---

## 11. Definition of Done

- [ ] `scripts/autoload/combat_manager.gd` created with selection API
- [ ] `CombatManager` added to project.godot autoloads
- [ ] `Unit.tscn` has SelectionIndicator (Sprite2D) node
- [ ] `Unit.tscn` has ClickArea (Area2D) with CollisionShape2D
- [ ] `unit.gd` has selection methods (`select()`, `deselect()`)
- [ ] Clicking friendly unit shows yellow outline
- [ ] Only one unit selected at a time
- [ ] Clicking elsewhere deselects
- [ ] All acceptance criteria pass
- [ ] Code follows GDScript style guidelines
- [ ] Ready for Task 1.5 (Click-to-Move with Path Preview)

---

## 12. References

### From GDD

- **Player Inputs**: "Click unit to select" (Section 3: Combat System)
- **Party Control**: "Party members (4): Full tactical control - you choose every action" (Section 3)
- **Design Pillar**: "Tactical Combat - Grid-based turn-based combat" (Section 1)

### From Roadmap

- **Task 1.4**: Click-to-Select Unit (Phase 1, Day 1, 1.5 hours)
- **Dependencies**: Task 1.2 (units must exist)
- **Leads to**: Task 1.5 (Click-to-Move with Path Preview)
- **Hardcoded Values**: Yellow (#f1c40f) outline, 3px, click radius 28px

### Godot Documentation

- [Area2D](https://docs.godotengine.org/en/stable/classes/class_area2d.html)
- [Input handling](https://docs.godotengine.org/en/stable/tutorials/inputs/inputevent.html)
- [Autoloads](https://docs.godotengine.org/en/stable/tutorials/scripting/singletons_autoload.html)
- [Signals](https://docs.godotengine.org/en/stable/getting_started/step_by_step/signals.html)
