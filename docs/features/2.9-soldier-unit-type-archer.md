# Task 2.9: Soldier Unit Type (Archer)

**Status:** üî¥ Planned
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 1 hour
**Dependencies:** Task 2.8 (infantry exists), Task 2.7 (ranged attacks)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The Archer soldier completes the mercenary company roster, providing ranged firepower that complements the infantry's melee capabilities. Archers embody the tactical depth of Blood & Gold - they force players to think about positioning, cover, and protecting their ranged assets while leveraging their ability to eliminate threats from a distance.

**What does it enable?**
- Ranged tactical options through the soldier system (not just party members)
- Creates meaningful positioning decisions - protect archers vs send infantry forward
- Adds counter-play for enemies rushing the player's formation
- Enables "combined arms" tactics central to the commander fantasy

**Success criteria:**
- Archer soldiers appear with distinct teal/green sprites and "A" letter identifier
- Archers attack enemies from range (up to 8 tiles)
- Archers maintain distance - if enemies get too close, they retreat then shoot
- Archers follow the same order system as infantry (ADVANCE/HOLD)

---

## How It Works

### Overview

Archer soldiers are ranged NPC allies that complement the infantry soldiers in the player's mercenary company. Like infantry, they follow **standing orders** and act autonomously during their turn. However, their behavior differs significantly - archers prioritize staying at range and will retreat if enemies close the gap.

When an archer's turn comes up, they evaluate their current order and position relative to enemies:
- **ADVANCE:** Move toward a good firing position and shoot the nearest enemy
- **HOLD:** Stay in current position and shoot any enemy in range; retreat only if enemies are adjacent

The archer's core behavior loop is: **maintain range ‚Üí shoot ‚Üí reposition if threatened**. This creates the tactical depth the GDD describes - archers "stay at range, shoot priority targets" and "force player to advance or use cover." The player must protect their archers or risk losing valuable ranged support.

Archers have lower HP (15) and defense (11) than infantry, making them vulnerable in melee. Their damage (1d6) is consistent but their real value is in their 8-tile range and intelligent positioning behavior.

### User Flow

```
1. Battle begins - Archers placed on grid, typically behind infantry line
2. Initiative rolled - Archer appears in turn order with other units
3. Archer's turn arrives
4. System checks soldier's current_order and nearby enemy positions
5. Check: Are any enemies adjacent (threatening)?
   - Yes: Retreat 2-3 tiles away, then shoot if target in range
   - No: Proceed to order execution
6. If ADVANCE: Move to optimal firing position, shoot nearest enemy
7. If HOLD: Stay in place, shoot enemy in range (prioritize closest)
8. If no enemy in range and ADVANCE: Move closer until in range
9. Turn ends, next unit acts
10. Player can change orders via Order Panel (Task 2.10)
```

### Rules & Constraints

- **Range:** Archers can shoot enemies up to 8 tiles away
- **Retreat Behavior:** If an enemy is adjacent (1 tile), archer attempts to move 2-3 tiles away before shooting
- **Retreat Priority:** Retreat direction prefers moving toward allied units / away from other enemies
- **Order Persistence:** Orders persist until the player issues a new order
- **Target Priority:** Shoot the nearest enemy in range; on ADVANCE, may move to get targets in range
- **Movement:** Archers can move up to 5 tiles per turn (faster than infantry to enable repositioning)
- **Attack:** Ranged attack (1d6), requires line of sight (no blocking terrain/units)
- **Death:** Soldier deaths don't trigger defeat condition
- **No Direct Control:** Player cannot manually move archers or choose their attack targets
- **Action Economy:** Can move AND shoot in same turn (retreat + shoot, or advance + shoot)

### Edge Cases

- **No enemies in range (HOLD):** Stand idle, don't move
- **No enemies in range (ADVANCE):** Move toward nearest enemy until in range, then shoot
- **Retreat blocked:** If no valid retreat path, stand and fight (shoot adjacent enemy)
- **Multiple enemies adjacent:** Retreat first, then shoot one of them
- **Enemy in range but not adjacent:** Just shoot, no need to retreat
- **Ally blocking line of sight:** Find next valid target or reposition
- **All enemies dead:** Stand idle, order icon remains
- **No valid targets after moving:** End turn without attacking

---

## User Interaction

### Controls

- **No direct control:** Archers cannot be clicked to select for movement/attack
- **Order Panel (Task 2.10):** Player clicks order button, then clicks archer to assign
- **Selection indicator:** Archers don't show selection ring (only party members do)

### Visual Feedback

- **Order Icon:** 32x32 icon floating above archer showing current order
  - Sword icon for ADVANCE (aggressive)
  - Shield icon for HOLD (defensive)
- **Turn Indicator:** Current archer's turn highlighted in turn order panel
- **Movement Animation:** Archer moves along path (0.15s per tile)
- **Retreat Indicator:** Brief yellow/orange flash when retreating from danger
- **Ranged Attack Animation:** Projectile or arrow visual traveling to target
- **Attack Feedback:** Same damage numbers and target flash as other attacks
- **Death Animation:** Same death animation as other units (fade out)

### Audio Feedback (if applicable)

- Placeholder: Bow shot sound effect on attack
- Retreat: Quick footstep sound
- Future: Distinct "twang" for bow release

---

## Visual Design

### Layout

```
Archer Soldier Unit:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   [Order Icon]  ‚îÇ  <- 32x32 icon, centered above unit
‚îÇ        ‚Üì        ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ   ‚îÇ    A    ‚îÇ   ‚îÇ  <- 56x56 teal square with "A" letter
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ   [===HP===]    ‚îÇ  <- HP bar below
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Components

- **Sprite2D:** Teal colored square (56x56) with "A" letter
- **Order Icon:** Small sprite above unit showing current order (shared with infantry)
- **HP Bar:** Standard health bar (same as other units)
- **Letter Label:** "A" for Archer identification

### Visual Style

- **Base Color:** #1abc9c (Teal) - same as infantry to show soldier faction
- **Border Color:** #17a589 (Darker Teal)
- **Letter:** "A" in white, centered on sprite
- **Order Icon:** White/cream colored, 32x32 with dark outline
- **Icon Position:** 20 pixels above sprite top
- **Projectile (Future):** Simple arrow/bolt sprite for ranged attacks

### States

- **Default:** Teal sprite with current order icon
- **Taking Turn:** Slight pulse/glow (same as party members)
- **Retreating:** Brief orange/yellow tint while moving away from threat
- **Damaged:** Red flash on sprite
- **Low HP:** HP bar turns red (< 25%)
- **Dead:** Fade out animation, removed from grid

---

## Technical Implementation

### Scene Structure

```
ArcherSoldier.tscn (inherits Unit.tscn or uses UnitType.ARCHER)
‚îú‚îÄ‚îÄ Sprite2D (teal colored, inherits setup)
‚îú‚îÄ‚îÄ LetterLabel ("A")
‚îú‚îÄ‚îÄ HPBar
‚îú‚îÄ‚îÄ SelectionIndicator (hidden - soldiers not selectable)
‚îú‚îÄ‚îÄ ClickArea (disabled for soldiers)
‚îú‚îÄ‚îÄ OrderIcon (same as infantry)
‚îÇ   ‚îî‚îÄ‚îÄ Sprite2D (order icon texture)
‚îî‚îÄ‚îÄ (inherited nodes from Unit.tscn)
```

### Script Responsibilities

- **unit.gd (uses existing UnitType.ARCHER):**
  - Add `UnitType.ARCHER` stats in `_configure_stats_for_type()` if not already present
  - Use existing `current_order: String = "HOLD"` property from infantry implementation
  - Use existing `is_ranged_weapon = true` flag
  - Set `weapon_range = 8` for ranged attacks

- **soldier_ai.gd (modified):**
  - Add `_should_retreat(soldier: Unit) -> bool` - Check if enemies are adjacent
  - Add `_execute_retreat(soldier: Unit) -> Vector2i` - Move away from threats
  - Modify `execute_turn()` to handle archer-specific retreat behavior
  - Add `_find_best_firing_position(soldier: Unit)` - For ADVANCE order
  - Use existing `_perform_attack()` with ranged attack support

- **turn_manager.gd:**
  - No changes needed - already handles soldiers via `is_soldier` flag

### Integration Points

- **Connects to:** CombatManager (battle state), TurnManager (turn execution), Pathfinding
- **Uses:** Ranged attack system from Task 2.7
- **Emits signals:**
  - `order_changed(soldier, new_order)` (shared with infantry)
  - `soldier_retreated(soldier, from_pos, to_pos)` (new, for visual feedback)
- **Listens for:**
  - Turn system signals to know when it's archer's turn
- **Modifies:**
  - SoldierAI to handle ranged behavior and retreat logic

### Configuration

- **Stats in unit.gd:** Hardcoded in `_configure_stats_for_type()` switch
- **Order Icons:** Shared with infantry in `assets/sprites/ui/order_icons/`

---

## Acceptance Criteria

Feature is complete when:

- [ ] Archer soldier appears on grid with distinct teal sprite and "A" letter
- [ ] Archer has correct stats: HP 15, DEF 11, ATK 1d6, Range 8, Move 5
- [ ] Order icon (sword/shield) visible above archer showing current order
- [ ] When archer's turn arrives, they act automatically (no player input needed)
- [ ] Archer attacks enemies from range (up to 8 tiles)
- [ ] Archer retreats if enemy is adjacent before shooting
- [ ] ADVANCE order: Archer moves to firing position and shoots
- [ ] HOLD order: Archer stays in place and shoots enemies in range
- [ ] Archer death doesn't trigger defeat (only party deaths do)
- [ ] Multiple archers can exist and act independently
- [ ] Ranged attack visuals work correctly (projectile or hit feedback)

---

## Testing Checklist

### Functional Tests

- [ ] **Spawn Test:** Archer spawns at correct grid position with teal sprite
- [ ] **Stats Test:** Verify HP=15, DEF=11, weapon die=6, range=8, move=5
- [ ] **Turn Test:** Archer acts on their turn without player input
- [ ] **Range Test:** Archer can hit enemies up to 8 tiles away
- [ ] **Retreat Test:** Archer retreats when enemy is adjacent
- [ ] **ADVANCE Test:** Archer moves to good position and shoots
- [ ] **HOLD Test:** Archer stays in place and shoots enemies in range
- [ ] **Order Icon Test:** Icon updates when order changes
- [ ] **Death Test:** Archer dies correctly, removed from grid and turn order

### Edge Case Tests

- [ ] **No target in range (HOLD):** Archer stands idle
- [ ] **No target in range (ADVANCE):** Archer moves closer
- [ ] **Retreat blocked:** Archer fights from current position
- [ ] **Multiple adjacent enemies:** Archer retreats, then shoots one
- [ ] **All enemies dead:** Archer stands idle
- [ ] **Line of sight blocked:** Archer finds alternate target or repositions

### Integration Tests

- [ ] Works with turn order panel (appears correctly)
- [ ] Works with damage number system (shows damage)
- [ ] Works with pathfinding system (moves and retreats correctly)
- [ ] Works with ranged attack system from Task 2.7
- [ ] Works alongside infantry soldiers
- [ ] Doesn't break party member selection/control

### Polish Tests

- [ ] Movement animation smooth (0.15s per tile)
- [ ] Attack animations play correctly
- [ ] Retreat visual feedback visible
- [ ] Order icon clearly visible
- [ ] HP bar updates correctly
- [ ] Death animation plays

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Use existing UnitType.ARCHER:** Already defined in unit.gd enum and color dictionaries
2. **Set is_soldier = true:** Prevents defeat on archer death
3. **Set is_ranged_weapon = true:** Enables ranged attack logic
4. **Reuse SoldierAI:** Extend existing soldier_ai.gd with archer retreat behavior
5. **Retreat before attacking:** Core archer loop is retreat (if needed) ‚Üí shoot ‚Üí end turn

### Stats Configuration (in _configure_stats_for_type)

```gdscript
UnitType.ARCHER:
    is_enemy = false
    is_soldier = true
    unit_name = unit_name if unit_name != "Unit" else "Archer"
    max_hp = 15
    current_hp = 15
    strength = 10  # +0 modifier (uses DEX for ranged)
    dexterity = 14  # +2 modifier for ranged attacks
    armor_bonus = 1  # DEF 10 + 1 = 11 (light armor)
    skill_rank = 1
    weapon_damage_die = 6  # 1d6
    movement_range = 5
    weapon_range = 8  # Ranged!
    is_ranged_weapon = true
```

### Archer AI Approach (extends soldier_ai.gd)

```gdscript
# Pseudocode for archer behavior
static func execute_archer_turn(archer: Unit) -> void:
    # First: Check if we need to retreat
    if _should_retreat(archer):
        var retreat_success = await _execute_retreat(archer)
        # After retreat, try to shoot

    # Then: Execute order
    var order = archer.current_order
    match order:
        "ADVANCE":
            var target = _find_target_in_range(archer)
            if target:
                _perform_ranged_attack(archer, target)
            else:
                # Move closer to get target in range
                target = _find_nearest_enemy(archer)
                if target:
                    _move_toward_firing_position(archer, target)
                    # Check again after moving
                    if _is_in_range(archer, target):
                        _perform_ranged_attack(archer, target)
        "HOLD":
            var target = _find_target_in_range(archer)
            if target:
                _perform_ranged_attack(archer, target)
            # Don't move on HOLD

    CombatManager.end_current_turn()

static func _should_retreat(archer: Unit) -> bool:
    # Check if any enemy is adjacent (within 1 tile)
    var enemies = _get_all_enemies()
    for enemy in enemies:
        if _tile_distance(archer, enemy) <= 1:
            return true
    return false

static func _execute_retreat(archer: Unit) -> bool:
    # Find position 2-3 tiles away from nearest threat
    # Prefer moving toward allies or toward map edges
    var retreat_pos = _calculate_retreat_position(archer)
    if retreat_pos:
        await _move_to_position(archer, retreat_pos)
        return true
    return false
```

### Alternative Approaches Considered

1. **Separate ArcherSoldier class:** Rejected for same reasons as infantry - Unit handles variations well.

2. **Retreat distance as parameter:** Could make retreat distance configurable, but 2-3 tiles works for prototype. Can add complexity later.

3. **Kiting behavior:** More sophisticated "kite" behavior (always maintain max range) considered but deferred - simple retreat-when-adjacent is sufficient for prototype.

4. **Priority targeting:** Archers could target specific enemy types (casters, ranged, etc.) - deferred to Task 2.11 (Order Behaviors).

### Dependencies on Other Tasks

- **Task 2.7 (Ranged Attacks):** Must be implemented first - archers need ranged attack infrastructure
- **Task 2.8 (Infantry):** SoldierAI base implementation should exist
- **Task 2.10 (Order Panel):** Will add UI to change orders for both infantry and archers
- **Task 2.11 (Order Behaviors):** May add FOCUS_FIRE behavior for archers

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| HP | 15 | Lower than infantry (20), very fragile |
| Defense | 11 | Base 10 + 1 light armor |
| Attack | 1d6 | Same damage die as infantry |
| Range | 8 tiles | Long range for tactical advantage |
| Movement | 5 tiles | Faster than infantry (4) for repositioning |
| Sprite Color | #1abc9c | Teal (same as infantry - soldier faction) |
| Border Color | #17a589 | Darker teal |
| Letter | "A" | Archer identifier |
| Retreat Distance | 2-3 tiles | Distance to move when enemy adjacent |
| Order Icon Size | 32x32 | Same as infantry |
| Icon Offset Y | -60 pixels | Above sprite and HP bar |

---
