# Task 2.13: Attack of Opportunity

**Status:** ðŸŸ¢ Implemented
**Priority:** â¬†ï¸ High
**Estimated Time:** 1.5 hours
**Dependencies:** Task 1.7 (Attack System), Task 1.5 (Click-to-Move)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
Attacks of Opportunity create tactical tension around positioning, making movement decisions meaningful. In tactical combat, leaving a threatened position should carry risk - this mechanic punishes careless repositioning and rewards careful planning of movement paths.

**What does it enable?**
- Creates "zone of control" around melee combatants that enemies must respect
- Encourages players to think about engagement and disengagement
- Adds depth to positioning decisions - moving isn't always free
- Rewards flanking and surrounding tactics (enemies can't easily escape)
- Supports the design pillar of **Tactical Combat** with positioning-based gameplay

**Success criteria:**
- Moving away from an adjacent enemy triggers their free attack before movement occurs
- Each enemy can only perform one opportunity attack per turn
- Visual and audio feedback clearly indicates an opportunity attack is happening
- Players can see which tiles are "threatened" to make informed decisions

---

## How It Works

### Overview

When a unit attempts to move away from a tile that is adjacent to an enemy, that enemy gets a free attack (called an "Attack of Opportunity" or AoO) against the moving unit. This attack happens **before** the movement begins, meaning the unit might be killed or wounded before reaching their destination.

The key distinction is that the attack triggers when **leaving** a threatened tile, not when entering one. This means units can approach enemies safely, but retreating or repositioning carries risk. Moving between two tiles that are both adjacent to the same enemy does NOT trigger an opportunity attack - only moving from adjacent to non-adjacent does.

Each enemy can only make one opportunity attack per turn (their turn cycle, not game turn). This prevents abuse scenarios where moving past multiple enemies results in an overwhelming barrage of attacks. The limit resets when the enemy's next turn begins.

### User Flow

```
1. Player selects a unit adjacent to an enemy
2. Player clicks a destination tile that would move unit away from the adjacent enemy
3. Path preview shows - system detects unit will leave threatened tile
4. System checks if adjacent enemy has used their opportunity attack this turn
5. If enemy hasn't used opportunity attack:
   a. "OPPORTUNITY!" indicator flashes above enemy
   b. Enemy performs free attack against moving unit
   c. Damage is applied (damage numbers appear)
   d. If unit survives, movement proceeds normally
   e. If unit dies, movement is cancelled
6. If enemy already used opportunity attack this turn:
   a. No attack occurs
   b. Movement proceeds normally
7. Movement completes
```

### Rules & Constraints

- **Trigger Condition:** Moving from a tile adjacent to an enemy to a tile NOT adjacent to that enemy
- **Timing:** Attack resolves BEFORE movement begins
- **Limit:** Each enemy gets ONE opportunity attack per turn (resets at start of their turn)
- **Attack Type:** Uses enemy's basic attack (same as their normal attack action)
- **Range:** Only melee-adjacent enemies can perform opportunity attacks (ranged enemies cannot)
- **Multiple Enemies:** If leaving multiple enemies' threatened zones simultaneously, each eligible enemy gets an opportunity attack
- **Soldier Behavior:** NPC soldiers (infantry, archers) can also trigger and perform opportunity attacks
- **No Counter-AoO:** An opportunity attack cannot trigger another opportunity attack

### Edge Cases

- **Unit dies during AoO:** Movement is cancelled, turn ends for that unit
- **Multiple enemies adjacent:** Each enemy that would lose adjacency gets their own AoO (if available)
- **Moving through threatened tile:** If unit enters and then exits an enemy's adjacency in one move, AoO triggers on exit only
- **Diagonal movement:** Diagonal tiles count as adjacent (8-directional adjacency)
- **Enemy is stunned/incapacitated:** Cannot perform opportunity attacks (future consideration)
- **Unit is pushed/knocked back:** Forced movement does NOT trigger opportunity attacks
- **Teleportation effects:** Do NOT trigger opportunity attacks (future consideration)
- **Charging/rushing:** May bypass opportunity attacks (future consideration for special abilities)

---

## User Interaction

### Controls

- **No new controls:** Opportunity attacks happen automatically based on movement decisions
- **Click-to-move:** Existing movement system detects and processes AoO triggers
- **Path preview enhancement:** Could highlight tiles that trigger AoO (optional polish)

### Visual Feedback

- **"OPPORTUNITY!" text:** Appears above the attacking enemy in orange/red color
- **Enemy flash:** Attacking enemy flashes briefly (similar to normal attack visual)
- **Attack animation:** Enemy performs their attack animation
- **Damage numbers:** Standard damage numbers appear on the target
- **Movement pause:** Brief pause between AoO resolution and movement start
- **Threatened tiles (optional):** Red tint or warning indicator on tiles that would trigger AoO

### Audio Feedback (if applicable)

- **AoO trigger sound:** Quick "whoosh" or "slash" sound effect
- **Voice line (future):** "Got you!" or similar from attacking enemy
- **Impact sound:** Standard attack impact sounds

---

## Visual Design

### Layout

```
Combat Grid during Opportunity Attack:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                        â”‚
â”‚    [Enemy]  â†â”€â”€ Adjacent to player     â”‚
â”‚       â†“                                â”‚
â”‚  "OPPORTUNITY!"  (floating text)       â”‚
â”‚       â”‚                                â”‚
â”‚       â–¼                                â”‚
â”‚   [Player Unit]  (taking damage)       â”‚
â”‚       â”‚                                â”‚
â”‚       â–¼                                â”‚
â”‚   (movement destination)               â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

- **Opportunity Indicator:** Floating text "OPPORTUNITY!" above attacking enemy
- **Attack Line (optional):** Brief line/trail from enemy to target showing attack
- **Damage Number:** Standard damage number popup on target

### Visual Style

- **Indicator Color:** Orange (#ff9900) or Red (#ff3333) for danger/warning
- **Text Style:** Bold, slightly larger than damage numbers
- **Animation:** Quick fade-in, shake, then fade-out (0.5-0.8 seconds total)
- **Enemy Flash:** Red tint on sprite (similar to attack indicator)

### States

- **Default:** No special indicator (unit not moving away from enemies)
- **Threatened Path Preview:** (Optional) Destination tiles that trigger AoO show warning icon
- **AoO Triggered:** "OPPORTUNITY!" appears, enemy attacks
- **AoO Complete:** Indicator fades, movement begins

---

## Technical Implementation

### Scene Structure

```
No new scenes required - modifications to existing systems:

Unit.tscn (existing)
â”œâ”€â”€ ... existing nodes ...
â””â”€â”€ (no new nodes needed)

DamageNumber.tscn (reused for indicator)
â””â”€â”€ Label (can display "OPPORTUNITY!" text)
```

### Script Responsibilities

- **unit.gd (modify):**
  - Add method `get_adjacent_enemies() -> Array[Unit]` to find enemies in adjacent tiles
  - Add method `is_adjacent_to(other: Unit) -> bool` for adjacency check
  - Modify movement logic to check for AoO triggers before executing movement
  - Track `_opportunity_attack_used: bool` flag per unit
  - Add method `reset_opportunity_attack()` called at turn start
  - Add method `can_perform_opportunity_attack() -> bool`
  - Add method `perform_opportunity_attack(target: Unit)` for the free attack

- **combat_manager.gd (modify):**
  - Add `check_opportunity_attacks(moving_unit: Unit, from_pos: Vector2i, to_pos: Vector2i) -> Array[Unit]`
  - Returns list of enemies who will get opportunity attacks
  - Add `execute_opportunity_attacks(attackers: Array[Unit], target: Unit)` to process all AoO
  - Modify turn start to reset opportunity attack flags for the current unit

- **click_handler.gd or movement system (modify):**
  - Before executing movement, call `check_opportunity_attacks()`
  - If AoO will trigger, process them before movement
  - If unit dies during AoO, cancel movement

### Integration Points

- **Connects to:**
  - Attack system (Task 1.7) for performing the free attack
  - Movement system (Task 1.5) for intercepting movement commands
  - Turn system for resetting opportunity attack availability
  - Damage number system for "OPPORTUNITY!" indicator

- **Emits signals:**
  - `opportunity_attack_triggered(attacker: Unit, target: Unit)` - When AoO begins
  - `opportunity_attack_completed(attacker: Unit, target: Unit, damage: int)` - When AoO resolves

- **Listens for:**
  - Turn start signals to reset opportunity attack flags
  - Movement commands to check for AoO triggers

- **Modifies:**
  - Unit state (`_opportunity_attack_used` flag)
  - Movement flow (adds AoO check/execution step)

### Configuration

- **Hardcoded Values:**
  - Opportunity attacks per turn per enemy: 1
  - Attack type: Basic attack (enemy's normal attack)
  - Adjacency range: 1 tile (8-directional)

- **Tunable constants (in unit.gd or combat_manager.gd):**
  - `const OPPORTUNITY_ATTACKS_PER_TURN: int = 1`
  - `const OPPORTUNITY_ATTACK_ENABLED: bool = true` (for easy toggling during testing)

---

## Acceptance Criteria

Feature is complete when:

- [ ] Moving away from an adjacent enemy triggers their free attack
- [ ] Attack resolves BEFORE movement begins
- [ ] Enemy can only perform one opportunity attack per turn
- [ ] "OPPORTUNITY!" visual indicator appears when AoO triggers
- [ ] Damage numbers display correctly for opportunity attacks
- [ ] If unit dies during AoO, movement is cancelled
- [ ] Multiple adjacent enemies can each perform AoO (if they haven't used theirs)
- [ ] AoO flag resets at the start of each enemy's turn
- [ ] Moving BETWEEN adjacent tiles (staying adjacent) does NOT trigger AoO
- [ ] NPC soldiers can both trigger and receive opportunity attacks

---

## Testing Checklist

### Functional Tests

- [ ] **Basic AoO Test:** Move party member away from adjacent enemy, verify attack occurs
- [ ] **Damage Test:** Verify AoO deals damage using enemy's normal attack stats
- [ ] **Timing Test:** Verify AoO damage applies BEFORE unit moves
- [ ] **One-per-turn Test:** Move two units away from same enemy, only first triggers AoO
- [ ] **Reset Test:** After enemy's turn starts, they can AoO again
- [ ] **Death Test:** Unit killed by AoO doesn't complete movement
- [ ] **Multiple Enemies Test:** Moving away from 2+ adjacent enemies triggers AoO from each

### Edge Case Tests

- [ ] **Diagonal adjacency:** AoO triggers for diagonal neighbors correctly
- [ ] **Staying adjacent:** Moving parallel to enemy (staying adjacent) doesn't trigger AoO
- [ ] **Moving toward enemy:** Approaching an enemy doesn't trigger AoO
- [ ] **Circle movement:** Moving in a circle that starts and ends adjacent to enemy (triggers on exit)
- [ ] **Path through threat:** Path that passes through enemy adjacency triggers AoO on exit

### Integration Tests

- [ ] Works with party members (player-controlled units)
- [ ] Works with soldier AI (NPC soldiers can trigger AoO)
- [ ] Works with enemy AI (enemies performing AoO)
- [ ] Works with damage number system
- [ ] Works with turn order system (AoO flag reset)
- [ ] Doesn't break existing movement functionality
- [ ] Works with ranged units (they should NOT perform AoO)

### Polish Tests

- [ ] "OPPORTUNITY!" indicator appears clearly
- [ ] Attack animation plays correctly
- [ ] Damage numbers display correctly
- [ ] Brief pause between AoO and movement feels right
- [ ] Multiple AoO chain smoothly (if multiple enemies attack)
- [ ] No performance issues with AoO checks

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Check BEFORE movement:** The AoO must resolve before `move_along_path()` is called
2. **Adjacency calculation:** Use Chebyshev distance (max of dx, dy) for 8-directional adjacency
3. **Path analysis:** Need to check if moving unit will EXIT adjacency, not just current state
4. **Melee only:** Only units with `is_ranged_weapon == false` should perform AoO
5. **Reuse attack system:** Call existing `perform_attack()` method for consistency

### Pseudocode for AoO Check

```gdscript
func check_opportunity_attacks(unit: Unit, path: Array[Vector2i]) -> Array[Unit]:
    var attackers: Array[Unit] = []
    var current_pos = unit.grid_position

    for next_pos in path:
        # Get enemies adjacent to current position
        var adjacent_enemies = get_adjacent_enemies(unit, current_pos)

        for enemy in adjacent_enemies:
            # Check if moving to next_pos LEAVES this enemy's adjacency
            if not is_adjacent(next_pos, enemy.grid_position):
                # This move triggers AoO from this enemy
                if enemy.can_perform_opportunity_attack():
                    attackers.append(enemy)

        current_pos = next_pos

    return attackers
```

### Alternative Approaches Considered

1. **AoO on enter (rejected):** Some systems trigger AoO when entering threat range. Rejected because leaving is more intuitive for "trying to escape" scenarios.

2. **Infinite AoO (rejected):** No per-turn limit. Rejected because it would make certain positions (surrounded by enemies) inescapable death traps.

3. **Reflex save to avoid (deferred):** Adding a chance to avoid AoO based on Dexterity. Could be added later but keeps things simple for prototype.

4. **AoO for ranged (rejected):** Letting archers perform AoO. Rejected because it doesn't make narrative sense - archers don't threaten adjacent tiles the same way melee fighters do.

### Dependencies on Other Tasks

- **Task 1.7 (Attack System):** Must exist to perform the free attack
- **Task 1.5 (Click-to-Move):** Must hook into movement to intercept and check AoO
- **Task 2.8/2.9 (Soldiers):** Soldier AI should handle AoO (both triggering and performing)

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| Opportunity attacks per turn | 1 | Per enemy, resets at their turn start |
| Attack type | Basic attack | Uses enemy's normal attack stats |
| Adjacency range | 1 tile | 8-directional (includes diagonals) |
| Indicator text | "OPPORTUNITY!" | Floating above attacker |
| Indicator color | Orange #ff9900 | Warning/danger color |
| Indicator duration | 0.5-0.8 seconds | Quick flash and fade |

---
