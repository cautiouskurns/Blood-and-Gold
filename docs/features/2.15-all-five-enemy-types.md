# Task 2.15: All 5 Enemy Types

**Status:** üü¢ Implemented
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 2 hours
**Dependencies:** Task 2.14 (Enemy AI Basic Behavior)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The GDD specifies 5 distinct enemy types, each with unique behaviors and abilities that create tactical variety. Currently, only the basic Bandit Melee (ENEMY) type exists. Adding the remaining enemy types - particularly the Ironmark forces - enables the full tactical combat experience where players face formations, leaders with buff abilities, and elite knights that require strategic responses.

**What does it enable?**
- Tactical variety with ranged, melee, leader, and elite enemy types
- Formation-based combat with Shield Wall synergy
- Priority target decisions (kill the Leader to remove buffs, or the Knight to stop charges)
- Preparation for Contract 2 (ruins with Bandit Leader) and Contract 3 (Ironmark enemies)
- Testing player ability to break defensive formations and handle aggressive charges

**Success criteria:**
- All 5 enemy types appear with distinct sprites and behaviors
- Shield Wall provides correct DEF bonus when adjacent to ally
- Charge ability moves and attacks in one action with bonus damage
- Each enemy type has GDD-accurate stats
- Enemy variety creates meaningfully different tactical challenges

---

## How It Works

### Overview

This feature implements the complete enemy roster from the GDD, adding four new enemy types to the existing Bandit Melee. Each enemy type has unique stats, visual appearance, and (for some) special abilities that affect how players approach combat.

**Bandit Enemies** represent common threats - lightly armored bandits who rely on numbers and their Leader's buffs. They're the "cannon fodder" that players learn tactics against.

**Ironmark Enemies** are disciplined soldiers with better armor and tactical abilities. The Ironmark Soldier uses Shield Wall to create defensive formations, while the Ironmark Knight is an aggressive elite that charges into combat and can shake soldier morale.

The enemy AI (Task 2.14) will use these abilities appropriately - Soldiers staying in formation, Knights charging vulnerable targets, Leaders buffing from safety.

### Enemy Types

#### 1. Bandit Melee (Existing - UnitType.ENEMY)
- **Role:** Basic fodder, tests positioning
- **Stats:** HP 15, DEF 12, ATK 1d6+2, Move 5
- **Behavior:** Rush nearest target
- **Visual:** Dirty brown leather, red bandana, rusty blade

#### 2. Bandit Archer (New - UnitType.BANDIT_ARCHER)
- **Role:** Ranged threat, forces advancement or cover usage
- **Stats:** HP 10, DEF 11, ATK 1d6 (range 8), Move 5
- **Behavior:** Stay at range, shoot priority targets (lowest HP or casters)
- **Visual:** Green hooded cloak, longbow, quiver
- **Abilities:** None (basic ranged attack)

#### 3. Bandit Leader (New - UnitType.BANDIT_LEADER)
- **Role:** Priority target, buff provider
- **Stats:** HP 30, DEF 14, ATK 1d8+3, Move 5
- **Behavior:** Stay protected, use Rally to buff nearby bandits
- **Visual:** Red cape, better armor, distinctive helm with plume
- **Abilities:**
  - **Rally Bandits:** All bandits within 4 tiles get +2 ATK for 2 turns (once per battle)
  - **Power Attack:** Standard power attack (+50% damage, -2 hit)

#### 4. Ironmark Soldier (New - UnitType.IRONMARK_SOLDIER)
- **Role:** Defensive formation unit, tests player's ability to break lines
- **Stats:** HP 25, DEF 15 (heavy armor), ATK 1d8+2, Move 4
- **Behavior:** Hold formation, advance slowly in line, stay adjacent to allies
- **Visual:** Blue and silver armor, tower shield with Ironmark crest, spear
- **Abilities:**
  - **Shield Wall (Passive):** +2 DEF when adjacent to another Ironmark unit

#### 5. Ironmark Knight (New - UnitType.IRONMARK_KNIGHT)
- **Role:** Elite mini-boss, aggressive threat, morale attacker
- **Stats:** HP 40, DEF 17 (full plate), ATK 1d10+4, Move 5
- **Behavior:** Aggressive charges, prioritize player's soldiers to break morale
- **Visual:** Blue full plate, mounted look (though on foot), lance/sword, plumed helm
- **Abilities:**
  - **Charge:** Move up to full movement + attack in one action, +1d6 bonus damage
  - **Intimidate:** All player soldiers within 3 tiles make morale check or suffer -2 ATK for 2 turns

### User Flow

```
1. Battle starts - enemies placed on grid by type
2. Each enemy type has distinct appearance (sprite + letter identifier)
3. During enemy turns:
   - Bandit Melee: Rushes nearest player unit
   - Bandit Archer: Maintains range, shoots priority targets
   - Bandit Leader: Uses Rally if bandits nearby, stays protected
   - Ironmark Soldier: Advances in formation, maintains Shield Wall
   - Ironmark Knight: Uses Charge if path clear, targets soldiers
4. Shield Wall bonus calculated dynamically based on adjacency
5. Charge resolves as move + attack in single action
6. Battle ends when all enemies defeated or player party killed
```

### Rules & Constraints

**Shield Wall:**
- Passive ability, always active
- Grants +2 DEF when adjacent to ANY Ironmark unit (Soldier or Knight)
- Multiple adjacencies don't stack (still only +2)
- Breaks when no adjacent Ironmark allies

**Charge:**
- Uses full turn (action economy: move + attack = 1 action)
- Must have clear path to target (pathfinding check)
- Minimum charge distance: 3 tiles (must "build momentum")
- Maximum charge distance: movement range (5 tiles)
- Bonus damage: +1d6 on top of normal attack
- Can only use once every 2 turns (cooldown)

**Rally Bandits:**
- Area of effect: 4 tile radius (Chebyshev distance)
- Only affects units with `is_bandit = true` flag
- Duration: 2 turns
- Uses per battle: 1 (limited use ability)
- Leader can still attack on same turn after Rally

**Intimidate:**
- Area of effect: 3 tile radius
- Only affects player soldiers (`is_soldier = true`)
- Morale check: Roll d20 + WIS modifier vs DC 12
- Failure: -2 ATK for 2 turns
- Uses per battle: 1

### Edge Cases

- **Shield Wall with no allies:** No bonus (soldier is alone)
- **Charge blocked by obstacles:** Cannot use Charge, uses normal attack instead
- **Charge with less than 3 tiles:** Cannot use Charge (needs momentum)
- **Rally with no bandits in range:** Ability not used (AI won't waste it)
- **Intimidate with no soldiers in range:** Ability not used
- **All Ironmark units killed except one:** Remaining soldier loses Shield Wall bonus
- **Bandit Leader killed:** Rally buff already applied persists for duration

---

## User Interaction

### Controls

- **No new controls:** Enemy behavior is AI-driven
- **Targeting:** Players click on any enemy type to attack (same as existing)
- **Hover info:** Hovering shows enemy stats and active abilities/effects

### Visual Feedback

- **Distinct sprites:** Each enemy type has unique appearance
- **Letter identifiers:** E (Bandit), A (Archer), L (Leader), S (Soldier), K (Knight)
- **Shield Wall indicator:** Blue glow/outline when Shield Wall is active
- **Charge telegraph:** Red line showing charge path before execution
- **Rally effect:** Orange pulse on buffed bandits
- **Intimidate effect:** Purple wave from Knight, affected soldiers show debuff icon

### Audio Feedback (if applicable)

- **Charge:** Heavy footsteps, impact sound
- **Rally:** Battle horn/shout
- **Intimidate:** Intimidating yell, metal clang
- **Shield Wall:** Shield clunk sound when forming up

---

## Visual Design

### Layout

```
Enemy Unit Visual Structure:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   [Letter ID]   ‚îÇ  <- "E", "A", "L", "S", "K"
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ   ‚îÇ  Sprite ‚îÇ   ‚îÇ  <- 48x48 unique sprite
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ   [===HP===]    ‚îÇ  <- HP bar
‚îÇ   [Buff Icons]  ‚îÇ  <- Status effect indicators
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Components

- **Sprite2D:** 48x48 programmatically generated sprite per type
- **LetterLabel:** Single letter identifier (E/A/L/S/K)
- **HPBar:** Standard health bar (same as other units)
- **StatusIcons:** Small icons for Shield Wall active, Rally buff, etc.

### Visual Style - Sprite Palettes

**Bandit Archer:**
- Primary: Forest Green (#27ae60)
- Secondary: Brown Leather (#6d4c41)
- Accent: Tan (#d4a574)
- Hood and cloak dominant

**Bandit Leader:**
- Primary: Crimson Red (#c0392b)
- Secondary: Dark Brown (#5d4e37)
- Accent: Gold (#f1c40f)
- Red cape, gold trim, plume

**Ironmark Soldier:**
- Primary: Royal Blue (#2980b9)
- Secondary: Steel Gray (#5d6d7e)
- Accent: Silver (#bdc3c7)
- Large shield dominant, blue tabard

**Ironmark Knight:**
- Primary: Royal Blue (#2980b9)
- Secondary: Polished Steel (#95a5a6)
- Accent: Gold (#f1c40f)
- Full plate, gold trim, plumed helm

### States

- **Default:** Standard appearance with faction colors
- **Shield Wall Active (Soldier):** Subtle blue glow around shield
- **Charging (Knight):** Red tint while charging
- **Buffed (Rally):** Orange particle effect
- **Intimidated (negative):** Purple tint, debuff icon
- **Low HP:** HP bar turns red (< 25%)
- **Dead:** Fade out animation

---

## Technical Implementation

### Scene Structure

```
All enemies use the existing Unit.tscn with different UnitType:

Unit.tscn (existing)
‚îú‚îÄ‚îÄ Sprite2D (generated per type)
‚îú‚îÄ‚îÄ LetterLabel (E/A/L/S/K)
‚îú‚îÄ‚îÄ HPBar
‚îú‚îÄ‚îÄ SelectionIndicator
‚îú‚îÄ‚îÄ ClickArea
‚îî‚îÄ‚îÄ StatusIcons (new - for buff/debuff display)
```

### Script Responsibilities

**unit.gd (modify):**
- Add new enum values to UnitType: `BANDIT_ARCHER, BANDIT_LEADER, IRONMARK_SOLDIER, IRONMARK_KNIGHT`
- Add `is_bandit: bool` flag for Rally targeting
- Add `is_ironmark: bool` flag for Shield Wall calculation
- Add stats configuration for each new enemy type in `_configure_stats_for_type()`
- Add `get_shield_wall_bonus() -> int` for dynamic DEF calculation
- Modify `get_defense()` to include Shield Wall bonus when applicable

**unit_sprite_generator.gd (modify):**
- Add color palettes for new enemy types
- Add `generate_bandit_archer_sprite() -> ImageTexture`
- Add `generate_bandit_leader_sprite() -> ImageTexture`
- Add `generate_ironmark_soldier_sprite() -> ImageTexture`
- Add `generate_ironmark_knight_sprite() -> ImageTexture`
- Update `generate_sprite()` match statement for new types

**enemy_ai.gd (create or modify):**
- Add behavior logic for each enemy type
- `execute_bandit_archer_turn()` - ranged attack, maintain distance
- `execute_bandit_leader_turn()` - Rally usage, positioning
- `execute_ironmark_soldier_turn()` - formation maintenance
- `execute_ironmark_knight_turn()` - Charge usage, soldier targeting

**abilities/ (create ability resources):**
- `rally_bandits.tres` - Area buff ability
- `charge.tres` - Move + attack ability with bonus damage
- `intimidate.tres` - Area debuff ability

**combat_manager.gd (modify):**
- Add `get_adjacent_ironmark_count(unit: Unit) -> int` for Shield Wall calculation
- Add `get_bandits_in_range(unit: Unit, range: int) -> Array[Unit]` for Rally

### Integration Points

- **Connects to:**
  - UnitSpriteGenerator for visual generation
  - AttackResolver for combat calculations
  - StatusEffectManager for buffs/debuffs
  - CombatManager for adjacency calculations

- **Emits signals:**
  - `ability_used(unit: Unit, ability_id: String)` - When enemy uses ability
  - `shield_wall_changed(unit: Unit, active: bool)` - When Shield Wall status changes

- **Listens for:**
  - Unit movement (to recalculate Shield Wall)
  - Unit death (to update Shield Wall for remaining units)

- **Modifies:**
  - Unit stats (dynamic DEF with Shield Wall)
  - Combat flow (Charge is move + attack)

### Configuration

**Stats in unit.gd:**
```gdscript
UnitType.BANDIT_ARCHER:
    is_enemy = true
    is_bandit = true
    unit_name = "Bandit Archer"
    max_hp = 10
    dexterity = 14  # +2 for ranged
    armor_bonus = 1  # DEF 11
    weapon_damage_die = 6  # 1d6
    weapon_range = 8
    is_ranged_weapon = true
    movement_range = 5

UnitType.BANDIT_LEADER:
    is_enemy = true
    is_bandit = true
    unit_name = "Bandit Leader"
    max_hp = 30
    strength = 14  # +2
    armor_bonus = 4  # DEF 14
    weapon_damage_die = 8  # 1d8
    damage_bonus = 3  # +3
    movement_range = 5

UnitType.IRONMARK_SOLDIER:
    is_enemy = true
    is_ironmark = true
    unit_name = "Ironmark Soldier"
    max_hp = 25
    strength = 12
    armor_bonus = 5  # DEF 15 (heavy armor)
    weapon_damage_die = 8  # 1d8
    damage_bonus = 2  # +2
    movement_range = 4

UnitType.IRONMARK_KNIGHT:
    is_enemy = true
    is_ironmark = true
    unit_name = "Ironmark Knight"
    max_hp = 40
    strength = 16  # +3
    armor_bonus = 7  # DEF 17
    weapon_damage_die = 10  # 1d10
    damage_bonus = 4  # +4
    movement_range = 5
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] All 5 enemy types defined in UnitType enum
- [ ] Each enemy type has correct GDD stats
- [ ] Each enemy type has distinct programmatic sprite
- [ ] Each enemy type has unique letter identifier (E/A/L/S/K)
- [ ] Bandit Archer attacks from range (8 tiles)
- [ ] Bandit Leader can use Rally Bandits ability
- [ ] Rally buff applies +2 ATK to bandits in range
- [ ] Ironmark Soldier has Shield Wall passive
- [ ] Shield Wall grants +2 DEF when adjacent to Ironmark ally
- [ ] Shield Wall bonus updates dynamically when allies move/die
- [ ] Ironmark Knight can use Charge ability
- [ ] Charge moves + attacks in one action with +1d6 damage
- [ ] All enemy types can appear in battles

---

## Testing Checklist

### Functional Tests

- [ ] **Spawn Test:** Each enemy type spawns with correct sprite and letter
- [ ] **Stats Test:** Verify HP, DEF, ATK for each type match GDD
- [ ] **Bandit Archer Range:** Archer attacks from 8 tiles, maintains distance
- [ ] **Rally Test:** Leader uses Rally, nearby bandits get +2 ATK for 2 turns
- [ ] **Shield Wall Active:** Soldier adjacent to Ironmark ally shows +2 DEF
- [ ] **Shield Wall Dynamic:** Moving ally away removes Shield Wall bonus
- [ ] **Shield Wall Death:** Killing adjacent ally removes bonus from survivor
- [ ] **Charge Movement:** Knight moves and attacks in same action
- [ ] **Charge Damage:** Charge deals normal damage + 1d6 bonus
- [ ] **Charge Minimum:** Cannot Charge if target is within 2 tiles

### Edge Case Tests

- [ ] **Solo Soldier:** Ironmark Soldier alone has normal DEF (no Shield Wall)
- [ ] **Multiple Adjacent:** Soldier with 2 adjacent allies still only gets +2 DEF
- [ ] **Charge Blocked:** Knight uses normal attack if Charge path blocked
- [ ] **Rally No Targets:** Leader AI doesn't waste Rally if no bandits in range
- [ ] **Mixed Formation:** Ironmark Soldier adjacent to Knight gets Shield Wall
- [ ] **Leader Death:** Rally buff persists on buffed units after Leader dies

### Integration Tests

- [ ] Works with turn order system
- [ ] Works with attack resolver (damage calculations)
- [ ] Works with pathfinding (Charge path calculation)
- [ ] Works with status effect system (Rally/Intimidate buffs)
- [ ] Doesn't break existing enemy (ENEMY type) functionality
- [ ] Works with soldier AI (INFANTRY/ARCHER)

### Polish Tests

- [ ] Distinct visual appearance for each enemy type
- [ ] Shield Wall visual indicator visible
- [ ] Charge telegraph shows path
- [ ] Rally effect visible on buffed units
- [ ] HP bars and damage numbers work correctly
- [ ] Death animations play correctly

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Use existing Unit system:** Add new UnitType enum values, don't create separate classes
2. **Dynamic Shield Wall:** Calculate in `get_defense()` by checking adjacent Ironmark units
3. **Charge as ability:** Create ability resource with `ability_type = CHARGE`, custom execution
4. **Faction flags:** Add `is_bandit` and `is_ironmark` for ability targeting
5. **Sprite generation:** Follow existing pattern in UnitSpriteGenerator

### Pseudocode for Shield Wall

```gdscript
func get_defense() -> int:
    var base_defense = 10 + get_dex_mod() + armor_bonus

    # Shield Wall bonus for Ironmark units
    if is_ironmark and _has_adjacent_ironmark_ally():
        base_defense += 2

    return base_defense

func _has_adjacent_ironmark_ally() -> bool:
    var adjacent_units = CombatManager.get_adjacent_allies(self)
    for unit in adjacent_units:
        if unit.is_ironmark:
            return true
    return false
```

### Pseudocode for Charge

```gdscript
func execute_charge(knight: Unit, target: Unit) -> void:
    var distance = get_distance(knight, target)

    # Must be at least 3 tiles away for momentum
    if distance < 3:
        return

    # Move to adjacent tile
    var path = pathfinding.get_path(knight.grid_position, target.grid_position)
    knight.move_along_path(path)
    await knight.movement_finished

    # Attack with bonus damage
    var result = AttackResolver.resolve_attack(knight, target)
    if result.hit:
        var bonus_damage = randi_range(1, 6)  # +1d6
        result.damage += bonus_damage

    target.take_damage(result.damage)
```

### Alternative Approaches Considered

1. **Separate Enemy scenes:** Rejected - UnitType enum pattern is established and works
2. **Shield Wall as status effect:** Could work, but passive recalculation is cleaner
3. **Charge as two-turn ability:** Rejected - should feel impactful and immediate

### Dependencies on Other Tasks

- **Task 2.14 (Enemy AI):** AI must know how to use each enemy type's abilities
- **Task 1.7 (Attack System):** Must exist for damage calculation
- **Task 5.1 (Sprites):** UnitSpriteGenerator pattern must exist

---

## Hardcoded Values Reference

| Property | Enemy Type | Value | Notes |
|----------|------------|-------|-------|
| HP | Bandit Melee | 15 | Existing |
| HP | Bandit Archer | 10 | Squishy ranged |
| HP | Bandit Leader | 30 | Priority target |
| HP | Ironmark Soldier | 25 | Tanky |
| HP | Ironmark Knight | 40 | Mini-boss |
| DEF | Bandit Melee | 12 | Light armor |
| DEF | Bandit Archer | 11 | Very light |
| DEF | Bandit Leader | 14 | Better armor |
| DEF | Ironmark Soldier | 15 | Heavy armor |
| DEF | Ironmark Knight | 17 | Full plate |
| Shield Wall bonus | - | +2 DEF | When adjacent to Ironmark |
| Charge bonus damage | - | +1d6 | On successful charge |
| Charge minimum distance | - | 3 tiles | Need momentum |
| Rally ATK bonus | - | +2 | To all bandits in range |
| Rally range | - | 4 tiles | Chebyshev distance |
| Rally duration | - | 2 turns | |
| Intimidate range | - | 3 tiles | Affects soldiers only |
| Intimidate DC | - | 12 | WIS save to resist |
| Intimidate ATK penalty | - | -2 | On failed save |

---
