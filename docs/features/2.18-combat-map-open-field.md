# Task 2.18: Combat Map - Open Field

**Status:** üü¢ Implemented
**Priority:** ‚¨ÜÔ∏è High
**Estimated Time:** 1 hour
**Dependencies:** Task 2.16 (Combat Map - Forest Clearing)
**Assigned To:** AI assistant

---

## Purpose

**Why does this feature exist?**
The prototype needs maps that test different tactical scenarios. Forest Clearing tests cover and difficult terrain; Ruined Fort tests defensive chokepoints and walls. The Open Field map tests **mobility and flanking** - a wide open battlefield with minimal cover forces players to rely on positioning, initiative, and coordinated attacks rather than defensive terrain. The GDD emphasizes "flank, set up ambushes" - this map rewards aggressive maneuvering.

**What does it enable?**
- Third combat map with distinctly different tactical feel
- Minimal cover forces aggressive, mobile tactics
- Wide flanking lanes reward coordinated attacks
- Tests whether mobility-focused combat is satisfying
- Contrasts with defensive-focused maps (Ruined Fort)
- Used by Contract 3 "Ironmark Patrol" encounter (GDD)
- Validates that not all maps need complex terrain to be interesting

**Success criteria:**
- Map renders at 12x12 with sparse terrain (mostly open grass)
- Only 3-4 rock cover positions exist (scarce defensive options)
- No chokepoints or difficult terrain blocking movement
- Flanking feels viable and rewarding
- Battle feels exposed and different from other maps

---

## How It Works

### Overview

The Open Field is a 12x12 combat map representing a grassy plain with scattered rocks. Unlike Forest Clearing (stream divide) or Ruined Fort (wall chokepoints), this map is intentionally sparse - the lack of terrain IS the design. Players cannot rely on cover; they must use mobility, initiative order, and coordinated attacks.

The few rocks present create "islands" of safety that both sides will contest. Controlling a rock position gives a significant defensive advantage in an otherwise exposed battlefield. This creates dynamic, mobile combat where units maneuver for position rather than turtling behind terrain.

The map supports the GDD's Contract 3 "Ironmark Patrol" - fighting professional soldiers in an open field where their Shield Wall formation and superior numbers are most effective. Players must flank to break their formations.

### Map Layout

```
    0   1   2   3   4   5   6   7   8   9  10  11
  +---+---+---+---+---+---+---+---+---+---+---+---+
0 | E | E | E |   |   |   |   |   | E | E | E |   |  <- Enemy spawn zone
  +---+---+---+---+---+---+---+---+---+---+---+---+
1 |   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
2 |   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
3 |   |   | R |   |   |   |   |   |   |   |   |   |  <- Rock (cover)
  +---+---+---+---+---+---+---+---+---+---+---+---+
4 |   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
5 |   |   |   |   |   |   |   |   |   | R |   |   |  <- Rock (cover)
  +---+---+---+---+---+---+---+---+---+---+---+---+
6 |   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
7 |   | R |   |   |   |   |   |   |   |   |   |   |  <- Rock (cover)
  +---+---+---+---+---+---+---+---+---+---+---+---+
8 |   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
9 |   |   |   |   |   |   |   |   | R |   |   |   |  <- Rock (cover)
  +---+---+---+---+---+---+---+---+---+---+---+---+
10|   |   |   |   |   |   |   |   |   |   |   |   |
  +---+---+---+---+---+---+---+---+---+---+---+---+
11| P | P | P |   |   |   |   |   | P | P | P |   |  <- Party spawn zone
  +---+---+---+---+---+---+---+---+---+---+---+---+

Legend:
  (blank) = Walkable grass (open ground)
  R = Rock (cover tile, +2 Defense)
  E = Enemy spawn point
  P = Party spawn point
```

### User Flow

```
BATTLE START:
1. Combat scene loads OpenField map
2. Party units placed at party spawn points (Y=11)
3. Enemy units placed at enemy spawn points (Y=0)
4. Player sees wide open battlefield with scattered rocks
5. Battle proceeds using standard turn system

TACTICAL DECISIONS:
- "There's almost no cover - I need to close distance quickly"
- "Should I race for that rock, or commit to flanking around?"
- "The enemy has higher initiative - they'll reach cover first"
- "If I spread out, I can flank them from multiple angles"
- "Ironmark soldiers in Shield Wall are tough - I need to break their formation"
- "Lyra is exposed without cover - I need Thorne to protect her"
```

### Rules & Constraints

- **Map Size:** 12 x 12 tiles (standard combat grid, matching Forest Clearing)
- **Rocks (Cover):** Only 4 rocks scattered asymmetrically, provide +2 Defense
- **No High Ground:** No elevated positions on this map
- **No Difficult Terrain:** All tiles cost 1 movement (full mobility)
- **No Obstacles:** Nothing blocks movement or line of sight
- **Spawn Points:** 6 party spawn points (south), 6 enemy spawn points (north)

### Edge Cases

- **Rock Contention:** Both sides may race to reach the same rock for cover
- **No Cover Available:** If all rocks are occupied/controlled by enemies, player must fight exposed
- **Ranged Dominance:** Without cover, ranged units are very powerful - player may need to rush archers
- **Shield Wall Effectiveness:** Ironmark enemies are extra dangerous here (no terrain to break formations)
- **Initiative Matters:** First-movers can claim limited cover spots

---

## User Interaction

### Controls

| Input | Action |
|-------|--------|
| Hover tile | Show terrain info tooltip (cover or open ground) |
| Click to move | Path preview shows direct routes (no obstacles to route around) |
| Select attack target | Clear line of sight to all visible targets (no walls) |

### Visual Feedback

- **Grass Tiles:** Standard green walkable tiles (vast majority of map)
- **Rock Tiles:** Darker green with shield icon (cover indicator)
- **Spawn Points:** (Debug only) Colored highlights showing spawn zones
- **Exposed Feeling:** Large swaths of uniform green emphasize openness

### Audio Feedback (if applicable)

- Wind/grass ambient sound suggesting open plains (optional polish)
- No stream or structure sounds (contrasting with other maps)

---

## Visual Design

### Layout

```
OPEN FIELD MAP - Visual Composition:

+------------------------------------------+
|                                          |
|         [Enemy Spawn Zone]               |
|                                          |
|      *                                   |
|                                          |
|                         *                |
|                                          |
|   *                                      |
|                                          |
|                    *                     |
|                                          |
|         [Party Spawn Zone]               |
|                                          |
+------------------------------------------+

* = Scattered rock (cover)
```

### Components

- **Base Terrain:** Green grass tiles (existing TILE_WALKABLE)
- **Cover Terrain:** Darker green rock tiles (existing TILE_COVER)
- **Spawn Markers:** (Debug) Colored circles indicating spawn points

### Visual Style

- **Grass Color:** `#4a6741` (existing walkable color)
- **Rock Color:** `#3d5636` (existing cover color)
- Uses existing tileset - no new tiles required

### States

- **Default:** Mostly green grass with 4 scattered rocks
- **Movement Preview:** Shows full movement range (few obstacles)
- **Combat:** Exposed units visible across entire battlefield

---

## Technical Implementation

### Scene Structure

```
scenes/combat/maps/OpenField.tscn (optional - can use data dictionary)
‚îú‚îÄ‚îÄ OpenField (Node2D) - Root node
‚îÇ   ‚îî‚îÄ‚îÄ CombatGrid (existing) - Loads OPEN_FIELD_DATA

Alternative: Map data stored in combat_grid.gd as constant
```

### Script Responsibilities

**combat_grid.gd (modify):**
- Add `OPEN_FIELD_DATA` constant dictionary
- Add `get_open_field_data()` getter method
- No new tile types needed (uses existing TILE_WALKABLE and TILE_COVER)

### Integration Points

- **Connects to:**
  - `CombatGrid` - Loads terrain data via `load_map()`
  - `Pathfinding` - Full mobility (no difficult terrain)
  - `CombatManager` - Uses spawn points for unit placement
  - `AttackResolver` - Cover bonuses apply to 4 rock positions

- **Listens for:**
  - Nothing new - map is data that gets loaded at combat start

- **Modifies:**
  - `CombatGrid._grid_data` - Populated with map terrain
  - Unit starting positions based on spawn points

### Configuration

**Map Data Structure:**
```gdscript
# Open Field map definition
const OPEN_FIELD_DATA: Dictionary = {
    "name": "Open Field",
    "width": 12,
    "height": 12,
    "tiles": [
        # Row 0 (north - enemy spawn)
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 1
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 2
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 3 (rock at 2,3)
        [0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 4
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 5 (rock at 9,5)
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0],
        # Row 6
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 7 (rock at 1,7)
        [0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 8
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 9 (rock at 8,9)
        [0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0],
        # Row 10
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        # Row 11 (south - party spawn)
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    ],
    "party_spawns": [
        Vector2i(0, 11), Vector2i(1, 11), Vector2i(2, 11),
        Vector2i(8, 11), Vector2i(9, 11), Vector2i(10, 11)
    ],
    "enemy_spawns": [
        Vector2i(0, 0), Vector2i(1, 0), Vector2i(2, 0),
        Vector2i(8, 0), Vector2i(9, 0), Vector2i(10, 0)
    ]
}
# Tile type reference:
# 0 = TILE_WALKABLE
# 2 = TILE_COVER (rocks)
```

---

## Acceptance Criteria

Feature is complete when:

- [ ] Open Field map loads and renders at 12x12 tiles
- [ ] Map is mostly open grass (walkable tiles)
- [ ] Exactly 4 rock (cover) tiles placed asymmetrically
- [ ] No high ground, difficult terrain, or obstacles exist
- [ ] Party units spawn at south spawn points
- [ ] Enemy units spawn at north spawn points
- [ ] Full movement range available (no terrain slowing units)
- [ ] Clear line of sight across entire battlefield
- [ ] Battle feels distinctly different from Forest Clearing and Ruined Fort
- [ ] Flanking tactics are viable (wide open lanes)

---

## Testing Checklist

### Functional Tests

- [ ] **Map Rendering:** Open Field loads with correct terrain layout (12x12)
- [ ] **Rock Count:** Exactly 4 cover tiles exist at specified positions
- [ ] **Cover Bonus:** Unit on rock tile receives +2 Defense
- [ ] **No High Ground:** Verify no high ground tiles exist
- [ ] **No Difficult Terrain:** All tiles cost 1 movement
- [ ] **Spawn Points:** Party spawns at Y=11, enemies at Y=0
- [ ] **Full LoS:** Ranged attacks can target any tile without obstruction

### Tactical Tests

- [ ] **Exposed Combat:** Units without cover are vulnerable (no terrain to hide behind)
- [ ] **Rock Contention:** Both sides can reach and contest rock positions
- [ ] **Flanking Viable:** Units can move around enemies without terrain blocking
- [ ] **Initiative Matters:** First-moving units can claim cover spots
- [ ] **Different Feel:** Battle feels different from Forest Clearing and Ruined Fort

### Integration Tests

- [ ] **With Enemy AI:** Enemies can pathfind across open terrain
- [ ] **With Soldier AI:** Soldiers execute orders without terrain complications
- [ ] **With Attack System:** Cover bonuses apply correctly to rock tiles
- [ ] **With Turn System:** Normal turn flow with map loaded

### Visual Tests

- [ ] **Open Appearance:** Map looks sparse and exposed
- [ ] **Rock Visibility:** Rock tiles are clearly identifiable
- [ ] **Movement Preview:** Shows large movement range (few obstacles)

---

## Implementation Notes

*(For AI assistant)*

### Key Considerations

1. **Simplest Map:** This is the simplest map to implement - just walkable tiles with 4 cover positions. No new tile types, no complex layouts.

2. **Grid Size:** Uses 12x12 (matching Forest Clearing), not 14x14 like Ruined Fort. Since the grid constants were increased to 14 for Ruined Fort, the extra tiles will just be unused.

3. **Rock Placement:** Rocks are placed asymmetrically to prevent predictable patterns. Both sides have roughly equal access to cover, but they're scattered to force movement choices.

4. **Design Intent:** The sparse terrain IS the design. Don't add more terrain "to make it interesting." The lack of terrain creates a different kind of tactical challenge.

5. **Contract 3 Connection:** This map is designed for Contract 3 "Ironmark Patrol" where fighting professional soldiers in open ground tests the player's ability to break formations without terrain advantages.

### Alternative Approaches Considered

1. **Add Some Obstacles:** Considered adding rocks that block movement (not just cover). Rejected - keeps map fully traversable for maximum mobility.

2. **Central High Ground:** Considered adding a small hill in center. Rejected - would create a "king of the hill" dynamic that changes the open field feel.

3. **Scattered Difficult Terrain:** Considered adding mud patches. Rejected - would slow movement and reduce the "wide open" tactical feel.

---

## Hardcoded Values Reference

| Property | Value | Notes |
|----------|-------|-------|
| Map Size | 12 x 12 | Standard size (matches Forest Clearing) |
| Rock Count | 4 | Minimal cover |
| Rock Positions | (2,3), (9,5), (1,7), (8,9) | Asymmetric scatter |
| High Ground Tiles | 0 | No elevated positions |
| Difficult Terrain Tiles | 0 | Full mobility |
| Obstacle Tiles | 0 | No movement blocking |
| Party Spawn Points | 6 | Y=11 (south edge) |
| Enemy Spawn Points | 6 | Y=0 (north edge) |

---

## Asset Requirements

### No New Assets Required

All graphics use existing tileset:
- Walkable grass tiles (TILE_WALKABLE)
- Cover rock tiles (TILE_COVER)

This map requires no new tile types or visual assets.

---

## Relationship to Contract 3

This map is designed for Contract 3 "Ironmark Patrol" from the GDD:

**Contract 3 Setup:**
- Combat: Open Field map
- Enemies: 6 Ironmark Soldier + 2 Ironmark Knight
- Challenge: Fighting professional soldiers without terrain advantages
- Tactical Focus: Break Shield Wall formations through flanking

**Why Open Field for Ironmark:**
- Ironmark soldiers use Shield Wall (+2 DEF when adjacent)
- In open terrain, they can maintain tight formations easily
- Player must use mobility to flank and break formations
- No cover means player can't turtle - must engage aggressively
- Tests the "break formations" tactical skill from GDD

---

## Comparison with Other Maps

| Feature | Forest Clearing | Ruined Fort | Open Field |
|---------|-----------------|-------------|------------|
| Size | 12x12 | 14x14 | 12x12 |
| Cover Tiles | 10 (trees) | 8 (barriers) | 4 (rocks) |
| High Ground | 2 tiles | 4 tiles (tower) | 0 tiles |
| Difficult Terrain | Yes (stream) | Yes (rubble) | No |
| Walls/Obstacles | No | Yes (walls) | No |
| Chokepoints | Stream divide | Wall gaps | None |
| Tactical Focus | Cover + mobility | Defensive siege | Pure mobility |
| Contract Use | Contract 1 | Contract 2 | Contract 3 |

---
