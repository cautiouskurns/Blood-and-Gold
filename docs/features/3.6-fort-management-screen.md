# Fort Management Screen

**Feature ID:** 3.6
**Status:** ðŸ”´ Planned
**Priority:** âž¡ï¸ Medium
**Estimated Time:** 2-3 hours
**Dependencies:** Task 3.1 (Hub Scene Structure)
**Assigned To:** AI Assistant

---

## Purpose

### Why does this feature exist?
The Fort Management screen provides players with a meaningful way to invest their contract earnings into permanent upgrades that enhance their mercenary company's capabilities, supporting the "Build & Command" design pillar.

### What does it enable?
- Players can purchase three fort upgrades using gold earned from contracts
- Each upgrade provides a distinct strategic benefit (more soldiers, faster XP, better recruits)
- Creates long-term progression and investment decisions between contracts

### Success Criteria
- Players can view all available upgrades with clear cost/benefit information
- Players can purchase upgrades when they have sufficient gold
- Purchased upgrades persist and provide their stated benefits
- Unavailable upgrades (already owned or unaffordable) are clearly indicated

---

## How It Works

### Overview
The Fort Management screen is accessed from the main hub navigation. It displays the player's current fort status and three available upgrades in a grid or list layout. Each upgrade shows its name, cost, current status (available/owned/unaffordable), and a description of its benefits.

When the player clicks on an upgrade they can afford, a confirmation prompt appears. Upon confirmation, gold is deducted from GameState, the upgrade is marked as purchased, and its benefits take effect immediately. The UI updates to reflect the new state.

Upgrades that are already owned display a "PURCHASED" badge and cannot be clicked. Upgrades the player cannot afford are grayed out with the cost displayed in red.

### User Flow
1. Player navigates to Hub and clicks "FORT" button
2. Fort Management screen slides in or replaces current view
3. Player sees three upgrade cards with current status
4. Player clicks an affordable upgrade card
5. Confirmation dialog appears: "Purchase [Upgrade] for [Cost] gold?"
6. Player confirms purchase
7. Gold is deducted, upgrade marked as owned
8. Card updates to show "PURCHASED" state
9. Player can purchase more upgrades or return to hub

### Rules & Constraints
- Each upgrade can only be purchased once
- Gold must be sufficient to purchase (checked via `GameState.can_afford()`)
- Purchased upgrades persist across game sessions (saved in GameState)
- Upgrade effects apply immediately upon purchase

### Upgrades

| Upgrade | Cost | Effect |
|---------|------|--------|
| Barracks | 500g | +4 soldier capacity (allows larger party) |
| Training Yard | 600g | +50% XP gain for all soldiers |
| Tavern | 300g | Better quality recruits available |

### Edge Cases
- **Insufficient Gold:** Purchase button disabled, cost shown in red
- **Already Owned:** Card shows "PURCHASED" badge, not clickable
- **All Upgrades Owned:** Display congratulatory message, all cards show purchased
- **Gold Gained Mid-Screen:** UI should update affordability when returning from other screens

---

## User Interaction

### Controls
- **Mouse Click:** Select upgrade card, confirm purchase
- **ESC / Back Button:** Return to hub main view

### Visual Feedback
- **Hover:** Upgrade card highlights, shows detailed tooltip
- **Click:** Button press animation, brief highlight
- **Purchase Success:** Gold counter animates down, card flashes green, transforms to "PURCHASED" state
- **Purchase Denied:** Shake animation on card, brief red flash

### Audio Feedback
- **Hover:** Subtle UI hover sound
- **Purchase:** Coin sound effect, success chime
- **Denied:** Error buzz or denied sound

---

## Visual Design

### Layout
```
+--------------------------------------------------+
|  FORT MANAGEMENT                    Gold: 1200   |
+--------------------------------------------------+
|                                                  |
|  +----------------+  +----------------+          |
|  |   BARRACKS     |  | TRAINING YARD  |          |
|  |                |  |                |          |
|  |  [Icon/Image]  |  |  [Icon/Image]  |          |
|  |                |  |                |          |
|  | +4 Soldier Cap |  | +50% XP Gain   |          |
|  |                |  |                |          |
|  |   500 GOLD     |  |   600 GOLD     |          |
|  +----------------+  +----------------+          |
|                                                  |
|  +----------------+                              |
|  |    TAVERN      |                              |
|  |                |                              |
|  |  [Icon/Image]  |                              |
|  |                |                              |
|  | Better Recruits|                              |
|  |                |                              |
|  |   300 GOLD     |                              |
|  +----------------+                              |
|                                                  |
|              [ BACK TO HUB ]                     |
+--------------------------------------------------+
```

### Components
- **Header Bar:** Title "FORT MANAGEMENT" + current gold display
- **Upgrade Cards (x3):** Each contains icon area, name, benefit description, cost
- **Back Button:** Returns to hub main navigation
- **Confirmation Dialog:** Modal with upgrade name, cost, confirm/cancel buttons

### Visual States

| State | Appearance |
|-------|------------|
| **Available** | Normal colors, gold cost visible, clickable |
| **Hover** | Brightened border, slight scale up |
| **Unaffordable** | Grayed out, cost in red, not clickable |
| **Purchased** | "PURCHASED" banner overlay, checkmark icon, not clickable |
| **Clicking** | Brief scale down, button press effect |

### Style Guidelines
- Match existing hub UI style (dark backgrounds, clean borders)
- Use gold/yellow accent for costs and purchase buttons
- Green accent for purchased/success states
- Red accent for unaffordable states

---

## Technical Implementation

### Scene Structure
```
FortManagement (Control)
â”œâ”€â”€ Background (ColorRect)
â”œâ”€â”€ Header (HBoxContainer)
â”‚   â”œâ”€â”€ TitleLabel (Label) - "FORT MANAGEMENT"
â”‚   â””â”€â”€ GoldDisplay (HBoxContainer)
â”‚       â”œâ”€â”€ GoldLabel (Label) - "GOLD:"
â”‚       â””â”€â”€ GoldAmount (Label) - Dynamic value
â”œâ”€â”€ UpgradesContainer (GridContainer or VBoxContainer)
â”‚   â”œâ”€â”€ BarracksCard (PanelContainer)
â”‚   â”‚   â””â”€â”€ VBoxContainer
â”‚   â”‚       â”œâ”€â”€ NameLabel (Label) - "BARRACKS"
â”‚   â”‚       â”œâ”€â”€ IconRect (TextureRect) - Placeholder/icon
â”‚   â”‚       â”œâ”€â”€ DescriptionLabel (Label) - "+4 Soldier Capacity"
â”‚   â”‚       â””â”€â”€ CostContainer (HBoxContainer)
â”‚   â”‚           â””â”€â”€ CostLabel (Label) - "500 GOLD"
â”‚   â”œâ”€â”€ TrainingYardCard (PanelContainer)
â”‚   â”‚   â””â”€â”€ [Same structure]
â”‚   â””â”€â”€ TavernCard (PanelContainer)
â”‚       â””â”€â”€ [Same structure]
â”œâ”€â”€ BackButton (Button) - "BACK TO HUB"
â””â”€â”€ ConfirmationDialog (ConfirmationDialog or custom Panel)
    â””â”€â”€ VBoxContainer
        â”œâ”€â”€ MessageLabel (Label)
        â”œâ”€â”€ ButtonContainer (HBoxContainer)
        â”‚   â”œâ”€â”€ ConfirmButton (Button) - "PURCHASE"
        â”‚   â””â”€â”€ CancelButton (Button) - "CANCEL"
```

### Script Responsibilities

#### fort_management.gd
- Manages screen state and upgrade display
- Connects to GameState for gold and upgrade status
- Handles purchase flow and confirmation
- Updates UI when state changes

```gdscript
class_name FortManagement
extends Control

signal upgrade_purchased(upgrade_id: String)
signal back_pressed

@onready var _gold_amount: Label = $Header/GoldDisplay/GoldAmount
@onready var _barracks_card: PanelContainer = $UpgradesContainer/BarracksCard
@onready var _training_yard_card: PanelContainer = $UpgradesContainer/TrainingYardCard
@onready var _tavern_card: PanelContainer = $UpgradesContainer/TavernCard
@onready var _confirmation_dialog: Control = $ConfirmationDialog

var _pending_upgrade: String = ""

func _ready() -> void:
    _connect_signals()
    _refresh_display()

func _refresh_display() -> void:
    _gold_amount.text = str(GameState.gold)
    _update_card(_barracks_card, "barracks", 500)
    _update_card(_training_yard_card, "training_yard", 600)
    _update_card(_tavern_card, "tavern", 300)

func _update_card(card: PanelContainer, upgrade_id: String, cost: int) -> void:
    var is_owned := GameState.has_upgrade(upgrade_id)
    var can_afford := GameState.can_afford(cost)
    # Update card visual state based on is_owned and can_afford

func _on_card_clicked(upgrade_id: String, cost: int) -> void:
    if GameState.has_upgrade(upgrade_id):
        return
    if not GameState.can_afford(cost):
        _shake_card(upgrade_id)
        return
    _pending_upgrade = upgrade_id
    _show_confirmation(upgrade_id, cost)

func _confirm_purchase() -> void:
    var cost := _get_upgrade_cost(_pending_upgrade)
    if GameState.spend_gold(cost):
        GameState.add_upgrade(_pending_upgrade)
        upgrade_purchased.emit(_pending_upgrade)
        _refresh_display()
    _hide_confirmation()
```

#### GameState Extensions (game_state.gd)
Add upgrade tracking to existing GameState autoload:

```gdscript
# Add to existing game_state.gd
var fort_upgrades: Array[String] = []

func has_upgrade(upgrade_id: String) -> bool:
    return upgrade_id in fort_upgrades

func add_upgrade(upgrade_id: String) -> void:
    if not has_upgrade(upgrade_id):
        fort_upgrades.append(upgrade_id)
        _apply_upgrade_effect(upgrade_id)

func _apply_upgrade_effect(upgrade_id: String) -> void:
    match upgrade_id:
        "barracks":
            max_party_size += 4
        "training_yard":
            xp_multiplier = 1.5
        "tavern":
            recruitment_quality_bonus = true
```

### Integration Points

| System | Integration |
|--------|-------------|
| **GameState** | Read gold, check upgrades, spend gold, add upgrades |
| **Hub** | Navigation button, SubScreenContainer display |
| **Save/Load** | Fort upgrades saved in game state |
| **Recruitment** | Tavern upgrade affects recruit quality |
| **Combat** | Training Yard affects XP rewards |
| **Party Management** | Barracks affects max party size |

### Signals
- `upgrade_purchased(upgrade_id: String)` - Emitted when player purchases an upgrade
- `back_pressed` - Emitted when player clicks back button

### Configuration
Upgrade data could be stored in a resource or constants:

```gdscript
const UPGRADES := {
    "barracks": {
        "name": "Barracks",
        "description": "+4 Soldier Capacity",
        "cost": 500,
    },
    "training_yard": {
        "name": "Training Yard",
        "description": "+50% XP Gain",
        "cost": 600,
    },
    "tavern": {
        "name": "Tavern",
        "description": "Better Quality Recruits",
        "cost": 300,
    }
}
```

---

## Acceptance Criteria

- [ ] Fort Management screen accessible from hub navigation
- [ ] All three upgrades displayed with name, description, and cost
- [ ] Current gold displayed in header
- [ ] Clicking affordable upgrade shows confirmation dialog
- [ ] Confirming purchase deducts gold from GameState
- [ ] Purchased upgrades show "PURCHASED" state and cannot be re-purchased
- [ ] Unaffordable upgrades are grayed out with cost in red
- [ ] Back button returns to hub main view
- [ ] Purchased upgrades persist (saved in GameState)
- [ ] Upgrade effects apply immediately after purchase

---

## Testing Checklist

### Functional Tests
- [ ] Screen loads without errors when accessed from hub
- [ ] All three upgrade cards render correctly
- [ ] Gold display shows correct current value
- [ ] Clicking affordable upgrade opens confirmation dialog
- [ ] Confirming purchase deducts correct gold amount
- [ ] Upgrade marked as purchased after confirmation
- [ ] Purchased cards show correct visual state
- [ ] Back button navigates to hub

### Edge Case Tests
- [ ] Cannot purchase upgrade when gold is exactly 1 less than cost
- [ ] Can purchase upgrade when gold equals exact cost
- [ ] Cannot click on already-purchased upgrades
- [ ] Cannot purchase when gold is 0
- [ ] Purchasing all upgrades shows correct final state

### Integration Tests
- [ ] GameState.gold updates correctly after purchase
- [ ] GameState.has_upgrade() returns true after purchase
- [ ] Barracks upgrade increases max_party_size
- [ ] Screen reflects gold changes from other sources (contracts)

### Polish Tests
- [ ] Hover effects work on upgrade cards
- [ ] Purchase animation plays correctly
- [ ] Denied animation plays when clicking unaffordable
- [ ] UI updates immediately after purchase (no delay)

---

## Implementation Notes

### Approach
- Follow existing hub sub-screen pattern (like ContractsScreen)
- Use PanelContainer for upgrade cards for consistent styling
- Store upgrade ownership in GameState.fort_upgrades array
- Effects applied via GameState helper methods

### Gotchas
- Ensure gold display updates when returning from other screens
- Confirmation dialog should be modal (block other input)
- Save/load must include fort_upgrades array
- Upgrade effects that modify combat/recruitment need those systems to check GameState

### Future Enhancements (Out of Scope)
- Upgrade prerequisites (unlock Training Yard after Barracks)
- Visual fort representation that changes with upgrades
- More upgrade tiers (Barracks II, etc.)
- Upgrade tooltips with detailed stat breakdowns

---

## Files

**New Files:**
- `scenes/hub/FortManagement.tscn` - Fort management screen scene
- `scripts/hub/fort_management.gd` - Screen controller script

**Modified Files:**
- `scripts/core/game_state.gd` - Add fort_upgrades tracking
- `scenes/hub/Hub.tscn` - Add Fort button to navigation
- `scripts/hub/hub.gd` - Add Fort screen navigation handler
