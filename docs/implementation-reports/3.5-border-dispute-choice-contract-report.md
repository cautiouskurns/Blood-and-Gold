# Feature Implementation Report

**Feature:** The Border Dispute - Choice Contract
**Spec File:** docs/features/3.5-border-dispute-choice-contract.md
**Implemented:** 2026-01-14
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts created: 5
- Scenes created: 3
- Data files modified: 1
- Files modified: 2
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: Meaningful choices with lasting consequences
- Reinforces player fantasy: Mercenary captain making hard decisions
- Within scope boundaries: Choice contract with loyalty system integration

---

## What Was Done

### Overview

The Border Dispute is the prototype's first **choice contract**, introducing players to moral decision-making with tangible gameplay consequences. Unlike combat-only contracts, this contract presents a scenario where Commander Harwick of the Ironmark border patrol asks the player's mercenary company to "remove" refugees trying to cross the border.

The contract features a full dialogue sequence introducing the scenario, companion opinions that preview their reactions, and three distinct choices:
- **Option A:** Comply with the contract (600 gold, combat with refugee defenders, Matthias loyalty -20)
- **Option B:** Refuse the contract (300 gold, no combat, Matthias loyalty +10)
- **Option C:** Negotiate a peaceful solution (CHA DC 15 skill check, 500 gold on success, all companions +5)

This implementation also introduces two new global systems: **LoyaltyManager** (stub for Task 3.9) and **SkillCheckManager** for D20-style attribute checks.

### Technical Changes

1. **New Autoloads:** Added LoyaltyManager and SkillCheckManager as global singletons
2. **Choice Tracking:** Extended GameState with `contract_choices` dictionary and related methods
3. **UI Components:** Created ChoicePanel for displaying branching options and LoyaltyPopup for showing loyalty changes
4. **State Machine:** BorderDispute uses a state machine pattern (DIALOGUE → CHOICE → CHA_CHECK → COMBAT → RESULTS → COMPLETE)

---

## Files Created

### Scripts

#### 1. scripts/autoload/loyalty_manager.gd
**Purpose:** Manages companion loyalty values and provides reaction quotes
**Key Methods:**
- `modify_loyalty(companion_id, delta)` - Changes loyalty and emits signal
- `get_loyalty(companion_id)` - Returns current loyalty value (0-100)
- `get_loyalty_status(companion_id)` - Returns text status (Hostile/Suspicious/Neutral/Friendly/Devoted)
- `get_loyalty_color(companion_id)` - Returns color for UI display
- `get_reaction_quote(companion_id, delta)` - Returns contextual companion quote

**Signals:**
- `loyalty_changed(companion_id: String, new_value: int, delta: int)` - Emitted on any loyalty change

**Integration:**
- Registered as autoload in project.godot
- Used by BorderDispute contract and LoyaltyPopup

---

#### 2. scripts/autoload/skill_check_manager.gd
**Purpose:** Performs D20-style skill checks with stat bonuses
**Key Methods:**
- `perform_check(stat, dc)` - Rolls d20 + bonus vs DC, returns result dictionary
- `set_stat_bonus(stat, bonus)` - Sets bonus for a stat
- `get_stat_bonus(stat)` - Returns current bonus for a stat

**Signals:**
- `check_completed(stat, dc, roll, total, success)` - Emitted after each check

**Check Result Dictionary:**
```gdscript
{
    "roll": int,           # Raw d20 roll (1-20)
    "bonus": int,          # Stat bonus applied
    "total": int,          # roll + bonus
    "dc": int,             # Difficulty class
    "success": bool,       # total >= dc (or nat 20)
    "critical_success": bool,  # Rolled 20
    "critical_failure": bool,  # Rolled 1
}
```

---

#### 3. scripts/ui/choice_panel.gd
**Purpose:** Displays branching choice options for choice contracts
**Key Methods:**
- `show_choices(header, subheader, choices, opinions)` - Display the panel with options
- `hide_choices()` - Hide the panel with fade animation
- `show_reduced_choices(excluded_choice)` - Hide one option (after failed skill check)

**Signals:**
- `choice_selected(choice_id: String)` - Emitted when player clicks an option
- `choice_hovered(choice_id: String)` - Emitted on mouse enter
- `choice_unhovered(choice_id: String)` - Emitted on mouse exit

**Visual Design:**
- Option A: Red tint (#c0392b) - Combat/aggressive
- Option B: Blue tint (#2980b9) - Peaceful
- Option C: Gold tint (#f39c12) - Diplomatic

---

#### 4. scripts/ui/loyalty_popup.gd
**Purpose:** Shows animated notifications when loyalty changes
**Key Methods:**
- `show_loyalty_change(companion_id, delta, quote)` - Queue a single notification
- `show_multiple_changes(changes)` - Queue multiple notifications in sequence

**Signals:**
- `popup_closed()` - Emitted when all queued popups have been shown

**Animation:**
- Fade in over 0.3 seconds
- Delta number rises from below
- Auto-closes after 2.5 seconds
- Queues multiple changes and shows sequentially

---

#### 5. scripts/contracts/border_dispute.gd
**Purpose:** Main contract controller implementing the choice flow
**State Machine:**
```
DIALOGUE → CHOICE → (CHA_CHECK) → COMBAT/RESULTS → COMPLETE
                ↘ CHA_FAILED_CHOICE → COMBAT/RESULTS → COMPLETE
```

**Key Methods:**
- `_show_current_dialogue()` - Displays dialogue sequence
- `_transition_to_choice()` - Shows choice panel after dialogue
- `_on_choice_selected(choice_id)` - Handles player choice
- `_execute_option_a/b/c()` - Implements each choice branch
- `_apply_loyalty_changes(choice_id)` - Applies loyalty changes and shows popup

**Combat Setup (Option A):**
- Party: Player, Thorne, Lyra, Matthias + 2 Soldiers
- Enemies: 2 Refugee Defenders (melee) + 2 Refugee Guards (ranged)
- Map: 12x12 border checkpoint

---

### Scenes

#### 1. scenes/ui/ChoicePanel.tscn
**Root Node:** CanvasLayer (layer 60)
**Structure:**
```
ChoicePanel (CanvasLayer)
├── DimBackground (ColorRect) - 70% opacity black
└── Panel (PanelContainer) - 900x500 centered
    └── MarginContainer
        └── VBoxContainer
            ├── HeaderLabel - "THE BORDER DISPUTE"
            ├── SubheaderLabel - "What will you do about the refugees?"
            ├── HSeparator
            ├── ChoicesContainer (HBoxContainer)
            │   ├── OptionA (Button) - 200x150
            │   ├── OptionB (Button) - 200x150
            │   └── OptionC (Button) - 200x150
            ├── HSeparator2
            └── CompanionOpinions (VBoxContainer)
                ├── ThorneOpinion (Label)
                └── MatthiasOpinion (Label)
```

---

#### 2. scenes/ui/LoyaltyPopup.tscn
**Root Node:** CanvasLayer (layer 100)
**Structure:**
```
LoyaltyPopup (CanvasLayer)
└── Panel (PanelContainer) - Top-right corner
    └── MarginContainer
        └── HBoxContainer
            ├── Portrait (TextureRect) - 80x80
            └── InfoContainer (VBoxContainer)
                ├── NameLabel - Companion name
                ├── StatusLabel - "Neutral (50)"
                ├── DeltaLabel - "+10 LOYALTY"
                └── QuoteLabel - Reaction quote
```

---

#### 3. scenes/contracts/BorderDispute.tscn
**Root Node:** Node2D
**Structure:**
```
BorderDispute (Node2D)
├── CombatGrid (instanced scene)
└── DialogueLayer (CanvasLayer, layer 50)
    ├── DimBackground (ColorRect)
    └── DialoguePanel (PanelContainer)
        └── MarginContainer
            └── VBoxContainer
                ├── SpeakerLabel
                ├── DialogueText (RichTextLabel)
                └── ContinueButton
```

---

### Data Files Modified

#### resources/contracts/border_dispute.tres
**Changes:**
- Updated story from noble houses dispute to refugee scenario
- Set `contract_type = 2` (CHOICE)
- Set `gold_reward = 300` (minimum), `gold_reward_max = 600` (maximum)
- Set `has_pre_combat_dialogue = true`
- Set `triggers_camp_scene = true`
- Set `camp_scene_id = "difficult_decisions"`

---

## Files Modified

### 1. project.godot
**Changes:**
- Added autoload: `LoyaltyManager` → `res://scripts/autoload/loyalty_manager.gd`
- Added autoload: `SkillCheckManager` → `res://scripts/autoload/skill_check_manager.gd`

### 2. scripts/autoload/game_state.gd
**Changes:**
- Added signal: `choice_made(contract_id: String, choice_id: String)`
- Added variable: `contract_choices: Dictionary`
- Added methods: `record_choice()`, `get_choice()`, `has_made_choice()`, `get_all_choices()`
- Updated `get_save_data()` to include contract_choices
- Updated `load_save_data()` to restore contract_choices
- Updated `reset_to_new_game()` to clear contract_choices

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- All contracts were combat-only with fixed rewards
- No moral decisions or branching outcomes
- No companion reactions to player choices
- No skill checks outside combat

**After Implementation:**
- Players face a moral dilemma with real consequences
- Three distinct paths through the contract with different rewards
- Companion loyalty changes based on choices
- CHA skill check provides alternative peaceful resolution
- Choices are tracked and persisted for future narrative callbacks

### New Mechanics Introduced

1. **Choice Contracts:** Contracts can now have branching narrative paths with different outcomes
2. **Loyalty System (Stub):** Companions track loyalty 0-100, react to choices with quotes
3. **Skill Checks:** D20 + bonus vs DC system for non-combat challenges
4. **Choice Tracking:** Player decisions are recorded for narrative continuity

### Systems Affected

- **GameState:** Now tracks contract choices with full save/load support
- **Contract System:** ContractType.CHOICE now has full implementation
- **Combat System:** Can be triggered conditionally based on player choice

---

## What the Player Should Now See

### Visible Differences

#### During Gameplay

1. **Dialogue Sequence:**
   - Screen dims, dialogue panel appears at bottom
   - Commander Harwick introduces the refugee situation
   - Companion reactions show during dialogue
   - Click or press Space to advance

2. **Choice Panel:**
   - Three large buttons appear after dialogue
   - Each shows: label, gold reward, combat status, skill check requirement
   - Companion opinions shown at bottom
   - Color coding: Red (combat), Blue (peaceful), Gold (diplomatic)

3. **CHA Check (Option C):**
   - Brief pause for dramatic effect
   - Success: Contract completes peacefully with 500 gold
   - Failure: Shows reduced options (only A and B)

4. **Loyalty Popup:**
   - Slides in from top-right
   - Shows companion name, current status
   - Animated "+10 LOYALTY" or "-20 LOYALTY"
   - Companion quote reaction
   - Multiple changes shown in sequence

### Step-by-Step: What the Player Experiences

**Scenario: Playing the Border Dispute Contract**

1. Player accepts "The Border Dispute" from Contract Board
2. BorderDispute scene loads
3. Dialogue begins with Commander Harwick explaining the situation
4. Player clicks through 7 dialogue lines
5. Choice panel appears with three options
6. Player selects Option C (Negotiate)
7. CHA check rolls (d20 + 2 vs DC 15)
8. If success: Loyalty popup shows all companions +5, then victory screen
9. If failure: Choice panel returns with only A and B options
10. Player selects remaining option, consequences follow

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. Press F5 to run the game
3. Navigate to Contract Board
4. Accept "The Border Dispute" contract
5. Click through dialogue (7 lines)
6. **Success if:** Choice panel appears with 3 options showing companion opinions

### Comprehensive Testing Checklist

#### Core Functionality
- [ ] **Test 1:** Dialogue advances correctly
  - **Steps:** Click through all dialogue lines
  - **Expected:** 7 lines show sequentially, choice panel appears after

- [ ] **Test 2:** Option A triggers combat
  - **Steps:** Select "We'll handle it."
  - **Expected:** Combat starts with refugees, 600 gold on victory

- [ ] **Test 3:** Option B skips combat
  - **Steps:** Select "We're mercenaries, not butchers."
  - **Expected:** No combat, 300 gold, loyalty popups show

- [ ] **Test 4:** Option C performs CHA check
  - **Steps:** Select "Perhaps there's another way..."
  - **Expected:** Check result determines outcome

#### Acceptance Criteria Verification

- [ ] **Pre-combat dialogue scene plays** with Commander Harwick
- [ ] **Choice panel displays** with 3 branching options
- [ ] **Companion opinions visible** during choice (Thorne, Matthias)
- [ ] **CHA check (DC 15)** occurs for Option C
- [ ] **Reduced options** shown on CHA failure (only A/B)
- [ ] **Loyalty changes applied** and shown via popup
- [ ] **Different gold rewards** per choice (600/300/500)
- [ ] **Choice recorded** in GameState.contract_choices

#### Edge Case Tests

- [ ] **CHA natural 20:** Should always succeed
- [ ] **CHA natural 1:** Should always fail (unless bonus makes it impossible)
- [ ] **Combat loss:** Should show defeat screen, allow retry

#### Integration Tests

- [ ] **With GameState:** Choice persists after scene reload
- [ ] **With Combat System:** Option A combat works correctly
- [ ] **With Hub:** Returns to hub after completion

---

## Troubleshooting

### Issue: Choice panel doesn't appear
**Symptom:** Dialogue ends but no choices shown
**Cause:** ChoicePanel scene not preloaded correctly
**Fix:** Check that `res://scenes/ui/ChoicePanel.tscn` exists and has correct UID

### Issue: LoyaltyManager not found
**Symptom:** Error: "LoyaltyManager is not declared"
**Cause:** Autoload not registered in project.godot
**Fix:** Verify project.godot has LoyaltyManager in [autoload] section

### Issue: Skill check always fails/succeeds
**Symptom:** CHA check doesn't seem random
**Cause:** Check debug output for actual roll values
**Fix:** Verify SkillCheckManager.perform_check() is being called

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest testing all three paths
2. [ ] Verify loyalty values persist across scene changes
3. [ ] Test save/load with contract_choices
4. [ ] Implement Task 3.9 (Full Loyalty System) to expand stub
5. [ ] Add camp scene for "difficult_decisions" (future task)
6. [ ] Consider adding more skill check opportunities

---

## Rollback Instructions

If implementation has issues:

```bash
# See what changed
git status

# Review changes
git diff

# Revert specific file
git checkout -- scripts/autoload/loyalty_manager.gd

# Revert all changes
git reset --hard HEAD
```

All original code preserved in git history.
