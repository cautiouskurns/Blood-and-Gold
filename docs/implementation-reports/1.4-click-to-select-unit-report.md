# Feature Implementation Report

**Feature:** Click-to-Select Unit
**Feature ID:** 1.4
**Spec File:** docs/features/1.4-click-to-select-unit.md
**Implemented:** 2026-01-12
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts created: 1
- Scenes modified: 1
- Files modified: 3
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: **Tactical Combat** - Selection is the first step in issuing tactical commands
- Supports design pillar: **Build & Command** - Selecting party members enables direct control
- Reinforces player fantasy: Commanding a mercenary company in tactical combat

---

## What Was Done

### Overview

The Click-to-Select Unit system has been implemented as the foundational interaction for tactical combat. This feature allows players to click on friendly units to select them, displaying a visible yellow outline indicator. Only one unit can be selected at a time, and clicking elsewhere (empty tiles, enemies, or outside the grid) deselects the current unit.

A new CombatManager autoload has been created to track the currently selected unit globally, providing signals for other systems (movement, abilities, UI) to react to selection changes. This establishes the pattern for all future combat interactions.

Each unit now has an Area2D with CircleShape2D collision for click detection. When clicked, friendly units request selection through CombatManager, which handles the selection state machine and emits appropriate signals.

### Technical Changes

- **New CombatManager autoload**: Global state manager for combat (starting with selection)
- **Area2D click detection**: Each unit has collision-based click detection
- **Programmatic selection indicator**: Yellow outline generated at runtime (consistent with existing visual approach)
- **Signal-based architecture**: Loose coupling via `unit_selected`, `unit_deselected`, `selection_changed` signals
- **Grid click handling**: Clicking empty tiles deselects current unit

---

## Files Created

### Scripts

#### 1. scripts/autoload/combat_manager.gd
**Purpose:** Global combat state management autoload

**Key Methods:**
- `select_unit(unit: Unit)` - Select a unit, deselecting any previously selected
- `deselect_unit()` - Clear the current selection
- `get_selected_unit() -> Unit` - Get the currently selected unit (or null)
- `has_selection() -> bool` - Check if any unit is selected
- `is_unit_selected(unit: Unit) -> bool` - Check if specific unit is selected

**Signals:**
- `unit_selected(unit: Unit)` - Emitted when a unit is selected
- `unit_deselected(unit: Unit)` - Emitted when a unit is deselected
- `selection_changed(old_unit: Unit, new_unit: Unit)` - Emitted on any selection change

**Integration:**
- Registered as autoload in project.godot
- Called by Unit.gd when units are clicked
- Called by Main.gd for grid click deselection

---

## Files Modified

### 1. project.godot
**Changes:**
- Added `[autoload]` section
- Registered `CombatManager` autoload at `res://scripts/autoload/combat_manager.gd`

### 2. scripts/combat/unit.gd
**Changes:**
- Added selection constants: `COLOR_SELECTION`, `SELECTION_OUTLINE_WIDTH`, `CLICK_RADIUS`
- Added node references: `selection_indicator`, `click_area`
- Added internal state: `is_selected`
- Added lifecycle calls: `_setup_selection_indicator()`, `_setup_click_detection()`
- Added selection management section with functions:
  - `_setup_selection_indicator()` - Creates yellow outline texture
  - `_setup_click_detection()` - Connects Area2D input events
  - `_on_click_area_input_event()` - Handles click events
  - `_handle_click()` - Processes click logic
  - `select()` - Shows selection indicator
  - `deselect()` - Hides selection indicator

### 3. scenes/combat/Unit.tscn
**Changes:**
- Added `SelectionIndicator` (Sprite2D) with z_index 0 for outline
- Added `ClickArea` (Area2D) with `input_pickable = true`
- Added `CollisionShape2D` child with CircleShape2D (radius: 28px)
- Added sub_resource for CircleShape2D

**New Structure:**
```
Unit (Node2D) [z_index: 10]
├── SelectionIndicator (Sprite2D) [z_index: 0, hidden by default]
├── Sprite2D (Sprite2D) [z_index: 1]
├── LetterLabel (Label) [z_index: 2]
├── HPBar (ProgressBar) [z_index: 3]
└── ClickArea (Area2D) [input_pickable: true]
    └── CollisionShape2D (CircleShape2D, radius: 28)
```

### 4. scripts/main/main.gd
**Changes:**
- Added grid click handling in `_unhandled_input()`
- Added `_handle_grid_click()` function for deselection logic
- Clicks on empty tiles or outside grid now call `CombatManager.deselect_unit()`

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- Units were visible on the grid but couldn't be interacted with
- No way to indicate which unit should receive commands
- No selection state existed

**After Implementation:**
- Players can click on any friendly unit to select it
- Selected unit shows a yellow outline indicator
- Clicking different friendly unit switches selection
- Clicking elsewhere clears selection
- Foundation ready for movement commands (Task 1.5)

### New Mechanics Introduced

1. **Unit Selection:** Click any friendly unit to select it for commands
2. **Selection Indicator:** Yellow (#f1c40f) 3px outline around selected unit
3. **Deselection:** Click empty tile, enemy, or outside grid to deselect
4. **Single Selection:** Only one unit can be selected at a time

### Systems Affected

- **Unit System:** Units now have click detection and selection state
- **Main Scene:** Handles grid clicks for deselection
- **New Autoload:** CombatManager provides global selection tracking

---

## What the Player Should Now See

### Visible Differences

#### During Gameplay

1. **Clicking on a friendly unit (Player, Thorne, Lyra, Matthias):**
   - Yellow outline appears around the clicked unit
   - Console shows: `[CombatManager] Selected: [unit_name]`

2. **Clicking a different friendly unit:**
   - Previous unit's yellow outline disappears
   - New unit's yellow outline appears
   - Console shows selection change

3. **Clicking on empty tile:**
   - Current unit's yellow outline disappears
   - Console shows: `[CombatManager] Deselected`

4. **Clicking on enemy unit:**
   - Current selection is cleared (enemies cannot be selected)
   - Console shows deselection

5. **Clicking outside the grid:**
   - Current selection is cleared

### Step-by-Step: What the Player Experiences

**Scenario: Selecting a Unit**
1. Player sees 4 party units on left side of grid (no selection indicators)
2. Player clicks on the blue "P" (Player) unit
3. Yellow outline immediately appears around Player
4. Player knows this unit is now selected for commands

**Scenario: Switching Selection**
1. Player has Player unit selected (yellow outline visible)
2. Player clicks on purple "L" (Lyra) unit
3. Player's yellow outline disappears
4. Lyra's yellow outline appears
5. Only Lyra is now selected

**Scenario: Deselecting**
1. Player has Thorne selected
2. Player clicks on an empty grass tile
3. Thorne's yellow outline disappears
4. No unit is now selected

### What the Developer Should See

#### In Godot Editor

1. **FileSystem Panel:**
   - `scripts/autoload/combat_manager.gd` - New CombatManager autoload
   - `scenes/combat/Unit.tscn` - Updated with SelectionIndicator and ClickArea

2. **Project Settings > Autoload:**
   - `CombatManager` listed pointing to `res://scripts/autoload/combat_manager.gd`

3. **Unit.tscn Scene Inspector:**
   - SelectionIndicator (Sprite2D)
   - Sprite2D
   - LetterLabel (Label)
   - HPBar (ProgressBar)
   - ClickArea (Area2D) with CollisionShape2D child

#### Console Output (Debug)

Expected debug output when game starts:
```
[CombatManager] Initialized
[Main] Spawning test units...
[Main] Spawned Player (Player) at grid position (1, 5)
[Main] Spawned Thorne (Thorne) at grid position (1, 3)
[Main] Spawned Lyra (Lyra) at grid position (1, 7)
[Main] Spawned Matthias (Matthias) at grid position (2, 5)
[Main] Spawned Bandit 1 (Enemy) at grid position (10, 4)
[Main] Spawned Bandit 2 (Enemy) at grid position (10, 6)
[Main] Spawned Bandit 3 (Enemy) at grid position (9, 5)
[Main] Test units spawned: 7 total
[Main] Debug controls enabled: D = damage, H = heal (hover over unit)
```

When clicking units:
```
[CombatManager] Selected: Player
[CombatManager] Selected: Thorne
[CombatManager] Deselected
```

---

## How to Test

### Quick Smoke Test (1 minute)

1. Open Godot Editor
2. Press F5 to run the game
3. Click on the blue "P" (Player) unit
4. **Success if:** Yellow outline appears around Player
5. Click on empty grass tile
6. **Success if:** Yellow outline disappears
7. **Failure if:** No outline appears, or clicking doesn't respond

### Comprehensive Testing Checklist

#### Core Functionality

- [ ] **Test 1:** Click on Player unit - selection indicator appears
  - **Steps:** Run game, click on blue "P" unit
  - **Expected:** Yellow outline appears, console shows "Selected: Player"

- [ ] **Test 2:** Click on Thorne unit - Player deselects, Thorne selects
  - **Steps:** With Player selected, click on dark blue "T" unit
  - **Expected:** Player outline disappears, Thorne outline appears

- [ ] **Test 3:** Click on empty grid tile - current unit deselects
  - **Steps:** With any unit selected, click on empty grass tile
  - **Expected:** Outline disappears, console shows "Deselected"

- [ ] **Test 4:** Click on enemy unit - current unit deselects
  - **Steps:** With friendly unit selected, click on red "E" unit
  - **Expected:** Selection clears, enemy does NOT get selected

- [ ] **Test 5:** Click outside grid - current unit deselects
  - **Steps:** With unit selected, click on dark background outside grid
  - **Expected:** Selection clears

- [ ] **Test 6:** `CombatManager.selected_unit` matches visual state
  - **Steps:** Use Remote debugger to check CombatManager.selected_unit
  - **Expected:** Variable matches which unit has visible indicator

- [ ] **Test 7:** `CombatManager.has_selection()` returns correct boolean
  - **Steps:** Check after selecting and deselecting
  - **Expected:** Returns true when selected, false when not

#### Visual Tests

- [ ] Selection indicator is yellow (#f1c40f)
- [ ] Selection indicator is 3px outline around unit
- [ ] Indicator visible against dark background
- [ ] Indicator visible when unit on green tile
- [ ] Indicator z-order correct (below HP bar, around sprite)

#### Integration Tests

- [ ] CombatManager autoload loads correctly (check Project Settings)
- [ ] `unit_selected` signal emits on selection
- [ ] `unit_deselected` signal emits on deselection
- [ ] `selection_changed` signal emits with correct parameters

#### Edge Cases

- [ ] Click dead unit (use D key to kill) - no selection
- [ ] Click same unit twice - stays selected (no toggle off)
- [ ] Rapid clicking between units - correct unit selected
- [ ] Click on obstacle tile - deselects (no unit there)

#### Acceptance Criteria Verification

- [ ] **Criterion 1:** Clicking friendly unit shows selection indicator
- [ ] **Criterion 2:** Only one unit selected at any time
- [ ] **Criterion 3:** Clicking elsewhere deselects current unit
- [ ] **Criterion 4:** Clicking enemy deselects (doesn't select enemy)
- [ ] **Criterion 5:** Selection indicator is clearly visible
- [ ] **Criterion 6:** CombatManager tracks selection correctly
- [ ] **Criterion 7:** Cannot select dead units
- [ ] **Criterion 8:** Selection persists until changed
- [ ] **Criterion 9:** Clicking selected unit keeps it selected
- [ ] **Criterion 10:** Click detection area appropriate (28px radius)

---

## Manual Steps Required

**None** - All implementation is automated and ready to run.

---

## Troubleshooting

### Issue: Clicking unit doesn't select it
**Symptom:** No yellow outline appears when clicking unit
**Possible causes:**
1. ClickArea not receiving input (check `input_pickable`)
2. CollisionShape2D missing or wrong size
3. Signal not connected
**Fix:**
1. Check Unit.tscn has ClickArea with `input_pickable = true`
2. Verify CollisionShape2D has CircleShape2D with radius 28
3. Check console for errors

### Issue: CombatManager not found
**Symptom:** Error: "Identifier 'CombatManager' not declared"
**Cause:** Autoload not registered in project.godot
**Fix:**
1. Open Project Settings > Autoload
2. Add: Name=CombatManager, Path=res://scripts/autoload/combat_manager.gd

### Issue: Selection indicator not visible
**Symptom:** Unit selects (console shows) but no outline
**Cause:** SelectionIndicator node missing or wrong z_index
**Fix:**
1. Check Unit.tscn has SelectionIndicator node
2. Verify z_index is 0 (below sprite at z_index 1)

### Issue: Cannot deselect by clicking empty tile
**Symptom:** Selection persists when clicking empty tiles
**Cause:** main.gd not handling grid clicks
**Fix:**
1. Verify _unhandled_input checks for mouse button
2. Check _handle_grid_click() function exists

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest - select all 4 party members
2. [ ] Test deselection in all scenarios
3. [ ] Implement Task 1.5: Click-to-Move with Path Preview
4. [ ] Update changelog
5. [ ] Commit changes

---

## Rollback Instructions

If implementation has issues:

```bash
# See what changed
git status

# Review changes
git diff

# Revert specific files
git checkout -- scripts/autoload/combat_manager.gd
git checkout -- scripts/combat/unit.gd
git checkout -- scenes/combat/Unit.tscn
git checkout -- scripts/main/main.gd
git checkout -- project.godot
```

---

## Signal Reference

| Signal | Emitter | Parameters | When Emitted |
|--------|---------|------------|--------------|
| `unit_clicked` | Unit | `(unit: Unit)` | When unit is clicked |
| `unit_selected` | CombatManager | `(unit: Unit)` | When a unit becomes selected |
| `unit_deselected` | CombatManager | `(unit: Unit)` | When a unit is deselected |
| `selection_changed` | CombatManager | `(old: Unit, new: Unit)` | On any selection state change |

---

## API Reference

### CombatManager (Autoload)

```gdscript
# Properties
var selected_unit: Unit  # Currently selected unit (or null)

# Methods
func select_unit(unit: Unit) -> void      # Select a unit
func deselect_unit() -> void              # Clear selection
func get_selected_unit() -> Unit          # Get selected unit
func has_selection() -> bool              # Check if any selected
func is_unit_selected(unit: Unit) -> bool # Check specific unit
```

### Unit (Selection Methods)

```gdscript
# Properties
var is_selected: bool  # Selection state

# Methods
func select() -> void    # Mark as selected, show indicator
func deselect() -> void  # Mark as not selected, hide indicator
```
