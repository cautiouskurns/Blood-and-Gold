# Feature Implementation Report

**Feature:** Task 2.7: Ranged Attack System
**Spec File:** docs/features/2.7-ranged-attack-system.md
**Implemented:** 2026-01-12
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts modified: 5
- Ability resources created: 1
- Files modified: 6 total
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: Tactical positioning and meaningful combat choices
- Reinforces player fantasy: Ranged characters can attack from distance
- Within scope boundaries: Grid-based ranged combat with LoS

---

## What Was Done

### Overview

Implemented a complete ranged attack system that enables units with bows or crossbows to attack enemies at a distance. The system uses Bresenham's line algorithm for line-of-sight calculations, ensuring ranged attacks can't pass through walls or obstacles.

Key features implemented:
- **Weapon Range Property**: Units now have `weapon_range` and `is_ranged_weapon` properties
- **Line of Sight**: Bresenham algorithm calculates whether obstacles block ranged attacks
- **Range Indicator**: Blue overlay shows valid attack tiles when ranged targeting is active
- **Ranged Attack Ability**: New "Shoot" ability for Lyra and Archers uses ranged targeting

### Technical Changes

1. Added ranged weapon properties to Unit class
2. Implemented Bresenham LoS algorithm in AttackResolver
3. Added range indicator overlay system to CombatGrid
4. Added LoS helper methods to CombatManager
5. Updated ability targeting to show attack range for ranged units
6. Created ranged_attack ability resource for bow/crossbow users

---

## Files Modified

### scripts/combat/unit.gd

**Changes:**
- Added `@export var weapon_range: int = 1` - Weapon attack range in tiles
- Added `@export var is_ranged_weapon: bool = false` - Flag for ranged weapons
- Updated Lyra's stats: `weapon_range = 8`, `is_ranged_weapon = true`, `weapon_damage_die = 6`
- Updated Archer's stats: `weapon_range = 8`, `is_ranged_weapon = true`
- Updated Lyra's abilities to use `ranged_attack` instead of `basic_attack`
- Added ARCHER case to `_init_abilities()` to use `ranged_attack`
- Updated `can_attack()` to use `AttackResolver.can_attack_at_range()`

### scripts/combat/attack_resolver.gd

**Changes:**
Added new static methods for ranged attack support:
- `get_distance(from, to)` - Chebyshev distance calculation
- `can_attack_at_range(attacker, target)` - Check if attack is valid (range + LoS)
- `has_line_of_sight(from, to)` - Bresenham LoS check
- `get_line_points(from, to)` - Bresenham line algorithm implementation
- `get_valid_targets_in_range(attacker, enemies)` - Filter enemies by range and LoS

### scripts/combat/combat_grid.gd

**Changes:**
- Added `COLOR_ATTACK_RANGE` constant (#4a90d9 at 30% opacity)
- Added `COLOR_ATTACK_RANGE_BLOCKED` constant (#888888 at 20% opacity)
- Added `_attack_range_overlay: Node2D` for attack range visualization
- Added `_attack_range_tiles: Array[Vector2i]` to track valid tiles
- Added `_setup_attack_range_overlay()` - Initialize overlay node
- Added `show_attack_range(unit)` - Display attack range with LoS check
- Added `hide_attack_range()` - Clear attack range overlay
- Added `clear_attack_range_overlay()` - Remove all attack range highlights
- Added `is_in_attack_range(coords)` - Check if tile is in valid attack range
- Added `get_attack_range_tiles()` - Get current valid attack tiles

### scripts/autoload/combat_manager.gd

**Changes:**
- Added `_combat_grid: CombatGrid` reference variable
- Added `set_combat_grid(grid)` - Set grid reference for LoS checks
- Added `get_combat_grid()` - Get grid reference with fallbacks
- Added `is_tile_blocked_for_los(position)` - Check if tile blocks line of sight
- Added `get_enemies_in_range_with_los(unit, range)` - Get enemies with LoS check
- Updated `_get_valid_targets_for_ability()` to use LoS check for ENEMY_RANGE

### scripts/UI/ability_bar.gd

**Changes:**
- Updated `_on_targeting_started()` to show attack range overlay for ranged units
- Updated `_on_targeting_cancelled()` to hide attack range overlay
- Updated `_on_ability_executed()` to hide attack range overlay
- Added `_hide_attack_range_overlay()` helper method

### scripts/main/main.gd

**Changes:**
- Added `CombatManager.set_combat_grid(combat_grid)` call in `_start_battle()`

---

## Files Created

### resources/abilities/ranged_attack.tres

**Purpose:** Basic ranged attack ability for bow/crossbow users

**Properties:**
- `id = "ranged_attack"`
- `display_name = "Shoot"`
- `description = "A ranged attack using bow or crossbow. Range depends on weapon."`
- `ability_type = 1` (RANGED_ATTACK)
- `target_type = 2` (ENEMY_RANGE)
- `ability_range = 8` (shortbow range)
- `auto_hit = false` (uses standard attack roll)

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- All attacks required units to be adjacent (1 tile away)
- Lyra and Archers were effectively melee units despite having bows
- No tactical advantage to positioning ranged units behind frontline

**After Implementation:**
- Lyra can attack enemies up to 8 tiles away with her shortbow
- Archers can shoot enemies from 8 tiles away
- Line of sight matters - can't shoot through walls/obstacles
- Ranged units can stay behind tanks and still contribute damage

### New Mechanics Introduced

1. **Weapon Range**: Each unit's weapon has a maximum attack range
2. **Line of Sight**: Bresenham algorithm determines if path is clear
3. **Attack Range Indicator**: Blue overlay shows valid attack tiles

### Systems Affected

- **AttackResolver**: Extended with range and LoS calculations
- **CombatGrid**: Added attack range visualization
- **CombatManager**: Added LoS helper methods
- **Ability targeting**: Shows range overlay for ranged units

---

## What the Player Should Now See

### Visible Differences

#### During Gameplay

- **Lyra's first ability** is now "Shoot" instead of "Attack"
- **When clicking Shoot with Lyra selected**: Blue overlay appears showing 8-tile range
- **Tiles with blocked LoS**: Appear grayed out or excluded
- **Valid enemy targets**: Highlighted red within the blue range
- **Attack execution**: Same d20 + DEX vs Defense roll as before, but at range

#### In Ability Bar

- Lyra shows: "Shoot", "Backstab", "Shadowstep", "Poison Blade"
- Archers show: "Shoot" (only ability)

### Step-by-Step: What the Player Experiences

**Scenario: Lyra attacks from range**
1. Player selects Lyra during her turn
2. Player clicks "Shoot" ability button
3. Blue overlay appears showing 8-tile attack range
4. Some tiles may be grayed if walls block LoS
5. Enemies within valid range show red highlight
6. Player clicks on a highlighted enemy
7. Attack resolves: d20 + DEX + skill vs enemy Defense
8. Damage number appears (or "Miss" on failure)
9. Lyra's turn ends

**Scenario: LoS blocked by obstacle**
1. Player selects Lyra
2. Player clicks "Shoot"
3. Blue range appears, but tiles behind the center obstacle cluster are grayed
4. Enemy behind wall has no red highlight - cannot be targeted
5. Player must position to get clear LoS, or attack different target

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor and press F5 to run
2. Wait for battle to start
3. Progress turns until it's Lyra's turn
4. Click the "Shoot" ability button
5. **Success if**: Blue range overlay appears around Lyra showing ~8 tile range
6. Click on a highlighted enemy
7. **Success if**: Attack resolves, damage number appears, Lyra's turn ends

### Comprehensive Testing Checklist

#### Core Functionality

- [ ] **Range check**: Lyra can attack enemies 8 tiles away
- [ ] **Range limit**: Lyra cannot attack enemies 9+ tiles away
- [ ] **LoS clear**: Attack succeeds when path is clear
- [ ] **LoS blocked**: Cannot target enemies behind obstacles
- [ ] **Attack roll**: d20 + DEX + skill vs Defense
- [ ] **Damage**: 1d6 + DEX modifier dealt on hit
- [ ] **Miss display**: "Miss" floating text on failed roll

#### Edge Case Tests

- [ ] **Target at max range**: Attack works at exactly 8 tiles
- [ ] **Adjacent target**: Ranged attack works at 1 tile (no LoS issue)
- [ ] **Diagonal LoS**: Wall on diagonal correctly blocks
- [ ] **Multiple enemies**: Can target any valid enemy in range

#### Integration Tests

- [ ] **Works with ability system**: Shoot ability triggers ranged flow
- [ ] **Works with turn system**: Turn ends after ranged attack
- [ ] **Works with damage numbers**: Floating damage appears
- [ ] **Backstab still works**: Lyra's melee backstab unaffected

---

## Troubleshooting

### Issue: No attack range appears
**Symptom:** Clicking "Shoot" doesn't show blue overlay
**Cause:** combat_grid reference not set on CombatManager
**Fix:** Ensure `CombatManager.set_combat_grid(combat_grid)` is called in main.gd `_start_battle()`

### Issue: All tiles in range appear blocked (gray)
**Symptom:** Range overlay is all gray, no valid targets
**Cause:** LoS check is returning blocked for all tiles
**Fix:** Check that `is_tile_blocked_for_los()` only returns true for actual obstacles

### Issue: Attack doesn't resolve
**Symptom:** Clicking valid target does nothing
**Cause:** Target not in `_valid_targets` array
**Fix:** Ensure `get_enemies_in_range_with_los()` is being called for ranged units

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest with Lyra using ranged attacks
2. [ ] Test obstacle LoS blocking in various positions
3. [ ] Consider adding crossbow (range 10) to enemy archers
4. [ ] Test with multiple ranged units in party
5. [ ] Update changelog
6. [ ] Commit changes

---

## Rollback Instructions

If implementation has issues:

```bash
# See what changed
git status

# Revert all changes
git reset --hard HEAD
```

All original code preserved in git history.
