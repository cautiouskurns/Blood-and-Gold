# Feature Implementation Report: Combat Map - Ruined Fort

**Feature:** Combat Map - Ruined Fort (Task 2.17)
**Spec File:** docs/features/2.17-combat-map-ruined-fort.md
**Implemented:** 2026-01-13
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts modified: 2
- Files created: 1 (this report)
- Manual steps required: 0 (fully integrated)

### Design Alignment Confirmed
- Supports design pillar: **Tactical Combat** - Walls create chokepoints for tactical positioning
- Supports design pillar: **Meaningful Choice** - Players must decide which gap to assault, whether to split forces
- Reinforces player fantasy: Commander must break defensive formations and control high ground
- Within scope boundaries: Uses existing terrain and LoS systems

---

## What Was Done

### Overview
This implementation adds **wall tiles** to the combat system - a fundamentally new terrain type that blocks both movement AND line of sight. Unlike obstacles (which only block movement), walls prevent ranged attacks from passing through them. This creates tactical chokepoints where ranged units must reposition to engage targets.

The **Ruined Fort map** (14x14) is the first map to use wall tiles, creating a fortified defensive position with:
- Wall perimeter with two gaps (north and south)
- Rubble (difficult terrain) in the gaps slowing entry
- Central tower (2x2 high ground) providing commanding position
- Interior cover positions for defenders

The key gameplay impact is that ranged attacks are now blocked by walls, forcing tactical repositioning.

### Technical Changes
- Added `TILE_WALL` constant (type 6) for wall tiles
- Added wall rendering with brick pattern icon
- Added `is_wall()` and `blocks_los()` methods to CombatGrid
- Updated `CombatManager.is_tile_blocked_for_los()` to check walls
- Increased grid size from 12x12 to 14x14 to support larger maps
- Added `RUINED_FORT_DATA` map definition with spawn points

---

## Files Modified

### 1. scripts/combat/combat_grid.gd
**Changes:**
- Line 12-13: Increased `GRID_WIDTH` and `GRID_HEIGHT` from 12 to 14
- Line 23: Added `TILE_WALL: int = 6` constant
- Lines 51-53: Added `COLOR_WALL` and `COLOR_WALL_BORDER` color constants
- Lines 111-118: Updated tileset to create 7 tile types instead of 6
- Lines 127-152: Updated atlas texture creation for 7 tiles
- Lines 189-191: Added wall icon case in `_draw_tile_with_icon()`
- Lines 274-300: Added `_draw_brick_icon()` function for wall visuals
- Lines 384-391: Added `is_wall()` and `blocks_los()` methods
- Lines 424-428: Updated `get_terrain_info()` to include wall data
- Lines 502-504: Added `set_tile_wall()` helper method
- Lines 717-767: Added `RUINED_FORT_DATA` map definition and getter

**Key Methods:**

```gdscript
func is_wall(coords: Vector2i) -> bool:
    ## Check if a tile is a wall (blocks movement AND line of sight) - Task 2.17
    return get_tile_type(coords) == TILE_WALL

func blocks_los(coords: Vector2i) -> bool:
    ## Check if a tile blocks line of sight (obstacles and walls) - Task 2.17
    var tile_type = get_tile_type(coords)
    return tile_type == TILE_OBSTACLE or tile_type == TILE_WALL
```

---

### 2. scripts/autoload/combat_manager.gd
**Changes:**
- Lines 627-641: Updated `is_tile_blocked_for_los()` to use `blocks_los()` instead of just `is_obstacle()`

**Updated Method:**
```gdscript
func is_tile_blocked_for_los(position: Vector2i) -> bool:
    ## Check if a tile blocks line of sight (obstacles and walls, NOT units)
    ## Task 2.17: Updated to include walls
    var grid = get_combat_grid()
    if not grid:
        return false
    if not grid.is_valid_position(position):
        return true
    # Check if tile blocks LoS (obstacles and walls)
    return grid.blocks_los(position)
```

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- Only obstacles blocked movement (but not line of sight implicitly)
- Ranged attacks could target any enemy within range with LoS
- No defensive fortification terrain existed
- Grid was limited to 12x12

**After Implementation:**
- Wall tiles block both movement AND line of sight
- Ranged units cannot shoot through walls
- Chokepoint tactics become viable (force melee combat at gaps)
- Tower provides commanding high ground position
- Grid supports 14x14 maps

### New Mechanics Introduced

1. **Wall Tile (TILE_WALL):** Impassable terrain that also blocks ranged attacks
2. **Line of Sight Blocking:** Walls prevent ranged attacks from passing through
3. **Chokepoint Tactics:** Wall gaps force combat through narrow passages
4. **Larger Maps:** Grid now supports 14x14 for more complex battlefields

### Systems Affected
- **Combat Grid:** New tile type, larger grid size
- **Attack Resolver:** LoS checks now respect walls (via CombatManager)
- **Pathfinding:** Walls treated as impassable (handled by `is_walkable()` returning false)
- **Visual System:** New brick pattern icon for wall tiles

---

## What the Player Should Now See

### Visible Differences

#### Terrain Types
When loading the Ruined Fort map, players will see:
- **Wall Tiles:** Dark gray (#4a4a4a) with brick pattern icon
- **Rubble Tiles:** Blue difficult terrain in wall gaps
- **Tower Tiles:** Brown high ground in fort center (2x2 area)
- **Cover Tiles:** Darker green defensive positions

#### Ranged Attack Blocking
- When targeting an enemy with walls between, the attack will be blocked
- Attack range overlay shows blocked tiles in gray (existing LoS system)
- Ranged units must reposition to get clear line of sight

### Step-by-Step: What the Player Experiences

**Scenario: Assaulting the Ruined Fort**
1. Party spawns at south edge (Y=13), outside the fort
2. Enemies are visible inside fort and on tower
3. Lyra (archer) tries to target enemy on tower
4. If wall is between them, attack is blocked - must move through gap
5. Player sends Thorne through west gap (slowed by rubble)
6. Enemy archers on tower get +2 attack bonus from high ground
7. Player must control tower to eliminate ranged threat
8. Wall gaps create chokepoints for concentrated combat

### What the Developer Should See

#### In Godot Editor

1. **FileSystem Panel:**
   - No new files created (modifications only)

2. **Combat Grid:**
   - GRID_WIDTH = 14, GRID_HEIGHT = 14
   - 7 tile types in tileset (added TILE_WALL)

3. **Running the Game:**
   - Load Ruined Fort map via `combat_grid.load_map(combat_grid.RUINED_FORT_DATA)`
   - See 14x14 grid with fort layout
   - Wall tiles appear dark gray with brick pattern

#### Console Output (Debug)

Expected output when loading map:
```
[CombatGrid] Loaded map: Ruined Fort
[CombatGrid] Centered at Vector2(...) (viewport: ..., grid: 896x896)
```

When LoS is blocked by wall:
```
(Attack resolver will return false for has_line_of_sight)
```

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. In a test scene or main scene, add this code to load the map:
   ```gdscript
   func _ready():
       var grid = $CombatGrid  # or get reference
       grid.load_map(grid.RUINED_FORT_DATA)
   ```
3. Press F5 to run the game
4. **Success if:** 14x14 grid appears with dark gray walls forming a fort shape
5. **Failure if:** Walls don't appear or grid is wrong size

### Comprehensive Testing Checklist

#### Core Functionality
- [ ] **Map Loading:** Ruined Fort map loads correctly at 14x14
- [ ] **Wall Rendering:** Wall tiles display with dark gray color and brick icon
- [ ] **Wall Blocking Movement:** Units cannot move to wall tiles
- [ ] **Wall Blocking LoS:** Ranged attacks cannot pass through walls
- [ ] **Rubble Cost:** Moving through rubble costs double movement
- [ ] **Tower Bonus:** Units on tower tiles get +2 ranged attack
- [ ] **Cover Bonus:** Units on cover tiles get +2 defense
- [ ] **Spawn Points:** Party spawns at Y=13, enemies at designated positions

#### LoS Tests
- [ ] **Direct Wall Block:** Shooting through wall is blocked
- [ ] **Diagonal Wall Block:** Shooting diagonally past wall corner is blocked
- [ ] **No Wall:** Shooting through gap with no walls works normally
- [ ] **Obstacle + Wall:** Both obstacles and walls block LoS
- [ ] **Attack Range Overlay:** Shows blocked tiles in gray when wall obstructs

#### Pathfinding Tests
- [ ] **Wall Avoidance:** Path routes around walls through gaps
- [ ] **Rubble Cost:** Path prefers non-rubble route when equal distance
- [ ] **AI Navigation:** Enemy AI correctly navigates through gaps

#### Integration Tests
- [ ] **With Enemy AI:** Enemies pathfind through gaps correctly
- [ ] **With Attack System:** Cover and high ground bonuses apply
- [ ] **With AoO System:** Attack of opportunity works at chokepoints
- [ ] **With Turn System:** Normal turn flow with map loaded

---

## Troubleshooting

### Issue: Walls not appearing
**Symptom:** Map loads but walls show as different tile type
**Cause:** Tile atlas not updated for 7 tiles
**Fix:** Verify `_create_tile_atlas_texture()` creates 7-tile-wide atlas

### Issue: Can shoot through walls
**Symptom:** Ranged attacks pass through wall tiles
**Cause:** `blocks_los()` not being called
**Fix:** Verify `CombatManager.is_tile_blocked_for_los()` calls `grid.blocks_los()`

### Issue: Grid too small
**Symptom:** Map appears cut off at 12x12
**Cause:** GRID_WIDTH/HEIGHT not updated
**Fix:** Verify constants are set to 14

### Issue: Wall tile shows wrong icon
**Symptom:** Wall tile has wrong visual pattern
**Cause:** `_draw_brick_icon()` not being called
**Fix:** Verify `_draw_tile_with_icon()` has "wall" case

---

## Next Steps

After verifying this feature works:

1. [ ] Create test battle scene with Ruined Fort map
2. [ ] Test with Ironmark enemies (Shield Wall + walls combo)
3. [ ] Test Contract 2 "Clear the Ruins" encounter setup
4. [ ] Update changelog
5. [ ] Commit changes

---

## Files Summary

| File | Type | Status |
|------|------|--------|
| scripts/combat/combat_grid.gd | Script | Modified |
| scripts/autoload/combat_manager.gd | Script | Modified |
| docs/features/2.17-combat-map-ruined-fort.md | Spec | Updated status |
| docs/implementation-reports/2.17-combat-map-ruined-fort-implementation.md | Report | Created |

---
