# Feature Implementation Report

**Feature:** Camp Scene System
**Spec File:** docs/features/3.10-camp-scene-system.md
**Implemented:** 2026-01-15
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts created: 2
- Scenes created: 1
- Data files created: 3
- Files modified: 2
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: **Consequence & Choice** (dialogue choices affect companion loyalty)
- Supports design pillar: **Company Identity** (companions express personality and values)
- Reinforces player fantasy: **Mercenary captain managing relationships with crew**
- Within scope boundaries: Core dialogue system with loyalty integration

---

## What Was Done

### Overview

The Camp Scene System adds visual novel-style dialogue scenes where companions share their thoughts and react to the player's decisions. These camp conversations occur between contracts, giving players opportunities to build relationships with their mercenary crew.

The system consists of a `DialogueManager` class that parses JSON dialogue trees, and a `CampDialogue` scene that displays character portraits, dialogue text with typewriter effect, and branching choices. Player choices can affect companion loyalty, with changes displayed via the existing `LoyaltyPopup` component.

Integration with the existing `CampScreen` allows players to initiate camp dialogues by clicking "TALK" buttons on companion cards, creating a natural flow from viewing loyalty status to engaging in conversations.

### Technical Changes

1. **DialogueManager Class:** New RefCounted class for parsing and navigating JSON dialogue trees
2. **CampDialogue Scene:** Full-screen visual novel dialogue UI with portraits, text, and choices
3. **CampScreen Integration:** Added "TALK" buttons to companion cards that launch dialogues
4. **Sample Dialogue Content:** Three JSON dialogue files, one per companion

---

## Files Created

### 1. scripts/systems/dialogue_manager.gd

**Purpose:** Parses JSON dialogue trees and manages navigation through nodes.

**Key Methods:**
- `load_dialogue(json_path: String) -> bool` - Load dialogue from JSON file
- `start() -> Dictionary` - Start dialogue from Start node
- `advance() -> Dictionary` - Move to next node (for non-choice nodes)
- `select_choice(choice_id: String) -> Dictionary` - Follow a choice path
- `get_available_choices() -> Array[Dictionary]` - Get choice options

**Signals:**
- `node_reached(node_data: Dictionary)` - Emitted when reaching a new node
- `choices_available(choices: Array[Dictionary])` - Emitted when choices appear
- `dialogue_ended(end_type: String)` - Emitted when dialogue ends

**Integration:**
- Used by CampDialogue to navigate dialogue trees
- Standalone class (RefCounted) - can be reused elsewhere

---

### 2. scripts/camp/camp_dialogue.gd

**Purpose:** Controller for visual novel dialogue UI. Handles display, input, and loyalty integration.

**Key Methods:**
- `load_scene(json_path: String) -> bool` - Load dialogue from file
- `start_dialogue() -> void` - Begin displaying dialogue
- `end_dialogue() -> void` - Clean up and close

**Signals:**
- `scene_started(scene_id: String)` - Camp scene begins
- `scene_ended(scene_id: String)` - Camp scene ends
- `dialogue_advanced(node_id: String)` - Moved to new node
- `choice_selected(choice_index: int, choice_text: String)` - Player made choice

**Features:**
- Typewriter effect for dialogue text (0.03s per character)
- Portrait placeholders with colored rectangles and initials
- Choice buttons with number key shortcuts (1-4)
- Loyalty change integration via LoyaltyManager
- LoyaltyPopup display for loyalty changes

---

### 3. scenes/camp/CampDialogue.tscn

**Root Node:** Control with camp_dialogue.gd script

**Structure:**
```
CampDialogue (Control)
├── Background (ColorRect)
├── PortraitLayer (CanvasLayer)
│   ├── LeftPortrait (Control)
│   └── RightPortrait (Control)
├── DialogueLayer (CanvasLayer)
│   └── DialoguePanel (PanelContainer)
│       └── MarginContainer
│           └── VBoxContainer
│               ├── SpeakerLabel (Label)
│               ├── DialogueText (RichTextLabel)
│               └── ContinueIndicator (Label)
└── ChoiceLayer (CanvasLayer)
    └── ChoiceContainer (VBoxContainer)
```

---

### 4. data/camp_scenes/camp_scene_1_thorne.json

**Trigger:** After Merchant's Escort contract
**Content:** Thorne discusses mercenary life philosophy
**Choices affect:** Thorne loyalty (+5 or -5)

---

### 5. data/camp_scenes/camp_scene_2_lyra.json

**Trigger:** After Clear the Ruins contract
**Content:** Lyra shares concerns about dark forces and necromancy
**Choices affect:** Lyra loyalty (+5 or -5)

---

### 6. data/camp_scenes/camp_scene_3_matthias.json

**Trigger:** After Border Dispute contract
**Content:** Matthias reflects on refugee encounter and morality
**Choices affect:** Matthias and Thorne loyalty (opposing effects)

---

## Files Modified

### 1. scripts/hub/screens/camp_screen.gd

**Changes:**
- Added constants for camp dialogue paths
- Added preload for CampDialogueScene
- Added "TALK" button to each companion card
- Added `_on_talk_pressed()` handler
- Added `_start_camp_dialogue()` method
- Added `_cleanup_dialogue()` method
- Increased card height from 320 to 380 for button

---

### 2. scenes/hub/screens/CampScreen.tscn

**Changes:**
- Added "TalkHint" label with instruction text

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- CampScreen only showed companion loyalty information
- No way to interact with companions narratively
- Loyalty changes only happened during contract events

**After Implementation:**
- Players can talk to companions in camp
- Visual novel dialogue scenes with portraits and choices
- Dialogue choices affect companion loyalty
- Companions express personality through conversation
- Three unique camp scenes available (one per companion)

### New Mechanics Introduced

1. **Camp Dialogues:**
   - Full-screen visual novel interface
   - Character portraits on left side
   - Dialogue text with typewriter effect
   - Branching choices (2-3 per scene)

2. **Dialogue Choices:**
   - Each choice has distinct flavor text
   - Some choices affect loyalty positively or negatively
   - Loyalty indicators show which companion is affected
   - LoyaltyPopup displays changes after selection

3. **Input Methods:**
   - Click/Space/Enter to advance dialogue
   - Number keys 1-4 to select choices quickly
   - Click on choice buttons

### Systems Affected

- **LoyaltyManager:** Called to modify loyalty from dialogue choices
- **LoyaltyPopup:** Displays loyalty changes during dialogue
- **CampScreen:** Enhanced with TALK buttons
- **GameState:** No direct changes (future: track viewed dialogues)

---

## What the Player Should Now See

### Visible Differences

#### In Menus/UI

1. **Camp Screen** now has a "TALK" button on each companion card
2. **Talk Hint** text at bottom: "Click TALK to have a conversation with a companion"
3. Companion cards are slightly taller to accommodate the button

#### During Dialogue

1. **Full-screen dialogue scene** with dark background
2. **Portrait placeholder** on left (colored rectangle with initials)
3. **Speaker name** in character color (Thorne=blue, Lyra=gold, Matthias=red)
4. **Dialogue text** appearing with typewriter effect
5. **Continue indicator** pulsing when waiting for input
6. **Choice buttons** appearing below dialogue box
7. **Loyalty indicator** on choices that affect loyalty (e.g., "+Thorne")
8. **LoyaltyPopup** sliding in after choice selection

### Step-by-Step: What the Player Experiences

**Scenario: Talking to Thorne**
1. Player navigates to Hub
2. Clicks "CAMP" button
3. Sees three companion cards with "TALK" buttons
4. Clicks "TALK" on Thorne's card
5. Screen transitions to camp dialogue
6. Sees Thorne's portrait placeholder (dark blue with "THO")
7. "THORNE" appears as speaker name
8. Text appears with typewriter effect
9. After reading, player clicks to continue
10. Choices appear:
    - [1] "Safety keeps the company alive..." (-Thorne)
    - [2] "You want glory?..." (+Thorne)
    - [3] "What would you have us do differently?"
11. Player selects option 2
12. LoyaltyPopup shows "+5 LOYALTY" for Thorne
13. Thorne responds approvingly
14. Dialogue ends, returns to Camp Screen
15. Thorne's loyalty card shows updated value

**Scenario: Matthias dialogue with dual loyalty effects**
1. Player talks to Matthias after Border Dispute
2. Discusses the refugees
3. Choice 1 affects both: Matthias -5, Thorne +5
4. LoyaltyPopup shows both changes in sequence
5. Player sees consequences of prioritizing pragmatism vs compassion

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. Press F5 to run the game
3. Navigate to Hub
4. Click "CAMP" button
5. Click "TALK" on any companion card
6. **Success if:** Dialogue scene appears with portrait and text
7. Click to advance, select a choice
8. **Success if:** LoyaltyPopup appears, dialogue continues
9. Dialogue ends and returns to camp

### Comprehensive Testing Checklist

#### Core Functionality

- [ ] **Test 1:** Camp dialogue loads
  - **Steps:** Click TALK on Thorne's card
  - **Expected:** Full-screen dialogue with portrait and text

- [ ] **Test 2:** Typewriter effect works
  - **Steps:** Watch text appear
  - **Expected:** Characters appear one at a time

- [ ] **Test 3:** Click advances dialogue
  - **Steps:** Click after text finishes
  - **Expected:** Continue to next speaker node

- [ ] **Test 4:** Choices appear correctly
  - **Steps:** Advance to choice point
  - **Expected:** 2-3 choice buttons visible

- [ ] **Test 5:** Number keys select choices
  - **Steps:** Press 1, 2, or 3 when choices visible
  - **Expected:** Choice selected immediately

- [ ] **Test 6:** Loyalty changes apply
  - **Steps:** Select choice with loyalty indicator
  - **Expected:** LoyaltyManager value changes

- [ ] **Test 7:** LoyaltyPopup displays
  - **Steps:** Select choice with loyalty effect
  - **Expected:** Popup shows "+X LOYALTY"

- [ ] **Test 8:** Dialogue ends properly
  - **Steps:** Advance through entire dialogue
  - **Expected:** Returns to Camp Screen

#### Acceptance Criteria Verification

- [ ] **Camp scene displays with character portraits**
  - Test: Start any camp dialogue
  - Expected: Portrait placeholder visible on left

- [ ] **Portraits display at 200x250 pixels**
  - Test: Visual inspection of portrait size
  - Expected: Approximately 200x250 portrait area

- [ ] **Dialogue box shows speaker name with color**
  - Test: Check speaker label
  - Expected: "THORNE" in blue, "LYRA" in gold, etc.

- [ ] **Dialogue advances on click/space/enter**
  - Test: Try each input method
  - Expected: All three advance dialogue

- [ ] **Choices as clickable buttons**
  - Test: Click on choice button
  - Expected: Choice selected, dialogue continues

- [ ] **Choices show loyalty indicator**
  - Test: Look at choice text
  - Expected: "(+Thorne)" or similar suffix

- [ ] **LoyaltyManager.modify_loyalty() called**
  - Test: Check loyalty value before/after choice
  - Expected: Value changes by indicated amount

- [ ] **LoyaltyPopup displays after choice**
  - Test: Select loyalty-affecting choice
  - Expected: Popup appears with change

- [ ] **Dialogue loads from JSON**
  - Test: Check console for load messages
  - Expected: "[CampDialogue] Loaded scene: ..."

- [ ] **End node returns to camp**
  - Test: Complete entire dialogue
  - Expected: Back at Camp Screen

- [ ] **Missing portraits show placeholder**
  - Test: No portrait sprites exist yet
  - Expected: Colored rectangle with initials

#### Edge Case Tests

- [ ] **Skip typewriter with click**
  - **How:** Click while text appearing
  - **Expected:** Full text displays immediately

- [ ] **Number key outside choice range**
  - **How:** Press 5 when only 3 choices
  - **Expected:** Nothing happens

- [ ] **Departed companion has no TALK button**
  - **How:** Set companion loyalty to 0, revisit camp
  - **Expected:** No TALK button on departed companion

#### Integration Tests

- [ ] **With LoyaltyManager:** Loyalty values persist
- [ ] **With LoyaltyPopup:** Popup displays correctly
- [ ] **With CampScreen:** Updates loyalty display after dialogue

---

## Troubleshooting

### Issue: Dialogue doesn't load
**Symptom:** Error in console, no dialogue appears
**Cause:** JSON file path incorrect or file missing
**Fix:** Verify file exists at `res://data/camp_scenes/` and path in `CAMP_DIALOGUE_PATHS`

### Issue: Choices don't appear
**Symptom:** Dialogue ends early without showing choices
**Cause:** JSON connection structure incorrect
**Fix:** Verify `connections` array has `to` fields pointing to Choice nodes

### Issue: LoyaltyPopup doesn't show
**Symptom:** Loyalty changes but no popup
**Cause:** Popup scene not loading or not in scene tree
**Fix:** Check LoyaltyPopupScene preload path matches actual location

### Issue: Portrait colors wrong
**Symptom:** Gray placeholder instead of character color
**Cause:** Speaker name doesn't match `PORTRAIT_COLORS` keys
**Fix:** Ensure JSON `speaker` field uses lowercase (thorne, lyra, matthias)

---

## Next Steps

After verifying this feature works:

1. [ ] Add portrait art assets to replace placeholders
2. [ ] Add more camp scenes for post-contract triggers
3. [ ] Track which dialogues have been viewed in GameState
4. [ ] Add ambient audio (fire crackling) to camp scenes
5. [ ] Add portrait reaction sprites (happy, angry, sad)
6. [ ] Implement auto-trigger after contract completion
7. [ ] Add GameState.get_choice() integration for branching

---

## Rollback Instructions

If implementation has issues:

```bash
# See what changed
git status

# Review changes
git diff

# Revert specific file
git checkout -- scripts/systems/dialogue_manager.gd

# Revert all changes
git reset --hard HEAD
```

All original code preserved in git history.
