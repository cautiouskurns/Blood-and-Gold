# Feature Implementation Report: Soldier Order Behavior Implementation

**Feature:** Soldier Order Behavior Implementation (Task 2.11)
**Spec File:** docs/features/2.11-soldier-order-behavior-implementation.md
**Implemented:** 2026-01-13
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- ✅ Scripts modified: 3
- ✅ Files created: 0 (all infrastructure already existed)
- ⚠️ Manual steps required: 0 (fully integrated)

### Design Alignment Confirmed
- ✅ Supports design pillar: Build & Command - Players issue strategic orders, soldiers act autonomously
- ✅ Supports design pillar: Tactical Combat - Five distinct orders create tactical depth
- ✅ Reinforces player fantasy: Mercenary commander leading a warband
- ✅ Within scope boundaries: Uses existing soldier infrastructure

---

## What Was Done

### Overview
This implementation adds full behavior for all five soldier orders (ADVANCE, HOLD, FOCUS_FIRE, RETREAT, PROTECT). Prior to this, only HOLD and ADVANCE were fully implemented. Now soldiers can:

- **FOCUS_FIRE**: Attack a designated high-priority target, ignoring closer enemies
- **RETREAT**: Move toward the starting map edge without attacking (tactical withdrawal)
- **PROTECT**: Stay adjacent to a designated ally and intercept attacks aimed at them

The PROTECT order includes **attack interception** - when an enemy attacks a protected ally, the protecting soldier takes the damage instead (once per round).

### Technical Changes
- Added FOCUS_FIRE target and PROTECT ally tracking to CombatManager
- Implemented full order behaviors in SoldierAI
- Added attack interception in Unit.perform_attack()
- Reset interception flags each combat round

---

## Files Modified

### 1. scripts/autoload/combat_manager.gd
**Changes:**
- Added `_focus_fire_target: Unit` - Stores designated FOCUS_FIRE target
- Added `_protected_allies: Dictionary` - Maps soldier → protected ally
- Added `_interception_used: Dictionary` - Tracks which soldiers have intercepted this round

**Key Methods Added:**
- `set_focus_fire_target(target)` - Designate a target for FOCUS_FIRE soldiers
- `get_focus_fire_target() -> Unit` - Get current FOCUS_FIRE target
- `set_protected_ally(soldier, ally)` - Create a PROTECT relationship
- `get_protected_ally(soldier) -> Unit` - Get the ally a soldier is protecting
- `get_protector_for_unit(unit) -> Unit` - Get the soldier protecting a unit
- `try_intercept_attack(target, damage) -> Dictionary` - Check and execute interception
- `reset_interception_flags()` - Called at round start to reset limits
- `can_soldier_intercept(soldier) -> bool` - Check if soldier can still intercept
- `mark_interception_used(soldier)` - Mark that soldier used their interception

**Integration:**
- `_on_round_started()` now calls `reset_interception_flags()` to reset interception limits

---

### 2. scripts/combat/soldier_ai.gd
**Changes:**
- Fully implemented `_execute_focus_fire_order()` - Attack designated target, move if needed
- Fully implemented `_execute_retreat_order()` - Move toward map edge, don't attack
- Fully implemented `_execute_protect_order()` - Stay adjacent to ally, attack when possible
- Added `_find_protect_position()` - Find best adjacent tile to protected ally (preferring positions between ally and enemies)
- Updated `_execute_archer_turn()` to handle all five orders (not just HOLD/ADVANCE)

**Key Methods:**
- `_execute_focus_fire_order(soldier, combat_grid)` - Attacks designated target, fallback to ADVANCE if no target
- `_execute_retreat_order(soldier, combat_grid)` - Moves toward Y=0 (or max Y for enemies), doesn't attack
- `_execute_protect_order(soldier, combat_grid)` - Moves to adjacent tile of ally, attacks enemies in range
- `_find_protect_position(soldier, ally, combat_grid)` - Finds optimal protection position

---

### 3. scripts/combat/unit.gd
**Changes:**
- Modified `perform_attack()` to check for PROTECT interception before applying damage
- Added `_spawn_intercept_indicator(protector)` - Shows "BLOCKED!" text and blue flash when interception occurs

**Integration:**
- When an attack hits, checks `CombatManager.try_intercept_attack()`
- If intercepted, damage is redirected to the protector instead of original target

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- Only HOLD and ADVANCE orders worked fully
- FOCUS_FIRE, RETREAT, PROTECT were placeholder stubs
- No coordinated attacks on high-priority targets
- No way to protect vulnerable allies
- No tactical withdrawal option

**After Implementation:**
- **FOCUS_FIRE**: All soldiers with this order attack the same designated target, devastating for eliminating priority enemies
- **RETREAT**: Soldiers move toward starting edge without engaging, preserving wounded units
- **PROTECT**: Bodyguard behavior - stays near ally and intercepts incoming attacks

### New Mechanics Introduced

1. **Focus Fire Targeting**: CombatManager stores a FOCUS_FIRE target that all soldiers with that order will attack
2. **Protect Relationships**: Soldiers can be assigned to protect specific allies
3. **Attack Interception**: When a protected ally would take damage, the adjacent protector takes it instead (once per round)
4. **Interception Limit Reset**: At each round start, interception availability resets

### Systems Affected
- **SoldierAI**: Now fully handles all five orders for both melee and ranged soldiers
- **CombatManager**: Stores order-related state (targets, protect relationships)
- **Unit Attack Flow**: Checks for interception before applying damage
- **Round System**: Resets interception flags each round

---

## What the Player Should Now See

### Visible Differences

#### FOCUS_FIRE Order
- Soldiers with FOCUS_FIRE attack the designated target instead of nearest enemy
- If target is out of range, soldier moves toward it
- If target dies, soldier falls back to ADVANCE behavior

#### RETREAT Order
- Soldier moves toward the top of the map (Y=0 for player soldiers)
- Soldier does NOT attack, even if enemies are adjacent
- When soldier reaches map edge, stands idle

#### PROTECT Order
- Soldier moves to stay adjacent to protected ally
- Soldier prefers positions between ally and enemies (to intercept)
- When protected ally is attacked:
  - "BLOCKED!" text appears above protector (blue)
  - Protector flashes blue briefly
  - Protector takes the damage instead of ally
  - This works once per round per protector

### Step-by-Step: What the Player Experiences

**Scenario: FOCUS_FIRE Order**
1. Player sets FOCUS_FIRE target on an enemy commander via Order Panel
2. Soldier's turn arrives
3. Console: "[SoldierAI] Infantry executing FOCUS_FIRE order"
4. Soldier ignores closer enemies and moves toward designated target
5. When in range, soldier attacks the designated target
6. If target dies, soldier switches to attacking nearest enemy (ADVANCE fallback)

**Scenario: RETREAT Order**
1. Player assigns RETREAT order to a wounded soldier
2. Soldier's turn arrives
3. Console: "[SoldierAI] Infantry executing RETREAT order"
4. Soldier moves toward Y=0 (top of map for player soldiers)
5. Soldier does NOT attack, even if enemies are adjacent
6. When soldier reaches map edge, stands idle

**Scenario: PROTECT Order with Interception**
1. Player assigns PROTECT order to infantry, designating the party healer as protected ally
2. Infantry moves to position adjacent to healer
3. Enemy's turn arrives, enemy attacks healer
4. Attack would hit healer for 8 damage
5. Console: "[CombatManager] Infantry intercepts attack on Healer!"
6. "BLOCKED!" text appears above infantry (blue color)
7. Infantry takes the 8 damage instead of healer
8. Infantry flashes blue briefly
9. If infantry is attacked again on same round, it cannot intercept (limit: 1 per round)

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. Open the main battle scene
3. Add infantry and archer soldiers
4. Press F5 to run the game
5. Test each order behavior:
   - FOCUS_FIRE: Designate an enemy, verify soldiers attack only that target
   - RETREAT: Assign retreat, verify soldier moves toward map edge and doesn't attack
   - PROTECT: Assign protect on a party member, attack the protected unit, verify interception
6. ✅ **Success if:** Each order produces distinct, observable behavior
7. ❌ **Failure if:** Soldiers act like HOLD/ADVANCE regardless of order

### Comprehensive Testing Checklist

#### FOCUS_FIRE Tests
- [ ] **Melee FOCUS_FIRE:** Infantry attacks designated target, ignoring closer enemies
- [ ] **Ranged FOCUS_FIRE:** Archer shoots designated target from range
- [ ] **Move to Range:** Soldier moves toward target if not in range
- [ ] **Target Dead Fallback:** When target dies, soldier falls back to ADVANCE

#### RETREAT Tests
- [ ] **Basic Retreat:** Soldier moves toward Y=0
- [ ] **No Attack:** Soldier doesn't attack while retreating
- [ ] **Edge Stop:** Soldier stops at map edge
- [ ] **Blocked Path:** Soldier finds alternate path if direct path blocked

#### PROTECT Tests
- [ ] **Position Adjacent:** Soldier moves to be adjacent to protected ally
- [ ] **Attack While Protecting:** Soldier attacks enemies in range while adjacent
- [ ] **Attack Interception:** Soldier takes damage instead of protected ally
- [ ] **"BLOCKED!" Indicator:** Blue text and flash appear on interception
- [ ] **Interception Limit:** Soldier can only intercept once per round
- [ ] **Ally Death Fallback:** If protected ally dies, soldier reverts to HOLD

#### Integration Tests
- [ ] Works with Order Panel (Task 2.10)
- [ ] Works with turn order system
- [ ] Works with damage numbers
- [ ] Works for both infantry and archers
- [ ] Interception resets each round

---

## Console Output Examples

When FOCUS_FIRE executes:
```
[SoldierAI] Infantry executing FOCUS_FIRE order
[SoldierAI] Infantry attacking FOCUS_FIRE target: Enemy Commander
```

When RETREAT executes:
```
[SoldierAI] Infantry executing RETREAT order
[SoldierAI] Infantry retreating along path: [(3, 5), (3, 4), (3, 3), (3, 2)]
```

When PROTECT executes:
```
[SoldierAI] Infantry executing PROTECT order
[SoldierAI] Infantry moving to protect Healer (current distance: 3)
[SoldierAI] Infantry attacking while protecting Healer
```

When interception occurs:
```
[CombatManager] Infantry intercepts attack on Healer!
[Unit] Infantry intercepts attack on Healer!
```

---

## Troubleshooting

### Issue: FOCUS_FIRE soldier attacks nearest enemy instead of target
**Symptom:** Soldier ignores designated target and attacks closest enemy
**Cause:** No FOCUS_FIRE target set in CombatManager
**Fix:** Verify `CombatManager.set_focus_fire_target(enemy)` was called via Order Panel

### Issue: PROTECT soldier doesn't intercept
**Symptom:** Protected ally takes damage, no interception
**Possible causes:**
1. Protector not adjacent to ally
2. Protector already used interception this round
3. No PROTECT relationship set
**Fix:** Check console for interception messages, verify soldier is adjacent

### Issue: RETREAT soldier still attacks
**Symptom:** Soldier on RETREAT order attacks adjacent enemies
**Cause:** Wrong order or order not applied
**Fix:** Verify soldier's current_order is set to SoldierOrder.RETREAT

### Issue: Soldiers don't respond to order changes
**Symptom:** Order icon updates but behavior doesn't change
**Cause:** Order assignment not persisting
**Fix:** Check Order Panel integration and soldier.current_order property

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest with all order combinations
2. [ ] Test multiple soldiers with different orders simultaneously
3. [ ] Verify Order Panel (Task 2.10) can assign all orders
4. [ ] Consider adding visual lines for FOCUS_FIRE target and PROTECT ally
5. [ ] Update changelog
6. [ ] Commit changes

---

## Files Summary

| File | Type | Status |
|------|------|--------|
| scripts/autoload/combat_manager.gd | Script | Modified |
| scripts/combat/soldier_ai.gd | Script | Modified |
| scripts/combat/unit.gd | Script | Modified |
| docs/implementation-reports/2.11-soldier-order-behavior-implementation.md | Report | Created |

---
