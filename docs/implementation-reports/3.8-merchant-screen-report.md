# Feature Implementation Report

**Feature:** Merchant Screen
**Spec File:** docs/features/3.8-merchant-screen.md
**Implemented:** 2026-01-14
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts modified: 2
- Scenes modified: 1
- Data files created: 0
- Files modified: 2
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: Character Progression ("equipment matters - finding that enchanted sword changes everything")
- Reinforces player fantasy: Equipping party members to improve combat effectiveness
- Within prototype scope boundaries

---

## What Was Done

### Overview
Implemented the Merchant Screen, a sub-screen accessible from the Hub that allows players to purchase weapons and armor for their party members (Commander, Thorne, Lyra, Matthias). The screen displays items organized by category (Weapons/Armor) with clear pricing and stats. When selecting an item, a comparison panel shows current equipment versus the new item with stat changes highlighted in green (improvements) or red (reductions).

Players can switch between party members to equip different characters and purchase the same item multiple times for different characters. Purchases immediately deduct gold and equip the item, replacing any existing equipment in that slot (no inventory system for prototype).

### Technical Changes
- Added character equipment tracking system to GameState autoload
- Equipment stored as string IDs for easy serialization
- Dynamic item card generation with visual states (available/unaffordable/equipped)
- Comparison panel with stat change highlighting
- Purchase flow with visual feedback (flash on success, shake on failure)

---

## Files Created

None - modified existing placeholder files.

---

## Files Modified

### 1. scripts/autoload/game_state.gd
**Changes:**
- Added `equipment_changed` signal
- Added `character_equipment` dictionary tracking weapon/armor per party member
- Added equipment management functions:
  - `equip_item(character_id, slot, equipment_id)` - Equips an item to a character
  - `get_equipped(character_id, slot)` - Gets the equipped item ID
  - `has_equipment(character_id, equipment_id)` - Checks if character has specific item
  - `get_character_equipment(character_id)` - Gets all equipment for a character
- Updated `get_save_data()` to include character_equipment
- Updated `load_save_data()` to restore character_equipment
- Updated `reset_to_new_game()` to clear character_equipment

### 2. scripts/hub/screens/merchant_screen.gd
**Changes:**
- Replaced placeholder implementation with full merchant screen
- Key features:
  - Party member selection (Commander, Thorne, Lyra, Matthias)
  - Category tabs (Weapons, Armor)
  - Dynamic item card creation with visual states
  - Comparison panel with stat change highlighting
  - Purchase flow with validation and feedback

**Constants:**
```gdscript
const WEAPONS := [
    {"id": "iron_sword", "name": "Iron Sword", "cost": 100, "damage_die": 8, "damage_bonus": 0},
    {"id": "steel_sword", "name": "Steel Sword", "cost": 300, "damage_die": 8, "damage_bonus": 1},
]
const ARMOR := [
    {"id": "leather_armor", "name": "Leather Armor", "cost": 50, "armor_bonus": 2, "movement": 6},
    {"id": "chain_shirt", "name": "Chain Shirt", "cost": 150, "armor_bonus": 4, "movement": 5},
    {"id": "scale_mail", "name": "Scale Mail", "cost": 300, "armor_bonus": 5, "movement": 5},
]
```

**Signals:**
- `equipment_purchased(character_id, equipment_id)` - Emitted when player purchases equipment

### 3. scenes/hub/screens/MerchantScreen.tscn
**Changes:**
- Updated from placeholder to full UI structure
- Scene structure:
```
MerchantScreen (Control)
├── TopBar (HBoxContainer)
│   ├── BackButton (Button) - "< BACK"
│   ├── TitleLabel (Label) - "MERCHANT"
│   └── GoldDisplay (HBoxContainer)
│       ├── GoldLabel (Label) - "GOLD:"
│       └── GoldAmount (Label) - Dynamic value
├── ContentPanel (Panel)
│   └── VBoxContainer
│       ├── PartySelector (HBoxContainer) - Party member buttons
│       ├── CategoryTabs (HBoxContainer) - WEAPONS/ARMOR tabs
│       ├── ItemsContainer (GridContainer, columns=2) - Item cards
│       └── ComparisonPanel (PanelContainer, hidden)
│           └── HBoxContainer
│               ├── CurrentEquipment (VBoxContainer)
│               │   ├── CurrentLabel - "CURRENT"
│               │   ├── CurrentName - Equipment name
│               │   └── CurrentStats - Stat labels
│               ├── VSeparator
│               └── NewEquipment (VBoxContainer)
│                   ├── NewLabel - "NEW"
│                   ├── NewName - Equipment name
│                   ├── NewStats - Stat labels with change colors
│                   └── PurchaseButton
```

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- Merchant button opened placeholder screen with "Equipment shop coming in future task"
- No way to purchase or equip items
- Gold had no use in the hub beyond display

**After Implementation:**
- Players can browse and purchase 5 equipment items
- Equipment can be assigned to any of 4 party members
- Gold has meaningful use between contracts
- Stat comparison helps make informed decisions

### New Mechanics Introduced
1. **Equipment System:** Party members can have one weapon and one armor equipped
2. **Item Purchase:** Spend gold to acquire equipment
3. **Stat Comparison:** See how new equipment compares to current

### Systems Affected
- **GameState:** New character_equipment tracking, save/load includes equipment
- **Hub Navigation:** Merchant button now opens functional shop
- **Future Combat:** Equipment stats can be applied when combat begins

---

## What the Player Should Now See

### Visible Differences

#### In Hub
- Clicking "MERCHANT" opens the full equipment shop instead of placeholder

#### In Merchant Screen
- Header showing "MERCHANT" and current gold
- Party member selection buttons (COMMANDER, THORNE, LYRA, MATTHIAS)
- Category tabs (WEAPONS, ARMOR)
- Item cards showing name, stats, and cost:
  - **Weapons:** Iron Sword (100g, 1d8), Steel Sword (300g, 1d8+1)
  - **Armor:** Leather (50g, +2 DEF, 6 move), Chain Shirt (150g, +4 DEF, 5 move), Scale Mail (300g, +5 DEF, 5 move)
- Available items have white text and gold cost
- Unaffordable items are grayed out with red cost
- Equipped items show green "EQUIPPED" badge
- Clicking an item shows comparison panel

#### Comparison Panel
- Side-by-side view: Current equipment vs New equipment
- Stat improvements shown in green with ^ arrow
- Stat reductions shown in red with v arrow
- Same stats shown in gray
- Purchase button with cost, or "EQUIPPED"/"CANNOT AFFORD" when disabled

### Step-by-Step: What the Player Experiences

**Scenario: Purchasing Leather Armor for Commander**
1. Player has 500 gold (starting amount)
2. Player clicks "MERCHANT" button in hub
3. Merchant screen opens with Commander selected, Weapons tab active
4. Player clicks "ARMOR" tab
5. Three armor items displayed: Leather (50g), Chain Shirt (150g), Scale Mail (300g)
6. Player clicks Leather Armor card
7. Comparison panel appears showing "(None)" vs "Leather Armor"
8. Stats show: Defense: +2, Movement: 6
9. Purchase button shows "PURCHASE - 50g"
10. Player clicks purchase button
11. Card flashes white then turns green, shows "EQUIPPED"
12. Gold decreases from 500 to 450
13. Comparison panel updates: button now shows "EQUIPPED" (disabled)
14. Player can select Thorne and buy leather armor for them too

**Scenario: Switching Party Members**
1. Player has Commander with Leather Armor equipped
2. Player clicks "THORNE" button
3. Leather Armor card now shows cost again (not equipped for Thorne)
4. Comparison panel clears (no item selected)
5. Player can purchase same armor for Thorne

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. Press F5 to run the game
3. In hub, click "MERCHANT" button
4. **Success if:** Merchant screen opens with party selector, category tabs, and item cards
5. Click "ARMOR" tab
6. **Success if:** Three armor items displayed with costs
7. Click "Leather Armor" card (50g)
8. **Success if:** Comparison panel appears showing stats
9. Click "PURCHASE - 50g"
10. **Success if:** Gold decreases, card shows "EQUIPPED"
11. Click "< BACK" to return to hub
12. Click "MERCHANT" again
13. **Success if:** Leather Armor still shows "EQUIPPED" for Commander

### Comprehensive Testing Checklist

#### Acceptance Criteria Verification

- [ ] **Merchant screen accessible from hub MERCHANT button**
  - **How to test:** Click MERCHANT button in hub
  - **Expected result:** Screen loads with title "MERCHANT"

- [ ] **Shows weapons and armor for sale with correct prices**
  - **How to test:** Check item cards
  - **Expected result:** 2 weapons, 3 armor with correct costs

- [ ] **Can select different party members**
  - **How to test:** Click each party button
  - **Expected result:** Selection highlights, equipment states update

- [ ] **Clicking item shows comparison with current equipment**
  - **How to test:** Click any item card
  - **Expected result:** Comparison panel appears

- [ ] **Stat improvements shown in green, reductions in red**
  - **How to test:** Compare Chain Shirt to Leather (already equipped)
  - **Expected result:** Defense shows green (improvement), Movement shows red (reduction)

- [ ] **Can purchase items with sufficient gold**
  - **How to test:** Click purchase on affordable item
  - **Expected result:** Gold deducted, item equipped

- [ ] **Gold deducted on purchase**
  - **How to test:** Note gold before purchase, check after
  - **Expected result:** Gold reduced by exact item cost

- [ ] **Equipment marked as "EQUIPPED" after purchase**
  - **How to test:** Purchase item
  - **Expected result:** Card shows green "EQUIPPED" badge

- [ ] **Unaffordable items grayed out with red cost**
  - **How to test:** With low gold, check expensive items
  - **Expected result:** Cards grayed, cost in red

- [ ] **Back button returns to hub**
  - **How to test:** Click "< BACK"
  - **Expected result:** Returns to hub main view

#### Edge Case Tests

- [ ] **Cannot purchase with exactly 1 gold less than cost**
  - **How to trigger:** Set gold to 49, try to buy Leather (50)
  - **Expected behavior:** Purchase button disabled

- [ ] **Can purchase with exactly enough gold**
  - **How to trigger:** Set gold to 50, buy Leather
  - **Expected behavior:** Purchase succeeds, gold becomes 0

- [ ] **Buying same item for different characters works**
  - **How to trigger:** Buy Iron Sword for Commander, switch to Thorne, buy again
  - **Expected behavior:** Both can have Iron Sword equipped

- [ ] **Switching characters updates comparison correctly**
  - **How to trigger:** Select item, switch party member
  - **Expected behavior:** Comparison updates to show new character's equipment

#### Integration Tests

- [ ] **GameState.gold updates correctly after purchase**
  - **Scenario:** Purchase 100g item with 500g
  - **Verify:** GameState.gold == 400

- [ ] **GameState.get_equipped returns correct ID**
  - **Scenario:** Equip iron_sword to player
  - **Verify:** GameState.get_equipped("player", "weapon") == "iron_sword"

- [ ] **Equipment persists after leaving merchant screen**
  - **Scenario:** Purchase, exit, re-enter
  - **Verify:** Items still show as equipped

---

## Troubleshooting

### Issue: Item cards not appearing
**Symptom:** No items displayed in ItemsContainer
**Cause:** GridContainer not finding items or script not creating cards
**Fix:** Check that ItemsContainer exists in scene and _refresh_items() is called

### Issue: Gold not updating
**Symptom:** Gold display doesn't change after purchase
**Cause:** gold_amount reference incorrect or signal not connected
**Fix:** Verify $TopBar/GoldDisplay/GoldAmount path in scene

### Issue: Comparison panel not showing
**Symptom:** Click item but comparison doesn't appear
**Cause:** ComparisonPanel reference incorrect or visibility not being set
**Fix:** Check comparison_panel.visible assignment in _update_comparison()

### Issue: Equipment not persisting
**Symptom:** Equipment resets when re-entering merchant
**Cause:** GameState.character_equipment not being read correctly
**Fix:** Verify _refresh_item_states() checks GameState.get_equipped()

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest through Merchant Screen
2. [ ] Test purchasing all 5 items
3. [ ] Test equipping all 4 party members
4. [ ] Integrate equipment stats with combat (Unit.gd)
5. [ ] Update changelog
6. [ ] Commit changes

---

## Combat Integration (Future)

Equipment stats should be applied when combat begins. The spec describes this approach:

```gdscript
# In Unit._configure_stats_for_type():
func _configure_stats_for_type() -> void:
    match unit_type:
        UnitType.PLAYER:
            # Base stats...
            # Apply equipment overrides
            var weapon_id = GameState.get_equipped("player", "weapon")
            if weapon_id:
                var weapon = _get_weapon_data(weapon_id)
                weapon_damage_die = weapon.damage_die
                damage_bonus = weapon.damage_bonus
            var armor_id = GameState.get_equipped("player", "armor")
            if armor_id:
                var armor = _get_armor_data(armor_id)
                armor_bonus = armor.armor_bonus
                movement_range = armor.movement
```

This integration is out of scope for Task 3.8 but the data structure is ready.

---

## Files Summary

```
Modified:
├── scripts/autoload/game_state.gd (equipment tracking)
├── scripts/hub/screens/merchant_screen.gd (full implementation)
└── scenes/hub/screens/MerchantScreen.tscn (full UI)
```
