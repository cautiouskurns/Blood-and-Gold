# Feature Implementation Report

**Feature:** Soldier Recruitment Screen
**Spec File:** docs/features/3.7-soldier-recruitment-screen.md
**Implemented:** 2026-01-14
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts modified: 2
- Scenes modified: 1
- Data files created: 0
- Files modified: 2
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: Build & Command (grow your mercenary company)
- Reinforces player fantasy: Mercenary captain building their fighting force
- Within scope boundaries: Simple recruitment with capacity limits

---

## What Was Done

### Overview

The Soldier Recruitment Screen replaces the placeholder Barracks screen with a fully functional recruitment interface. Players can now spend gold to hire Infantry (50g) and Archer (100g) soldiers to expand their mercenary company. The system tracks soldiers in a roster array stored in GameState, with a capacity limit of 4 soldiers by default or 8 soldiers if the player has purchased the Barracks fort upgrade.

The interface displays two soldier cards side-by-side showing stats (HP, ATK, DEF, MOVE, and RANGE for archers), a visual capacity bar, and a roster display showing currently owned soldiers. Hiring a soldier deducts gold, adds the soldier to the roster, and provides visual feedback through a green flash animation. If the player lacks gold or roster capacity, clicking hire shows a shake animation and the button is appropriately disabled.

### Technical Changes

1. **GameState Extensions:** Added `soldiers: Array[String]` to track owned soldiers, plus methods for roster management (`add_soldier()`, `remove_soldier()`, `get_soldiers()`, etc.)
2. **Signal System:** Added `soldiers_changed` signal for reactive UI updates
3. **Save/Load Support:** Soldiers array is now included in save data
4. **Capacity System:** Uses existing `has_upgrade("barracks")` to check for +4 capacity bonus

---

## Files Modified

### 1. scripts/autoload/game_state.gd

**Changes:**
- Added signal: `soldiers_changed()`
- Added state variable: `soldiers: Array[String] = []`
- Added methods:
  - `add_soldier(soldier_type: String)` - Add a soldier to the roster
  - `remove_soldier(soldier_type: String) -> bool` - Remove soldier (for deaths)
  - `get_soldiers() -> Array[String]` - Get copy of roster
  - `get_soldier_count() -> int` - Get total count
  - `get_soldier_count_by_type(soldier_type: String) -> int` - Get count by type
  - `clear_soldiers()` - Clear all soldiers
- Updated `get_save_data()` to include soldiers array
- Updated `load_save_data()` to restore soldiers array
- Updated `reset_to_new_game()` to clear soldiers

**Key Code Section (lines 298-330):**
```gdscript
# ===== SOLDIER ROSTER MANAGEMENT =====
func add_soldier(soldier_type: String) -> void:
    soldiers.append(soldier_type)
    soldiers_changed.emit()

func remove_soldier(soldier_type: String) -> bool:
    var idx := soldiers.find(soldier_type)
    if idx >= 0:
        soldiers.remove_at(idx)
        soldiers_changed.emit()
        return true
    return false

func get_soldiers() -> Array[String]:
    return soldiers.duplicate()

func get_soldier_count() -> int:
    return soldiers.size()
```

---

### 2. scripts/hub/screens/barracks_screen.gd

**Complete Rewrite:** Replaced placeholder with full recruitment logic.

**Key Features:**
- `SOLDIER_DATA` constant with Infantry and Archer stats
- `BASE_CAPACITY = 4` and `BARRACKS_BONUS = 4` constants
- Dynamic hire button states (available, disabled-no-gold, disabled-roster-full)
- Success feedback: green flash animation
- Denied feedback: shake animation
- Roster display with color-coded soldier icons

**Key Methods:**
- `get_max_capacity()` - Returns 4 or 8 based on Barracks upgrade
- `can_hire()` - Checks if roster has room
- `_hire_soldier(soldier_type)` - Validates and executes purchase
- `_refresh_display()` - Updates all UI elements
- `_create_roster_slot()` - Builds dynamic roster icons

**Signals:**
- `soldier_hired(soldier_type: String)` - Emitted when purchase succeeds

---

### 3. scenes/hub/screens/BarracksScreen.tscn

**Complete Rebuild:** Replaced placeholder scene with full recruitment UI.

**Structure:**
```
BarracksScreen (Control)
├── Background (ColorRect)
├── TopBar (HBoxContainer)
│   ├── BackButton
│   ├── TitleLabel - "SOLDIER RECRUITMENT"
│   └── GoldDisplay
│       ├── GoldLabel
│       └── GoldAmount
└── ContentPanel (Panel)
    └── MainContent (VBoxContainer)
        ├── RosterStatus (VBoxContainer)
        │   ├── RosterLabel - "CURRENT ROSTER"
        │   ├── CapacityBar (ProgressBar)
        │   ├── CapacityText - "0/4 SOLDIERS"
        │   └── BarracksHint
        ├── SoldiersContainer (HBoxContainer)
        │   ├── InfantryCard (PanelContainer)
        │   │   └── VBoxContainer
        │   │       ├── NameLabel
        │   │       ├── Portrait (ColorRect with label)
        │   │       ├── StatsContainer (GridContainer)
        │   │       ├── DescriptionLabel
        │   │       └── HireButton
        │   └── ArcherCard (PanelContainer)
        │       └── [Same structure]
        └── OwnedRosterDisplay (VBoxContainer)
            ├── OwnedLabel
            ├── NoSoldiersLabel
            └── SoldierIcons (HBoxContainer)
```

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- Barracks screen was a placeholder with no functionality
- No way to expand fighting force beyond core party members
- Gold had limited spending options (only fort upgrades)

**After Implementation:**
- Players can hire Infantry (50g) and Archer (100g) soldiers
- Roster system tracks owned soldiers with 4-8 capacity
- Gold now has meaningful spending choices (upgrades vs soldiers)
- Barracks upgrade provides additional value (+4 soldier capacity)

### New Mechanics Introduced

1. **Soldier Roster:** Persistent array of owned soldiers tracked in GameState
2. **Capacity System:** Base 4 slots, expandable to 8 with Barracks upgrade
3. **Hire Transaction:** Gold deduction + roster addition with validation

### Systems Affected

- **GameState:** Now tracks soldiers array with full save/load support
- **Fort Management:** Barracks upgrade now provides +4 soldier capacity
- **Combat (Future):** Soldiers in roster can spawn in battles

---

## What the Player Should Now See

### Visible Differences

#### In Menus/UI

1. **Barracks Button** now leads to "SOLDIER RECRUITMENT" screen
2. **Two Soldier Cards** displayed side-by-side:
   - Infantry: Green portrait, HP 20, ATK 1d6+1, DEF 13, MOVE 4, 50 Gold
   - Archer: Purple portrait, HP 15, ATK 1d6, DEF 11, MOVE 5, RANGE 8, 100 Gold
3. **Capacity Bar** shows current/max soldiers (e.g., "2/4 SOLDIERS")
4. **Roster Display** shows owned soldiers as color-coded slots
5. **Gold Display** in top-right shows current gold

#### During Gameplay

- **Clicking HIRE with enough gold:** Card flashes green, gold decrements, roster updates
- **Clicking HIRE without gold:** Card shakes, button stays grayed out
- **Clicking HIRE with full roster:** Button shows "ROSTER FULL"
- **With Barracks upgrade:** Capacity shows 8 max, hint text changes to green

### Step-by-Step: What the Player Experiences

**Scenario: Hiring First Soldier**
1. Player navigates to Hub
2. Clicks "BARRACKS" button
3. Sees "SOLDIER RECRUITMENT" screen with empty roster (0/4)
4. Reviews Infantry card: 50 gold, good defense, melee
5. Clicks "HIRE - 50 GOLD" button
6. Card flashes green briefly
7. Gold display updates (500 → 450)
8. Roster shows "1/4 SOLDIERS"
9. One green "INF" slot appears in roster display

**Scenario: Roster Full**
1. Player has 4 soldiers (roster 4/4)
2. Both hire buttons show "ROSTER FULL"
3. Hint text says "Upgrade Barracks at Fort for more capacity"
4. Player navigates to Fort, purchases Barracks (200g)
5. Returns to Recruitment, roster now shows "4/8 SOLDIERS"
6. Hire buttons are enabled again

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. Press F5 to run the game
3. Navigate to Hub
4. Click "BARRACKS" button
5. **Success if:** See two soldier cards (Infantry, Archer) with hire buttons
6. Click "HIRE - 50 GOLD" on Infantry card
7. **Success if:** Gold decreases, roster shows 1 soldier

### Comprehensive Testing Checklist

#### Core Functionality
- [ ] **Test 1:** Screen loads from hub
  - **Steps:** Click BARRACKS from hub
  - **Expected:** Recruitment screen appears with gold display

- [ ] **Test 2:** Infantry hire works
  - **Steps:** Click HIRE on Infantry card
  - **Expected:** 50g deducted, "infantry" added to roster

- [ ] **Test 3:** Archer hire works
  - **Steps:** Click HIRE on Archer card
  - **Expected:** 100g deducted, "archer" added to roster

- [ ] **Test 4:** Back button works
  - **Steps:** Click "< BACK"
  - **Expected:** Returns to hub main view

#### Acceptance Criteria Verification

- [ ] **Recruitment screen accessible from hub navigation**
  - Test: Click BARRACKS button
  - Expected: Screen shows with soldier cards

- [ ] **Both soldier types displayed with full stats**
  - Test: Visual inspection
  - Expected: Infantry shows HP 20, ATK 1d6+1, DEF 13, MOVE 4
  - Expected: Archer shows HP 15, ATK 1d6, DEF 11, MOVE 5, RANGE 8

- [ ] **Current gold displayed in header**
  - Test: Check top-right
  - Expected: Shows current gold amount

- [ ] **Roster capacity displayed as bar and text**
  - Test: Visual inspection
  - Expected: Progress bar + "X/4 SOLDIERS" text

- [ ] **Hire deducts gold and adds soldier**
  - Test: Hire infantry with 500g
  - Expected: Gold shows 450, roster shows 1

- [ ] **Cannot hire when roster is full**
  - Test: Hire 4 soldiers (without Barracks)
  - Expected: Buttons show "ROSTER FULL", disabled

- [ ] **Cannot hire when gold insufficient**
  - Test: Have 40g, try hiring Infantry
  - Expected: Button disabled, grayed out

- [ ] **Barracks upgrade increases capacity from 4 to 8**
  - Test: Purchase Barracks at Fort, return to Recruitment
  - Expected: Capacity shows X/8

- [ ] **Hired soldiers persist in GameState**
  - Test: Hire soldier, leave screen, return
  - Expected: Soldier still in roster

#### Edge Case Tests

- [ ] **Exactly 50 gold for Infantry**
  - Set gold to 50, hire Infantry
  - Expected: Purchase succeeds, gold becomes 0

- [ ] **49 gold for Infantry**
  - Set gold to 49, try hire Infantry
  - Expected: Button disabled

- [ ] **Full roster (4/4) without Barracks**
  - Hire 4 soldiers
  - Expected: Both buttons show "ROSTER FULL"

- [ ] **Full roster (8/8) with Barracks**
  - Purchase Barracks, hire 8 soldiers
  - Expected: Both buttons show "ROSTER FULL"

#### Integration Tests

- [ ] **With GameState:** `GameState.get_soldiers()` returns correct array
- [ ] **With Fort Management:** Barracks upgrade affects capacity
- [ ] **With Save/Load:** Soldiers persist through save/load

---

## Troubleshooting

### Issue: Screen shows old placeholder
**Symptom:** "Soldier recruitment coming in Task 3.3" text appears
**Cause:** Scene not saved or cached
**Fix:** Reload project in Godot Editor (Project > Reload Current Project)

### Issue: Hire button doesn't work
**Symptom:** Click does nothing
**Cause:** Signal not connected
**Fix:** Check `_connect_recruitment_signals()` is being called

### Issue: Capacity doesn't update after Barracks purchase
**Symptom:** Still shows 4/4 after purchasing Barracks
**Cause:** `upgrade_purchased` signal not connected
**Fix:** Verify `GameState.upgrade_purchased.connect(_on_upgrade_purchased)` exists

### Issue: Soldiers not persisting
**Symptom:** Soldiers disappear after scene change
**Cause:** `soldiers` not in save data or not loading
**Fix:** Check `get_save_data()` includes soldiers array

---

## Next Steps

After verifying this feature works:

1. [ ] Integrate soldiers with combat system (spawn in battles)
2. [ ] Connect soldier death to `GameState.remove_soldier()`
3. [ ] Test save/load with soldiers
4. [ ] Add soldier count to hub UI (optional)
5. [ ] Consider adding dismiss functionality (future)

---

## Combat Integration Notes

For future integration, the combat system should:

```gdscript
# In combat setup
func _spawn_player_soldiers() -> void:
    var soldiers := GameState.get_soldiers()
    for i in range(soldiers.size()):
        var soldier_type := soldiers[i]
        var unit := _spawn_soldier_unit(soldier_type, spawn_positions[i])
        # Connect death to remove from roster
        unit.unit_died.connect(func(): GameState.remove_soldier(soldier_type))
```

This is documented in the feature spec and should be implemented when combat integration is tackled.

---

## Rollback Instructions

If implementation has issues:

```bash
# See what changed
git status

# Review changes
git diff

# Revert specific file
git checkout -- scripts/hub/screens/barracks_screen.gd

# Revert all changes
git reset --hard HEAD
```

All original code preserved in git history.
