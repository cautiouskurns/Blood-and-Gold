# Feature Implementation Report

**Feature:** Thorne Camp Scene - Post Contract 1
**Spec File:** docs/features/3.11-thorne-camp-scene-post-contract-1.md
**Implemented:** 2026-01-15
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts modified: 2
- Data files created: 1
- New methods added: 8
- Manual steps required: 0

### Design Alignment Confirmed
- Supports design pillar: **Consequence & Choice** (dialogue choices affect Thorne's loyalty)
- Supports design pillar: **Company Identity** (Thorne expresses cynical veteran personality)
- Reinforces player fantasy: **Mercenary captain building relationships with crew**
- Within scope boundaries: Post-contract narrative camp scene with loyalty integration

---

## What Was Done

### Overview

This implementation adds the first automatic post-contract camp scene featuring Thorne Blackwood. After completing the Merchant's Escort tutorial contract, players are taken to a camp scene where Thorne shares his cynical philosophy about mercenary life and tests the new captain's values.

The scene establishes Thorne's character as a pragmatic veteran who values survival over idealism. Players choose from three responses that reveal their captain's personality:
1. **Agree** (neutral) - Pragmatic acceptance of Thorne's worldview
2. **Disagree** (-5 loyalty) - Idealistic pushback that Thorne dislikes
3. **Ask why** (+5 loyalty) - Genuine curiosity that Thorne appreciates

This teaches players that companion conversations have meaningful consequences while establishing the first major NPC relationship.

### Technical Changes

1. **GameState Scene Tracking:** Added `viewed_scenes` dictionary and methods to track one-time scenes
2. **Dialogue JSON:** Created complete dialogue tree with branching paths and loyalty changes
3. **Contract Integration:** Modified merchants_escort.gd to trigger camp scene after victory

---

## Files Created

### 1. resources/dialogue/thorne_camp_1.json

**Purpose:** Complete dialogue tree for Thorne's post-contract camp scene.

**Structure:**
- 14 total nodes (Start, 10 Speaker, 3 Choice, 1 End)
- 4 speaker nodes before choice point (as per spec)
- 3 distinct choice branches
- "Ask why" branch has 4 additional speaker nodes (backstory reveal)
- All branches converge to single closing line

**Loyalty Changes:**
- `choice_agree`: No change (neutral response)
- `choice_disagree`: -5 Thorne loyalty
- `choice_ask`: +5 Thorne loyalty

**Key Dialogue Content:**
- Thorne shares philosophy: "Gold keeps us fed, steel keeps us alive"
- "Ask why" reveals Red Shields backstory - company that starved after taking unpaid contract
- Closing line works regardless of branch taken

---

## Files Modified

### 1. scripts/autoload/game_state.gd

**Changes:**
- Added `viewed_scenes: Dictionary = {}` state variable
- Added `has_viewed_scene(scene_id: String) -> bool` method
- Added `mark_scene_viewed(scene_id: String) -> void` method
- Added `get_all_viewed_scenes() -> Array[String]` method
- Updated `get_save_data()` to include viewed_scenes
- Updated `load_save_data()` to restore viewed_scenes
- Updated `reset_to_new_game()` to clear viewed_scenes

**New Methods:**

| Method | Purpose |
|--------|---------|
| `has_viewed_scene(scene_id)` | Check if a one-time scene has been viewed |
| `mark_scene_viewed(scene_id)` | Mark scene as viewed (won't trigger again) |
| `get_all_viewed_scenes()` | Get list of all viewed scene IDs |

---

### 2. scripts/contracts/merchants_escort.gd

**Changes:**
- Added preload for `CampDialogueScene`
- Added constants for camp scene configuration
- Added `_camp_dialogue: Node` state variable
- Refactored `_on_continue_pressed()` to check for camp scene trigger
- Added 6 new methods for camp scene management

**New Constants:**
```gdscript
const CampDialogueScene = preload("res://scenes/camp/CampDialogue.tscn")
const TRIGGERED_CAMP_SCENE_ID: String = "thorne_camp_1"
const TRIGGERED_CAMP_SCENE_PATH: String = "res://resources/dialogue/thorne_camp_1.json"
```

**New Methods:**

| Method | Purpose |
|--------|---------|
| `_should_trigger_camp_scene()` | Check if camp scene should trigger (not viewed, Thorne present) |
| `_start_camp_scene()` | Load and display camp dialogue |
| `_on_camp_scene_ended(scene_id)` | Handle dialogue completion, mark as viewed |
| `_cleanup_camp_scene()` | Free camp dialogue instance |
| `_return_to_hub()` | Scene transition to Hub |

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- After winning Merchant's Escort, player immediately returned to Hub
- No narrative moment after first contract completion
- No introduction to Thorne's character beyond combat

**After Implementation:**
- After winning Merchant's Escort, camp scene triggers automatically
- Thorne approaches captain and shares his philosophy on mercenary life
- Player makes meaningful choice that affects Thorne's loyalty
- Sets up Thorne's character arc for future scenes
- Scene only triggers once (tracked in GameState)

### New Mechanics Introduced

1. **Automatic Post-Contract Scenes:**
   - Camp scenes can trigger after specific contracts
   - Checked via `GameState.has_viewed_scene()` to prevent repeats
   - Skipped if relevant companion has departed

2. **Scene Tracking System:**
   - New `viewed_scenes` dictionary in GameState
   - Persists across save/load cycles
   - Reset on new game

### Systems Affected

- **GameState:** New scene tracking capabilities
- **LoyaltyManager:** Called from dialogue choices (existing integration)
- **LoyaltyPopup:** Displays loyalty changes (existing integration)
- **CampDialogue:** Used to display the new dialogue (existing scene)
- **DialogueManager:** Parses the new JSON dialogue (existing class)

---

## What the Player Should Now See

### Visible Differences

#### After Winning Merchant's Escort

1. **Victory popup appears** (as before)
2. Player clicks **Continue**
3. **Screen transitions to camp scene** instead of directly to Hub
4. **Thorne's portrait placeholder** appears on left (dark blue with "THO")
5. **"THORNE"** speaker name in blue (#5dade2)
6. **Dialogue text** with typewriter effect
7. **Continue indicator** pulses when waiting for input

#### During Dialogue

1. Thorne's opening: "Captain. Mind if I join you?"
2. Three more speaker nodes setting up the philosophy
3. **Choice point appears** with three options:
   - [1] "Gold and survival. Same as you."
   - [2] "There's more to life than coin." (-Thorne)
   - [3] "What happened to those other companies?" (+Thorne)
4. Player selects choice
5. **LoyaltyPopup** shows if loyalty changes (+5 or -5)
6. Branch-specific response from Thorne
7. Closing line: "Anyway. Get some rest..."
8. **Scene ends**, returns to Hub

### Step-by-Step: What the Player Experiences

**Full Flow:**
1. Player completes Merchant's Escort contract (victory)
2. Battle Result popup shows gold earned
3. Player clicks "Continue"
4. Screen transitions to camp dialogue
5. Player advances through 4 speaker nodes
6. Three choices appear
7. Player selects a choice (click or number key)
8. If loyalty change: LoyaltyPopup displays
9. Thorne responds based on choice
10. Closing dialogue
11. Scene ends, Hub loads
12. If player plays contract again, scene won't repeat

**Edge Case: Thorne Departed**
1. If Thorne's loyalty reached 0 and he departed
2. After victory, "Continue" goes directly to Hub
3. No camp scene (console shows skip message)

---

## How to Test

### Quick Smoke Test (3 minutes)

1. Open Godot Editor
2. Press F5 to run game
3. Navigate to Contracts screen
4. Accept "Merchant's Escort" contract
5. Accept briefing, complete combat (kill all enemies, protect wagon)
6. On victory popup, click "Continue"
7. **Success if:** Camp dialogue scene appears with Thorne
8. Click/Space to advance through dialogue
9. Select any choice when options appear
10. **Success if:** LoyaltyPopup shows for choices 2 or 3
11. Dialogue ends, Hub loads
12. Return to Contracts, replay mission
13. After second victory, click Continue
14. **Success if:** Goes directly to Hub (scene already viewed)

### Comprehensive Testing Checklist

#### Core Functionality

- [ ] **Test 1:** Camp scene triggers after first win
  - **Steps:** Complete Merchant's Escort, click Continue
  - **Expected:** Camp dialogue appears with Thorne

- [ ] **Test 2:** All speaker nodes display
  - **Steps:** Advance through dialogue
  - **Expected:** 4 speaker nodes before choices, then responses

- [ ] **Test 3:** All three choices appear
  - **Steps:** Reach choice point
  - **Expected:** Three choice buttons with text and loyalty indicators

- [ ] **Test 4:** "Agree" choice (0 loyalty)
  - **Steps:** Select "Gold and survival. Same as you."
  - **Expected:** No LoyaltyPopup, Thorne approving response

- [ ] **Test 5:** "Disagree" choice (-5 loyalty)
  - **Steps:** Select "There's more to life than coin."
  - **Expected:** LoyaltyPopup shows -5 Thorne, disapproval response

- [ ] **Test 6:** "Ask why" choice (+5 loyalty)
  - **Steps:** Select "What happened to those other companies?"
  - **Expected:** LoyaltyPopup shows +5 Thorne, 4 additional backstory nodes

#### Acceptance Criteria Verification

- [ ] Scene triggers automatically after Merchant's Escort completion
- [ ] Thorne's cynical mercenary personality established through dialogue
- [ ] Three choices available: Agree, Disagree, Ask why
- [ ] "Agree" choice results in 0 loyalty change
- [ ] "Disagree" choice results in -5 Thorne loyalty
- [ ] "Ask why" choice results in +5 Thorne loyalty
- [ ] LoyaltyPopup displays after choice (if change occurred)
- [ ] Scene marked as viewed in GameState (doesn't repeat)
- [ ] Scene transitions smoothly back to hub after ending
- [ ] Dialogue text conveys Thorne's character effectively

#### Edge Case Tests

- [ ] **Scene doesn't repeat**
  - **How:** Complete contract twice
  - **Expected:** Scene only triggers first time

- [ ] **Skip if Thorne departed**
  - **How:** Set Thorne loyalty to 0, complete contract
  - **Expected:** Goes directly to Hub

- [ ] **Typewriter skip**
  - **How:** Click during text appearing
  - **Expected:** Full text displays immediately

- [ ] **Number key shortcuts**
  - **How:** Press 1, 2, or 3 at choice point
  - **Expected:** Corresponding choice selected

#### Integration Tests

- [ ] **With LoyaltyManager:** Loyalty values actually change
- [ ] **With LoyaltyPopup:** Popup displays correctly
- [ ] **With GameState save/load:** viewed_scenes persists
- [ ] **With CampScreen:** Updated loyalty shows after dialogue

---

## Troubleshooting

### Issue: Camp scene doesn't trigger
**Symptom:** Goes directly to Hub after victory
**Possible causes:**
1. Scene already viewed (check `GameState.viewed_scenes`)
2. Thorne loyalty is 0 (check `LoyaltyManager.get_loyalty("thorne")`)
3. JSON file not found
**Fix:** Check console for skip messages, verify file exists

### Issue: Dialogue JSON fails to load
**Symptom:** Error in console, returns to Hub
**Cause:** Path incorrect or JSON syntax error
**Fix:** Verify `resources/dialogue/thorne_camp_1.json` exists and is valid JSON

### Issue: Loyalty changes not applying
**Symptom:** No popup, loyalty unchanged
**Cause:** loyalty_changes in JSON might be malformed
**Fix:** Verify JSON has `"loyalty_changes": {"thorne": 5}` format

### Issue: Scene repeats every time
**Symptom:** Camp scene triggers on every contract completion
**Cause:** `mark_scene_viewed()` not being called
**Fix:** Check `_on_camp_scene_ended()` is connected and executing

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest to verify flow
2. [ ] Test save/load with viewed_scenes
3. [ ] Add portrait art for Thorne expressions
4. [ ] Implement Task 3.12: Lyra's camp scene (if planned)
5. [ ] Add ambient audio to camp scenes
6. [ ] Update changelog

---

## Rollback Instructions

If implementation has issues:

```bash
# See what changed
git status

# Review changes
git diff

# Revert specific files
git checkout -- scripts/autoload/game_state.gd
git checkout -- scripts/contracts/merchants_escort.gd

# Remove created file
rm resources/dialogue/thorne_camp_1.json

# Revert all changes
git reset --hard HEAD
```

All original code preserved in git history.
