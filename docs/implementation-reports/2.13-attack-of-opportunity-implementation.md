# Feature Implementation Report: Attack of Opportunity

**Feature:** Attack of Opportunity (Task 2.13)
**Spec File:** docs/features/2.13-attack-of-opportunity.md
**Implemented:** 2026-01-13
**Implementer:** Claude Code (feature-implementer skill)

---

## Summary

- Scripts modified: 3
- Files created: 0 (all infrastructure already existed)
- Manual steps required: 0 (fully integrated)

### Design Alignment Confirmed
- Supports design pillar: **Tactical Combat** - Creates zone-of-control around melee combatants
- Supports design pillar: **Meaningful Choice** - Movement decisions now carry risk/reward trade-offs
- Reinforces player fantasy: Commander must consider positioning and escape routes
- Within scope boundaries: Uses existing attack and movement systems

---

## What Was Done

### Overview
This implementation adds **Attacks of Opportunity (AoO)** - free attacks that trigger when a unit moves away from an adjacent enemy. When a unit attempts to leave a tile that is adjacent to an enemy, that enemy gets a free attack before the movement occurs. This creates tactical "zones of control" around melee combatants, making positioning and movement decisions more meaningful.

The attack resolves **before** movement begins, meaning a unit could potentially be killed before completing their intended move. Each enemy can only perform one opportunity attack per turn (resets at the start of their turn), preventing overwhelming barrages from multiple retreats.

Only melee units can perform opportunity attacks - ranged units (archers, Lyra) cannot. Moving between tiles that both remain adjacent to the same enemy does NOT trigger AoO - only leaving the threat zone does.

### Technical Changes
- Added AoO tracking flag (`_opportunity_attack_used`) to Unit
- Added AoO methods to Unit for checking/marking/resetting AoO usage
- Added AoO reset on turn start in TurnManager
- Added AoO check and execute methods to CombatManager
- Modified `start_unit_movement()` to check for and execute AoO before movement
- Added visual "OPPORTUNITY!" indicator with orange flash

---

## Files Modified

### 1. scripts/combat/unit.gd
**Changes:**
- Added `_opportunity_attack_used: bool` - Tracks if unit has used their AoO this turn
- Added `can_perform_opportunity_attack() -> bool` - Checks if unit can perform AoO
- Added `mark_opportunity_attack_used()` - Marks that unit used their AoO
- Added `reset_opportunity_attack()` - Resets AoO flag (called at turn start)
- Added `has_used_opportunity_attack() -> bool` - Check if AoO was already used
- Added `is_adjacent_to(other: Unit) -> bool` - Utility for adjacency checking

**Key Methods:**
```gdscript
func can_perform_opportunity_attack() -> bool:
    ## Only melee units can perform AoO, and only once per turn
    if not is_alive(): return false
    if is_ranged_weapon: return false  # Ranged units cannot
    if _opportunity_attack_used: return false  # Already used
    return true
```

---

### 2. scripts/combat/turn_manager.gd
**Changes:**
- Modified `_start_current_turn()` to reset opportunity attack flag for the current unit

**Integration:**
- At the start of each unit's turn, their `reset_opportunity_attack()` is called
- This allows each unit to perform one AoO during their own "turn cycle"

---

### 3. scripts/autoload/combat_manager.gd
**Changes:**
- Added signal `opportunity_attack_triggered(attacker, target)` - Emitted when AoO begins
- Added signal `opportunity_attack_completed(attacker, target, damage)` - Emitted when AoO resolves
- Added `check_opportunity_attacks(moving_unit, path) -> Array[Unit]` - Checks if path triggers AoO
- Added `execute_opportunity_attacks(attackers, target) -> bool` - Executes all AoO, returns survival status
- Added `_get_enemies_adjacent_to_position(unit, pos) -> Array[Unit]` - Helper for adjacency check
- Added `_is_adjacent_to_position(pos1, pos2) -> bool` - Position adjacency helper
- Added `_spawn_opportunity_indicator(attacker)` - Shows "OPPORTUNITY!" text
- Added `_spawn_aoo_damage_number(target, result)` - Shows damage/miss for AoO
- Modified `start_unit_movement()` to check for and execute AoO before movement

**Key Method - AoO Check:**
```gdscript
func check_opportunity_attacks(moving_unit: Unit, path: Array[Vector2i]) -> Array[Unit]:
    # For each step in path, check if unit leaves any enemy's adjacency
    # Returns array of enemies who will get AoO
```

**Key Method - AoO Execution:**
```gdscript
func execute_opportunity_attacks(attackers: Array[Unit], target: Unit) -> bool:
    # For each attacker:
    #   - Spawn "OPPORTUNITY!" indicator
    #   - Resolve attack using AttackResolver
    #   - Spawn damage number
    #   - Apply damage if hit
    #   - Mark attacker's AoO as used
    # Returns true if target survives, false if killed
```

---

## What Changed in the Game

### Gameplay Impact

**Before Implementation:**
- Units could freely move away from adjacent enemies
- No penalty for repositioning or retreating
- Melee units couldn't punish units trying to escape

**After Implementation:**
- Moving away from adjacent enemies triggers free attack before movement
- Retreating from combat carries risk of taking damage
- Each enemy can only perform one AoO per turn
- Movement decisions now require tactical consideration
- Melee fighters create "threat zones" that enemies must respect

### New Mechanics Introduced

1. **Attack of Opportunity:** Free attack when enemy leaves your adjacency
2. **Zone of Control:** Melee units now "threaten" adjacent tiles
3. **One AoO Per Turn:** Limit prevents overwhelming damage on retreat
4. **AoO Reset:** Flag resets at start of each unit's turn

### Systems Affected
- **Movement System:** Now checks for AoO before executing movement
- **Unit State:** Tracks whether AoO has been used this turn
- **Turn System:** Resets AoO flag at turn start
- **Attack System:** Reused for performing the free attack

---

## What the Player Should Now See

### Visible Differences

#### During Movement
- When a unit moves away from an adjacent enemy:
  1. "OPPORTUNITY!" text appears above the attacking enemy (orange color)
  2. Enemy flashes orange briefly
  3. Damage number appears on the moving unit (hit/miss)
  4. If unit survives, movement proceeds normally
  5. If unit dies, movement is cancelled

### Step-by-Step: What the Player Experiences

**Scenario: Unit Retreating from Adjacent Enemy**
1. Player selects a party member adjacent to an enemy
2. Player clicks a tile that would move the unit away from the enemy
3. Console: "[CombatManager] Player leaving Enemy's threat zone triggers AoO"
4. "OPPORTUNITY!" text appears above the enemy (orange)
5. Enemy flashes orange
6. Attack roll is made using enemy's normal attack stats
7. Damage number appears on player unit
8. If player unit survives:
   - Movement proceeds normally to the destination
9. If player unit dies:
   - Movement is cancelled
   - Unit death is processed

**Scenario: Enemy Cannot Perform AoO**
1. Enemy has already used their AoO this turn
2. Player moves away from that enemy
3. No AoO triggers - movement proceeds normally
4. Console shows no AoO message

**Scenario: Ranged Enemy**
1. Player is adjacent to an enemy archer
2. Player moves away from the archer
3. No AoO triggers - ranged units cannot perform AoO
4. Movement proceeds normally

---

## How to Test

### Quick Smoke Test (2 minutes)

1. Open Godot Editor
2. Open the main battle scene
3. Press F5 to run the game
4. Move a party member adjacent to an enemy
5. Click a tile to move AWAY from the enemy (not staying adjacent)
6. **Success if:** "OPPORTUNITY!" appears, damage/miss shows, then movement occurs
7. **Failure if:** Movement occurs without AoO trigger

### Comprehensive Testing Checklist

#### Core Functionality
- [ ] **Basic AoO Test:** Move party member away from adjacent enemy, verify AoO triggers
- [ ] **Damage Test:** Verify AoO deals damage using enemy's normal attack stats
- [ ] **Timing Test:** Verify AoO damage applies BEFORE unit moves
- [ ] **One-per-turn Test:** Same enemy only performs one AoO per turn
- [ ] **Reset Test:** After enemy's turn starts, they can AoO again
- [ ] **Death Test:** Unit killed by AoO doesn't complete movement
- [ ] **Multiple Enemies Test:** Moving away from 2+ enemies triggers AoO from each (if available)

#### Edge Case Tests
- [ ] **Diagonal adjacency:** AoO triggers for diagonal neighbors
- [ ] **Staying adjacent:** Moving parallel to enemy (staying adjacent) does NOT trigger AoO
- [ ] **Moving toward enemy:** Approaching an enemy doesn't trigger AoO
- [ ] **Path through threat:** Path passing through enemy adjacency triggers AoO on exit
- [ ] **Ranged enemies:** Archers and other ranged units do NOT perform AoO

#### Integration Tests
- [ ] Works with party members (player-controlled units)
- [ ] Works with soldier AI (NPC soldiers can trigger AoO)
- [ ] Works with enemy AI (enemies performing AoO)
- [ ] Works with damage number system
- [ ] Works with turn order system (AoO flag reset)
- [ ] Doesn't break existing movement functionality

---

## Console Output Examples

When AoO triggers:
```
[CombatManager] Player leaving Enemy's threat zone triggers AoO
[CombatManager] 1 enemy units will get opportunity attacks
[CombatManager] Enemy performs opportunity attack on Player!
[Unit] Enemy used their opportunity attack this turn
[CombatManager] AoO: Enemy vs Player - Roll 15 + 3 = 18 vs DEF 15 -> HIT for 5 damage
[CombatManager] Player starting movement to (3, 5)
```

When unit dies from AoO:
```
[CombatManager] Player leaving Enemy's threat zone triggers AoO
[CombatManager] 1 enemy units will get opportunity attacks
[CombatManager] Enemy performs opportunity attack on Player!
[CombatManager] AoO: Enemy vs Player - Roll 18 + 3 = 21 vs DEF 15 -> HIT for 12 damage
[CombatManager] Player killed by opportunity attack - movement cancelled
```

When enemy already used AoO:
```
[CombatManager] Player leaving Enemy's threat zone triggers AoO
(No AoO message - enemy can't perform AoO because _opportunity_attack_used is true)
[CombatManager] Player starting movement to (3, 5)
```

---

## Troubleshooting

### Issue: AoO not triggering when moving away from enemy
**Symptom:** Unit moves without AoO happening
**Possible causes:**
1. Enemy already used their AoO this turn
2. Enemy is a ranged unit (cannot perform AoO)
3. Unit is not actually leaving adjacency (moving parallel)
**Fix:** Check console for "[CombatManager] leaving threat zone" message

### Issue: AoO triggers when it shouldn't
**Symptom:** AoO triggers when staying adjacent to enemy
**Cause:** Bug in adjacency check
**Fix:** Verify `_is_adjacent_to_position()` returns true for both current and next position

### Issue: Multiple AoO from same enemy
**Symptom:** Same enemy attacks multiple times per turn
**Cause:** `mark_opportunity_attack_used()` not being called
**Fix:** Verify the attack sequence calls `attacker.mark_opportunity_attack_used()`

### Issue: AoO flag not resetting
**Symptom:** Enemy can't perform AoO on subsequent turns
**Cause:** `reset_opportunity_attack()` not being called
**Fix:** Verify `_start_current_turn()` in TurnManager calls reset

---

## Next Steps

After verifying this feature works:

1. [ ] Run full playtest with various movement scenarios
2. [ ] Test AoO with soldier AI movement
3. [ ] Test multiple enemies triggering AoO simultaneously
4. [ ] Consider adding visual warning for tiles that would trigger AoO
5. [ ] Update changelog
6. [ ] Commit changes

---

## Files Summary

| File | Type | Status |
|------|------|--------|
| scripts/combat/unit.gd | Script | Modified |
| scripts/combat/turn_manager.gd | Script | Modified |
| scripts/autoload/combat_manager.gd | Script | Modified |
| docs/features/2.13-attack-of-opportunity.md | Spec | Updated status |
| docs/implementation-reports/2.13-attack-of-opportunity-implementation.md | Report | Created |

---
